<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4941951590762138"
     crossorigin="anonymous"></script>
     
     <meta name="google-adsense-account" content="ca-pub-4941951590762138">
     
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&amp;display=swap" rel="stylesheet"/>
<link rel="apple-touch-icon" sizes="180x180" href="https://i.postimg.cc/1XkPsyWc/IMG-20251201-WA0008.jpg">
<link rel="icon" type="image/png" sizes="192x192" href="https://i.postimg.cc/1XkPsyWc/IMG-20251201-WA0008.jpg">
<link rel="icon" type="image/png" sizes="512x512" href="https://i.postimg.cc/1XkPsyWc/IMG-20251201-WA0008.jpg">

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-LG4B6NR8XN"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-LG4B6NR8XN');
</script>

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title> vipro store </title>
  <meta name="description" content="فيبرو ستور | Vipro Store - متجر متخصص في شحن الألعاب والتطبيقات، بطاقات الهدايا، وشحن العملات داخل الألعاب بأسعار منافسة وتسليم فوري. أفضل منصة عربية لخدمات الألعاب الرقمية.">
  
  <meta name="keywords" content="فيبرو ستور, Vipro Store, شحن ألعاب, شحن ببجي, شحن فري فاير, بطاقات هدايا, شحن تطبيقات, متجر ألعاب, شحن شدات, شحن جواهر, متجر رقمي ,ببجي ,شحن جواهر فري فاير ,شدات , شدات ببجي, شحن شدات ببجي,شام كاش,سريتيل كاش,    فيبرو,فيبروو,فيبرو ستور,فيبرو شوب,موقع فييرو,شحن فييرو,فيبرو, vipro,viproo,vipro store,viproo store,viproo shop,vibro,vibro store,اقرب أليك,اقرب اليك,شام">
  
  <meta property="og:title" content="فيبرو ستور | Vipro Store">
<meta property="og:description" content="أفضل متجر عربي لشحن الألعاب والتطبيقات مع تسليم فوري وأسعار منافسة.">
<meta property="og:image" content="https://i.postimg.cc/1XkPsyWc/IMG-20251201-WA0008.jpg">
<meta property="og:image:type" content="image/jpeg">
<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="630">
  <!-- ربط خط Almarai -->
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
  <style>
  /* تطبيق خط Almarai على كل الصفحة */
body {
  font-family: 'Cairo', sans-serif !important;
}
  :root { --main-color: #A80003; }

  /* (CSS الأصلي مع تعديلات لإخفاء الشريط العلوي وإضافة انبثاق سريع) */
  * { margin:0; padding:0; box-sizing:border-box }
  html,body { height:100% }
  body { font-family:Arial,Helvetica,sans-serif;background:#000;color:#fff; overflow-x:hidden }

  /* header عادي */
  header { background:#111; padding:10px 20px; position:relative; text-align:center; transition:height .12s ease, padding .12s ease, background .12s ease }
  header img { height:90px; width:auto; display:block; margin:0 auto; transition:opacity .12s ease }
  #ordersStatusBar { margin:8px auto 0; max-width:720px; padding:4px 8px; border-radius:6px; text-align:center; min-height:22px; display:none; overflow:hidden; white-space:normal; pointer-events:none }
  .status-line { color:var(--main-color); padding:2px 4px; margin:2px 0; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; display:block; font-weight:700; border-bottom:1px solid rgba(255,203,1,0.06); line-height:1.1 }
  .menu { position:absolute; right:20px; font-size:28px; cursor:pointer; color:var(--main-color); top:50%; transform:translateY(-50%) }
  #personalNumberDisplay { position:absolute; left:20px; top:30%; transform:translateY(-50%); color:#111; font-weight:bold; font-size:11px }
  #notifBell { position:absolute; right:80px; top:51%; transform:translateY(-50%); font-size:18px; cursor:pointer; color:var(--main-color) }
  #notifBell .badge {
  position: relative;
  top: -20px;
  left: 10px;
  background: #ff3b30;
  color: #fff;
  border-radius: 999px;
  padding: 2px 6px;
  font-size: 12px;
}

  #balanceBox {
    position:absolute;
    left:20px;
    top:5px;
    transform:translateY(0);
    background:none;
    color: #fff;
    
    border-radius:4px;
    font-weight:700;
    font-size:11px;
    
    white-space:nowrap;
  }

  .notif-panel { position:fixed; top:70px; right:20px; width:360px; max-width:92%; background:#111; border:2px solid var(--main-color); border-radius:10px; padding:10px; z-index:1500; box-shadow:0 6px 30px rgba(0,0,0,0.6) }
  .notif-panel.hidden { display:none }
  .notif-empty { color:#aaa; padding:8px; text-align:center }

  .sidebar {
    position:fixed;
    top:0;
    right:-100%;
    width:80%;
    max-width:300px;
    height:100%;
    background:transparent;
    padding:20px;
    transition:0.28s;
    z-index:1000;
    overflow-y:auto;
    border-left:2px solid rgba(255,255,255,0.03);
  }
  .sidebar.active { right:0; background:rgba(17,17,17,0.98); }

  .sidebar .avatar { width:48px; height:48px; border-radius:50%; background:#222; display:flex; align-items:center; justify-content:center; font-size:20px; color:var(--main-color); border:2px solid var(--main-color); }

  .sidebar a {
    display:block;
    color:#fff !important;
    text-decoration:none;
    padding:10px 12px;
    margin:6px 0;
    font-size:16px;
    font-weight:700;
    text-align:right;
    border-radius:6px;
    transition: color 0.15s, background 0.15s;
    background: transparent;
  }
  .sidebar a:hover { color:var(--main-color); background:rgba(255,203,1,0.04); }

  .sidebar .small-btn {
    display:block;
    width:100%;
    text-align:center;
    background:transparent;
    color:#fff;
    border:2px solid rgba(255,255,255,0.05);
    padding:10px;
    border-radius:8px;
    margin-top:12px;
    cursor:pointer;
  }
  .sidebar .small-btn:hover { border-color:rgba(255,203,1,0.35); color:var(--main-color); }

  .container { display:grid; grid-template-columns:repeat(auto-fill,minmax(120px,1fr)); gap:15px; padding:20px }
  .card { background:#111; border:2px solid var(--main-color); border-radius:12px; padding:20px; text-align:center; cursor:pointer; transition:.25s; aspect-ratio:1/1; display:flex; align-items:center; justify-content:center }
  .card:hover { background:var(--main-color); color:#000 }
  .hidden { display:none }
  .form-box { background:#000000; border:2px solid var(--main-color); border-radius:0px; padding:20px; margin:1px }
  select,input,button,textarea { width:100%; padding:10px; margin:10px 0; border-radius:8px; border:none; font-size:16px; background:#222; color:#fff }
  .button-option { background:#222; color:var(--main-color); border:2px solid var(--main-color); margin:5px 0; padding:10px; border-radius:8px; cursor:pointer; width:100%; text-align:center; font-weight:bold }
  .button-option.selected { background:var(--main-color); color:#000 }
  button { background:var(--main-color); color:#000; font-weight:bold; cursor:pointer; border-radius:8px; padding:10px }
  .small-btn { display:inline-block; padding:8px 12px; border-radius:8px; background:var(--main-color); color:#000; cursor:pointer; margin-top:8px; text-align:center }
  .back-btn { display:block; margin:20px auto; background:var(--main-color); color:#000; padding:10px; border-radius:8px; text-align:center; font-weight:bold; cursor:pointer }
  .price-note { color:var(--main-color); font-weight:bold; margin:10px 0; font-size:14px; white-space:pre-line }
  .order-item { padding:12px; border:2px solid var(--main-color); border-radius:8px; margin-bottom:10px; background:#111 }
  .login-page { max-width:600px; margin:18px auto; padding:16px }
  .muted-small { font-size:13px; color:#aaa; margin-top:6px }
  .upload-status { font-size:13px; color:#aaa; margin-top:6px }

  @media (min-width: 900px) {
    .sidebar { right:0; position:static; width:260px; max-width:none; background:transparent; border-left:none; padding:20px 10px 20px 20px; }
    .sidebar.active { right:0; background:transparent; }
    main { margin-right:260px; }
  }

  @media (max-width: 899px) {
    .menu { display:block }
    header img { height:72px }
    #personalNumberDisplay { top:1px; left:0px; }
    #balanceBox { top:43%; left:10px; }
  }

  /* fast popup animation */
  @keyframes quickPop {
    0% { opacity:0; transform: translateY(10px) scale(0.995); }
    100% { opacity:1; transform: translateY(0) scale(1); }
  }
  .quick-popup { animation: quickPop .10s ease-out both; transform-origin: top center; }

  /* compact header class - يخفي التفاصيل العلوية بسرعة ويجعل المحتوى يصعد للأعلى */
  header.compact { height:8px !important; padding:2px 8px !important; background:#111 !important; }
  header.compact img, header.compact #personalNumberDisplay, header.compact #balanceBox, header.compact #notifBell, header.compact .menu, header.compact #ordersStatusBar { display:none !important; opacity:0 !important; }

  /* when header compact, remove extra top space from main */
  header + main { transition: margin-top .12s ease }
  /* make pages occupy top when header compact */
  main.compact-main { margin-top: 4px; padding-top:8px; }

  /* existing gradient for charge button */
  #btnCharge {
    background: linear-gradient(270deg, var(--main-color), #FF9F00, var(--main-color)) !important;
    background-size: 600% 600%;
    animation: moveGradient 6s ease infinite;
    color: #000 !important;
    border: none !important;
    padding: 12px !important;
    width: 100% !important;
    font-weight: 800 !important;
    border-radius: 10px !important;
    cursor: pointer;
  }

  @keyframes moveGradient {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
  }

  /* bottom navigation styles */
  #bottomNav{
    position:fixed; left:0; right:0; bottom:0; z-index:1200;
    display:flex; justify-content:space-around; align-items:center;
    padding:10px 8px; padding-bottom:calc(10px + env(safe-area-inset-bottom));
    background:rgba(17,17,17,0.98); border-top:1px solid rgba(255,255,255,0.03);
  }
  .nav-btn{ display:flex; gap:8px; align-items:center; justify-content:center; flex-direction:column; background:transparent; border:none; color:#fff; font-weight:800; cursor:pointer; padding:4px 6px; border-radius:10px; min-width:56px }
  .nav-btn .icon{ width:26px; height:26px; display:block; }
  .nav-btn:active, .nav-btn:focus{ outline:none; transform:translateY(-2px); }
  .nav-label{ font-size:12px; color:var(--main-color) }

  @media(min-width:900px){ .nav-label{ display:block } }



  .profile-summary .row{ display:flex; gap:12px; align-items:center }
  .profile-summary .avatar { width:64px; height:64px; font-size:28px }
  .profile-summary .name{ color:var(--main-color); font-weight:800; font-size:18px; cursor:pointer }
  .profile-summary .personal{ color:#ccc; font-weight:700; cursor:pointer }
  .profile-actions{ margin-top:12px; display:flex; gap:10px; flex-direction:column; align-items:stretch; } /* تم تعديل: جعل الأزرار عمودية */
.profile-actions .small-link {
  background: transparent !important;
  border: none !important;
  box-shadow: none !important;
  color: #fff !important;
  font-weight: bold;
  display: flex;
  flex-direction: row-reverse;  /* الأيقونة على أقصى اليمين */
  align-items: center;
  justify-content: flex-end;    /* جميع العناصر على اليمين */
  gap: 25px;                     /* المسافة بين الأيقونة والنص */
  padding: 10px 15px 10px 0;     /* اضفت 15px على اليمين */
}

  /* تعطيل المربع الأزرق / الظل لجميع العناصر */
  * { outline: none !important; -webkit-tap-highlight-color: transparent; }
  button, a, input, textarea, select { outline: none !important; box-shadow: none !important; -webkit-tap-highlight-color: transparent; }

  .nav-btn { color: #fff; -webkit-tap-highlight-color: transparent; }
  .nav-btn.active { color:var(--main-color) }

  /* البروفايل بالنص مع خلفية #111 */
.profile-summary {
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;
  gap: 4px;                 /* مسافة صغيرة بين العناصر */
  background: none;
  padding: 15px;
  border-radius: 12px;
  margin-bottom: 15px;
  color: #fff;
}

/* الصورة مع إطار ذهبي */
.profile-summary .avatar {
  width: 90px;
  height: 90px;
  border-radius: 50%;
  border: 3px solid var(--main-color);   /* الدائرة ذات لون الثيم */
  background: #333;         /* خلفية داخلية */
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 36px;
  color: #fff;
}

/* الاسم */
.profile-summary .name {
  font-size: 18px;
  font-weight: bold;
  color: var(--main-color);
  margin: 0;
}

.s {
  font-size: 11px;
  background: none;
  color: #ccc;
  margin: 0;
}

.a7d {
  font-size: 11px;
  background: none;
  color: #00A3FF ;
  margin: 0;
}
/* الرقم رمادي فاتح */
.profile-summary .personal {
  font-size: 14px;
  color: #ccc;
  margin: 0;
}

/* بناتك grid tiles */
.benatak-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:12px; margin-top:12px; }
.benatak-tile { padding:14px; border:2px solid var(--main-color); border-radius:10px; text-align:center; background:#111; }
.benatak-tile .title { color:var(--main-color); font-weight:800; }
.benatak-tile .value { font-size:20px; margin-top:8px; color:#0f0; font-weight:800; }
/* خلي الإطار موجود */
#settingsPage .form-box {
  background: transparent !important;
  border: 2px solid var(--main-color) !important; /* الإطار يبقى */
  border-radius: 8px;
  padding: 20px;
}

#settingsPage .small-link,
#settingsPage .back-btn {
  background: transparent !important;
  border: none !important;
  box-shadow: none !important;
  color: #fff !important;
  font-weight: bold;
  display: flex;
  flex-direction: row-reverse;  /* الأيقونة على أقصى اليمين */
  align-items: center;
  justify-content: flex-end;    /* جميع العناصر على اليمين */
  gap: 25px;                     /* المسافة بين الأيقونة والنص */
  padding: 10px 0;
}
/* تطبيق Almarai على كل العناصر حتى لو كانت محددة مسبقًا */


/* FIX: ensure sections take full width and show 3 per row */
#homePage > .container {
  display: block !important; /* منع السلوك الشبكي الخارجي الذي يضغط .sections-grid */
  padding: 12px !important;
  box-sizing: border-box;
}



/* subgrid inside section */
#sectionPage .subgrid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 12px;
  margin-top: 12px;
}
#sectionPage .subcard {
  background: #111;
  border: 2px solid rgba(255,203,1,0.06);
  border-radius: 10px;
  padding: 10px;
  text-align: center;
  cursor: pointer;
  min-height: 140px;
  display:flex;
  flex-direction:column;
  gap:8px;
  align-items:center;
  overflow:hidden;
}
#sectionPage .subcard img { width:66%; height:76px; object-fit:cover; border-radius:8px; display:block; }

/* game store grid */
#gameStoreGrid { display:grid; gap:12px; grid-template-columns: repeat(4,1fr); align-items:start; margin-top:12px; }
#gameStoreGrid .item-card { background:#0f0f0f; border:2px solid rgba(255,203,1,0.06); border-radius:10px; padding:10px; text-align:center; cursor:pointer; min-height:150px; display:flex; flex-direction:column; gap:8px; align-items:center; justify-content:flex-start; overflow:hidden; }
#gameStoreGrid .item-card img { width:72px; height:72px; object-fit:cover; border-radius:8px; }

/* simple order small box */
.simple-order-box { max-width:520px; margin:8px auto; padding:12px; background:#0b0b0b; border-radius:10px; border:2px solid rgba(255,203,1,0.06); }

/* responsiveness */
@media(max-width:1100px){
  #homePage .sections-grid { grid-template-columns: repeat(2,1fr) !important; }
  #sectionPage .subgrid { grid-template-columns: repeat(3,1fr); }
  #gameStoreGrid { grid-template-columns: repeat(3,1fr); }
}
@media(max-width:720px){
  #homePage .sections-grid { grid-template-columns: repeat(1,1fr) !important; }
  #sectionPage .subgrid { grid-template-columns: repeat(2,1fr); }
  #gameStoreGrid { grid-template-columns: repeat(2,1fr); }
}



.a7d_at {
    color: #ccc;
}

main {
  padding-bottom: 85px; /* مسافة تكفي لزر الرجوع/الإرسال */
}

.form-box {
  margin-bottom: 30px; /* مسافة إضافية قبل نهاية الصندوق */
}

/* ===== منع التحديد / long-press menu بشكل عام (ما عدا حقول الإدخال) ===== */
body, body *:not(input):not(textarea):not(select):not(button):not([contenteditable]) {
  -webkit-user-select: none !important;
  -moz-user-select: none !important;
  -ms-user-select: none !important;
  user-select: none !important;

  -webkit-touch-callout: none !important; /* يمنع قائمة الضغط الطويل في iOS */
  -webkit-user-drag: none !important;     /* يمنع سحب الصور */
  -webkit-tap-highlight-color: transparent !important; /* لونه الأزرق على الأندرويد */
}

/* اسمح بالتحديد داخل عناصر النموذج حتى تظل قابلة للتحرير ونسخ النص */
input, textarea, select, button, [contenteditable] {
  -webkit-user-select: text !important;
  user-select: text !important;
}

/* منع سحب الصور (fallback) */
img {
  -webkit-user-drag: none !important;
  user-drag: none !important;
  -webkit-touch-callout: none !important;
  draggable: false; /* HTML attribute fallback (will be set by JS too) */
}
  
/* ===== share button inside profile summary (small, top-left, scrolls with block) ==== */
.profile-summary { position: relative; } /* make container reference for absolute button */
.summary-share-btn {
  position: absolute;
  top: 2px;
  left: 8px; /* top-left inside the profile-summary block */
  width: 38px;
  height: 38px;
  display:flex;
  align-items:center;
  justify-content:center;
  border-radius:5px;
  background: transparent;
  border: none;
  cursor: pointer;
  z-index: 20;
  color: var(--main-color);
  transition: transform .12s ease, background .12s ease, opacity .12s ease;
  opacity: 0.95;
}
.summary-share-btn:active { transform: scale(0.96); }
.summary-share-btn:hover { opacity: 1; background: rgba(255,203,1,0.06); }
.summary-share-btn svg { width:18px; height:18px; pointer-events:none; display:block.; top:5px;}



/* نهاية التعديلات */
body {
  font-family: 'Almarai', sans-serif !important;
  background: url("https://i.postimg.cc/KcpW1cv3/20251203-165618.jpg") no-repeat center center fixed;
  background-size: cover;
  position: relative;
  color: #fff;
  overflow-x: hidden;
}

body::before {
  content: "";
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.6); /* درجة التعتيم */
  z-index: -1; /* تخليها خلف المحتوى */
}

.profile-summary { position: relative; }
.login-number-badge {
  position: absolute;
  top: 8px;
  right: 8px;
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 10px;
  border-radius: 10px;
  background: rgba(255,203,1,0.06);
  border: 1px solid rgba(255,203,1,0.14);
  color: var(--main-color);
  font-weight: 800;
  font-size: 13px;
  cursor: pointer;
  user-select: none;
}
.login-number-badge small {
  font-size: 11px;
  color: #aaa;
  font-weight: 600;
}
/* إطار متغيّر اللون حسب الثيم لكل مربع قسم */
#homePage .sections-grid > .section-tile {
  border: 0px solid var(--main-color) !important; /* اللون يتبع قيمة --main-color */
  border-radius: 12px !important;                /* نفس الانحناء السابق أو عدله */
  position: relative !important;
  overflow: hidden !important;
}

/* ===== Header search (home-only) ===== */
#searchWrapHeader {
  display:flex;
  gap:8px;
  align-items:center;
  position:relative;
  top:0;
  z-index:2500;
  direction: rtl;
}
#searchToggleBtn {
  background:transparent;
  border:none;
  font-size:22px;
  cursor:pointer;
  color:var(--main-color);
  padding:px;
  border-radius:8px;
}
#headerSearchInput {
  width:0;
  opacity:0;
  transition: width .16s ease, opacity .12s ease;
  padding:8px 10px;
  border-radius:10px;
  border:1px solid rgba(255,255,255,0.05);
  background:#0b0b0b;
  color:#fff;
  font-size:14px;
  outline:none;
}
#headerSearchInput.open {
  width:220px;
  opacity:1;
}
#searchResultsBox {
  position:absolute;
  top:calc(100% + 8px);
  right:0;
  min-width:220px;
  max-width:90vw;
  max-height:50vh;
  overflow:auto;
  background:#0e0e0e;
  border:1px solid rgba(255,203,1,0.08);
  border-radius:10px;
  padding:6px;
  box-shadow:0 8px 30px rgba(0,0,0,0.6);
  color:#fff;
  font-size:14px;
  display:none;
}
#searchResultsBox.show { display:block; }
.search-result {
  padding:8px;
  border-radius:8px;
  cursor:pointer;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.search-result:hover, .search-result.selected {
  background: rgba(255,203,1,0.12);
  color:#000;
}
.search-result .meta { font-size:12px; color:#bbb; margin-top:4px; display:block; }
.no-results { padding:12px; color:#aaa; text-align:center; }

/* responsive minor tweaks */
@media (max-width:520px){
  #headerSearchInput.open { width:60vw; }
}
/* ===== Header layout tweak to keep logo and search inline ===== */
header {
  background:#111;
  padding:10px 20px;
  position:relative;
  text-align:center;
  transition:height .12s ease, padding .12s ease, background .12s ease;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:8px; /* مسافة بين اللوغو والبحث */
}

/* Logo inline (كان display:block سابقاً) */
header img#siteLogo {
  height:80px;
  width:auto;
  display:inline-block;
  margin:0;
  vertical-align:middle;
  transition:opacity .12s ease;
}

/* wrapper للبحث بجانب اللوغو */
#searchWrapHeader {
  display:inline-flex;
  gap:8px;
  align-items:center;
  position:relative;
  z-index:2500;
  direction: rtl;
}

/* زر البحث — نستخدم SVG داخل الزر، لونه يتبع currentColor */
#searchToggleBtn {
  background:transparent;
  border:none;
  font-size:18px;
  cursor:pointer;
  color:var(--main-color);
  padding:6px;
  border-radius:8px;
  display:inline-flex;
  align-items:center;
  justify-content:center;
}

/* تأكد أن الـ SVG يملأ الزر ويتلوّن بواسطة currentColor */
#searchToggleBtn svg { width:18px; height:18px; display:block; fill:currentColor; }

/* حقل البحث */
#headerSearchInput {
  width:0;
  opacity:0;
  transition: width .16s ease, opacity .12s ease;
  padding:8px 10px;
  border-radius:10px;
  border:1px solid rgba(255,255,255,0.05);
  background:#0b0b0b;
  color:#fff;
  font-size:14px;
  outline:none;
}
#headerSearchInput.open { width:220px; opacity:1; }

/* نتائج البحث (لا تغيير) */
#searchResultsBox { position:absolute; top:calc(100% + 8px); right:0; min-width:220px; max-width:90vw; max-height:50vh; overflow:auto; background:#0e0e0e; border:1px solid rgba(255,203,1,0.08); border-radius:10px; padding:6px; box-shadow:0 8px 30px rgba(0,0,0,0.6); color:#fff; font-size:14px; display:none; }
#searchResultsBox.show { display:block; }
/* ضع هذا آخر الـ CSS */
header #searchWrapHeader {
  margin-left: 120px; /* زيد الرقم لتركه أبعد لليسار */
}
/* 1) اجعل الهيدر حاوية نسبية */
#topHeader {
  position: relative;
  z-index: 1200;
}

/* 2) ثبّت اللوغو في منتصف الهيدر */
#siteLogo {
  position: absolute;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%);
  z-index: 1250;
  pointer-events: auto;
  max-height: 150px; /* عدّل حسب حجم اللوغو */
  width: auto;
}

/* 3) تأكد أن شريط البحث فوق اللوغو */
#searchWrapHeader,
#searchToggleBtn,
#headerSearchInput {
  position: relative;
  z-index: 1300;
}

/* 4) عند تفعيل حالة البحث نخفي اللوغو والزر والقائمة وشريط الجوانب */
#topHeader.search-active #siteLogo,
#topHeader.search-active #menuBtn,
#topHeader.search-active .menu {
  display: none !important;
}

/* اخفاء الشريط الجانبي (وهو عنصر شقيق بعد الهيدر) */
#topHeader.search-active ~ #sidebar,
#topHeader.search-active ~ .sidebar {
  display: none !important;
  pointer-events: none !important;
}

/* ضبط سلوك الحقل لو بقي ظاهر */
#headerSearchInput.open {
  width: 220px !important; /* نفس سلوك ملفك */
  opacity: 1 !important;
}
/* ===== FIX: force sidebar to remain visible and on top ===== */

/* 1) قم بإبطال أي قاعدة أخفت الـ sidebar عند تفعيل search-active */
#topHeader.search-active ~ #sidebar,
#topHeader.search-active ~ .sidebar {
  display: block !important;
  visibility: visible !important;
  pointer-events: auto !important;
}

/* 2) اجعل z-index للشريط الجانبي أعلى من z-index للهيدر/اللوغو */
#sidebar,
.sidebar {
  z-index: 1600 !important; /* اجعله أعلى من قيم الهيدر (مثلاً 1200,1250,1300) */
}

/* 3) إذا كان الـ sidebar يحتاج أن يكون ثابتًا فوق الصفحة (كما في أغلب التصاميم) */
/* إلغاء التعليق إذا كان الـ sidebar بالأصل position: fixed; */
/*
#sidebar {
  position: fixed !important;
  top: 0;
  left: 0;
  height: 100%;
  /* width حسب تصميمك */
  z-index: 1600 !important;
}
*/

/* 4) لو لاحظت أن اللوغو أو زر البحث ما يزالان يظهران فوق الشريط (نادراً) */
/* نزّل z-index لهم فقط في حالة تفعيل الشريط الجانبي */
#topHeader.sidebar-open,
#topHeader.search-active.sidebar-open {
  z-index: 1100 !important;
}
#topHeader.sidebar-open #siteLogo,
#topHeader.sidebar-open .logo {
  z-index: 1105 !important;
}

/* ===== VIP badge (60px, left of logo, glowing) ===== */
#vipBadge {
  position: absolute;
  left: calc(50% - 120px); /* سيضع الشعار على يسار اللوغو؛ عدّل القيمة لو احتجت */
  top: 50%;
  transform: translateY(-50%);
  width: 20px;
  height: 20px;
  background-image: url('https://i.postimg.cc/SQzj8bjd/20251201-232317.png');
  background-size: cover;
  background-position: center;
  border-radius: 10px;
  display: none; /* يظهر فقط عند وجود VIP */
  z-index: 1400;
  /* توهج ذهبي */
  box-shadow: 0 0 10px rgba(255,203,1,0.8), 0 0 28px rgba(255,203,1,0.18);
  /* حركة صغيرة لشد الانتباه */
  animation: vipPulse 2s ease-in-out infinite;
}

/* نبضة/توهج */
@keyframes vipPulse {
  0%   { transform: translateY(-50%) scale(0.98); box-shadow: 0 0 8px rgba(255,203,1,0.6); }
  50%  { transform: translateY(-50%) scale(1.03); box-shadow: 0 0 22px rgba(255,203,1,1); }
  100% { transform: translateY(-50%) scale(0.98); box-shadow: 0 0 8px rgba(255,203,1,0.6); }
}
#topHeader.search-active #vipBadge { display: none !important; }
/* =========================
   UI PRO KIT — CSS (اضف هذا آخر CSS)
   لا يغير مواضع العناصر، فقط تحسينات جمالية وتفاعلية
   ========================= */

/* متغيّرات الثيم الأساسية */
:root{
  --main-color: #A80003;        /* لون افتراضي */
  --accent-color: color-mix(in srgb, var(--main-color) 72%, #ffffff 18%);
  --accent-contrast: #111;
  --bg-layer-1: rgba(10,10,12,0.36);
  --bg-layer-2: rgba(255,255,255,0.02);
  --glass-blur: 10px;
  --glass-saturate: 120%;
  --card-radius: 14px;
  --soft-shadow: 0 8px 30px rgba(2,6,23,0.56);
  --soft-shadow-2: 0 4px 14px rgba(0,0,0,0.36);
  --glow-strength: 0.20;
  --ui-anim-fast: 140ms;
  --ui-anim-mid: 260ms;
  --ui-anim-ease: cubic-bezier(.2,.9,.2,1);
  --elev-1: 0 6px 20px rgba(2,6,23,0.48);
  --elev-2: 0 12px 48px rgba(2,6,23,0.56);
  --text-muted: rgba(255,255,255,0.78);
  --glass-border: rgba(255,255,255,0.04);
}

/* =========================
   خلفية متدرجة متحركة وطبقة تغشية (لا تلمس DOM)
   ========================= */
body::before{
  content:'';
  position:fixed;
  inset:0;
  z-index: -9999;
  background:
    radial-gradient(600px 400px at 10% 20%, color-mix(in srgb, var(--main-color) 25%, #3b3bff 0% ) 0%, transparent 25%),
    radial-gradient(500px 300px at 90% 80%, color-mix(in srgb, #00b4ff 30%, var(--main-color) 0%) 0%, transparent 25%),
    linear-gradient(180deg, rgba(0,0,0,0.18), rgba(0,0,0,0.36));
  background-size: 120% 120%, 110% 110%, cover;
  filter: saturate(120%);
  transform: scale(1.02);
  transition: transform 1200ms var(--ui-anim-ease);
  will-change: transform, filter;
  pointer-events: none;
}

/* subtle movement for background (disabled on reduced-motion) */
@media (prefers-reduced-motion: no-preference){
  body::before {
    animation: bgFloat 18s linear infinite;
  }
  @keyframes bgFloat {
    0% { transform: translateY(0) scale(1.02); filter: saturate(110%); }
    50% { transform: translateY(-18px) scale(1.03); filter: saturate(128%); }
    100% { transform: translateY(0) scale(1.02); filter: saturate(110%); }
  }
}

/* طبقة تغشية زجاجية عالية الجودة فوق المحتوى */
body::after{
  content:'';
  position:fixed;
  inset:0;
  z-index: -9998;
  background: linear-gradient(180deg, rgba(10,10,12,0.28), rgba(10,10,12,0.52));
  backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturate));
  -webkit-backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturate));
  pointer-events:none;
}

/* =========================
   قواعد عامة للعناصر التفاعلية
   ========================= */
* { box-sizing: border-box; }
button, .btn, .small-btn, .nav-btn, .back-btn, .link-like {
  -webkit-tap-highlight-color: transparent;
  transition: transform var(--ui-anim-fast) var(--ui-anim-ease), box-shadow var(--ui-anim-mid) ease, background .18s ease, color .12s ease;
  will-change: transform, box-shadow;
  touch-action: manipulation;
}

/* مظهر عام للأزرار — غير متطفل على مواضع */
button, .btn, .small-btn {
  background: linear-gradient(90deg, var(--main-color), var(--accent-color));
  color: var(--accent-contrast);
  border: none;
  border-radius: 10px;
  padding: 10px 12px;
  font-weight: 800;
  letter-spacing: .2px;
  box-shadow: var(--soft-shadow);
  display: inline-flex;
  align-items: center;
  gap: .6rem;
}

/* fallback لو هناك أزرار بيضاء أو شفافة — نحافظ على الشكل */
.button-ghost, .small-link, .button-option {
  background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  border: 1px solid var(--glass-border);
  color: var(--text-muted);
  padding: 8px 10px;
  border-radius: 9px;
}

/* Focus ring للأكسيسّبيليتي */
button:focus, .small-link:focus, .nav-btn:focus {
  outline: none;
  box-shadow: 0 10px 36px color-mix(in srgb, var(--main-color) 30%, transparent 70%), 0 0 0 6px rgba(255,203,1,0.06);
}

/* Active feedback: ضغط وانهاء */
button:active, .small-btn:active, .nav-btn:active {
  transform: translateY(2px) scale(.992);
  filter: brightness(.98);
}

/* ==== التأثير اللامع (Glow) والذي يفعّله السكربت عبر إضافة صنف .ui-glow ==== */
.ui-glow {
  box-shadow:
    0 18px 60px color-mix(in srgb, var(--main-color) var(--glow-strength), rgba(0,0,0,0.4)),
    0 6px 18px rgba(0,0,0,0.46);
  transform: translateY(-3px) scale(1.006);
}

/* ripple element الذي ينشئه JS */
.ui-ripple {
  position: absolute;
  border-radius: 50%;
  transform: scale(0);
  opacity: .5;
  pointer-events: none;
  z-index: 6;
  will-change: transform, opacity;
}

/* =========================
   بطاقات، نماذج، مربعات — نظرة مصقولة
   ========================= */
.card, .form-box, .section-tile, .profile-box, .notif-panel {
  
  border: 1px solid var(--glass-border);
  border-radius: var(--card-radius);
  padding: 14px;
  
  color: #fff;
  overflow: hidden;
}

/* عنوان البطاقات */
.card .title, .section-tile .title {
  font-weight: 800;
  letter-spacing: .2px;
  color: #fff;
  margin-bottom: 8px;
}

/* خطوط صغيرة/مطبقة */
.muted, .muted-small {
  color: rgba(255,255,255,0.72);
  font-size: 13px;
}

/* تفاصيل رشيقة داخل البطاقات */
.card .meta {
  display:flex;
  gap:8px;
  align-items:center;
  color: rgba(255,255,255,0.64);
  font-size: 13px;
}

/* ايقونات داخل الnav أو الcard */
.icon {
  display:inline-flex;
  align-items:center;
  justify-content:center;
  width:34px;
  height:34px;
  border-radius:8px;
  background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
  box-shadow: 0 6px 18px rgba(0,0,0,0.38) inset;
}

/* badges */
.badge {
  background: linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  border-radius: 999px;
  padding: 6px 8px;
  font-weight:700;
  font-size:12px;
  box-shadow: 0 6px 18px rgba(0,0,0,0.45);
}

/* =========================
   Tooltip بسيط ومرن — يظهر عند إضافة data-tooltip
   ========================= */
[data-tooltip] {
  position: relative;
}
[data-tooltip]:hover::after,
[data-tooltip]:focus::after {
  content: attr(data-tooltip);
  position: absolute;
  white-space: nowrap;
  left: 50%;
  transform: translateX(-50%) translateY(-8px);
  bottom: calc(100% + 8px);
  background: rgba(10,10,12,0.9);
  color: #fff;
  padding: 6px 8px;
  border-radius: 8px;
  font-size: 12px;
  box-shadow: 0 10px 36px rgba(0,0,0,0.5);
  z-index: 9999;
  opacity: 1;
  transition: opacity .18s ease, transform .18s ease;
  pointer-events: none;
}

/* =========================
   Floating Action Button (non-intrusive) — ضع العنصر (#fab) إن رغبت
   ========================= */
#fab {
  position: fixed;
  right: 18px;
  bottom: 18px;
  z-index: 99999;
  width: 62px;
  height: 62px;
  border-radius: 14px;
  display: inline-grid;
  place-items: center;
  box-shadow: var(--elev-2);
  cursor: pointer;
  transition: transform .18s var(--ui-anim-ease), box-shadow .22s ease;
  background: linear-gradient(180deg, var(--main-color), var(--accent-color));
  color: var(--accent-contrast);
  border: none;
}

/* =========================
   Toasts / small notifications (lightweight)
   ========================= */
#ui-toaster {
  position: fixed;
  left: 50%;
  bottom: 34px;
  transform: translateX(-50%) translateY(24px);
  z-index: 999999;
  display: grid;
  gap: 8px;
  pointer-events: none;
}
.toast {
  pointer-events: auto;
  min-width: 180px;
  max-width: 440px;
  background: linear-gradient(180deg, rgba(0,0,0,0.64), rgba(0,0,0,0.42));
  color: #fff;
  padding: 10px 14px;
  border-radius: 12px;
  box-shadow: 0 10px 36px rgba(0,0,0,0.6);
  transform-origin: bottom center;
  opacity: 0;
  transform: translateY(12px) scale(.98);
  transition: transform var(--ui-anim-mid) var(--ui-anim-ease), opacity .18s ease;
}
.toast.show {
  opacity: 1;
  transform: translateY(0) scale(1);
}

/* =========================
   small helper classes
   ========================= */
.u-center { display:flex; align-items:center; justify-content:center; }
.u-between { display:flex; align-items:center; justify-content:space-between; }
.hidden { display:none !important; }
.lite { opacity:.9; }

/* =========================
   responsive tweaks (non-intrusive)
   ========================= */
@media (max-width: 520px){
  :root { --card-radius: 10px; --glass-blur: 8px; }
  #fab { right: 12px; bottom: 12px; width:56px; height:56px; }
  .icon { width:30px; height:30px; border-radius:9px; }
}

/* =========================
   accessibility: reduce animations if user asked
   ========================= */
@media (prefers-reduced-motion: reduce){
  * { animation: none !important; transition: none !important; }
  body::before, body::after { animation: none !important; }
}

/* ======= UI Tweaks: أسرع أنيميشن + إشعارات داكنة + أقسام شبه شفاف + ألعاب/تطبيقات داكنة ======= */

/* 1) تسريعات عامة لأنيميشن الضغطة */
:root{
  --ui-anim-fast: 70ms;   /* أسرع */
  --ui-anim-mid: 150ms;
  --glow-duration: 320ms; /* مدة توهج أقصر */
  --ripple-duration: 320ms; /* مدة الـ ripple أقصر */
}

/* override للـ transitions العامة (تتغلب على تعريفات سابقة لأنها مضافة لاحقاً) */
button, .btn, .small-btn, .nav-btn, .back-btn, .card, .section-tile, .small-link {
  transition: transform var(--ui-anim-fast) cubic-bezier(.2,.9,.2,1),
              
              color .09s linear !important;
}

/* active feedback أسرع */
button:active, .small-btn:active, .nav-btn:active, .card:active {
  transform: translateY(1px) scale(.996);
  transition-duration: var(--ui-anim-fast);
}



/* تسريع الـ ripple عبر css override */
.ui-ripple {
  transition: transform var(--ripple-duration) cubic-bezier(.2,.9,.2,1),
              opacity calc(var(--ripple-duration) - 60ms) linear !important;
}

/* تسريع واعطاء إحساس فوري للتوهّج */
.ui-glow {
  transition: box-shadow var(--ui-anim-fast) ease, transform var(--ui-anim-fast) ease !important;
  /* ستُفعّل/تُزال عبر الـ JS */
}

/* 2) إشعارات داكنة متدرجة (ليست شفافة) */
/* استهداف صنفين شائعين: .notif-panel و #notifPanel و toasts */
.notif-panel,
#notifPanel,
.panel-notif,
#notifications,
#ui-toaster .toast {
  background: linear-gradient(180deg, #05060a 0%, #0d0f12 48%, #111214 100%) !important;
  border: 1px solid rgba(255,255,255,0.03) !important;
  color: #f5f6f7 !important;
  box-shadow: 0 18px 60px rgba(0,0,0,0.7) !important;
  backdrop-filter: none !important; /* لا شفافية */ 
  -webkit-backdrop-filter: none !important;
}

/* تفاصيل نصية داخل الإشعارات */
.notif-panel .title, #ui-toaster .toast .title {
  color: #fff;
  font-weight: 800;
}

/* زر إغلاق الاشعار واضح */
.notif-panel .close, .notif-panel .dismiss {
  color: rgba(255,255,255,0.9);
  opacity: .95;
}

/* 3) الأقسام: شبه شفاف متدرّج */
/* استهداف .section-tile و .sections-grid > .section-tile وغيرها */


/* إضافات بصرية للعناوين داخل الأقسام */
.section-tile .title, .section-card .title {
  color: #fff;
  text-shadow: 0 6px 18px rgba(0,0,0,0.6);
}

/* 4) بطاقات "الألعاب / التطبيقات" — dark gradient look */
/* نغطي أسماء شائعة: .game-tile, .game-card, .app-tile, .app-card, .create-game */
.game-tile, .game-card, .app-tile, .app-card, .create-game {
  background: linear-gradient(180deg, rgba(4,4,6,0.92) 0%, rgba(12,12,16,0.96) 60%, rgba(18,18,20,1) 100%);
  border: 1px solid rgba(255,255,255,0.035);
  border-left: 3px solid rgba(255,203,1,0.06); /* لمسة ثيم */
  padding: 14px;
  border-radius: 12px;
  box-shadow: 0 20px 70px rgba(0,0,0,0.75), inset 0 1px 0 rgba(255,255,255,0.02);
  color: #fff;
  overflow: hidden;
  position: relative;
}

/* تأثير غطاء لوني لطيف متدرج على البطاقة */
.game-tile::before, .app-tile::before, .game-card::before, .app-card::before {
  content: '';
  position: absolute;
  inset: 0;
  pointer-events: none;
  background: linear-gradient(120deg, rgba(255,203,1,0.03) 0%, transparent 25%, rgba(0,0,0,0.18) 70%);
  mix-blend-mode: overlay;
}

/* أيقونة اللعبة */
.game-tile .icon, .app-tile .icon {
  border-radius: 10px;
  background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  box-shadow: 0 6px 18px rgba(0,0,0,0.6) inset;
}

/* زر إنشاء لعبة / تطبيق */
.create-game, .create-app, #createGameBtn {
  background: linear-gradient(90deg, rgba(255,203,1,0.98), rgba(255,165,0,0.95));
  color: #111;
  font-weight: 900;
  border-radius: 12px;
  padding: 10px 14px;
  box-shadow: 0 10px 40px rgba(255,165,0,0.06), 0 8px 28px rgba(0,0,0,0.6);
}

/* 5) لمسات نهائية: نجعل التوهّج أسرع بصرياً */
.ui-glow {
  box-shadow:
    0 22px 64px rgba(255,203,1,0.14),
    0 8px 26px rgba(0,0,0,0.6);
  transform: translateY(-2px) scale(1.004);
}

/* 6) متطلبات توافقيّة: لو لم توجد الأصناف السابقة يطبق على الأنماط الشائعة */
#notifications, .alerts-list, .notify-pane { 
  background: linear-gradient(180deg,#060607,#0e0f12) !important;
  box-shadow: 0 18px 70px rgba(0,0,0,0.7) !important;
}

/* اختصار: إن أردت أقوى dark mode على هذه العناصر */
.darkify-notifs {
  background: linear-gradient(180deg, #040405 0%, #0b0b0d 100%) !important;
  border-color: rgba(255,255,255,0.02) !important;
  color: #fff !important;
}
/* ✅ توسيط جميع النصوص والعناصر افقيًا افتراضيًا */
body,
body * {
  text-align: center !important;
}

#balanceBox::after {
  content: "ل.س";
  left: 1px;
  font-size: 9px;
  font-weight: 500;
  top: 60px;
  color: #3FFF11;
  margin-bottom: 2px;
}

button,
input,
select,
textarea {
  text-align: center !important;
  justify-content: center !important;
  align-items: center !important;
  display: flex !important;
}

/* ❌ استثناء أزرار قسم الملخص (الإعدادات، المساعدة، الهدايا...) */
.profile-actions .small-link {
  text-align: right !important;
  justify-content: flex-end !important;
  display: flex !important;
  flex-direction: row-reverse !important;
  gap: 25px !important;
}

/* ❌ استثناء أزرار داخل صفحة الإعدادات */
#settingsPage .small-link,
#settingsPage button,
#settingsPage .back-btn {
  text-align: right !important;
  justify-content: flex-end !important;
  display: flex !important;
  flex-direction: row-reverse !important;
  gap: 25px !important;
}
<style>
#paymentDetailsPage #pdMethodsGrid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 12px;
}

#paymentDetailsPage .pd-method-tile {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  aspect-ratio: 1 / 1;
  text-align: center;
  border: 2px solid transparent;
  border-radius: 10px;
  padding: 10px;
}

#paymentDetailsPage .pd-method-tile img {
  width: 70%;
  height: auto;
  object-fit: cover;
  margin-bottom: 8px;
}

#paymentDetailsPage .pd-method-tile div {
  font-weight: bold;
  color: var(--main-color);
}

#paymentDetailsPage .pd-method-tilei {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  aspect-ratio: 1 / 1;
  text-align: center;
  border: 2px solid transparent;
  border-radius: 10px;
  padding: 10px;
}

#paymentDetailsPage .pd-method-tilei img {
  width: 70%;
  height: auto;
  object-fit: cover;
  margin-bottom: 8px;
}

#paymentDetailsPage .pd-method-tilei div {
  font-weight: bold;
  color: var(--main-color);
}


#paymentDetailsPage .pd-method-tilee {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  aspect-ratio: 1 / 1;
  text-align: center;
  border: 2px solid transparent;
  border-radius: 10px;
  padding: 10px;
}

#paymentDetailsPage .pd-method-tilee img {
  width: 70%;
  height: auto;
  object-fit: cover;
  margin-bottom: 8px;
}

#paymentDetailsPage .pd-method-tilee div {
  font-weight: bold;
  color: var(--main-color);
}


/*#balanceBox::before {
 content: "+";
 left: 50px;
  font-size: 15px;
 font-weight: 500;
  top: 35px;
 color: #3FFF11;
 margin-bottom: 2px;
}
  */
  #balanceBox::before {
  content: "✙";
  left: 1px;
  font-size: 9px;
  font-weight: 500;
  top: 60px;
  color: #3FFF11;
  margin-bottom: 2px;
}
body, 
body * {
  font-family: 'Cairo', sans-serif !important;
}


/* ===== تغييرات: خانة المفضلة بالصفحة الرئيسية — تحويل العنصر لقالب مربع بالصورة فوق والاسم تحت ===== */
/* نعيد تعريف .fav-preview ليصبح Tile مربع */


/* الصورة تصبح مربعة وتملأ عرض التايل */


/* اسم العنصر تحت الصورة */

/* اجعل الشبكة تحتفظ بأعمدة مناسبة */
/* ===== تنسيق تايل المفضلة ===== */

#favoritesGrid .fav-preview {
  display: flex !important;
  flex-direction: column !important;
  align-items: center !important;
  justify-content: flex-start !important;
  gap: 8px;
  padding: 10px;
  border-radius: 12px;
  background: none;
  box-sizing: border-box;
  text-align: center;
}

/* غلاف للصورة يحافظ على نسبة مربعة */

#favoritesGrid > * {
    aspect-ratio: 1/1; /* مربع تمامًا */
    overflow: hidden;
}

#favoritesGrid img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

/* الاسم تحت الصورة */
#favoritesGrid .fav-preview .fav-name,
#favoritesGrid .fav-preview .name {
  margin-top: 6px;
  font-weight: 800;
  color: var(--main-color);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  width: 100%;
  text-align: center;
}

/* الشبكة */
#favoritesGrid {
  display: grid;
  gap: 8px;
  grid-template-columns: repeat(3, 1fr);
}

@media (max-width:520px) {
  #favoritesGrid {
    grid-template-columns: repeat(3, 1fr) !important;
  }
}

/* اضف/استبدل هذه القواعد داخل الـ <style> الرئيسية */
#sectionPage .subgrid { /* ممكن تبقى كما هي */ }
#sectionPage .subcard {
  display: flex;
  flex-direction: column;
  gap: 8px;
  align-items: flex-start; /* اجعل العناصر تبدأ من اليسار، هكذا الصورة ستكون أقرب لليسار */
  padding: 10px;
  min-height: 140px;
  cursor: pointer;
}
#sectionPage .subcard img {
  width: 100%; /* حافظت على الحجم المستخدم */
  height: 100%;
  object-fit: cover;
  border-radius: 8px;
  display: block;
  margin-left: 0; /* تأكد الصورة في أقصى اليسار داخل البطاقة */
}


</style>

<!-- ADDED: center section images and overlay favorite/star button -->
<style>
/* Center images inside section tiles and subcards, place fav-star over image (top-right) */
#sectionPage .sec-tile,
#sectionPage .subcard {
  display: flex !important;
  flex-direction: column !important;
  align-items: center !important;
  justify-content: center !important;
  position: relative !important;
  padding: 10px !important;
  text-align: center !important;
  overflow: hidden;
}

/* make image centered, behind the star (lower z-index) */
#sectionPage .sec-tile img,
#sectionPage .subcard img {
  width: 80% !important;
  max-width: 140px !important;
  height: auto !important;
  object-fit: cover !important;
  border-radius: 10px !important;
  display: block !important;
  margin: 0 auto !important;
  z-index: 1 !important;
}

/* favorite/star button should be on top-right over the image */
#sectionPage .sec-tile .fav-btn,
#sectionPage .subcard .fav-btn {
  position: absolute !important;
  top: 8px !important;
  right: 8px !important;
  left: auto !important;
  z-index: 30 !important;
  width: 36px !important;
  height: 36px !important;
  display: inline-flex !important;
  align-items: center !important;
  justify-content: center !important;
  border-radius: 8px !important;
  background: rgba(255,255,255,0.06) !important;
  color: var(--main-color) !important;
  font-weight: 900 !important;
  border: none !important;
  box-shadow: 0 6px 18px rgba(0,0,0,0.35) inset;
}

/* ensure name/info is centered under the image */
#sectionPage .sec-tile .info,
#sectionPage .sec-tile .info .name,
#sectionPage .subcard > .name,
#sectionPage .subcard .info,
#sectionPage .subcard div {
  width: 100% !important;
  text-align: center !important;
  margin-top: 8px !important;
  padding: 0 6px !important;
  font-weight: 800 !important;
}

/* override older rules that placed fav-btn on the left */
.sec-tile .fav-btn, .subcard .fav-btn { left: auto !important; }

/* responsive tweak: slightly smaller image on very small screens */
@media (max-width:520px){
  #sectionPage .sec-tile img,
  #sectionPage .subcard img {
    max-width: 120px !important;
    width: 70% !important;
  }
}


/* النجمة قبل الضغط: بيضاء بدون خلفية */
#sectionPage .fav-btn,
#sectionPage .subcard .fav-btn,
#sectionPage .sec-tile .fav-btn {
    background: none !important;
    color: #ffffff !important;    /* أبيض */
    border: none !important;
    padding: 0 !important;
    width: auto !important;
    height: auto !important;
    min-width: 28px;
    min-height: 28px;
    font-size: 22px !important;
    display: inline-flex !important;
    align-items: center;
    justify-content: center;
    box-shadow: none !important;
    text-shadow: 0 1px 2px rgba(0,0,0,0.5); /* يعطي وضوح فقط */
}

/* النجمة بعد الضغط: حمراء بدون خلفية */
#sectionPage .fav-btn.active,
#sectionPage .subcard .fav-btn.active,
#sectionPage .sec-tile .fav-btn.active {
    color: #ff2b2b !important;     /* أحمر */
    background: none !important;
    text-shadow: 0 0 6px rgba(255,0,0,0.5); /* لمعان خفيف (اختياري) */
}

/* إزالة الخلفية السوداء من صفحات الأقسام والشحن */
#sectionsPage,
#sectionPage,
#chargePage,
#buyPage,
#balancePage {
    background: transparent !important;
}

/* إضافة خلفية الصورة مع البلور */
#sectionsPage::before,
#sectionPage::before,
#chargePage::before,
#buyPage::before,
#balancePage::before {
    content: "";
    position: absolute;
    inset: 0;
    z-index: -1;
    background: url("https://i.postimg.cc/KcpW1cv3/20251203-165618.jpg") center/cover no-repeat;
    filter: blur(3px) brightness(0.4);
}

/* إزالة الخلفيات السوداء من البطاقات */
#sectionsPage .sec-tile,
#sectionPage .subcard,
#chargePage .card,
#buyPage .card,
#balancePage .card {
    background: rgba(0,0,0,0.25) !important;
    border: 1px solid rgba(255,255,255,0.08) !important;
    backdrop-filter: blur(8px) !important;
}

/* إزالة الخلفية السوداء من النموذج form-box */
.form-box {
    background: rgba(0,0,0,0.25) !important;
    border: 1px solid rgba(255,255,255,0.1) !important;
    backdrop-filter: blur(8px) !important;
}

/* جعل كل الصفحات تسمح للوراء بالظهور */
#sectionsPage, #sectionPage,
#chargePage, #buyPage, #balancePage {
    position: relative !important;
    overflow: hidden !important;
}

/* بطاقات الأقسام */
#sectionsPage .sec-tile,
#sectionPage .subcard,
#chargePage .card,
#buyPage .card,
#balancePage .card {
  background: rgba(0,0,0,0.25) !important;  /* شفافية مثل الصفحة الرئيسية */
  backdrop-filter: blur(6px);
  border: 1px solid rgba(255,255,255,0.08) !important;
}

</style>


</head>
<body>
  <header id="topHeader">
    <img src="https://i.postimg.cc/13h4mCKC/20251201-225354.png" alt="Logo" id="siteLogo">
    <div id="personalNumberDisplay">رقمك الشخصي: <span id="personalNum">0000000</span></div>

    <div id="balanceBox" class="hidden">0</div>
    <!-- استبدال جزء الإشعارات في الهيدر -->
    <div id="notifBell" title="الإشعارات">
<svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="currentColor" class="bi bi-bell-fill" viewBox="0 0 16 16">
  <path d="M8 16a2 2 0 0 0 2-2H6a2 2 0 0 0 2 2m.995-14.901a1 1 0 1 0-1.99 0A5 5 0 0 0 3 6c0 1.098-.5 6-2 7h14c-1.5-1-2-5.902-2-7 0-2.42-1.72-4.44-4.005-4.901"/>
</svg>
  <span id="notifBadge" class="badge hidden">0</span></div>

    <div class="menu" id="menuBtn">☰</div>
    <div id="ordersStatusBar" aria-live="polite" role="status" style="display:none"></div>
  </header>

  <div id="rotBannerWrap">
    <div class="rotBanner" id="rotBanner">
      <img class="banner-img" src="https://i.postimg.cc/GmWLZB7q/1764836108431.png" alt="banner 1">
      <img class="banner-img" src="https://i.postimg.cc/rwtnK7fx/20251204-094306.jpg" alt="banner 2">
      <img class="banner-img" src="https://i.postimg.cc/tRx5j84D/20251204-095123.jpg" alt="banner 3">
            <img class="banner-img" src="https://i.postimg.cc/hj9fC8KL/20251204-095402.jpg" alt="banner 4">
    </div>
    <div class="banner-ticker">
      <div class="ticker-track" id="tickerTrack">   vipro شكرا لاختيارك   
      
      ، لأصحاب المحلات والمتاجر خصومات عالية مع استرجاع نسبة من الرصيد بعد الشحن 
      تواصلوا واتساب للتفاصيل 
      </div>
    </div>
  </div>

  <!-- notif panel -->
  <div id="notifPanel" class="notif-panel hidden" aria-live="polite">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
      <h4 style="color: var(--main-color);margin:0">الإشعارات</h4>
      <div style="cursor:pointer;color: var(--main-color);" id="notifCloseBtn">×</div>
    </div>
    <div id="notifList"></div>
    <div style="display:flex;gap:8px;margin-top:8px;">
      <div class="small-btn" id="notifClearBtn">مسح الكل</div>
    </div>
  </div>

  <!-- sidebar -->
  <div id="sidebar" class="sidebar">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
      <div style="display:flex;gap:10px;align-items:center;cursor:pointer" id="sidebarProfileArea">
        <div class="avatar" id="sidebarAvatar">أ</div>
        <div>
          <div id="sidebarName" style="color: var(--main-color);font-weight:700">ضيف</div>
          <div id="sidebarPersonal" style="color:#ccc;font-size:13px">--</div>
        </div>
      </div>
      <div style="cursor:pointer;color: var(--main-color);" id="sidebarCloseBtn">×</div>
    </div>

    <a href="#" id="linkHome">الرئيسية</a>
    <a href="#" id="linkOrders">الطلبات</a>
    <a href="#" id="linkJoinWhats">الانضمام لمجتمع واتساب</a>
        <a href="#" id="linkpya">  بياناتك الشخصية</a>
            <a href="#" id="summaryJoinBt1">  وكلائنا</a>
    
    <div style="margin-top:16px;">
      <div class="small-btn" id="btnCharge">شحن الرصيد</div>
      
    </div>
  </div>

  <!-- pages -->
  <main id="mainContent">

<!-- profile summary page -->
<div id="profileSummaryPage" class="hidden">
  <!-- بلوك البروفايل -->
  <div class="profile-summary">
<!-- Share button (top-left inside profile-summary) -->

<div id="loginNumberBadge" class="login-number-badge" title="اضغط لنسخ رقم الدخول">
  #<span id="loginNum">—</span>
  <small>رقم الدخول</small>
</div>
    <div class="avatar" id="summaryAvatar">أ</div>
    <div class="name" id="summaryName" title="عرض وتعديل الملف">ضيف</div>
    <div class="personal" id="summaryPersonal" title="عرض وتعديل الملف">رقم: --</div>
  </div>

  <!-- الأزرار خارج البلوك (الآن رأسياً)-->
  <div class="profile-actions">
    <button class="small-link" id="summarySettingsBtn">الإعدادات ️
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-gear-fill" viewBox="0 0 16 16">
  <path d="M9.405 1.05c-.413-1.4-2.397-1.4-2.81 0l-.1.34a1.464 1.464 0 0 1-2.105.872l-.31-.17c-1.283-.698-2.686.705-1.987 1.987l.169.311c.446.82.023 1.841-.872 2.105l-.34.1c-1.4.413-1.4 2.397 0 2.81l.34.1a1.464 1.464 0 0 1 .872 2.105l-.17.31c-.698 1.283.705 2.686 1.987 1.987l.311-.169a1.464 1.464 0 0 1 2.105.872l.1.34c.413 1.4 2.397 1.4 2.81 0l.1-.34a1.464 1.464 0 0 1 2.105-.872l.31.17c1.283.698 2.686-.705 1.987-1.987l-.169-.311a1.464 1.464 0 0 1 .872-2.105l.34-.1c1.4-.413 1.4-2.397 0-2.81l-.34-.1a1.464 1.464 0 0 1-.872-2.105l.17-.31c.698-1.283-.705-2.686-1.987-1.987l-.311.169a1.464 1.464 0 0 1-2.105-.872zM8 10.93a2.929 2.929 0 1 1 0-5.86 2.929 2.929 0 0 1 0 5.858z"/>
</svg>
    </button> 
    <button class="small-link" id="summaryHelpBtn">المساعدة في حل مشكلة
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-envelope-exclamation-fill" viewBox="0 0 16 16">
  <path d="M.05 3.555A2 2 0 0 1 2 2h12a2 2 0 0 1 1.95 1.555L8 8.414zM0 4.697v7.104l5.803-3.558zM6.761 8.83l-6.57 4.026A2 2 0 0 0 2 14h6.256A4.5 4.5 0 0 1 8 12.5a4.49 4.49 0 0 1 1.606-3.446l-.367-.225L8 9.586zM16 4.697v4.974A4.5 4.5 0 0 0 12.5 8a4.5 4.5 0 0 0-1.965.45l-.338-.207z"/>
  <path d="M12.5 16a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7m.5-5v1.5a.5.5 0 0 1-1 0V11a.5.5 0 0 1 1 0m0 3a.5.5 0 1 1-1 0 .5.5 0 0 1 1 0"/>
</svg>
    </button>
    <button class="small-link" id="summaryJoinBtn">انضمام الى مجتمع واتساب
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-whatsapp" viewBox="0 0 16 16">
  <path d="M13.601 2.326A7.85 7.85 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.9 7.9 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.9 7.9 0 0 0 13.6 2.326zM7.994 14.521a6.6 6.6 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.56 6.56 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592m3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.099-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.73.73 0 0 0-.529.247c-.182.198-.691.677-.691 1.654s.71 1.916.81 2.049c.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-.943.164-.464.164-.86.114-.943-.049-.084-.182-.133-.38-.232"/>
</svg>
    </button>
    <button class="small-link" id="summaryBenatakBtn"> بياناتك الشخصية
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-bar-chart-fill" viewBox="0 0 16 16">
  <path d="M1 11a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1zm5-4a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v7a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1zm5-5a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1z"/>
</svg>
    </button> <!-- زر بيناتك جديد -->

    <button class="small-link" id="coodeBtn"> بياناتك الشخصية
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-bar-chart-fill" viewBox="0 0 16 16">
  <path d="M1 11a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1zm5-4a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v7a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1zm5-5a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1z"/>
</svg>
    </button> <!-- زر بيناتك جديد -->


<!-- اضف هذا داخل <div class="profile-actions">, بعد زر بياناتك الشخصية -->
<!--<button class="small-link" id="summaryGiftBtn"> رمز الهدايا
  <!-- أيقونة الهدية التي أعطيتني -->
<!--  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-gift-fill" viewBox="0 0 16 16">
<    <path d="M3 2.5a2.5 2.5 0 0 1 5 0 2.5 2.5 0 0 1 5 0v.006c0 .07 0 .27-.038.494H15a1 1 0 0 1 1 1v1a1 1 0 0 1-1 1H1a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h2.038A3 3 0 0 1 3 2.506zm1.068.5H7v-.5a1.5 1.5 0 1 0-3 0c0 .085.002.274.045.43zM9 3h2.932l.023-.07c.043-.156.045-.345.045-.43a1.5 1.5 0 0 0-3 0zm6 4v7.5a1.5 1.5 0 0 1-1.5 1.5H9V7zM2.5 16A1.5 1.5 0 0 1 1 14.5V7h6v9z"/>
  </svg>
</button> -->



    <a   class="s" id="lin">إصدار v.1.9 </a>



  </div>
</div>

    <!-- benatak page -->
    <div id="benatakPage" class="hidden">
      <div class="form-box">
        <h3 style="text-align:center;color: var(--main-color);">البيانات</h3>
        <div class="benatak-grid" aria-live="polite">
          <div class="benatak-tile" id="tileTotalTopups">
            <div class="title">مجموع رصيدك (كل الشحنات)</div>
            <div class="value" id="totalTopupsValue">0 ل.س</div>
            <div class="muted-small" style="margin-top:8px;color:#aaa">هذا مجموع كل المبالغ التي شحنتها منذ إنشاء الحساب.</div>
          </div>

          <div class="benatak-tile" id="tileAccepted">
            <div class="title">طلباتك المقبولة</div>
            <div class="value" id="acceptedCount">0</div>
          </div>

          <div class="benatak-tile" id="tileRejected">
            <div class="title">طلباتك المرفوضة</div>
            <div class="value" id="rejectedCount">0</div>
          </div>

          <div class="benatak-tile" id="tilePending">
            <div class="title">قيد المراجعة</div>
            <div class="value" id="pendingCount">0</div>
          </div>

          <div class="benatak-tile" id="tileProfileEdits">
            <div class="title">عدد طلبات تعديل معلومات البروفايل</div>
            <div class="value" id="profileEditRequestsCount">0</div>
          </div>
        </div>

        <div class="back-btn" id="benatakBackBtn">⬅ رجوع</div>
      </div>
    </div>

<!-- login page (new minimal clean version) -->
<div id="loginPage" class="form-box login-page hidden">

  <h3 style="text-align:center;color: var(--main-color);margin-bottom:15px;">تسجيل الدخول</h3>

  <label>الاسم</label>
  <input type="text" id="loginName" placeholder="أدخل اسمك">

  <label>البريد الإلكتروني</label>
  <input type="email" id="loginEmail" placeholder="example@domain.com">

  <label>كلمة السر</label>
  <div style="position:relative;">
    <input type="password" id="loginPassword" placeholder="كلمة السر">
    <button id="loginTogglePwd" style="position:absolute;left:6px;top:10px;height:36px;width:80px;cursor:pointer;">اظهار</button>
  </div>

  <!-- رقم الهاتف غير مطلوب للتطابق لكنه يرسل مع الطلب -->
  <label>رقم الهاتف</label>
  <input type="text" id="loginPhone" placeholder="مثال: 0999xxxxxx">

  <div style="text-align:center;margin-top:12px;">
    <button id="doLoginBtn">تسجيل الدخول</button>
  </div>

  <div style="text-align:center;margin-top:12px;">
    <span id="openSignupNew" style="color:red;cursor:pointer;font-weight:bold">
      ليس لديك حساب؟ إنشاء حساب
    </span>
  </div>

  <div id="loginError" class="error" style="display:none;margin-top:10px;text-align:center;"></div>

</div>
<!-- signup page NEW -->
<div id="signupPage" class="form-box login-page hidden">

  <h3 style="text-align:center;color: var(--main-color);margin-bottom:15px;">إنشاء حساب</h3>

  <label>الاسم</label>
  <input type="text" id="suName" placeholder="اسمك الكامل">

  <label>البريد الإلكتروني</label>
  <input type="email" id="suEmail" placeholder="example@domain.com">

  <label>كلمة السر</label>
  <input type="password" id="suPassword" placeholder="كلمة السر">

  <label>رقم الهاتف</label>
  <input type="text" id="suPhone" placeholder="0999xxxxxx">

  <div style="text-align:center;margin-top:12px;">
    <button id="signupBtn">إنشاء حساب</button>
  </div>

  <div style="text-align:center;margin-top:12px;">
    <span id="openLoginNew" style="color:#0288d1;cursor:pointer;font-weight:bold">
      لديك حساب؟ تسجيل الدخول
    </span>
  </div>

  <div id="signupError" class="error" style="display:none;margin-top:10px;text-align:center;"></div>

</div>


    <!-- profile page -->
    <div id="profilePage" class="hidden">
      <div class="form-box">
        <h3 style="text-align:center;color: var(--main-color);">الملف الشخصي</h3>
        <label>الاسم</label>
        <input type="text" id="profileName" readonly>
        <label>البريد الإلكتروني</label>
        <input type="email" id="profileEmail" readonly>
        <label>كلمة السر</label>
        <input type="password" id="profilePassword" readonly>
        <label>رقم الهاتف</label>
        <input type="text" id="profilePhone" readonly>
        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;">
          <button id="requestEditBtn">طلب تعديل معلوماتك</button>
          <button id="confirmSaveBtn" class="hidden">حفظ التعديلات</button>
        </div>
      </div>
    </div>

    <!-- settings page -->
    <div id="settingsPage" class="hidden">
      <div class="form-box">
        <h3 style="text-align:center;color:var(--main-color);">الإعدادات</h3>
        <div style="display:flex;flex-direction:column;gap:10px;">
          <button class="small-link" id="settingsEditProfileBtn">تعديل 
        المعلومات الشخصية              
        
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pencil-square" viewBox="0 0 16 16">
  <path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"/>
  <path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5z"/>
</svg>
</button>

  <!--        <button class="small-link" id="4bee3na">الدعم والمساعدة 
    <!-      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chat-left-text-fill" viewBox="0 0 16 16">
  <path d="M0 2a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H4.414a1 1 0 0 0-.707.293L.854 15.146A.5.5 0 0 1 0 14.793zm3.5 1a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1zm0 2.5a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1zm0 2.5a.5.5 0 0 0 0 1h5a.5.5 0 0 0 0-1z"/>
</svg>
          </button> -->
          <button class="small-link" id="settingsPrivacyBtn">سياسة الخصوصية
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info-square-fill" viewBox="0 0 16 16">
  <path d="M0 2a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2zm8.93 4.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533zM8 5.5a1 1 0 1 0 0-2 1 1 0 0 0 0 2"/>
</svg>
          </button>
          <button class="small-link" id="settingsLogoutBtn">تسجيل خروج
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M6 12.5a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-9a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v2a.5.5 0 0 1-1 0v-2A1.5 1.5 0 0 1 6.5 2h8A1.5 1.5 0 0 1 16 3.5v9a1.5 1.5 0 0 1-1.5 1.5h-8A1.5 1.5 0 0 1 5 12.5v-2a.5.5 0 0 1 1 0z"/>
  <path fill-rule="evenodd" d="M.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L1.707 7.5H10.5a.5.5 0 0 1 0 1H1.707l2.147 2.146a.5.5 0 0 1-.708.708z"/>
</svg>
          </button>
        </div>
        <div class="back-btn" id="settingsBackBtn">⬅ رجوع</div>
      </div>
    </div>
    <!-- theme selection page -->
    <div id="themePage" class="hidden">
      <div class="form-box">
        <h3 style="text-align:center;color:var(--main-color);">اختيار لون الثيم</h3>
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:12px;">
          <!-- الألوان المطلوبة -->
          <div class="theme-swatch" data-color="#AF10FF" style="height:70px;border-radius:8px;cursor:pointer;border:3px solid #222;background:#AF10FF"></div>
          <div class="theme-swatch" data-color="#01FEFF" style="height:70px;border-radius:8px;cursor:pointer;border:3px solid #222;background:#01FEFF"></div>
          <div class="theme-swatch" data-color="#FF0701" style="height:70px;border-radius:8px;cursor:pointer;border:3px solid #222;background:#FF0701"></div>
          <div class="theme-swatch" data-color="#FF03CF" style="height:70px;border-radius:8px;cursor:pointer;border:3px solid #222;background:#FF03CF"></div>
          <div class="theme-swatch" data-color="#0E19FF" style="height:70px;border-radius:8px;cursor:pointer;border:3px solid #222;background:#0E19FF"></div>
          <div class="theme-swatch" data-color="#08FF03" style="height:70px;border-radius:8px;cursor:pointer;border:3px solid #222;background:#08FF03"></div>
          <div class="theme-swatch" data-color="#FFCB01" style="height:70px;border-radius:8px;cursor:pointer;border:3px solid #222;background:#FFCB01"></div>
            <div class="theme-swatch" data-color="#FFFFFF" style="height:70px;border-radius:8px;cursor:pointer;border:3px solid #222;background:#FFFFFF"></div>
            <div class="theme-swatch" data-color="#FF760B" style="height:70px;border-radius:8px;cursor:pointer;border:3px solid #222;background:#FF760B"></div>
            <div class="theme-swatch" data-color="#83C218" style="height:70px;border-radius:8px;cursor:pointer;border:3px solid #222;background:#83C218"></div>
            <div class="theme-swatch" data-color="#934900" style="height:70px;border-radius:8px;cursor:pointer;border:3px solid #222;background:#934900"></div>
            <div class="theme-swatch" data-color="#FFFD01" style="height:70px;border-radius:8px;cursor:pointer;border:3px solid #222;background:#FFFD01"></div>
            <div class="theme-swatch" data-color="#9B9B9B" style="height:70px;border-radius:8px;cursor:pointer;border:3px solid #222;background:#9B9B9B"></div>
        </div>
        <div style="margin-top:12px;" class="muted-small">اضغط على اللون لتطبيقه. سيتم حفظه محليًا على جهازك.</div>
        <div class="back-btn" id="themeBackBtn">⬅ رجوع</div>
      </div>
    </div>

    <!-- privacy policy page -->
    <div id="privacyPage" class="hidden">
      <div class="form-box">
        <h3 class="privacy-title">سياسة الخصوصية والشروط</h3>
        <div class="privacy-box">
•مسؤوليات المستخدم:
-دقة بيانات الحساب: أنت مسؤول بالكامل عن دقة بيانات حسابك وحماية بيانات تسجيل الدخول الخاصة بك
-المسؤولية عن سوء الاستخدام: نحن نخلي مسؤوليتنا عن أي أخطاء تنتج عن سوء استخدامك
-عمليات الحساب : أنت مسؤول عن جميع العمليات والتحويلات التي تتم في حسابك وعن جميع الأخطاء التي قد تنتج نتيجة سوء استخدامه او الخطأ الناجم عن استعمال ارقام وروابط مغلوطة
-الاستخدام غير المناسب: استخدامك غير المناسب أو غير الأخلاقي للبرنامج، أو محاولتك للتحايل عليه، يجعلك مسؤولاً بالكامل ويعرضك للمساءلة حتى ان كانت قانونية

الاستخدام غير القانوني : لا يحق لك استخدام البرنامج لأغراض غير قانونية أو بما يخالف الأنظمة والقوانين المعمول بها.

تعليق الحساب والإجراءات القانونية

. حق التعليق: نحتفظ بالحق في تعليق حسابك في حالة انتهاكك لهذا الاتفاق أو بناءً على أمر قضائي دون الحاجة إلى إشعارك مسبقاً.

التزامنا

. هدف الخدمة: نسعى لتوفير منصة آمنة وموثوقة تمكن المستخدمين من شحن السلع الإلكترونية بسهولة وراحة باحترافية وشفافية.

قبول الشروط

. الاستخدام يعني الموافقة: استخدامك للبرنامج يعني قبولك لهذه الشروط والأحكام. إذا كنت لا توافق على أي جزء من هذه الاتفاقية، يجب عليك التوقف عن الاستخدام فوراً.

ختاماً

شكراً لثقتكم بنا، ونتطلع إلى تقديم خدمات الكترونية استثنائية لكم.
        </div>
        <div style="text-align:center;margin-top:12px;">
          <div class="back-btn" id="privacyBackBtn">⬅ رجوع</div>
        </div>
      </div>
    </div>

<!-- لوحة رمز الهدايا — يمكن وضعها بعد #notifPanel -->
<div id="giftPanel" class="notif-panel hidden" aria-live="polite" role="dialog" aria-hidden="true">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
    <h4 style="color: var(--main-color);margin:0">رمز الهدايا</h4>
    <div id="giftCloseBtn" style="cursor:pointer;color: var(--main-color);font-weight:bold">×</div>
  </div>

  <div style="padding:6px;color:#fff">ضع رمز الهدايا للحصول على هديتك</div>

  <input id="giftCodeInput" type="text" placeholder="أدخل الرمز هنا" style="margin-top:10px;background:#222;color:#fff;border-radius:6px;padding:10px;border:1px solid rgba(255,255,255,0.03)">

  <div style="display:flex;gap:8px;margin-top:10px;">
    <div class="small-btn" id="redeemGiftBtn">الحصول</div>
    <div class="small-btn" id="giftPanelCloseBtn2">اغلاق</div>
  </div>

  <div id="giftMsg" class="muted-small" style="margin-top:8px;color:#aaa"></div>
</div>
<!-- START: homePage replacement -->
<div id="homePage" class="">
  <div class="container">
    <div class="sections-grid">

      <!-- ROW 1 -->
      <div class="section-tile" data-section="games" title=" الألعاب">
        <img class="placeholder" src="" data-img="PLACE_IMG_GAMES" alt=" الألعاب">
        <div class="section-name"> الألعاب</div>
      </div>

      <div class="section-tile" data-section="apps" title=" التطبيقات">
        <img class="placeholder" src="" data-img="PLACE_IMG_APPS" alt=" التطبيقات">
        <div class="section-name"> التطبيقات</div>
      </div>
      
      <div class="section-tile" data-section="rashq" title=" الرشق">
        <img class="placeholder" src="" data-img="PLACE_IMG_rashq" alt=" الرشق">
        <div class="section-name"> الرشق</div>
      </div>
      
      <div class="section-tile" data-section="card" title=" البطاقات">
        <img class="placeholder" src="" data-img="PLACE_IMG_rashq" alt=" البطاقات">
        <div class="section-name"> البطاقات</div>
      </div>
      
      <div class="section-tile" data-section="numb" title=" الأرقام">
        <img class="placeholder" src="" data-img="PLACE_IMG_rashq" alt=" الأرقام">
        <div class="section-name"> الأرقام</div>
      </div>
      
      <div class="section-tile" data-section="accau" title=" حسابات جاهزة">
        <img class="placeholder" src="" data-img="PLACE_IMG_rashq" alt=" حسابات جاهزة">
        <div class="section-name"> حسابات جاهزة</div>
      </div>

      <div class="section-tile" data-section="editor" title=" برامج تصميم ">
        <img class="placeholder" src="" data-img="PLACE_IMG_rashq" alt=" برامج تصميم ">
        <div class="section-name"> برامج تصميم </div>
      </div>
      <div class="section-tile" data-section="balances" title=" قسم الرصيد ">
        <img class="placeholder" src="" data-img="PLACE_IMG_balances" alt=" قسم الرصيد  ">
        <div class="section-name"> قسم الرصيد </div>
      </div>
    </div>
  </div>
</div>
<!-- END homePage replacement -->

<!-- sectionPage (show subcategories inside section) -->
<div id="sectionPage" class="hidden">
  <div class="form-box">
    <h3 id="sectionPageTitle" style="text-align:center;color:var(--main-color)">القسم</h3>
    <div id="sectionSubgrid" class="subgrid"></div>
    <div class="back-btn" id="sectionBackBtn">⬅ رجوع</div>
  </div>
</div>

    <!-- help page -->
    <div id="helpPage" class="hidden">
      <div class="form-box">
        <h3 style="text-align:center;">المساعدة في حل مشكلة</h3>
        <label>الرقم الشخصي </label>
        <input type="text" id="helpPersonalField" readonly>
        <label>-اختر مشكلتك-</label>
        <select id="helpIssueSelect">
          <option value="" disabled selected>-- اختر مشكلتلك --</option>
          <option value="لا استطيع تعبئة البيانات">لا استطع تعبئة البيانات</option>
          <option value="قمت بتحويل الرصيد ولم يُراجع طلبي">قمت بتحويل الرصيد ولم يُراجع طلبي</option>
          <option value="تم قبول طلبي لكن لم يصلني شيء">تم قبول طلبي لكن لم يصلني شيء</option>
          <option value="لا استطيع ارسال لقطة شاشة">لا استطيع ارسال لقطة شاشة</option>
          <option value="غير ذلك">غير ذلك</option>
        </select>
        <label>ارفاق ملف (اختياري)</label>
        <input type="file" id="helpFileUpload" accept="image/*">
        <div class="upload-status" id="helpUploadStatus"></div>
        <input type="text" id="helpFileLink" placeholder="رابط الملف سيظهر هنا (اختياري)" readonly>
        <label>وصف المشكلة</label>
        <textarea id="helpDesc" rows="5" maxlength="100" placeholder="اكتب مشكلتك وضع رقم عملية الطلب #***********"></textarea>
        <div style="display:flex;gap:10px;flex-wrap:wrap;">
          <button id="helpSubmitBtn">إرسال</button>
        </div>
      </div>
    </div>

    <!-- games page -->
    <div id="gamesPage" class="hidden">
      <div class="form-box">
        <h3>اختر لعبتك</h3>
        <select id="gameSelect">
          <option value="">-- اختر لعبة --</option>
          <option value="أكواد فري فاير">أكواد فري فاير</option>
          <option value="فري فاير ايدي"> ايدي</option>
          <option value="ببجي ايدي">ببجي ايدي</option>
          <option value="أكواد ببجي">أكواد ببجي</option>
          <option value="جواكر">جواكر</option>
        </select>
        <input type="text" id="personalField" readonly>
        <input type="text" id="idField" placeholder="ضع الايدي" oninput="this.value=this.value.replace(/[^0-9]/g,'')">
        <div id="optionsContainer"></div>
        <div id="priceDisplay"></div>
        <button id="submitForm" disabled>إرسال</button>
        <div class="price-note" id="paymentNote">اختر الحزمة ثم اضغط إرسال لإرسال الطلب مباشرة (يُخصم من رصيدك إن كافى).</div>
        <div id="orderStatus" style="color:#0f0;font-weight:bold;text-align:center;margin-top:10px;"></div>
        <div style="text-align:center;">
          <button id="goOrdersBtn" class="small-btn hidden">عرض الطلبات</button>
        </div>
      </div>
    </div>

    <!-- apps page -->
    <div id="appsPage" class="hidden">
      <div class="form-box">
        <h3>اختر التطبيق</h3>
        <select id="appSelect">
          <option value="">-- اختر تطبيق --</option>
          <option value="تطبيق 1">تطبيق 1</option>
          <option value="تطبيق 2">تطبيق 2</option>
          <option value="تطبيق 3">تطبيق 3</option>
        </select>
        <input type="text" id="appPersonalField" readonly>
        <input type="text" id="appIdField" placeholder="ضع الايدي" oninput="this.value=this.value.replace(/[^0-9]/g,'')">
        <div id="optionsContainerApps"></div>
        <div id="priceDisplayApps"></div>
        <button id="appSubmitForm" disabled>إرسال</button>
        <div class="price-note" id="appPaymentNote">اختر الباقة/التطبيق ثم اضغط إرسال لإرسال الطلب مباشرة (يُخصم من رصيدك إن كافى).</div>
        <div id="appOrderStatus" style="color:#0f0;font-weight:bold;text-align:center;margin-top:10px;"></div>
        <div style="text-align:center;">
          <button id="goOrdersBtnApp" class="small-btn hidden">عرض الطلبات</button>
        </div>
      </div>
    </div>

    <!-- offers page -->
    <div id="offersPage" class="hidden">
      <div class="form-box">
        <h3 style="text-align:center;color:#FFCB01;">العروض والهدايا</h3>
        <div id="offersList"></div>
      </div>
    </div>
<!-- === payment details page (استبدال هذا القسم في index.html) === -->
<div id="paymentDetailsPage" class="hidden">
  <div class="form-box">
    <h3 id="pdTitle" style="text-align:center;"></h3>

    <!-- شبكة صور طرق الدفع (اترك src فارغة لتملأها يدوياً) -->
    <div id="pdMethodsGrid" style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin:12px 0;">
      <!-- tile example: اترك src="" وسأضيفها يدوياً لاحقاً -->
      <button class="pd-method-tile" data-method="sham" style="cursor:pointer;border:2px solid rgba(255,203,1,0.08);background:#0b0b0b;padding:10px;border-radius:12px">
        <img src="https://i.postimg.cc/0y7NGhC2/IMG-20251012-WA0055.jpg" alt="شام كاش" style="width:100%;height:110px;object-fit:cover;border-radius:8px;display:block" />
        <div style="margin-top:8px;font-weight:800;color:#fff">شام كاش سوري</div>
      </button>

      <button class="pd-method-tile" data-method="sham" style="cursor:pointer;border:2px solid rgba(255,203,1,0.08);background:#0b0b0b;padding:10px;border-radius:12px">
        <img src="https://i.postimg.cc/0y7NGhC2/IMG-20251012-WA0055.jpg" alt="شام كاش" style="width:100%;height:110px;object-fit:cover;border-radius:8px;display:block" />
        <div style="margin-top:8px;font-weight:800;color: #fff">شام كاش دولار </div>
      </button>


      <button class="pd-method-tile" data-method="syrtel" style="cursor:pointer;border:2px solid rgba(255,203,1,0.08);background:#0b0b0b;padding:10px;border-radius:12px">
        <img src="https://i.postimg.cc/6qNKQpD5/IMG-20251012-WA0056.jpg" alt="سيرتيل كاش" style="width:100%;height:110px;object-fit:cover;border-radius:8px;display:block" />
        <div style="margin-top:8px;font-weight:800;color:#fff">سيرتيل كاش</div>
      </button>

      <button class="pd-method-tile" data-method="hawala" style="cursor:pointer;border:2px solid rgba(255,203,1,0.08);background:#0b0b0b;padding:10px;border-radius:12px">
        <img src="https://i.postimg.cc/Gtr0CSyH/IMG-20251013-WA0002.jpg" alt="حوالة مالية" style="width:100%;height:110px;object-fit:cover;border-radius:8px;display:block" />
        <div style="margin-top:8px;font-weight:800;color:#fff">حوالة مالية</div>
      </button>

      <button class="pd-method-tile" data-method="usdt" style="cursor:pointer;border:2px solid rgba(255,203,1,0.08);background:#0b0b0b;padding:10px;border-radius:12px">
        <img src="https://i.postimg.cc/g27fJ0Z1/IMG-20251013-WA0001.jpg" alt="عملات رقمية USDT" style="width:100%;height:110px;object-fit:cover;border-radius:8px;display:block" />
        <div style="margin-top:8px;font-weight:800;color:#fff">USDT</div>
      </button>
      
            <button class="pd-method-tile" data-method="code" style="cursor:pointer;border:2px solid rgba(255,203,1,0.08);background:#0b0b0b;padding:10px;border-radius:12px">
        <img src="https://i.postimg.cc/90gLN1PQ/20251206-114954.jpg" alt="code vipro" style="width:100%;height:110px;object-fit:cover;border-radius:8px;display:block" />
        <div style="margin-top:8px;font-weight:800;color:#fff">code vipro</div>
      </button>
      
      <button class="pd-method-tilee" data-method="codee" style="cursor:pointer;border:2px solid rgba(255,203,1,0.08);background:#0b0b0b;padding:10px;border-radius:12px">
          <img src="https://i.postimg.cc/fTkdzmDs/20251212-105121.jpg" alt="كود إحالة الاصدقاء" style="width:100%;height:110px;object-fit:cover;border-radius:8px;display:block" />
        <div style="margin-top:8px;font-weight:800;color:#fff">كود إحالة الاصدقاء </div>
        </button>
      
<button type="button" class="pd-method-tilee" data-method="cash" style="cursor:pointer;border:2px solid rgba(255,203,1,0.08);background:#0b0b0b;padding:10px;border-radius:12px">
          <img src="https://i.postimg.cc/0jM1sHWx/ea2409c16116a15c1c484872a7e18578.jpg" alt="تسليم الكاش باليد" style="width:100%;height:110px;object-fit:cover;border-radius:8px;display:block" />
        <div style="margin-top:8px;font-weight:800;color:#fff">كاش باليد</div>
        </button>
    </div>

    <!-- زر للعودة لاختيار طريقة أخرى -->

    <!-- المحتوى الفعلي لتفاصيل الدفع (يُخفي تلقائياً حتى اختيار طريقة) -->
    <div id="pdContent" style="display:none;">
      <div id="pdTopInfo" style="text-align:center;margin-bottom:10px;color: var(--main-color);font-weight:bold;"></div>
<select id="pdCashSelect" style="position:absolute; opacity:0; pointer-events:none; width:0; height:0;">
    <option value="">-- اختر طريقة الدفع --</option>
    <option value="sham">شام كاش</option>
    <option value="syrtel">سيرتيل كاش</option>
        <option value="code">code vipro</option>
    <option value="hawala">حوالة مالية</option>
    <option value="usdt">عملات رقمية USDT</option>
</select>
<div style="position:relative; margin-bottom:10px;">
  <input type="text" id="pdCopyField" readonly style="width:100%;padding-right:80px;">
  <button type="button" id="pdCopyBtn" style="position:absolute; right:3%; top:-30%; height:100%; width:70px; cursor:pointer; background:none; border:none; color:var(--main-color)">نسخ</button>
</div>
<!-- ---------- تعديل: منطقة الشحن (ضع هذا مكان القسم القديم) ---------- -->
<div style="text-align:center;margin-bottom:10px;">
  <button type="button" id="pdToggleQrBtn">اظهر/اخفِ QR</button>
</div>

<!-- حقل المبلغ الجديد (يحل مكان نافذة prompt) -->
<div id="chargeAmountWrap" style="margin-top:8px;">
  <label style="display:block;font-weight:700;margin-bottom:6px;color:var(--main-color)">ضع المبلغ هنا</label>
  <input type="number" id="chargeAmountInput" placeholder="مطابق تماما لما ارسلته لحسابنا" min="1" />
</div>

<div id="usdAmountWrapper" style="display:none; margin-top:10px;">
  <label style="font-weight:600;color:var(--main-color);display:block;margin-bottom:6px;">
    ضع المبلغ (الحد الأدنى 1$)
  </label>
  <input type="number" id="usdAmountInput" min="1" value="1" placeholder="المبلغ بالدولار (1$ أو أكثر)" />
</div>
<!-- حاويات QR كما في ملفك (لا تغيير) -->
<div id="qrContainer" style="display:none;margin-top:10px;text-align:center;">
  <img id="qrImg" src="https://i.postimg.cc/vHYg2nK5/IMG.jpg" alt="QR شام" style="width:300px;height:auto;">
</div>
<div id="syrtelQrContainer" style="display:none;margin-top:10px;text-align:center;">
  <img id="syrtelQrImg" src="https://i.postimg.cc/tT6ScwYv/IMG.jpg" alt="QR سيرتيل" style="width:300px;height:auto;">
</div>
<div id="usdtQrContainer" style="display:none;margin-top:10px;text-align:center;">
  <img id="usdtQrImg" src="https://i.postimg.cc/m26FRSgW/IMG.jpg" alt="QR USDT" style="width:300px;height:auto;">
</div>

<!-- رفع صورة التحويل -->
<input type="file" id="paymentFileUpload" accept="image/*">
<div class="upload-status" id="paymentUploadStatus"></div>

<!-- خفي الحقل المرئي للرابط (القيمة تبقى متاحة للـ JS / للارسال) -->
<input type="text" id="paymentFileLink" class="hidden" aria-hidden="true" readonly>

<!-- حقل الملاحظة (اختياري) يوضع قبل زر الإرسال -->
<label for="chargeNote" style="display:block;margin-top:8px;font-weight:700;color:#fff"></label>
<textarea id="chargeNote" rows="3" maxlength="200" placeholder="اكتب ملاحظتك (اختياري)"></textarea>

<!-- معلومات السعر/ملاحظة واجهة -->
<div id="pdPriceInfo" style="color:#0f0;font-weight:bold;margin-top:10px;text-align:center"></div>
<div class="price-note" id="pdNote" style="white-space:pre-line">اختر طريقة الدفع لمتابعة التعليمات</div>


      <!-- الجزء الخاص بحقول كل طريقة (خلايا موجودة مسبقاً في ملفك) -->
      <div id="shamFields" style="display:none;margin-top:12px;">
        <!-- محتوى شام كاش -->
      </div>
      <div id="syrtelFields" style="display:none;margin-top:12px;">
        <!-- محتوى سيرتيل -->
      </div>
      <div id="hawalaFields" style="display:none;margin-top:12px;">
      </div>
                <div id="codeFields" style="display:none;margin-top:12px;">
        <!-- محتوى حوالة -->
      </div>
      <div id="usdtFields" style="display:none;margin-top:12px;">
        <!-- محتوى USDT -->
      </div>
<!-- زر الإرسال (التصرف الجديد يُلتقط عبر JS المضاف أدناه) -->
<button id="pdSubmitForm">إرسال الطلب</button>
<!-- ---------- نهاية التعديل ---------- -->

        <button id="pdCancel" class="small-btn" style="background:transparent;border:1px solid rgba(255,255,255,0.06);color:#fff">إلغاء</button>
      </div>
      <div id="pdNote" style="margin-top:8px;color:#aaa"></div>
        </div>
      </div>
    </div>


    <!-- orders page -->
    <div id="ordersPage" class="hidden">
      <div class="form-box">
        <h3 style="text-align:center">الطلبات</h3>
        <div id="ordersList" class="orders-list"></div>
      </div>
    </div>

    <!-- review page -->
    <div id="reviewPage" class="hidden">
      <div class="form-box" style="text-align:center;">
        <h3>تم ارسال طلبك</h3>
        <p id="reviewMsg">تم استلام طلبك وسيتم مراجعته</p>
        <div class="back-btn" id="reviewBackBtn">⬅ رجوع للصفحة الرئيسية</div>
      </div>
    </div>
    
<!-- gameStorePage -->
<div id="gameStorePage" class="hidden">
  <div class="form-box">
    <h3 id="gameStoreTitle" style="text-align:center;color:var(--main-color)">متجر اللعبة</h3>
    <div id="gameStoreGrid"></div>
    <div style="display:flex;gap:10px;margin-top:12px;justify-content:center;">
      <div id="gameStoreBack" class="small-btn" style="background:transparent;color:var(--main-color);border:2px solid rgba(255,203,1,0.08);">⬅ رجوع</div>
    </div>
  </div>
</div>

<!-- simpleOrderPage (صفحة الطلب السريع) -->
<div id="simpleOrderPage" class="hidden">
  <div class="form-box simple-order-box">
    <h3 style="text-align:center;color:var(--main-color)">طلب سريع</h3>
    <div style="display:flex;gap:12px;align-items:center;">
      <img id="simpleOrderImg" src="" alt="صورة" style="width:84px;height:84px;object-fit:cover;border-radius:8px;border:2px solid rgba(255,255,255,0.03)">
      <div style="flex:1;text-align:right;">
        <div id="simpleOrderItemName" style="font-weight:800;color:#fff;font-size:16px">اسم الحزمة</div>
        <div id="simpleOrderItemNote" style="color:#ccc;font-size:13px;margin-top:6px">ملاحظة</div>
      </div>
    </div>

    <label style="margin-top:10px">رقمك الشخصي (مقروء)</label>
    <input type="text" id="simplePersonal" readonly>

    <label>ضع الايدي</label>
    <input type="text" id="simpleIdField" placeholder="ضع الايدي" oninput="this.value=this.value.replace(/[^0-9]/g,'')">


    <label>السعر </label>
    <input type="text" id="simpleTotalPrice" readonly>

    <div id="simpleOrderMsg" style="color:#ffcc00;font-weight:700;margin-top:8px;text-align:center"></div>

    <div style="display:flex;gap:10px;margin-top:12px;">
      <button id="simpleOrderSend">إرسال وخصم من الرصيد</button>
      <div id="simpleOrderCancel" class="small-btn" style="background:transparent;color:#fff;border:2px solid rgba(255,255,255,0.05)">إلغاء</div>
    </div>
  </div>
</div>

  </main>


  <nav id="bottomNav" aria-label="شريط التنقل السفلي">
    <button class="nav-btn" id="navHomeBtn" title="الرئيسية">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="icon size-6">
        <path d="M11.47 3.841a.75.75 0 0 1 1.06 0l8.69 8.69a.75.75 0 1 0 1.06-1.061l-8.689-8.69a2.25 2.25 0 0 0-3.182 0l-8.69 8.69a.75.75 0 1 0 1.061 1.06l8.69-8.689Z" />
        <path d="m12 5.432 8.159 8.159c.03.03.06.058.091.086v6.198c0 1.035-.84 1.875-1.875 1.875H15a.75.75 0 0 1-.75-.75v-4.5a.75.75 0 0 0-.75-.75h-3a.75.75 0 0 0-.75.75V21a.75.75 0 0 1-.75.75H5.625a1.875 1.875 0 0 1-1.875-1.875v-6.198a2.29 2.29 0 0 0 .091-.086L12 5.432Z" />
      </svg>
      <span class="nav-label"></span>
    </button>

    <button class="nav-btn" id="navtodivideBtn" title="الأقسام">
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-grid-1x2-fill" viewBox="0 0 16 16">
  <path d="M0 1a1 1 0 0 1 1-1h5a1 1 0 0 1 1 1v14a1 1 0 0 1-1 1H1a1 1 0 0 1-1-1zm9 0a1 1 0 0 1 1-1h5a1 1 0 0 1 1 1v5a1 1 0 0 1-1 1h-5a1 1 0 0 1-1-1zm0 9a1 1 0 0 1 1-1h5a1 1 0 0 1 1 1v5a1 1 0 0 1-1 1h-5a1 1 0 0 1-1-1z"/>
</svg>
      <span class="nav-label"></span>
    </button>

    <button class="nav-btn" id="navChargeBtn" title="شحن الرصيد">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="icon size-6">
        <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18.75a60.07 60.07 0 0 1 15.797 2.101c.727.198 1.453-.342 1.453-1.096V18.75M3.75 4.5v.75A.75.75 0 0 1 3 6h-.75m0 0v-.375c0-.621.504-1.125 1.125-1.125H20.25M2.25 6v9m18-10.5v.75c0 .414.336.75.75.75h.75m-1.5-1.5h.375c.621 0 1.125.504 1.125 1.125v9.75c0 .621-.504 1.125-1.125 1.125h-.375m1.5-1.5H21a.75.75 0 0 0-.75.75v.75m0 0H3.75m0 0h-.375a1.125 1.125 0 0 1-1.125-1.125V15m1.5 1.5v-.75A.75.75 0 0 0 3 15h-.75M15 10.5a3 3 0 1 1-6 0 3 3 0 0 1 6 0Zm3 0h.008v.008H18V10.5Zm-12 0h.008v.008H6V10.5Z" />
      </svg>
      <span class="nav-label"></span>
    </button>

    <button class="nav-btn" id="navOrdersBtn" title="الطلبات">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="icon size-6">
        <path d="M2.25 2.25a.75.75 0 0 0 0 1.5h1.386c.17 0 .318.114.362.278l2.558 9.592a3.752 3.752 0 0 0-2.806 3.63c0 .414.336.75.75.75h15.75a.75.75 0 0 0 0-1.5H5.378A2.25 2.25 0 0 1 7.5 15h11.218a.75.75 0 0 0 .674-.421 60.358 60.358 0 0 0 2.96-7.228.75.75 0 0 0-.525-.965A60.864 60.864 0 0 0 5.68 4.509l-.232-.867A1.875 1.875 0 0 0 3.636 2.25H2.25ZM3.75 20.25a1.5 1.5 0 1 1 3 0 1.5 1.5 0 0 1-3 0ZM16.5 20.25a1.5 1.5 0 1 1 3 0 1.5 1.5 0 0 1-3 0Z" />
      </svg>
      <span class="nav-label"></span>
    </button>

    <button class="nav-btn" id="navProfileBtn" title="الملف الشخصي">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="icon size-6">
        <path fill-rule="evenodd" d="M18.685 19.097A9.723 9.723 0 0 0 21.75 12c0-5.385-4.365-9.75-9.75-9.75S2.25 6.615 2.25 12a9.723 9.723 0 0 0 3.065 7.097A9.716 9.716 0 0 0 12 21.75a9.716 9.716 0 0 0 6.685-2.653Zm-12.54-1.285A7.486 7.486 0 0 1 12 15a7.486 7.486 0 0 1 5.855 2.812A8.224 8.224 0 0 1 12 20.25a8.224 8.224 0 0 1-5.855-2.438ZM15.75 9a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0Z" clip-rule="evenodd" />
      </svg>
      <span class="nav-label"></span>
    </button>
  </nav>

  <!-- ---------- SCRIPT (مُعدل ومتكامل) ---------- -->
  <script>
// تهيئة الحالة العامة

/* ---------- Frontend logic مع التعديلات المطلوبة لإخفاء العناصر العلوية وصعود الصفحات وانبثاق سريع ---------- */

// API root
const API_ROOT = 'https://fourbe-0sfk.onrender.com/';
// helpers for safe requests with timeout and server-profile sync
async function fetchWithTimeout(url, opts = {}, timeoutMs = 3000) {
  const controller = new AbortController();
  const id = setTimeout(() => controller.abort(), timeoutMs);
  try {
    const resp = await fetch(url, Object.assign({}, opts, { signal: controller.signal }));
    clearTimeout(id);
    return resp;
  } catch (e) {
    clearTimeout(id);
    throw e;
  }
}


async function postJsonWithTimeout(path, body, timeoutMs = 3000) {
  try {
    const r = await fetchWithTimeout(API_ROOT + path, {
      method: 'POST',
      headers: {'content-type': 'application/json'},
      body: JSON.stringify(body)
    }, timeoutMs);
    const data = await r.json().catch(()=>null);
    return data;
  } catch (e) {
    if (e.name === 'AbortError') return { ok:false, error:'timeout' };
    return { ok:false, error: String(e) };
  }
}

async function refreshProfileFromServer(personal) {
  if (!personal) return null;
  try {
    const resp = await fetchWithTimeout(API_ROOT + 'api/profile/' + encodeURIComponent(personal), {}, 3000);
    const data = await resp.json().catch(()=>null);
    if (data && data.ok && data.profile) {
      currentProfile = Object.assign({}, currentProfile || {}, data.profile);
      try { localStorage.setItem('user_profile_v1', JSON.stringify(currentProfile)); } catch(e){}
      if (typeof refreshUIFromProfile === 'function') refreshUIFromProfile();
      return currentProfile;
    }
  } catch (err) { console.warn('refreshProfileFromServer failed', err); }
  return null;
}


// helpers
function $(id){ return document.getElementById(id); }
function show(id){ const el=$(id); if(el) el.classList.remove('hidden'); }
function hide(id){ const el=$(id); if(el) el.classList.add('hidden'); }
// updated list to include all known pages
function hideAllPages(){
  const pages = ['homePage','gamesPage','appsPage','ordersPage','paymentDetailsPage','reviewPage','helpPage','profilePage','loginPage','offersPage','profileSummaryPage','benatakPage','settingsPage','themePage','privacyPage','sectionPage','gameStorePage','simpleOrderPage'];
  pages.forEach(id => { const e=$(id); if(e) e.classList.add('hidden'); });
}

/* ----------- state & prices (كما كان) ----------- */
let currentProfile = null;
let selectedGameOption = '';
let selectedAppOption = '';
let currentMap = null;
let currentMap_num = {};
const priceMapFF={"100 جواهر":"12500 ل.س","200 جواهر":"25000 ل.س","300 جواهر":"60000 ل.س","530 جواهر":"60000 ل.س","1080 جواهر":"120000 ل.س","2200 جواهر":"240000 ل.س","عضوية أسبوعية":"30000 ل.س","عضوية شهرية":"140000 ل.س"};
const priceMapPUBG={"60 شدة":"6000 ل.س","325 شدة":"25000 ل.س","660 شدة":"48000 ل.س","1800 شدة":"120000 ل.س","3850 شدة":"240000 ل.س","8100 شدة":"480000 ل.س"};
const priceMappubg1={"كود 60 شده":"12500 ل.س"};
const priceMapApps = {"تطبيق 1":"5000 ل.س","تطبيق 2":"10000 ل.س","تطبيق 3":"15000 ل.س"};
const priceMapFF_num = Object.fromEntries(Object.entries(priceMapFF).map(([k,v])=>[k, parseInt((String(v).replace(/\D/g,''))||0,10)]));
const priceMapPUBG_num = Object.fromEntries(Object.entries(priceMapPUBG).map(([k,v])=>[k, parseInt((String(v).replace(/\D/g,''))||0,10)]));
const priceMappubg1_num = Object.fromEntries(Object.entries(priceMappubg1).map(([k,v])=>[k, parseInt((String(v).replace(/\D/g,''))||0,10)]));
const priceMapApps_num = Object.fromEntries(Object.entries(priceMapApps).map(([k,v])=>[k, parseInt((String(v).replace(/\D/g,''))||0,10)]));

// pages that should hide top details and move up
const compactPages = new Set(['paymentDetailsPage','ordersPage','profilePage','helpPage','gamesPage','appsPage','offersPage','profileSummaryPage','loginPage','benatakPage','sectionPage','gameStorePage','simpleOrderPage']);

/* ------------- notification helpers ------------- */
async function loadNotifications(){
  try{
    if(!currentProfile || !currentProfile.personalNumber) return;
    const resp = await fetch(API_ROOT + 'api/notifications/' + currentProfile.personalNumber);
    const data = await resp.json().catch(()=>null);
    if(!data || !data.ok) return;
    const list = $('notifList');
    if(!list) return;
    list.innerHTML = '';
    const notifications = data.notifications || [];
    if(notifications.length === 0){
      list.innerHTML = '<div class="notif-empty">لا توجد إشعارات حالياً</div>';
    } else {
      notifications.forEach(n=>{
        const el = document.createElement('div');
        el.style.padding='8px';
        el.style.border='1px solid rgba(255,203,1,0.06)';
        el.style.marginBottom='8px';
        el.innerHTML = `<div style="font-weight:700;">${n.text}</div><div style="font-size:12px;color:#aaa;margin-top:6px;">${new Date(n.createdAt||Date.now()).toLocaleString()}</div>`;
        list.appendChild(el);
      });
    }
  }catch(e){
    console.warn('loadNotifications error', e);
  }
}

/* ----------- small helpers for compact header & quick popup ----------- */
function setCompactHeader(on){
  const hdr = $('topHeader');
  const main = $('mainContent');
  if(!hdr || !main) return;
  if(on){ hdr.classList.add('compact'); main.classList.add('compact-main'); }
  else { hdr.classList.remove('compact'); main.classList.remove('compact-main'); }
}

function showPageQuick(id){
  hideAllPages();
  // compact header if page is in compact list
  setCompactHeader(compactPages.has(id));
  const el = $(id);
  if(!el) return;
  el.classList.remove('hidden');
  // force reflow then add quick-popup for very fast appearance
  void el.offsetWidth;
  el.classList.add('quick-popup');
  // remove quick-popup after short time so it can be reused
  setTimeout(()=>{ el.classList.remove('quick-popup'); }, 250);
  // scroll to top immediately
  window.scrollTo({ top: 0 });
}

/* ---------- DOM & bindings ---------- */
document.addEventListener('DOMContentLoaded', ()=> {
  // menu open/close
  if($('menuBtn')) $('menuBtn').addEventListener('click', ()=> { $('sidebar').classList.toggle('active'); });
  if($('sidebarCloseBtn')) $('sidebarCloseBtn').addEventListener('click', ()=> { $('sidebar').classList.remove('active'); });
  if($('sidebarProfileArea')) $('sidebarProfileArea').addEventListener('click', ()=> { showProfile(); $('sidebar').classList.remove('active'); });

  // sidebar links
  if($('linkHome')) $('linkHome').addEventListener('click', e=>{ e.preventDefault(); showHome(); $('sidebar').classList.remove('active'); });
    if($('linkpya')) $('linkpya').addEventListener('click', e=>{ e.preventDefault(); showBenatak(); $('sidebar').classList.remove('active'); });
  if($('linkOrders')) $('linkOrders').addEventListener('click', e=>{ e.preventDefault(); showOrders(); $('sidebar').classList.remove('active'); });
  if($('linkOrders')) $('linkOrders').addEventListener('click', e=>{ e.preventDefault(); showOrders(); $('sidebar').classList.remove('active'); });
  if($('linkHelp')) $('linkHelp').addEventListener('click', e=>{ e.preventDefault(); showHelp(); $('sidebar').classList.remove('active'); });
  if($('linkOffers')) $('linkOffers').addEventListener('click', e=>{ e.preventDefault(); showOffers(); $('sidebar').classList.remove('active'); });
  if($('linkJoinWhats')) $('linkJoinWhats').addEventListener('click', e=>{ e.preventDefault(); window.open('https://chat.whatsapp.com/LvrWRUCqLOw4cxjPlnH33J?mode=ems_copy_t','_blank'); });
  if($('btnCharge')) $('btnCharge').addEventListener('click', ()=>{ $('sidebar').classList.remove('active'); openChargePage(); });

  // notif bell
  if($('notifBell')) $('notifBell').addEventListener('click', async ()=> {
    const hidden = $('notifPanel').classList.toggle('hidden');
    await loadNotifications();
    if(!hidden){
      await markNotificationsReadForCurrentUser();
      refreshNotificationsCount();
    }
  });

  // close & clear listeners
  if($('notifCloseBtn')) $('notifCloseBtn').addEventListener('click', ()=> $('notifPanel').classList.add('hidden'));
  if($('notifClearBtn')) $('notifClearBtn').addEventListener('click', async () => {
    try {
      const resp = await fetch(API_ROOT + 'api/notifications/clear', {
        method:'POST', headers:{'content-type':'application/json'},
        body: JSON.stringify({ personal: currentProfile.personalNumber })
      });
      const data = await resp.json().catch(()=>null);
      if(data && data.ok){
        $('notifList').innerHTML='';
        $('notifBadge').classList.add('hidden');
      } else alert('فشل مسح الإشعارات');
    } catch(e){ console.error(e); alert('خطأ في الاتصال'); }
  });

  // bind main UI elements (buttons etc.)
  if($('doLoginBtn')) $('doLoginBtn').addEventListener('click', doLogin);
  if($('requestEditBtn')) $('requestEditBtn').addEventListener('click', requestProfileEdit);
  if($('confirmSaveBtn')) $('confirmSaveBtn').addEventListener('click', confirmProfileSave);
  if($('helpSubmitBtn')) $('helpSubmitBtn').addEventListener('click', submitHelp);
  if($('helpFileUpload')) $('helpFileUpload').addEventListener('change', async function(){ await uploadFileToImgbb(this.files[0], 'helpFileLink','helpUploadStatus'); });

  if($('paymentFileUpload')) $('paymentFileUpload').addEventListener('change', async function(){ await uploadFileToImgbb(this.files[0], 'paymentFileLink','paymentUploadStatus'); });

  // login pwd toggle
  if($('loginTogglePwd')){
    $('loginTogglePwd').addEventListener('click', ()=>{
      const pwd = $('loginPassword');
      if(!pwd) return;
      if(pwd.type === 'password'){ pwd.type='text'; $('loginTogglePwd').textContent='إخفاء'; }
      else { pwd.type='password'; $('loginTogglePwd').textContent='اظهار'; }
    });
  }

  // games/apps selects and inputs
  if($('gameSelect')) $('gameSelect').addEventListener('change', function(){ buildGameOptions(this.value); updateSubmitButtonGames(); });
  if($('idField')) $('idField').addEventListener('input', updateSubmitButtonGames);
  if($('submitForm')) $('submitForm').addEventListener('click', ()=> placeOrderFromUI('gamesPage'));
  if($('goOrdersBtn')) $('goOrdersBtn').addEventListener('click', ()=> showOrders());

  if($('appSelect')) $('appSelect').addEventListener('change', function(){ buildAppOptions(this.value); updateSubmitButtonApps(); });
  if($('appIdField')) $('appIdField').addEventListener('input', updateSubmitButtonApps);
  if($('appSubmitForm')) $('appSubmitForm').addEventListener('click', ()=> placeOrderFromUI('appsPage'));
  if($('goOrdersBtnApp')) $('goOrdersBtnApp').addEventListener('click', ()=> showOrders());

  // back buttons
  if($('sectionBackBtn')) $('sectionBackBtn').addEventListener('click', ()=> showHome());
  if($('gameStoreBack')) $('gameStoreBack').addEventListener('click', ()=> {
    // back to section page
    if(window._lastOpenedSection) openSection(window._lastOpenedSection);
    else showHome();
  });
  if($('simpleOrderCancel')) $('simpleOrderCancel').addEventListener('click', ()=> {
    if(window._lastOpenedGame) openGameStore(window._lastOpenedGame.key, window._lastOpenedGame.title);
    else if(window._lastOpenedSection) openSection(window._lastOpenedSection);
    else showHome();
  });

  // payment details bindings
  if($('pdCashSelect')) $('pdCashSelect').addEventListener('change', onPdCashChange);
  if($('pdToggleQrBtn')) $('pdToggleQrBtn').addEventListener('click', toggleQr);
  if($('pdCopyBtn')) $('pdCopyBtn').addEventListener('click', ()=>{
    const v = $('pdCopyField') ? $('pdCopyField').value : '';
    if(!v){ alert('لا يوجد شيء لنسخه'); return; }
    navigator.clipboard && navigator.clipboard.writeText ? navigator.clipboard.writeText(v).then(()=> alert('تم النسخ')) : (function(){ try{ const ta = document.createElement('textarea'); ta.value=v; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); alert('تم النسخ'); }catch(e){ alert('فشل النسخ'); } })();
  });
  if($('pdSubmitForm')) $('pdSubmitForm').addEventListener('click', submitPaymentDetails);

  // profile summary bindings
  if($('summaryName')) $('summaryName').addEventListener('click', ()=> { showProfile(); });
  if($('summaryPersonal')) $('summaryPersonal').addEventListener('click', ()=> { showProfile(); });
  if($('summaryAvatar')) $('summaryAvatar').addEventListener('click', ()=> { showProfile(); });
  if($('summaryHelpBtn')) $('summaryHelpBtn').addEventListener('click', ()=> { showHelp(); });
  if($('summaryJoinBtn')) $('summaryJoinBtn').addEventListener('click', ()=> { window.open('https://chat.whatsapp.com/LvrWRUCqLOw4cxjPlnH33J?mode=ems_copy_t','_blank'); });
      if($('summaryJoinBtn2')) $('summaryJoinBtn2').addEventListener('click', ()=> { window.open('https://4bee.netlify.app/','_blank'); });
    if($('summaryJoinBt1')) $('summaryJoinBt1').addEventListener('click', ()=> { window.open('https://lucent-clafoutis-7acd80.netlify.app/','_blank'); });
    if($('summaryGiftBtn2')) $('summaryGiftBtn2').addEventListener('click', ()=> { window.open('https://a7dat.netlify.app/','_blank'); });
  if($('4bee3na')) $('4bee3na').addEventListener('click', ()=> { window.open('https://teal-choux-e2aa39.netlify.app/'); });
  if($('summaryBenatakBtn')) $('summaryBenatakBtn').addEventListener('click', ()=> { showBenatak(); });
  if($('summarySettingsBtn')) $('summarySettingsBtn').addEventListener('click', ()=> { showSettings(); });

  if($('benatakBackBtn')) $('benatakBackBtn').addEventListener('click', ()=> { showProfileSummary(); });

  // settings bindings
  if($('settingsBackBtn')) $('settingsBackBtn').addEventListener('click', ()=> { showProfileSummary(); });
  if($('settingsEditProfileBtn')) $('settingsEditProfileBtn').addEventListener('click', ()=> { showProfile(); });
  if($('settingsThemeBtn')) $('settingsThemeBtn').addEventListener('click', ()=> { showThemePage(); });
  if($('settingsPrivacyBtn')) $('settingsPrivacyBtn').addEventListener('click', ()=> { showPrivacy(); });
  if($('settingsLogoutBtn')) $('settingsLogoutBtn').addEventListener('click', ()=> { doLogout(); });

  // theme bindings
  document.querySelectorAll('.theme-swatch').forEach(el=>{
    el.addEventListener('click', ()=>{
      const c = el.getAttribute('data-color');
      if(c) applyMainColor(c, true);
    });
  });
  if($('themeBackBtn')) $('themeBackBtn').addEventListener('click', ()=> { showSettings(); });

  if($('privacyBackBtn')) $('privacyBackBtn').addEventListener('click', ()=> { showSettings(); });
  
  // bottom nav bindings
  if($('navHomeBtn')) $('navHomeBtn').addEventListener('click', ()=> { showHome(); });
  if($('navtodivideBtn')) $('navtodivideBtn').addEventListener('click', ()=> { sectionPage(); });
  if($('navChargeBtn')) $('navChargeBtn').addEventListener('click', ()=> { openChargePage(); });
  if($('navOrdersBtn')) $('navOrdersBtn').addEventListener('click', ()=> { showOrders(); });
  if($('navProfileBtn')) $('navProfileBtn').addEventListener('click', ()=> { showProfileSummary(); });

  // load profile from localStorage
  const saved = localStorage.getItem('user_profile_v1');
  if(saved){
    try{ currentProfile = JSON.parse(saved); }catch(e){ currentProfile = null; }
  }
  if(!currentProfile){
    let pn = localStorage.getItem('personalNumber');
    if(!pn){ pn = String(Math.floor(1000000 + Math.random()*9000000)); localStorage.setItem('personalNumber', pn); }
    currentProfile = { personalNumber: pn, name:'ضيف', email:'', phone:'', balance:0, canEdit:false };
    localStorage.setItem('user_profile_v1', JSON.stringify(currentProfile));
  }
  if(typeof refreshUIFromProfile === 'function') refreshUIFromProfile();
  
  // apply saved main color if موجود
  const savedColor = localStorage.getItem('app_main_color');
  if(savedColor) applyMainColor(savedColor, false);

  // show login or home
  const isGuest = (!currentProfile || !currentProfile.name || currentProfile.name === 'ضيف');
  const hasCreds = !!(currentProfile && currentProfile.password);
  if (isGuest || !hasCreds) { hideAllPages(); if($('loginPage')) showPageQuick('loginPage'); window.scrollTo({ top: 0 }); }
  else { showHome(); }

  // poll every 6s
  setInterval(()=>{
    try{ refreshNotificationsCount(); }catch(e){ console.warn('refreshNotificationsCount interval error', e); }
    try{ if(typeof fetchOffers === 'function') fetchOffers(); }catch(e){ console.warn('fetchOffers interval error', e); }
  }, 6000);

  // initial calls
  refreshNotificationsCount();
  if(typeof fetchOffers === 'function') fetchOffers();

  // Initialize section tiles (img placeholders and click handlers)
  initSectionsUI();
});

/* ---------- باقي الدوال كما في الأصل مع استبدال show... بدوال سريعة انبثاقية حيث يحتاج المستخدم ---------- */

function showHome(){
  // remove compact header for home
  setCompactHeader(false);
  hideAllPages(); show('homePage'); window.scrollTo({top:0});
}
function showGames(){ showPageQuick('gamesPage'); }
function showApps(){ showPageQuick('appsPage'); }
function showHelp(){ showPageQuick('helpPage'); }
function showProfile(){ showPageQuick('profilePage'); fillProfileFields(); }
function openChargePage(){
  $('pdTitle').textContent=' ';
  $('pdTopInfo').textContent='اطلب شحن الرصيد عبر رفع ايصال التحويل';
  showPageQuick('paymentDetailsPage');
}
function showOrders(){ showPageQuick('ordersPage'); loadOrdersList(); }
function showOffers(){ showPageQuick('offersPage'); fetchOffers(); }
function showProfileSummary(){ showPageQuick('profileSummaryPage'); window.scrollTo({top:0}); }
function showSettings(){ showPageQuick('settingsPage'); }

/* theme page */
function showThemePage(){ showPageQuick('themePage'); }

/* privacy */
function showPrivacy(){ showPageQuick('privacyPage'); }

// New: show benatak page and populate
function showBenatak(){
  showPageQuick('benatakPage');
  populateBenatak();
}
/* apply main color */
function applyMainColor(colorHex, save=true){
  try{
    document.documentElement.style.setProperty('--main-color', colorHex);
    if(save) localStorage.setItem('app_main_color', colorHex);
  }catch(e){ console.warn('applyMainColor error', e); }
}

function refreshUIFromProfile(){
  try{
    $('personalNum').textContent = currentProfile.personalNumber || '';
    if($('personalField')) $('personalField').value = currentProfile.personalNumber || '';
    if($('appPersonalField')) $('appPersonalField').value = currentProfile.personalNumber || '';
    if($('helpPersonalField')) $('helpPersonalField').value = currentProfile.personalNumber || '';
    if($('loginPersonalNumber')) $('loginPersonalNumber').value = currentProfile.personalNumber || '';

    $('sidebarName').textContent = currentProfile.name || 'ضيف';
    $('sidebarAvatar').textContent = 
      (currentProfile.name && currentProfile.name.trim().length>0) 
        ? currentProfile.name.trim().charAt(0).toUpperCase() 
        : 'أ';
    $('sidebarPersonal').textContent = 'رقمك الشخصي: ' + (currentProfile.personalNumber || '');

    if($('summaryName')) $('summaryName').textContent = currentProfile.name || 'ضيف';
    if($('summaryAvatar')) $('summaryAvatar').textContent = 
      (currentProfile.name && currentProfile.name.trim().length>0) 
        ? currentProfile.name.trim().charAt(0).toUpperCase() 
        : 'أ';
    if($('summaryPersonal')) $('summaryPersonal').textContent = 'رقمك الشخصي: ' + (currentProfile.personalNumber || '');

    // 👇 login badge
    try {
      if (document.getElementById('loginNum')) {
        document.getElementById('loginNum').textContent = 
          (currentProfile.loginNumber != null && currentProfile.loginNumber !== '') 
            ? String(currentProfile.loginNumber) 
            : '—';
      }
      const badge = document.getElementById('loginNumberBadge');
      if (badge) {
        if (currentProfile.loginNumber != null && currentProfile.loginNumber !== '') {
          badge.style.display = 'inline-flex';
        } else {
          badge.style.display = 'none';
        }
        badge.onclick = function(e){
          e.preventDefault();
          const txt = String(currentProfile.loginNumber || '');
          if(!txt || txt === 'null' || txt === 'undefined') 
            return alert('لا يوجد رقم دخول مسجل بعد.');
          if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(txt)
              .then(()=> alert('تم نسخ رقم الدخول: ' + txt))
              .catch(()=> { prompt('نسخ فشل — انسخ يدوياً:', txt); });
          } else {
            prompt('انسخ رقم الدخول يدوياً:', txt);
          }
        };
      }
    } catch(e) { console.warn('login badge error', e); }

    // 👇 balance
    const bal = Number(currentProfile.balance || 0);
    const bEl = $('balanceBox');
    if(bEl){
      bEl.textContent = ` ${bal.toLocaleString('en-US')} `;
      bEl.classList.remove('hidden');
      bEl.style.opacity = bal === 0 ? '0.85' : '1';
    }
  }catch(e){ 
    console.warn('refreshUIFromProfile error', e); 
  }
}

function fillProfileFields(){
  if($('profileName')) $('profileName').value = currentProfile.name || '';
  if($('profileEmail')) $('profileEmail').value = currentProfile.email || '';
  if($('profilePassword')) $('profilePassword').value = currentProfile.password || '';
  if($('profilePhone')) $('profilePhone').value = currentProfile.phone || '';
  applyProfileEditState();
}
function applyProfileEditState(){
  const canEdit = !!currentProfile.canEdit;
  ['profileName','profileEmail','profilePassword','profilePhone'].forEach(id=>{
    const el = $(id);
    if(!el) return;
    if(canEdit){ el.removeAttribute('readonly'); } else { el.setAttribute('readonly','readonly'); }
  });
  if(canEdit){ if($('requestEditBtn')) $('requestEditBtn').classList.add('hidden'); if($('confirmSaveBtn')) $('confirmSaveBtn').classList.remove('hidden'); if($('profileMsg')) $('profileMsg').textContent='يمكنك تعديل بياناتك الآن مرة واحدة ثم اضغط حفظ.'; }
  else { if($('requestEditBtn')) $('requestEditBtn').classList.remove('hidden'); if($('confirmSaveBtn')) $('confirmSaveBtn').classList.add('hidden'); if($('profileMsg')) $('profileMsg').textContent='للتعديل اطلب موافقة من الإدارة عبر الزر أدناه.'; }
}


// request profile edit
async function requestProfileEdit(){
  const ok = confirm('سيتم إرسال طلب تعديل بياناتك للإدارة. هل تريد المتابعة؟');
  if(!ok) return;

  // increment local counter for edit requests
  try{
    const personal = currentProfile.personalNumber;
    const key = 'profile_edit_requests_' + personal;
    const prev = parseInt(localStorage.getItem(key) || '0', 10) || 0;
    const now = prev + 1;
    localStorage.setItem(key, String(now));
    currentProfile.profileEditRequests = now;
    localStorage.setItem('user_profile_v1', JSON.stringify(currentProfile));
    if($('profileEditRequestsCount')) $('profileEditRequestsCount').textContent = String(now);
  }catch(e){ console.warn('increment edit counter', e); }

  try{
    const resp = await fetch(API_ROOT + 'api/profile/request-edit', {
      method:'POST',
      headers:{'content-type':'application/json'},
      body: JSON.stringify({ personal: currentProfile.personalNumber })
    });
    const data = await resp.json().catch(()=>null);
    if (data && data.ok) {
      alert('تم إرسال طلب التعديل. انتظر موافقة الإدارة.');
      if($('requestEditBtn')) $('requestEditBtn').textContent='تم إرسال الطلب';
      setTimeout(() => { if($('requestEditBtn')) $('requestEditBtn').textContent='طلب تعديل معلوماتك'; }, 10000);
    } else {
      alert('فشل الإرسال');
    }
  }catch(e){ console.error('requestProfileEdit error', e); alert('خطأ في الاتصال'); }
}

async function confirmProfileSave(){
  const name = $('profileName').value.trim();
  const email = $('profileEmail').value.trim();
  const password = $('profilePassword').value;
  const phone = $('profilePhone').value.trim();

  if(email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){
    alert('البريد غير صالح');
    return;
  }

  try {
    const resp = await fetch(API_ROOT + 'api/profile/submit-edit', {
      method:'POST',
      headers:{'content-type':'application/json'},
      body: JSON.stringify({
        personal: currentProfile.personalNumber,
        name, email, password, phone
      })
    });
    const data = await resp.json().catch(()=>null);

    if(data && data.ok){
      if(data.profile){
        currentProfile = Object.assign({}, currentProfile, data.profile);
      } else {
        currentProfile.name = name || currentProfile.name;
        currentProfile.email = email || currentProfile.email;
        currentProfile.password = password || currentProfile.password;
        currentProfile.phone = phone || currentProfile.phone;
      }
      currentProfile.canEdit = false;
      localStorage.setItem('user_profile_v1', JSON.stringify(currentProfile));

      alert('تم حفظ التعديلات');
      applyProfileEditState();
      refreshUIFromProfile();
    } else {
      alert('لا يمكنك التعديل الآن: ' + (data && data.error ? data.error : 'خطأ غير معروف'));
    }
  } catch(err){
    console.error(err);
    alert('فشل الاتصال بالخادم');
  }
}

// help submit
async function submitHelp(){
  const issue = $('helpIssueSelect').value;
  const fileLink = $('helpFileLink').value;
  const desc = $('helpDesc').value.trim();
  const personal = currentProfile.personalNumber;
  if(!issue){ alert('اختر مشكلتك'); return; }
  try{
    const resp = await fetch(API_ROOT + 'api/help', {
      method:'POST', headers:{'content-type':'application/json'},
      body: JSON.stringify({ personal, issue, fileLink, desc, name: currentProfile.name, email: currentProfile.email, phone: currentProfile.phone })
    });
    const data = await resp.json().catch(()=>null);
    if(data && data.ok){ alert('تم ارسال المشكلة'); hide('helpPage'); showHome(); } else { alert('فشل الارسال'); }
  }catch(e){ console.error('submitHelp error', e); alert('خطأ في الاتصال'); }
}

// uploading to imgbb (client-side)
async function uploadFileToImgbb(file, targetInputId = 'paymentFileLink', statusElId='paymentUploadStatus'){
  if(!file) return;
  const statusEl = $(statusElId);
  if(statusEl) statusEl.textContent = 'جارية عملية الرفع... 0%';
  try{
    const IMGBB_KEY = "e5603dfd5675ed2b5a671577abcf6d33";
    const fd = new FormData();
    fd.append('image', file);
    const xhr = new XMLHttpRequest();
    xhr.open('POST', `https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`);
    xhr.onload = function(){
      if(xhr.status>=200 && xhr.status<300){
        try{
          const resp = JSON.parse(xhr.responseText||'{}');
          const url = resp && resp.data && (resp.data.url || resp.data.display_url);
          if(url){
            $(targetInputId).value = url;
            if(statusEl) statusEl.textContent = 'تم الرفع بنجاح';
            alert('تم رفع الملف');
          } else {
            if(statusEl) statusEl.textContent = 'فشل الرفع';
            alert('فشل رفع الملف');
          }
        }catch(e){ if(statusEl) statusEl.textContent = 'خطأ في الرفع'; alert('خطأ في رفع الملف'); }
      } else {
        if(statusEl) statusEl.textContent = 'فشل الرفع';
        alert('فشل الرفع: ' + xhr.status);
      }
    };
    xhr.onerror = function(){ if(statusEl) statusEl.textContent='خطأ في الشبكة'; alert('خطأ في الشبكة أثناء الرفع'); };
    xhr.upload.onprogress = function(ev){ if(ev.lengthComputable){ const pct = Math.round((ev.loaded/ev.total)*100); if(statusEl) statusEl.textContent = `جارية عملية الرفع... ${pct}%`; } };
    xhr.send(fd);
  }catch(e){ console.error(e); if($(statusElId)) $(statusElId).textContent = 'خطأ أثناء الرفع'; alert('خطأ أثناء الرفع'); }
}

/* ===== Unified Section + Store + Simple Order data & functions ===== */

// بيانات افتراضية (عدل او استبدل الصور بالروابط التي سترفعها)
const sectionsData = {
  "games": { title:"قسم الألعاب", subs:[ {key:'freefire', title:'فري فاير', img:'https://i.postimg.cc/Y0zZ36Cp/IMG-20250923-WA0056.jpg'},
  
  
   {key:'freefire2', title:'عضويات فري فاير ', img:'https://i.postimg.cc/Y0zZ36Cp/IMG-20250923-WA0056.jpg'},
  
  {key:'pubg', title:'PUBG', img:'https://i.postimg.cc/L6mrsbxh/IMG-20250923-WA0051.jpg'},
  
    {key:'pubg2', title:'عضويات ببجي', img:'https://i.postimg.cc/L6mrsbxh/IMG-20250923-WA0051.jpg'},
  
  
  {key:'blood', title:'بلود سترايك', img:'https://i.postimg.cc/651YNjSk/IMG-20250923-WA0054.jpg' },
  
    
  {key:'dlta', title:'دلتا فورس ', img:'https://i.postimg.cc/7ZF95CqX/IMG-20250923-WA0053.jpg'},
  
  
      
  {key:'duty', title:'كال اوف ديوتي  ', img:'https://i.postimg.cc/SNqJxm08/IMG-20250923-WA0121.jpg'},
  
      
  {key:'craft', title:' ماين كرافت ', img:'https://i.postimg.cc/Twr4dVmr/IMG-20250923-WA0062.jpg'},
  
      
  {key:'efoot', title:' E FOOTBALL ', img:'https://i.postimg.cc/dQzrwbnc/IMG-20250923-WA0123.jpg'},
  
      
  {key:'FC MOBILE', title:' FC MOBILE ', img:'https://i.postimg.cc/Pqr8STfY/IMG-20250923-WA0122.jpg'},
  
  
      
//  {key:'falaront', title:'فالورنت عالمي', img:'https://i.postimg.cc/HjD3s2jL/image.jpg'},
  
      
//  {key:'yalla', title:'YALLA LUDO', img:'https://i.postimg.cc/pXJ1XwYb/image.jpg'},
  
      
//  {key:'Ludoclub', title:' Ludo club ', img:'https://i.postimg.cc/90jJcbDQ/image.jpg'},
  
      
//  {key:'LudoWorld', title:' Ludo World ', img:'https://i.postimg.cc/cLj7shjG/image.jpg'},
  
      
//  {key:'Lordsmobile', title:' Lords mobile ', img:'https://i.postimg.cc/FsH03wXQ/image.jpg'},
  
      
  {key:'8BALLPOOL', title:' 8BALL POOL ', img:'https://i.postimg.cc/76WfLzkZ/IMG-20250923-WA0052.jpg'},
      
//  {key:'STUMBLEGUYS', title:' STUMBLE GUYS ', img:'https://i.postimg.cc/fWtVsZsy/image.jpg'}
  
  
  
  ] },
  
//<---التطبيقااااااتتتتتتتت--->

  "apps": { title:" التطبيقات", subs:[
      
        {key:'xena', title:'xena live', img:'https://i.postimg.cc/rmFhSKP4/IMG-20250923-WA0076.jpg'},
  
  
//  {key:'kwai', title:'kwai ', img:'https://i.postimg.cc/BnsqJ23v/image.jpg' },
  
    
//  {key:'yahlaan', title:' yaahlan chat ', img:'https://i.postimg.cc/sXZFY2z8/image.jpg'},
  
  
      
//  {key:'likee', title:' likee ', img:'https://i.postimg.cc/HxkgVW0Z/IMG-20250923-WA0075.jpg'},
  
      
//  {key:'soul', title:'soul u', img:'https://i.postimg.cc/Kv8NwHkc/image.jpg'},
  
      
//  {key:'ditto', title:'Ditto live', img:'https://i.postimg.cc/7hsgqqGH/image.jpg'},
  
      
//  {key:'tami', title:' Tami chat ', img:'https://i.postimg.cc/k5qDYkGf/image.jpg'},
  
  
      
//  {key:'chamet', title:'chamet ', img:'https://i.postimg.cc/bYCCyPjS/image.jpg'},
  
      
//  {key:'lmu', title:'Lmu ', img:'https://i.postimg.cc/XYQgVMhD/image.jpg'},
  
      
   {key:'ssood', title:'Sudfa chat', img:'https://i.postimg.cc/D0mnYf8J/IMG-20250923-WA0078.jpg'},
   
      {key:'aloo', title:'alo party', img:'https://i.postimg.cc/K8C7Fczw/IMG-20251023-WA0000.jpg'},
  
      
  {key:'poppo', title:'Poppo live', img:'https://i.postimg.cc/zGyHR57f/IMG-20250923-WA0077.jpg'},
  
      
//  {key:'tiktok', title:'TIK TOK', img:'https://i.postimg.cc/Rhtb02Yp/IMG-20250923-WA0079.jpg'},
  
      
//  {key:'olamet', title:'Olamet', img:'https://i.postimg.cc/t4WY5Fdd/image.jpg'},
  
      
  {key:'yooy', title:'yooy chat', img:'https://i.postimg.cc/mg1hgjZz/IMG-20250923-WA0080.jpg'},
  
  
  
  {key:'sugo1', title:'sugo', img:'https://i.postimg.cc/63WHN928/IMG-20251030-WA0007.jpg'},
  
  
//    {key:'taka', title:'taka live', img:'https://i.postimg.cc/fbvFYgJG/image.jpg'},
  
  
//  {key:'tada', title:'tada chat ', img:'https://i.postimg.cc/Y05J23Nn/image.jpg' },
  
    
//  {key:'yobi', title:'yobi chat', img:'https://i.postimg.cc/RCWhFZQK/image.jpg'},
  
  
      
//  {key:'yigo', title:'yigo chat', img:'https://i.postimg.cc/9QYFSRC5/image.jpg'},
  
      
//  {key:'hiha', title:'hiha chat', img:'https://i.postimg.cc/SsJSJg8k/image.jpg'},
  
      
//  {key:'hiyoo', title:'Hiyoo', img:'https://i.postimg.cc/MGGxF99V/image.jpg'},
  
      
//  {key:'imo', title:' iom ', img:'https://i.postimg.cc/q7kf5BFJ/IMG-20250923-WA0081.jpg'}
  
  ] },
  
  
//<---التطبيقااااااتتتتتتتت--->

  "rashq": { title:"الرشق", subs:[
      
        {key:'ins', title:' انستغرام', img:'https://i.postimg.cc/1X5RDcGQ/IMG-20250923-WA0086.jpg'},
  
  
  {key:'tok', title:'تيك توك ', img:'https://i.postimg.cc/52F45tC6/IMG-20250923-WA0085.jpg' },
  
    
  {key:'book', title:'  فيسبوك ', img:'https://i.postimg.cc/xTBYdS4Y/IMG-20250923-WA0084.jpg'},
  
  
      
  {key:'tuob', title:' يوتيوب ', img:'https://i.postimg.cc/RZr5BLWZ/IMG-20250923-WA0083.jpg'},
  
      
  {key:'gram', title:' تلجرام', img:'https://i.postimg.cc/25wPnp21/IMG-20250923-WA0082.jpg'}
  
  
  ] },
  
  
    
//<---التطبيقااااااتتتتتتتت--->

  "card": { title:"البطاقات", subs:[
      
    {key:'card1', title:' بطاقات جوجل', img:'https://i.postimg.cc/h41RBd9L/IMG-20250923-WA0088.jpg'},
  
  
  {key:'card2', title:'Steam ', img:'https://i.postimg.cc/ZRP24Gyb/IMG-20250923-WA0090.jpg' },
  
    
  {key:'card3', title:' visa ', img:'https://i.postimg.cc/QtM1d5FF/IMG-20250923-WA0089.jpg'},
  
  
      
  {key:'card4', title:' XBOX ', img:'https://i.postimg.cc/nVy0cFJn/IMG-20250923-WA0091.jpg'},
  
      
  {key:'card5', title:' shein', img:'https://i.postimg.cc/L5tfsMts/IMG-20250923-WA0092.jpg'}
  
  
  ] },
  
  
      
//<---التطبيقااااااتتتتتتتت--->

  "numb": { title:"الأرقام", subs:[
      
    {key:'numb1', title:' ارقام واتساب ', img:'https://i.postimg.cc/mrtXq9f8/image.jpg'},
  
  
  {key:'numb2', title:'ارقام تلجرام ', img:'https://i.postimg.cc/2SXT45bv/image.jpg' },
  
    
  {key:'numb3', title:' لجميع التطبيقات ', img:'https://i.postimg.cc/mZNwmj1T/image.jpg'},
  
  
      
  {key:'numb4', title:' ارقام عراقية ', img:'https://i.postimg.cc/VNC9nWcQ/image.jpg'},
  
      
  {key:'numb5', title:' ارقام سورية', img:'https://i.postimg.cc/k4PQcRnV/image.jpg'},
  
  {key:'numb6', title:' ارقام مغربية', img:'https://i.postimg.cc/wM6hKKRg/image.jpg'},
    
  {key:'numb7', title:' ارقام اوكرانية', img:'https://i.postimg.cc/L68zNpMV/image.jpg'}
  ] },
  
      
//<---التطبيقااااااتتتتتتتت--->

  "accau": { title:"حسابات جاهزة", subs:[
      
    {key:'acc', title:'chat gpt', img:'https://i.postimg.cc/wB1zV3Wd/image.jpg'},
  
  
  {key:'acc1', title:' Gimal ', img:'https://i.postimg.cc/1tDLCFwb/image.jpg' },
  
    
  {key:'acc2', title:'فيسبوك', img:'https://i.postimg.cc/qB2zHZpC/image.jpg'},
  
  
      
  {key:'acc3', title:'تيك توك', img:'https://i.postimg.cc/WzczJ0w3/image.jpg'},
  
      
  {key:'acc4', title:' snapchat ', img:'https://i.postimg.cc/yYL2bs36/image.jpg'}
  ] },
  
      
//<---التطبيقااااااتتتتتتتت--->

  "editor": { title:" برامج تصميم", subs:[
      
    {key:'editor', title:'Picsart ', img:'https://i.postimg.cc/tg7V067D/IMG-20250923-WA0096.jpg'},
  
  
  {key:'editor1', title:' CAPCUT ', img:'https://i.postimg.cc/xChvpRRK/IMG-20250923-WA0093.jpg' },
  
    
  {key:'editor2', title:'Canva pro', img:'https://i.postimg.cc/htBrq2qs/IMG-20250923-WA0094.jpg'},
  
  
      
  {key:'editor3', title:'Anghami plus ', img:'https://i.postimg.cc/vmSfDzCp/IMG-20250923-WA0095.jpg'}
  
  ] },
  
      
//<---التطبيقااااااتتتتتتتت--->

  "balances": { title:" قسم الرصيد ", subs:[
      
    {key:'balances1', title:'سريتيل كاش', img:'https://i.postimg.cc/05wsryLQ/IMG-20250923-WA0100.jpg'},
  
  
  {key:'balances2', title:' رصيد سريتيل ', img:'https://i.postimg.cc/sDPC90fC/IMG-20250923-WA0101.jpg' },
  
    
  {key:'balances3', title:'شام كاش', img:'https://i.postimg.cc/MHkg11hG/IMG-20250923-WA0099.jpg'},
  
  
      
  {key:'balances4', title:' MTN كاش ', img:'https://i.postimg.cc/SKJP5Z4s/IMG-20250923-WA0098.jpg'},
        
  {key:'balances5', title:'  رصيد MTN ', img:'https://i.postimg.cc/1tz3L1tF/IMG-20250923-WA0128.jpg'}
  
  ] }
};


// حزم لكل لعبة (قابلة للتعديل)
const gamePackages = {
  'freefire': [
    { id:'ff_100', title:'100 💎 + 10 ', note:'الوقت لقبول الطلب: من دقيقة حتى 3 ساعات', usdPrice: 0.98, img:'https://i.postimg.cc/Y0zZ36Cp/IMG-20250923-WA0056.jpg' },
    { id:'ff_210', title:'210 💎 + 21 ', note:'الوقت لقبول الطلب: من دقيقة حتى 3 ساعات', usdPrice: 1.96, img:'https://i.postimg.cc/Y0zZ36Cp/IMG-20250923-WA0056.jpg' },
    { id:'ff_530', title:'530 💎 + 53 ', note:'الوقت لقبول الطلب: من دقيقة حتى 3 ساعات!  ', usdPrice: 4.9, img:'https://i.postimg.cc/Y0zZ36Cp/IMG-20250923-WA0056.jpg' },
    { id:'ff_2200', title:'2200 💎 + 220 ', note:' الوقت لقبول الطلب: من دقيقة حتى 3 ساعات!  ', usdPrice: 19.6, img:'https://i.postimg.cc/Y0zZ36Cp/IMG-20250923-WA0056.jpg' }

  ],
  
  'freefire2': [  
      
      
//         { id:'ff_6', title:' حزمة ترقية المستوى 6 ', note:'الوقت لقبول الطلب: من دقيقة حتى  نصف ساعة! ', usdPrice: 0.552, img:'https://i.postimg.cc/Y0zZ36Cp/IMG-20250923-WA0056.jpg' },
  
  //  { id:'ff_10', title:'10 حزمة ترقية المستوى', note:'الوقت لقبول الطلب: من دقيقة حتى  نصف ساعة!', usdPrice: 0.850, img:'https://i.postimg.cc/Y0zZ36Cp/IMG-20250923-WA0056.jpg' },
    
  //  { id:'ff_15', title:'حزمة ترقية المستوى 15', note:'الوقت لقبول الطلب: من دقيقة حتى  نصف ساعة  ', usdPrice: 0.850, img:'https://i.postimg.cc/Y0zZ36Cp/IMG-20250923-WA0056.jpg' },
        
    
  //  { id:'ff_20', title:' حزمة ترقية المستوى 20 ', note:'الوقت لقبول الطلب: من دقيقة حتى  نصف ساعة!', usdPrice: 0.850, img:'https://i.postimg.cc/Y0zZ36Cp/IMG-20250923-WA0056.jpg' },
      
      
     //    { id:'ff_25', title:'حزمة ترقية المستوى 25', note:'الوقت لقبول الطلب: من دقيقة حتى  نصف ساعة! ', usdPrice: 0.850, img:'https://i.postimg.cc/Y0zZ36Cp/IMG-20250923-WA0056.jpg' },
  
   // { id:'ff_30', title:'حزمة ترقية المستوى 30', note:'الوقت لقبول الطلب: من دقيقة حتى  نصف ساعة!', usdPrice: 1.184, img:'https://i.postimg.cc/Y0zZ36Cp/IMG-20250923-WA0056.jpg' },
      
      
 //     { id:'ff_week', title:'عضوية اسبوعية (يدوية)', note:'الوقت لقبول الطلب من ساعة حتى 3 ساعات ', usdPrice: 2.352, img:'https://i.postimg.cc/jdSH8H8L/IMG-20250923-WA0124.jpg' },
  
   { id:'ff_week2', title:'عضوية اسبوعية (تلقائي)', note:'الوقت لقبول الطلب: من دقيقة حتى  نصف ساعة! ', usdPrice: 2.732, img:'https://i.postimg.cc/jdSH8H8L/IMG-20250923-WA0124.jpg' },
  
  //  { id:'ff_month', title:' عضوية شهرية (يدوي)', note:'الوقت لقبول الطلب من ساعة حتى 3 ساعات', usdPrice: 11.070, img:'https://i.postimg.cc/Ghgk64Nz/IMG-20250923-WA0125.jpg' },
    
    { id:'ff_month2', title:'عضوية شهرية (تلقائي)', note:'الوقت لقبول الطلب: من دقيقة حتى  نصف ساعة  ', usdPrice: 11.675, img:'https://i.postimg.cc/Ghgk64Nz/IMG-20250923-WA0125.jpg' },
        
    
    { id:'ff_boyah', title:'بوياه باس ', note:'   الوقت لقبول الطلب: من دقيقة حتى 3 ساعات!', usdPrice: 3.48, img:'https://i.postimg.cc/0ybNjfnR/IMG-20250923-WA0126.jpg' }
    ],
    
    
  'pubg': [

// <--- 60 شدة --->
    { id:'pubg_60', title:'60 UC ', note:' الوقت لقبول الطلب: من دقيقة حتى 3 ساعات! ', usdPrice: 0.973, img:'https://i.postimg.cc/L6mrsbxh/IMG-20250923-WA0051.jpg' },
    
       
// <--- 325 شدة --->
    { id:'pubg_120', title:'120 UC ', note:'الوقت لقبول الطلب: من دقيقة حتى 3 ساعات! ', usdPrice: 1.956,img:'https://i.postimg.cc/L6mrsbxh/IMG-20250923-WA0051.jpg' },
    
       
// <--- 325 شدة --->
    { id:'pubg_180', title:'180 UC ', note:'الوقت لقبول الطلب: من دقيقة حتى 3 ساعات! ', usdPrice: 2.929,img:'https://i.postimg.cc/L6mrsbxh/IMG-20250923-WA0051.jpg' },
    
    
    
    
// <--- 325 شدة --->
    { id:'pubg_240', title:'240 UC ', note:'الوقت لقبول الطلب: من دقيقة حتى 3 ساعات! ', usdPrice: 3.921,img:'https://i.postimg.cc/L6mrsbxh/IMG-20250923-WA0051.jpg' },
    
       
// <--- 325 شدة --->
    { id:'pubg_325', title:'325 UC ', note:'الوقت لقبول الطلب: من دقيقة حتى 3 ساعات! ', usdPrice: 4.789,img:'https://i.postimg.cc/L6mrsbxh/IMG-20250923-WA0051.jpg' },
    
       
// <--- 325 شدة --->
    { id:'pubg_360', title:'360 UC ', note:'الوقت لقبول الطلب: من دقيقة حتى 3 ساعات! ', usdPrice: 5.763,img:'https://i.postimg.cc/L6mrsbxh/IMG-20250923-WA0051.jpg' },
    
    
       
// <--- 325 شدة --->
    { id:'pubg_385', title:'385 UC ', note:'الوقت لقبول الطلب: من دقيقة حتى 3 ساعات! ', usdPrice: 5.842,img:'https://i.postimg.cc/L6mrsbxh/IMG-20250923-WA0051.jpg' },
    
       
// <--- 325 شدة --->
    { id:'pubg_565', title:'565 UC ', note:'الوقت لقبول الطلب: من دقيقة حتى 3 ساعات! ', usdPrice: 8.482,img:'https://i.postimg.cc/L6mrsbxh/IMG-20250923-WA0051.jpg' },
    
// <--- 660 شدة --->
    { id:'pubg_660', title:'660 UC ', note:'الوقت لقبول الطلب: من دقيقة حتى 3 ساعات! ', usdPrice: 9.359,img:'https://i.postimg.cc/L6mrsbxh/IMG-20250923-WA0051.jpg' },
    
       
// <--- 325 شدة --->
    { id:'pubg_840', title:'840 UC ', note:'الوقت لقبول الطلب: من دقيقة حتى 3 ساعات! ', usdPrice: 12.517,img:'https://i.postimg.cc/L6mrsbxh/IMG-20250923-WA0051.jpg' },
    
       
// <--- 325 شدة --->
    { id:'pubg_1045', title:'1045 UC ', note:'الوقت لقبول الطلب: من دقيقة حتى 3 ساعات! ', usdPrice:15.236 ,img:'https://i.postimg.cc/L6mrsbxh/IMG-20250923-WA0051.jpg' },
    
// <--- 1800 شدة --->
    { id:'pubg_1800', title:'1800 UC ', note:'الوقت لقبول الطلب: من دقيقة حتى 3 ساعات! ', priceText:'278650 ل.س',usdPrice: 23.570, img:'https://i.postimg.cc/L6mrsbxh/IMG-20250923-WA0051.jpg' },
    
       
// <--- 325 شدة --->
    { id:'pubg_3850', title:'3850 UC ', note:'الوقت لقبول الطلب: من دقيقة حتى 3 ساعات! ', usdPrice:45.938 ,img:'https://i.postimg.cc/L6mrsbxh/IMG-20250923-WA0051.jpg' }
    
],

 'pubg2': [ // <--- برايم شهر واحد --->
    { id:'pubg_prime1', title:'prime برايم شهر 1 ', note:'الوقت لقبول الطلب: من دقيقة حتى 3 ساعات! ',usdPrice: 1.377, img:'https://i.postimg.cc/L6mrsbxh/IMG-20250923-WA0051.jpg' },
    
// <--- برايم --->
    { id:'pupbg_brim2', title:'prime برايم 3 شهور', note:'الوقت لقبول الطلب: من دقيقة حتى 3 ساعات! ',usdPrice: 3.657, img:'https://i.postimg.cc/L6mrsbxh/IMG-20250923-WA0051.jpg' },

// <--- برايم --->
    { id:'pubg_prim3', title:'prime برايم 6 شهور ', note:'الوقت لقبول الطلب: من دقيقة حتى 3 ساعات! ',usdPrice: 6.728, img:'https://i.postimg.cc/L6mrsbxh/IMG-20250923-WA0051.jpg' },
    
// <---  --->
    { id:'plus', title:'برايم بلس شهر ', note:'الوقت لقبول الطلب: من دقيقة حتى 3 ساعات! ',usdPrice: 10.850, img:'https://i.postimg.cc/L6mrsbxh/IMG-20250923-WA0051.jpg' },
    
// <---  --->
    { id:'pluus', title:'برايم بلس 3 شهور', note:'الوقت لقبول الطلب: من دقيقة حتى 3 ساعات! ',usdPrice: 32.078, img:'https://i.postimg.cc/L6mrsbxh/IMG-20250923-WA0051.jpg' }
  ],
  
    'blood': [

// <---   --->
//    { id:'blood1', title:' BS 51 gold ', note:' الوقت لقبول الطلب: من دقيقة حتى 3 ساعات! ', usdPrice: 11.074,img:'https://i.postimg.cc/SNB37V5y/image.jpg' },
    
// <---   --->
    { id:'blood2', title:' BS 105 gold ', note:'الوقت لقبول الطلب: من دقيقة حتى 3 ساعات! ',usdPrice: 1.052, img:'https://i.postimg.cc/651YNjSk/IMG-20250923-WA0054.jpg' },
    
// <---   --->
    { id:'blood3', title:' BS 320 gola ', note:'الوقت لقبول الطلب: من دقيقة حتى 3 ساعات! ',usdPrice: 3.271, img:'https://i.postimg.cc/651YNjSk/IMG-20250923-WA0054.jpg' },
    
// <---   --->
    { id:'blood4', title:' BS 540 GOLD ', note:'الوقت لقبول الطلب: من دقيقة حتى 3 ساعات! ',usdPrice: 5.587, img:'https://i.postimg.cc/651YNjSk/IMG-20250923-WA0054.jpg' },
    
// <---    --->
    { id:'blood5', title:'BS 1100 GOLD', note:'الوقت لقبول الطلب: من دقيقة حتى 3 ساعات! ',usdPrice: 9.885, img:'https://i.postimg.cc/651YNjSk/IMG-20250923-WA0054.jpg' },
    
// <---  --->
    { id:'blood6', title:'BS 2260 GOLD', note:'الوقت لقبول الطلب: من دقيقة حتى 3 ساعات! ', usdPrice: 19.622, img:'https://i.postimg.cc/651YNjSk/IMG-20250923-WA0054.jpg' },
    
    { id:'blood7', title:'BS 5800 GOLD', note:'الوقت لقبول الطلب: من دقيقة حتى 3 ساعات! ', usdPrice: 49.640, img:'https://i.postimg.cc/651YNjSk/IMG-20250923-WA0054.jpg' },
    
    
    { id:'blood8', title:'strike pass elite', note:'الوقت لقبول الطلب: من دقيقة حتى 3 ساعات! ', usdPrice: 4.096, img:'https://i.postimg.cc/651YNjSk/IMG-20250923-WA0054.jpg' },
    
    { id:'blood9', title:'strike pass premium', note:'الوقت لقبول الطلب: من دقيقة حتى 3 ساعات! ', usdPrice: 9.885, img:'https://i.postimg.cc/651YNjSk/IMG-20250923-WA0054.jpg' }
    
  ],
  
      'dlta': [

// <---   --->
    { id:'dlta1', title:' 320 coins ', note:' الوقت لقبول الطلب: من دقيقة حتى 3 ساعات! ', priceText:'48000 ل.س', priceNum: 48000, img:'https://i.postimg.cc/7ZF95CqX/IMG-20250923-WA0053.jpg' },
    
// <---   --->
    { id:'dlta2', title:'460 coins', note:'الوقت لقبول الطلب: من دقيقة حتى 3 ساعات! ', priceText:'68500 ل.س', priceNum:68500, img:'https://i.postimg.cc/7ZF95CqX/IMG-20250923-WA0053.jpg' },
    
// <---   --->
    { id:'dlta3', title:'750 coins', note:'الوقت لقبول الطلب: من دقيقة حتى 3 ساعات! ', priceText:'95000 ل.س', priceNum:95000, img:'https://i.postimg.cc/7ZF95CqX/IMG-20250923-WA0053.jpg' },
    
// <---   --->
    { id:'dlta4', title:'1480 coins', note:'الوقت لقبول الطلب: من دقيقة حتى 3 ساعات! ', priceText:'190000 ل.س', priceNum:190000, img:'https://i.postimg.cc/7ZF95CqX/IMG-20250923-WA0053.jpg' },
    
// <---    --->
    { id:'dlta5', title:'1980 coins', note:'الوقت لقبول الطلب: من دقيقة حتى 3 ساعات! ', priceText:'240000 ل.س', priceNum:240000, img:'https://i.postimg.cc/7ZF95CqX/IMG-20250923-WA0053.jpg' },
    
// <---    --->
    { id:'dlta6', title:'3950 conis', note:'الوقت لقبول الطلب: من دقيقة حتى 3 ساعات! ', priceText:'471000 ل.س', priceNum:471000, img:'https://i.postimg.cc/7ZF95CqX/IMG-20250923-WA0053.jpg' },
    
// <---  --->
    { id:'dlta7', title:'8100 coins', note:'الوقت لقبول الطلب: من دقيقة حتى 3 ساعات! ', priceText:'950000 ل.س', priceNum:950000, img:'https://i.postimg.cc/7ZF95CqX/IMG-20250923-WA0053.jpg' }


  ],
  
      'duty': [

// <---   --->
    { id:'duty1', title:'88 point', note:' الوقت لقبول الطلب: من دقيقة حتى 3 ساعات! ', usdPrice: 1.447,img:'https://i.postimg.cc/SNqJxm08/IMG-20250923-WA0121.jpg' },
    
// <---   --->
    { id:'duty2', title:'460 point', note:'الوقت لقبول الطلب: من دقيقة حتى 3 ساعات! ',usdPrice: 5.969, img:'https://i.postimg.cc/SNqJxm08/IMG-20250923-WA0121.jpg' },
    
// <---   --->
    { id:'duty3', title:'960 point', note:'الوقت لقبول الطلب: من دقيقة حتى 3 ساعات! ',usdPrice: 10.228, img:'https://i.postimg.cc/SNqJxm08/IMG-20250923-WA0121.jpg' },
    
// <---   --->
    { id:'duty4', title:'2600 point', note:'الوقت لقبول الطلب: من دقيقة حتى 3 ساعات! ',usdPrice: 25.228, img:'https://i.postimg.cc/SNqJxm08/IMG-20250923-WA0121.jpg' },
    
// <---    --->
    { id:'duty5', title:'5400 point', note:'الوقت لقبول الطلب: من دقيقة حتى 3 ساعات! ',usdPrice: 47.245, img:'https://i.postimg.cc/SNqJxm08/IMG-20250923-WA0121.jpg' },
    
// <---  --->
    { id:'duty6', title:'BS 2260 GOLD', note:'الوقت لقبول الطلب: من دقيقة حتى 3 ساعات! ', usdPrice: 19.622, img:'https://i.postimg.cc/SNqJxm08/IMG-20250923-WA0121.jpg' },
    
    { id:'duty7', title:'BS 5800 GOLD', note:'الوقت لقبول الطلب: من دقيقة حتى 3 ساعات! ', usdPrice: 49.640, img:'https://i.postimg.cc/SNqJxm08/IMG-20250923-WA0121.jpg' },
    
    
    { id:'duty8', title:'strike pass elite', note:'الوقت لقبول الطلب: من دقيقة حتى 3 ساعات! ', usdPrice: 3.342, img:'https://i.postimg.cc/SNqJxm08/IMG-20250923-WA0121.jpg'},
    
    { id:'duty9', title:'strike pass premium', note:'الوقت لقبول الطلب: من دقيقة حتى 3 ساعات! ', usdPrice: 7.828, img:'https://i.postimg.cc/SNqJxm08/IMG-20250923-WA0121.jpg' }
    
  ]
};

const Packages = {
    apps: {
  'xena': [
    ],
  'ssood':[],
//  'yahlaan':[],
'sugo1':[],

  'likee':[],
  
//  'ditto':[],
//  'tami':[],
//  'chamet':[],
//  'lmu':[],
 // 'soul':[],
  'poppo':[],
  'tiktok':[],
 // 'olamet':[],
  'yooy':[],
 // 'taka':[],
 // 'tada':[],
 //'yobi':[],
 // 'yigo':[],
 // 'hiha':[],
 // 'hiyoo':[],
  'imo':[]
  
  },
  
    rashq: {
  'ins': [
    ],
  'tok':[],
  'book':[],

  'tuob':[],
  
  'gram':[]
  
  },
  
   card: {
  'card1': [
    ],
  'card2':[],
  'card3':[],

  'card4':[],
  
  'card5':[]

  },
  
  numb: {
  'numb1': [
    ],
  'numb2':[],
  'numb3':[],

  'numb4':[],
  
  'numb5':[],
  
  'numb6':[],
    
  'numb7':[]

  },
  
  accau: {
  'acc': [
    ],
  'acc1':[],
  'acc2':[],

  'acc3':[],
  
  'acc4':[]

  },
  
  editor: {
  'editor': [
    ],
  'editor1':[],
  'editor2':[],

  'editor3':[]

  }
};




// --- ADD: خريطة صور الأقسام عامة (اجعلها متاحة لبناء القوائم) ---
const SECTION_STATIC_IMAGES = {
  games: "https://i.postimg.cc/ZnMHVzC2/IMG-20251206-WA0004.jpg",
  apps: "https://i.postimg.cc/DyDnHxHd/IMG-20251206-WA0003.jpg",
  rashq: "https://i.postimg.cc/ZK9h8rnR/IMG-20251206-WA0007.jpg",
  card: "https://i.postimg.cc/TY5ZLfNv/IMG-20251206-WA0005.jpg",
  numb: "https://i.postimg.cc/0QN48sJR/IMG-20251206-WA0006.jpg",
  accau: "https://i.postimg.cc/Hnqv48Zq/IMG-20251206-WA0001.jpg",
  editor: "https://i.postimg.cc/q7mTcQsz/IMG-20251206-WA0002.jpg",
  balances: "https://i.postimg.cc/1RVQ6G4C/IMG-20251206-WA0008.jpg"
};
// -----------------------------------------------------------------

/* init: set images for section tiles and bind click */
function initSectionsUI(){
  // خريطة صور ثابتة للأقسام
  const staticImages = {
    games: "https://i.postimg.cc/rFprM82m/IMG-20250923-WA0059.jpg",
    apps:"https://i.postimg.cc/1zKm8qpZ/IMG-20250923-WA0048.jpg",
    rashq:"https://i.postimg.cc/Bn94Ngp0/IMG-20250923-WA0058.jpg",
    card:"https://i.postimg.cc/L8351wp7/IMG-20250923-WA0061.jpg",
    numb:"https://i.postimg.cc/GtDhhSKX/IMG-20250923-WA0055.jpg",
    accau:"https://i.postimg.cc/7YvZQwPd/IMG-20250923-WA0060.jpg",
    editor:"https://i.postimg.cc/XYs33b3V/IMG-20250923-WA0057.jpg",
    balances:"https://i.postimg.cc/0NpGXm43/IMG-20250923-WA0097.jpg"
  };

  document.querySelectorAll('#homePage .section-tile').forEach(tile=>{
    const key = tile.getAttribute('data-section');
    const img = tile.querySelector('img.placeholder');
    if(img){
      if(staticImages[key]){
        // صورة عامة ثابتة حسب القسم
        img.src = staticImages[key];
      } else {
        // fallback
        img.src = 'https://via.placeholder.com/200x120?text=img';
      }
    }
    // click handler
    tile.addEventListener('click', ()=> {
      const sec = tile.getAttribute('data-section');
      if(sec) openSection(sec);
    });
  });
}

/* openSection: show sectionPage and populate subs */
function openSection(sectionKey){
  const sd = sectionsData[sectionKey];
  if(!sd){
    alert('القسم غير موجود');
    return;
  }
  window._lastOpenedSection = sectionKey;
  const title = sd.title || '';
  if($('sectionPageTitle')) $('sectionPageTitle').textContent = title;
  const grid = $('sectionSubgrid'); if(!grid) return;
  grid.innerHTML = '';
  (sd.subs || []).forEach(sub=>{
    const d = document.createElement('div'); d.className = 'subcard';
    const img = document.createElement('img'); img.src = sub.img || 'https://via.placeholder.com/150x80?text=img'; img.alt = sub.title;
    const name = document.createElement('div'); name.textContent = sub.title;
    // بعد أن تخلق name = document.createElement('div');
name.textContent = sub.title;
name.style.fontWeight = '800';
name.style.width = '100%';
name.style.textAlign = 'right';
name.style.paddingRight = '8px';

// وتأكد أن البطاقة تصطف لليسار

    name.style.fontWeight='800';
    d.appendChild(img);
    d.appendChild(name);
    d.addEventListener('click', ()=>{
      // 1) إذا قسم الألعاب استعمل متجر الألعاب كما عندك
      if(sectionKey === 'games'){
        openGameStore(sub.key, sub.title);
        return;
      }

      // 2) إذا المستخدم عرّف Packages ولـ هذا القسم باقات، افتح المتجر العام للقسم
      const hasPackages = (typeof Packages !== 'undefined' && Packages);
      if(hasPackages){
        const secPack = Packages[sectionKey];
        if(secPack){
          // حالة: Packages[sectionKey] مصفوفة => باقات عامة للقسم
          if(Array.isArray(secPack)){
            openGenericStore(sectionKey, null, sub.title, secPack);
            return;
          }
          // حالة: Packages[sectionKey][sub.key] موجود => باقات خاصة بهذا التطبيق/المفتاح
          if(secPack[sub.key] && Array.isArray(secPack[sub.key])){
            openGenericStore(sectionKey, sub.key, sub.title, secPack[sub.key]);
            return;
          }
          // حالة: وجود "default" داخل Packages[sectionKey]
          if(secPack['default'] && Array.isArray(secPack['default'])){
            openGenericStore(sectionKey, null, sub.title, secPack['default']);
            return;
          }
        }
      }

      // 3) إفتراضي: افتح صفحة الطلب البسيط كما كان يفعل سابقاً
      openSimpleOrderGeneric(sub.title, sub.img, 0, sub.key, sectionKey);
    });
    grid.appendChild(d);
  });
  showPageQuick('sectionPage');
}

/* openGenericStore: يعرض باقات لأي قسم باستخدام نفس واجهة متاجر الألعاب (re-uses gameStorePage) */
function openGenericStore(sectionKey, subKey, displayTitle, pkgsArray){
  window._lastOpenedSectionStore = { section: sectionKey, key: subKey, title: displayTitle };
  const grid = $('gameStoreGrid'); if(!grid) { console.warn('missing gameStoreGrid element'); return; }
  const titleEl = $('gameStoreTitle'); if(titleEl) titleEl.textContent = `متجر ${displayTitle || sectionsData[sectionKey].title || sectionKey}`;
  grid.innerHTML = '';
  const pkgs = Array.isArray(pkgsArray) ? pkgsArray : [];

  if(pkgs.length === 0){
    grid.innerHTML = `<div style="text-align:center;color:#aaa;padding:20px;">لا توجد باقات حالياً</div>`;
  } else {
    pkgs.forEach(pkg=>{
      const d = document.createElement('div'); d.className = 'item-card';
      const img = document.createElement('img'); img.src = pkg.img || 'https://via.placeholder.com/120'; img.alt = pkg.title;
      const name = document.createElement('div'); name.textContent = pkg.title; name.style.fontWeight='800';
      const note = document.createElement('div'); note.textContent = pkg.note || ''; note.style.color='#ccc'; note.style.fontSize='13px';
      const price = document.createElement('div'); price.textContent = pkg.priceText || ''; price.style.color='var(--main-color)'; price.style.fontWeight='800';
      d.appendChild(img); d.appendChild(name); d.appendChild(note); d.appendChild(price);
      d.addEventListener('click', ()=> {
        openSimpleOrderFromPkg(pkg, displayTitle);
      });
      grid.appendChild(d);
    });
  }
  showPageQuick('gameStorePage'); // يعيد استخدام صفحة متجر الألعاب لعرض الباقات
}
/* openGameStore: show packages for a specific game (gameKey) */
function openGameStore(gameKey, gameTitle){
  window._lastOpenedGame = { key: gameKey, title: gameTitle };
  const grid = $('gameStoreGrid'); if(!grid) return;
  const titleEl = $('gameStoreTitle'); if(titleEl) titleEl.textContent = `متجر ${gameTitle}`;
  grid.innerHTML = '';
  const pkgs = gamePackages[gameKey] || [];
  if(pkgs.length === 0){
    grid.innerHTML = `<div style="text-align:center;color:#aaa;padding:20px;">لا توجد باقات حالياً</div>`;
  } else {
    pkgs.forEach(pkg=>{
      const d = document.createElement('div'); d.className = 'item-card';
      const img = document.createElement('img'); img.src = pkg.img || 'https://via.placeholder.com/120'; img.alt = pkg.title;
      const name = document.createElement('div'); name.textContent = pkg.title; name.style.fontWeight='800';
      const note = document.createElement('div'); note.textContent = pkg.note || ''; note.style.color='#ccc'; note.style.fontSize='13px';
      const price = document.createElement('div'); price.textContent = pkg.priceText || ''; price.style.color='var(--main-color)'; price.style.fontWeight='800';
      d.appendChild(img); d.appendChild(name); d.appendChild(note); d.appendChild(price);
      d.addEventListener('click', ()=> {
        openSimpleOrderFromPkg(pkg, gameTitle);
      });
      grid.appendChild(d);
    });
  }
  showPageQuick('gameStorePage');
}

/* openSimpleOrderFromPkg: عندما يضغط المستخدم على باقة من متجر اللعبة */
function openSimpleOrderFromPkg(pkg, gameTitle){
  if(!pkg) return;
  // fill the simple order page
  if($('simpleOrderImg')) $('simpleOrderImg').src = pkg.img || '';
  if($('simpleOrderItemName')) $('simpleOrderItemName').textContent = `${gameTitle} - ${pkg.title}`;
  if($('simpleOrderItemNote')) $('simpleOrderItemNote').textContent = pkg.note || '';
  if($('simpleUnitPrice')) $('simpleUnitPrice').value = (pkg.priceNum || pkg.priceNum === 0) ? String(pkg.priceNum) + ' ل.س' : (pkg.priceText || '');
  if($('simpleQty')) $('simpleQty').value = 1;
  if($('simpleIdField')) $('simpleIdField').value = '';
  if($('simplePersonal')) $('simplePersonal').value = currentProfile.personalNumber || '';
  
  // compute total
  const updateTotal = ()=>{
    const qty = Number(($('simpleQty') && $('simpleQty').value) || 1);
    const unit = Number(pkg.priceNum || 0);
    const total = qty * unit;
    if($('simpleTotalPrice')) $('simpleTotalPrice').value = total ? (total + ' ل.س') : '0 ل.س';
  };
  updateTotal();

  // listeners for qty change
  if($('simpleQty')) { $('simpleQty').oninput = updateTotal; }

  // set a handler for send button
  if($('simpleOrderSend')) {
    $('simpleOrderSend').onclick = async function(){
      const sendBtn = $('simpleOrderSend');
      const idField = $('simpleIdField') ? $('simpleIdField').value.trim() : '';
      const qty = Number(($('simpleQty') && $('simpleQty').value) || 1);

      if(!idField){ alert('ضع الايدي'); return; }
      const unit = Number(pkg.priceNum || 0);
      const total = unit * qty;

      // check balance
      const bal = Number(currentProfile.balance || 0);
      if(bal < total){ alert('مافي رصيد كافي'); return; }

      // ضع الزر في حالة "جارٍ الإرسال..."
      sendBtn.disabled = true;
      const oldText = sendBtn.textContent;
      sendBtn.textContent = "جارٍ الإرسال...";

      // deduct locally and update UI
      currentProfile.balance = bal - total;
      localStorage.setItem('user_profile_v1', JSON.stringify(currentProfile));
      refreshUIFromProfile();

      // prepare body
      const body = {
        personal: currentProfile.personalNumber,
        phone: currentProfile.phone,
        type: 'طلب سريع',
        item: `${gameTitle} - ${pkg.title}`,
        idField: idField,
        qty: qty,
        paidWithBalance: true,
        paidAmount: total
      };

      try{
        const r = await fetch(API_ROOT + 'api/orders', { 
          method:'POST', 
          headers:{'content-type':'application/json'}, 
          body: JSON.stringify(body) 
        });
        const data = await r.json().catch(()=>null);
        if(data && data.ok){
          hideAllPages(); 
          show('reviewPage'); 
          if($('reviewMsg')) $('reviewMsg').textContent = 'تم ارسال طلبك وسيتم مراجعته (مدفوع من رصيدك).';
          // store history locally
          try{
            const key = 'orders_history_' + (currentProfile.personalNumber || 'guest');
            const prev = JSON.parse(localStorage.getItem(key) || '[]');
            prev.push(Object.assign({}, data.order || {}, { localSavedAt: new Date().toISOString() }));
            localStorage.setItem(key, JSON.stringify(prev));
          }catch(e){}
        } else {
          alert('فشل ارسال الطلب');
        }
      }catch(e){ 
        console.error('simple order send', e); 
        alert('خطأ في الاتصال'); 
      } finally {
        // رجّع الزر لحالته الطبيعية
        sendBtn.disabled = false;
        sendBtn.textContent = oldText;
      }
    };
  }

  showPageQuick('simpleOrderPage');
}

/* generic opener for non-game simple orders */
function openSimpleOrderGeneric(title, img, priceNum=0, key=null, sectionKey=null){
  // For other sections, show simple order but price may be zero: user will be asked later or via payment flow
  const pkg = { id: key || ('pkg_' + Date.now()), title: title, note: title, priceText: priceNum ? (priceNum + ' ل.س') : 'سعر حسب الطلب', priceNum: priceNum || 0, img: img || '' };
  // mark last opened section so cancel goes back
  window._lastOpenedSection = sectionKey || null;
  openSimpleOrderFromPkg(pkg, title);
}

/* ----------- Existing build functions (kept for backward compatibility) ----------- */
function buildGameOptions(val){
  if($('optionsContainer')) $('optionsContainer').innerHTML='';
  selectedGameOption=''; if($('priceDisplay')) $('priceDisplay').textContent='';
  if(val==='فري فاير ايدي'){ currentMap = priceMapFF; currentMap_num = priceMapFF_num; }
  else if(val==='ببجي ايدي'){ currentMap = priceMapPUBG; currentMap_num = priceMapPUBG_num; }
  else if(val==='جواكر'){ currentMap = priceMappubg1; currentMap_num = priceMappubg1_num; }
  else { currentMap = null; currentMap_num = {}; }
  if(currentMap && $('optionsContainer')){
    Object.keys(currentMap).forEach(opt=>{
      const d = document.createElement('div'); d.className='button-option'; d.textContent = opt;
      d.addEventListener('click', ()=> {
        document.querySelectorAll('#optionsContainer .button-option').forEach(x=>x.classList.remove('selected'));
        d.classList.add('selected');
        selectedGameOption = opt;
        if($('priceDisplay')) { $('priceDisplay').textContent = `الحزمة: ${opt}\nالسعر: ${currentMap[opt]}`; $('priceDisplay').style.color='#0f0'; }
        updateSubmitButtonGames();
      });
      $('optionsContainer').appendChild(d);
    });
  }
}

function buildAppOptions(val){
  if($('optionsContainerApps')) $('optionsContainerApps').innerHTML='';
  selectedAppOption=''; if($('priceDisplayApps')) $('priceDisplayApps').textContent='';
  if(priceMapApps[val] && $('optionsContainerApps')){
    const d = document.createElement('div'); d.className='button-option'; d.textContent = val;
    d.addEventListener('click', ()=> {
      document.querySelectorAll('#optionsContainerApps .button-option').forEach(x=>x.classList.remove('selected'));
      d.classList.add('selected');
      selectedAppOption = val;
      if($('priceDisplayApps')) { $('priceDisplayApps').textContent = `السعر: ${priceMapApps[val]}`; $('priceDisplayApps').style.color='#0f0'; }
      updateSubmitButtonApps();
    });
    $('optionsContainerApps').appendChild(d);
  }
}

function updateSubmitButtonGames(){ const idf=$('idField') ? $('idField').value.trim() : ''; if($('submitForm')) $('submitForm').disabled = !(selectedGameOption && idf); }
function updateSubmitButtonApps(){ const idf=$('appIdField') ? $('appIdField').value.trim() : ''; if($('appSubmitForm')) $('appSubmitForm').disabled = !(selectedAppOption && idf); }

// helper: جلب البروفايل من السيرفر (fallback)
async function fetchProfileFromServer(personal) {
  try {
    const r = await fetch(API_ROOT + 'api/profile/' + personal);
    if (!r.ok) return null;
    const data = await r.json();
    if (data && data.ok && data.profile) return data.profile;
  } catch(e) { console.warn(e); }
  return null;
}

// عند التحميل: تجاهل القيم القديمة إذا كان السيرفر يعيد قيمة
async function fetchProfileFromServer(personalNumber) {
  if (!personalNumber) return null;
  try {
    const resp = await fetch(`http://localhost:3000/api/profile/${personalNumber}`);
    if (!resp.ok) return null;
    const data = await resp.json();
    return data.ok ? data.profile : null;
  } catch (e) {
    console.error('fetchProfileFromServer error', e);
    return null;
  }
}

async function loadProfile() {
  const prof = await fetchProfileFromServer(currentPersonal);
  if (prof) {
    currentProfile = prof;
    localStorage.setItem('user_profile_v1', JSON.stringify(currentProfile));
  }
  refreshUIFromProfile();
}

// استدعاء الدالة
loadProfile();

// order placement (uses balance)
async function placeOrderFromUI(fromPage){
  try{
    if(fromPage === 'gamesPage'){
      const personal = $('personalField').value;
      const game = $('gameSelect').value;
      const idField = $('idField').value.trim();
      const opt = selectedGameOption;
      if(!game || !idField || !opt){ alert('اكمل البيانات'); return; }
      let price = 0;
      if(currentMap_num && currentMap_num[opt]) price = Number(currentMap_num[opt]);
      else {
        const raw = $('priceDisplay') ? $('priceDisplay').textContent : '';
        price = parseInt((raw.replace(/\D/g,''))||0,10);
      }
      await attemptChargeAndSendOrder({ personal, phone: currentProfile.phone, type:'شحن لعبة', item: `${game} - ${opt}`, idField, paidAmount: price });
    } else if(fromPage === 'appsPage'){
      const personal = $('appPersonalField').value;
      const app = $('appSelect').value;
      const idField = $('appIdField').value.trim();
      const opt = selectedAppOption;
      if(!app || !idField || !opt){ alert('اكمل البيانات'); return; }
      let price = priceMapApps_num[opt] || 0;
      await attemptChargeAndSendOrder({ personal, phone: currentProfile.phone, type:'شراء تطبيق', item: `${app} - ${opt}`, idField, paidAmount: price });
    } else {
      alert('مصدر غير معروف للطلب');
    }
  }catch(e){
    console.error('placeOrderFromUI', e);
    alert('خطأ أثناء إرسال الطلب');
  }
}

async function attemptChargeAndSendOrder(orderBody){
  const bal = Number(currentProfile.balance || 0);
  const price = Number(orderBody.paidAmount || 0);

  if (isNaN(price) || price <= 0) {
    alert('تعذر تحديد سعر الحزمة');
    return;
  }
  if (bal < price) {
    alert('مافي رصيد كافي');
    return;
  }

  // وضع مؤشر التحميل على الصفحة
  const prevCursor = document.body.style.cursor || '';
  document.body.style.cursor = 'wait';

  const body = {
    personal: orderBody.personal,
    phone: orderBody.phone,
    type: orderBody.type,
    item: orderBody.item,
    idField: orderBody.idField || '',
    fileLink: orderBody.fileLink || '',
    cashMethod: orderBody.cashMethod || '',
    paidWithBalance: true,
    paidAmount: price
  };

  try {
    const r = await fetch(API_ROOT + 'api/orders', {
      method: 'POST',
      headers: { 'content-type': 'application/json' },
      body: JSON.stringify(body)
    });

    const data = await r.json().catch(() => null);

    if (r.ok && data && data.ok) {
      // مزامنة الرصيد من السيرفر إن رجع profile
      if (data.profile) {
        currentProfile = data.profile;
        localStorage.setItem('user_profile_v1', JSON.stringify(currentProfile));
        if (typeof refreshUIFromProfile === 'function') refreshUIFromProfile();
      } else {
        // fallback: حاول جلب البروفايل من endpoint مخصص
        const prof = await fetchProfileFromServer(orderBody.personal);
        if (prof) {
          currentProfile = prof;
          localStorage.setItem('user_profile_v1', JSON.stringify(currentProfile));
          if (typeof refreshUIFromProfile === 'function') refreshUIFromProfile();
        }
      }

      // عرض صفحة المراجعة وتخزين آخر معرف طلب
      hideAllPages();
      show('reviewPage');
      if ($('reviewMsg')) $('reviewMsg').textContent = 'تم ارسال طلبك وسيتم مراجعته (مدفوع من رصيدك).';
      localStorage.setItem('lastOrderId', data.order && data.order.id ? data.order.id : '');

      // تخزين الطلب محلياً للتاريخ (اختياري)
      try {
        const key = 'orders_history_' + (currentProfile && currentProfile.personalNumber ? currentProfile.personalNumber : 'guest');
        const prev = JSON.parse(localStorage.getItem(key) || '[]');
        prev.push(Object.assign({}, data.order || {}, { localSavedAt: new Date().toISOString() }));
        localStorage.setItem(key, JSON.stringify(prev));
      } catch (e) {
        console.warn('local order save failed', e);
      }

      document.body.style.cursor = prevCursor;
      return;
    } else {
      // رفض السيرفر للطلب أو خطأ منطقي — لا نخصم شيئاً محلياً
      document.body.style.cursor = prevCursor;
      const errMsg = (data && data.error) ? data.error : 'فشل ارسال الطلب';
      alert('فشل ارسال الطلب: ' + errMsg + '\nلم يتم خصم رصيدك.');
      // مزامنة احتياطية للبروفايل لو السيرفر رجع معلومات مصغّرة
      const prof = data && data.profile ? data.profile : null;
      if (prof) {
        currentProfile = prof;
        localStorage.setItem('user_profile_v1', JSON.stringify(currentProfile));
        if (typeof refreshUIFromProfile === 'function') refreshUIFromProfile();
      }
      return;
    }
  } catch (e) {
    console.error('order send error', e);
    document.body.style.cursor = prevCursor;
    alert('خطأ في الاتصال بالسيرفر — لم يتم خصم رصيدك.');
    // محاولة مزامنة بروفايل احتياطية
    const prof = await fetchProfileFromServer(orderBody.personal).catch(()=>null);
    if (prof) {
      currentProfile = prof;
      localStorage.setItem('user_profile_v1', JSON.stringify(currentProfile));
      if (typeof refreshUIFromProfile === 'function') refreshUIFromProfile();
    }
    return;
  }
}

// بقية الدوال: refreshNotificationsCount, markNotificationsReadForCurrentUser, loadOrdersList, fetchOffers, onPdCashChange, toggleQr, submitPaymentDetails
// (تم تضمينها كما في الملف الأصلي مع تعديلات بسيطة لتسجيل الشحنات محلياً — لتظهر في صفحة "بيناتك")

async function refreshNotificationsCount(){
  try{
    if(!currentProfile || !currentProfile.personalNumber) return;
    const resp = await fetch(API_ROOT + 'api/notifications/' + currentProfile.personalNumber);
    const data = await resp.json().catch(()=>null);
    if(!data || !data.ok) return;

    const serverCanEdit = !!(data.canEdit || (data.profile && data.profile.canEdit));
    if(serverCanEdit !== !!currentProfile.canEdit){
      currentProfile.canEdit = serverCanEdit;
      localStorage.setItem('user_profile_v1', JSON.stringify(currentProfile));
      if(typeof applyProfileEditState === 'function') applyProfileEditState();
    }

    if(data.profile && typeof data.profile.balance !== 'undefined'){
      const serverBal = Number(data.profile.balance || 0);
      if(serverBal !== Number(currentProfile.balance || 0)){
        currentProfile.balance = serverBal;
        localStorage.setItem('user_profile_v1', JSON.stringify(currentProfile));
        if(typeof refreshUIFromProfile === 'function') refreshUIFromProfile();
      }
    }

    const offers = data.offers || [];
    const orders = data.orders || [];
    const charges = data.charges || [];
    const notifications = data.notifications || [];
    const unreadCount = (orders.filter(o=>o.replied).length) + (charges.filter(c=>c.replied).length) + (offers.length>0 ? 1 : 0) + (notifications.filter(n=>!n.read).length);
    if(unreadCount>0){ $('notifBadge').classList.remove('hidden'); $('notifBadge').textContent = String(unreadCount); } else { $('notifBadge').classList.add('hidden'); }
  }catch(err){ console.warn('refreshNotificationsCount error', err); }
}

async function markNotificationsReadForCurrentUser(){
  if(!currentProfile || !currentProfile.personalNumber) return;
  try{
    const resp = await fetch(API_ROOT + 'api/notifications/mark-read', {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify({ personal: currentProfile.personalNumber })
    });
    const data = await resp.json().catch(()=>null);
    if(data && data.ok){ $('notifBadge').classList.add('hidden'); return true; }
  }catch(e){ console.warn('mark-read body failed', e); }
  try{
    const r2 = await fetch(API_ROOT + 'api/notifications/mark-read/' + currentProfile.personalNumber, { method:'POST' });
    const d2 = await r2.json().catch(()=>null);
    if(d2 && d2.ok){ $('notifBadge').classList.add('hidden'); return true; }
  }catch(e){ console.warn('mark-read param failed', e); }
  return false;
}

async function loadOrdersList(){
  try{
    const personal = currentProfile.personalNumber;
    const resp = await fetch(API_ROOT + 'api/notifications/' + personal);
    const data = await resp.json().catch(()=>null);
    if(data && data.ok){
      const orders = data.orders || [];
      const charges = data.charges || [];
      const container = $('ordersList'); if(container) container.innerHTML = '';
if(orders.length === 0 && charges.length === 0) {
    if(container) container.innerHTML = `

    `;
    return;
}
      orders.forEach(o=>{
        const d = document.createElement('div'); d.className='order-item';
        d.innerHTML = `<strong>#${o.id}</strong> - ${o.type} - ${o.item || ''} <br> الايدي: ${o.idField || ''} <br> الهاتف: ${o.phone || ''} <br> الحالة: <strong>${o.status}</strong> <br> أنشئ: ${new Date(o.createdAt).toLocaleString()}`;
        if(container) container.appendChild(d);
      });
      charges.forEach(c=>{
        const d = document.createElement('div'); d.className='order-item';
        d.innerHTML = `<strong>#${c.id}</strong> - شحن رصيد - المبلغ: ${c.amount} <br> الحالة: <strong>${c.status}</strong> <br> أنشئ: ${new Date(c.createdAt).toLocaleString()}`;
        if(container) container.appendChild(d);
      });
    }
  }catch(e){ console.error('loadOrdersList error', e); }
}


// payment flow
let previousBeforePayment = null;
function showPaymentDetailsFromSubmit(fromPage){
  previousBeforePayment = fromPage;
  hideAllPages(); show('paymentDetailsPage');
  if($('pdTopInfo')) $('pdTopInfo').textContent = '';
  if($('pdPriceInfo')) $('pdPriceInfo').textContent = '';
  if($('pdCashSelect')) $('pdCashSelect').value = '';
  if($('pdCopyField')) $('pdCopyField').value = '';
  if($('qrContainer')) $('qrContainer').style.display='none';
  if($('syrtelQrContainer')) $('syrtelQrContainer').style.display='none';
  if($('usdtQrContainer')) $('usdtQrContainer').style.display='none';
  if($('paymentFileLink')) $('paymentFileLink').value = '';
  if($('paymentUploadStatus')) $('paymentUploadStatus').textContent = '';
  if($('pdNote')) $('pdNote').textContent = 'اختر طريقة الدفع لمتابعة التعليمات';
  if($('shamFields')) $('shamFields').style.display='none';
  if($('syrtelFields')) $('syrtelFields').style.display='none';
  if($('hawalaFields')) $('hawalaFields').style.display='none';
    if($('codeFields')) $('codeFields').style.display='none';
  if($('usdtFields')) $('usdtFields').style.display='none';
}
function returnFromPaymentDetails(){ if(previousBeforePayment==='gamesPage') showGames(); else if(previousBeforePayment==='appsPage') showApps(); else showHome(); }

function onPdCashChange(){
  const value = $('pdCashSelect').value;
  const pdNoteEl = $('pdNote');
  if(value==='sham'){
    if($('shamFields')) $('shamFields').style.display='block';
    if($('syrtelFields')) $('syrtelFields').style.display='none';
    if($('hawalaFields')) $('hawalaFields').style.display='none';
    if($('codeFields')) $('codeFields').style.display='none';
    if($('usdtFields')) $('usdtFields').style.display='none';
    if($('qrContainer')) $('qrContainer').style.display='none';
    if($('syrtelQrContainer')) $('syrtelQrContainer').style.display='none';
    if($('usdtQrContainer')) $('usdtQrContainer').style.display='none';
    if($('pdCopyField')) $('pdCopyField').value = 'e5eca798a4add8f1b86d389330131c82';
    if(pdNoteEl) pdNoteEl.textContent = `1- انسخ عنوان محفظة شام كاش
2- ادخل لتطبيق شام كاش
3- في الاعلى هناك زر شخص وعليه اشارة موجب ضع النص المنسوخ او امسح ال QR
4- قم بتحويل المبلغ
5- ثم اذهب للتحويلات في الاسفل وخذ لقطة شاشة وارفقها بالاعلى للتحقق من تحويلك للرصيد`;
  } else if(value==='syrtel'){
    if($('shamFields')) $('shamFields').style.display='none';
    if($('syrtelFields')) $('syrtelFields').style.display='block';
    if($('hawalaFields')) $('hawalaFields').style.display='none';
    if($('codeFields')) $('codeFields').style.display='none';
    if($('usdtFields')) $('usdtFields').style.display='none';
    if($('pdCopyField')) $('pdCopyField').value = '72289118';
    if(pdNoteEl) pdNoteEl.textContent = `1- انسخ عنوان محفظة سيرتيل كاش
2- ادخل لتطبيق اقرب اليك
3- في اسفل اليسار زر سيرتيل كاش
4- اختر التحويل اليدوي
5- ضع المبلغ     
6- ادخل للسجل واختر التحويلات الصادرة، خد لقطة شاشة او اثناء عملية التحويل
7- ضع الصورة في الملف بالاعلى للتحقق من تحويلك من قبل الآدمن
`;
  } else if(value==='hawala'){
    if($('shamFields')) $('shamFields').style.display='none';
    if($('syrtelFields')) $('syrtelFields').style.display='none';
    if($('usdtFields')) $('usdtFields').style.display='none';
    if($('codeFields')) $('codeFields').style.display='none';
    if($('hawalaFields')) $('hawalaFields').style.display='block';
    if($('pdCopyField')) $('pdCopyField').value = 'تفاصيل الحوالة:عبد الرحمن احمد عتون .حمص سوريا   ';
    if(pdNoteEl) pdNoteEl.textContent = ``;
  } else if(value==='code'){
    if($('shamFields')) $('shamFields').style.display='none';
    if($('syrtelFields')) $('syrtelFields').style.display='none';
    if($('usdtFields')) $('usdtFields').style.display='none';
    if($('codeFields')) $('codeFields').style.display='block';
    if($('hawalaFields')) $('hawalaFields').style.display='none';
    if($('pdCopyField')) $('pdCopyField').value = 'ضع كود فيبرو المخصص بالملاحظة وقم برفع لقطة شاشة للكود ';
    if(pdNoteEl) pdNoteEl.textContent = ``;
  } else if(value==='usdt'){
    if($('shamFields')) $('shamFields').style.display='none';
    if($('syrtelFields')) $('syrtelFields').style.display='none';
    if($('usdtFields')) $('usdtFields').style.display='block';
    if($('hawalaFields')) $('hawalaFields').style.display='none';
        if($('codeFields')) $('codeFields').style.display='none';
    if($('pdCopyField')) $('pdCopyField').value = '(0x7359516D035235261fC946145b64853B9fa5C2ca)  : BEP20 ';
    if(pdNoteEl) pdNoteEl.textContent = ``;
    
  } else {
    if($('shamFields')) $('shamFields').style.display='none';
    if($('syrtelFields')) $('syrtelFields').style.display='none';
    if($('hawalaFields')) $('hawalaFields').style.display='none';
    if($('codeFields')) $('codeFields').style.display='none';
    if($('pdCopyField')) $('pdCopyField').value = '';
    if(pdNoteEl) pdNoteEl.textContent = 'اختر طريقة الدفع لمتابعة التعليمات';
  }
}

function toggleQr(){
  const m = $('pdCashSelect') ? $('pdCashSelect').value : '';
  if(m==='sham'){ if($('qrContainer')) $('qrContainer').style.display = $('qrContainer').style.display === 'none' ? 'block' : 'none'; }
  else if(m==='usdt'){ if($('usdtQrContainer')) $('usdtQrContainer').style.display = $('usdtQrContainer').style.display === 'none' ? 'block' : 'none'; }
  else if(m==='syrtel'){ if($('syrtelQrContainer')) $('syrtelQrContainer').style.display = $('syrtelQrContainer').style.display === 'none' ? 'block' : 'none'; }
  else alert('صورة QR غير متاحة لهذه الطريقة');
}

async function submitPaymentDetails(){
  const cashMethod = $('pdCashSelect') ? $('pdCashSelect').value : '';
  const fileLink = $('paymentFileLink') ? $('paymentFileLink').value : '';
  if(!cashMethod){ alert('اختر طريقة الدفع'); return; }

  const submitBtn = $('pdSubmitForm') || null;
  if (submitBtn) { submitBtn.disabled = true; submitBtn.textContent = '...جاري الإرسال'; }

  try {
    if(previousBeforePayment === 'gamesPage'){
      const personal = $('personalField').value;
      const game = $('gameSelect').value;
      const idField = $('idField').value;
      if(!game || !idField || !selectedGameOption){ alert('اكمل البيانات'); return; }
      const body = { personal, phone: currentProfile.phone, type: 'شحن لعبة', item: `${game} - ${selectedGameOption}`, idField, fileLink, cashMethod, paidWithBalance: true, paidAmount: 0 };
      const data = await postJsonWithTimeout('api/orders', body, 3000);
      if (data && data.ok) {
        await refreshProfileFromServer(currentProfile.personalNumber);
        hideAllPages(); show('reviewPage');
        if($('reviewMsg')) $('reviewMsg').textContent = 'تم إرسال طلبك وسيتم مراجعته';
        if (data.order && data.order.id) try{ localStorage.setItem('lastOrderId', data.order.id); }catch(e){}
      } else {
        alert('فشل إرسال الطلب: ' + (data && data.error ? data.error : 'خطأ'));
      }
    } else if(previousBeforePayment === 'appsPage'){
      const personal = $('appPersonalField').value;
      const app = $('appSelect').value;
      const idField = $('appIdField').value;
      if(!app || !idField || !selectedAppOption){ alert('اكمل البيانات'); return; }
      const body = { personal, phone: currentProfile.phone, type: 'شحن تطبيق', item: `${app} - ${selectedAppOption}`, idField, fileLink, cashMethod, paidWithBalance: true, paidAmount: 0 };
      const data = await postJsonWithTimeout('api/orders', body, 3000);
      if (data && data.ok) {
        await refreshProfileFromServer(currentProfile.personalNumber);
        hideAllPages(); show('reviewPage');
        if($('reviewMsg')) $('reviewMsg').textContent = 'تم إرسال طلب التطبيق وسيتم مراجعته';
        if (data.order && data.order.id) try{ localStorage.setItem('lastOrderId', data.order.id); }catch(e){}
      } else {
        alert('فشل إرسال الطلب: ' + (data && data.error ? data.error : 'خطأ'));
      }
    } else {
      // charge (شحن رصيد)
       const personal = currentProfile.personalNumber;
      // read amount from the input field instead of prompt
      const amountInputEl = document.getElementById('chargeAmountInput');
      const amount = amountInputEl && amountInputEl.value ? Number(amountInputEl.value) : NaN;
      if (isNaN(amount) || amount <= 0) { alert('الرجاء إدخال مبلغ صالح في حقل المبلغ.'); if (amountInputEl) amountInputEl.focus(); return; }
      const method = cashMethod || 'unknown';
      const data = await postJsonWithTimeout('api/charge', { personal, phone: currentProfile.phone, amount, method, fileLink }, 3000);
if (data && data.ok) {
        try{
          const key = 'charges_history_' + personal;
          const prev = JSON.parse(localStorage.getItem(key) || '[]');
          const rec = { amount: Number(amount), method: method, createdAt: new Date().toISOString(), status: data.charge && data.charge.status ? data.charge.status : 'pending', serverId: (data.charge && data.charge.id) || null };
          prev.push(rec);
          localStorage.setItem(key, JSON.stringify(prev));
        }catch(e){ console.warn('save local charge', e); }
        await refreshProfileFromServer(personal);
        alert('تم ارسال طلب الشحن. انتظر موافقة الإدارة وسيتم تحديث رصيدك بعد التأكيد.');
        hideAllPages(); if(typeof showHome === 'function') showHome();
      } else {
        alert('فشل ارسال طلب الشحن: ' + (data && data.error ? data.error : 'خطأ'));
      }
    }
  } catch (e) {
    console.error('submitPaymentDetails error', e);
    alert('خطأ في الاتصال أو انتهاء المهلة');
  } finally {
    if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = 'إرسال الطلب'; }
  }
}


/* ---------- New: populate benatak data ---------- */
async function populateBenatak(){
  try{
    if(!currentProfile || !currentProfile.personalNumber) return;
    const personal = currentProfile.personalNumber;

    // server charges & orders
    let serverCharges = [];
    let serverOrders = [];
    try{
      const resp = await fetch(API_ROOT + 'api/notifications/' + personal);
      const data = await resp.json().catch(()=>null);
      if(data && data.ok){
        serverCharges = data.charges || [];
        serverOrders = data.orders || [];
      }
    }catch(e){ console.warn('populateBenatak: server fetch failed', e); }

    // local fallback (في حال السيرفر ما رجع بيانات)
    let localTotal = 0;
    if(serverCharges.length === 0){
      const localKey = 'charges_history_' + personal;
      const localCharges = JSON.parse(localStorage.getItem(localKey) || '[]');
      localTotal = localCharges.reduce((s,c)=> s + (Number(c.amount)||0), 0);
    }

    // إذا في بيانات من السيرفر استعملها، غير هيك استعمل المحلي
    const totalTopups = serverCharges.length > 0
      ? serverCharges.reduce((s,c)=> s + (Number(c.amount)||0), 0)
      : localTotal;

    // compute order counts
    const orders = serverOrders.length
      ? serverOrders
      : (JSON.parse(localStorage.getItem('orders_history_' + personal) || '[]'));
    let accepted = 0, rejected = 0, pending = 0;
    (orders || []).forEach(o=>{
      const s = (o.status || '').toString().toLowerCase();
      if(/رفض|مرفوض|rejected|declined/.test(s)) rejected++;
      else if(/مقبول|قبول|accepted|approved|done/.test(s)) accepted++;
      else pending++;
    });

    // profile edit requests count
    const editKey = 'profile_edit_requests_' + personal;
    const editCountLocal = Number(localStorage.getItem(editKey) || '0') || 0;
    const editCountProfile = Number(currentProfile.profileEditRequests || 0) || 0;
    const editCount = Math.max(editCountLocal, editCountProfile);

    // render values
    if($('totalTopupsValue')) $('totalTopupsValue').textContent = `${Number(totalTopups).toLocaleString('en-US')} ل.س`;
    if($('acceptedCount')) $('acceptedCount').textContent = String(accepted);
    if($('rejectedCount')) $('rejectedCount').textContent = String(rejected);
    if($('pendingCount')) $('pendingCount').textContent = String(pending);
    if($('profileEditRequestsCount')) $('profileEditRequestsCount').textContent = String(editCount);
  }catch(e){ console.error('populateBenatak error', e); }
}
document.querySelectorAll('.nav-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
  });
});
/* logout */
function doLogout(){
  const ok = confirm('هل أنت متأكد أنك تريد تسجيل الخروج؟');
  if(!ok) return;
  // clear login-sensitive keys but keep personalNumber
  const pn = localStorage.getItem('personalNumber');
  localStorage.clear();
  if(pn) localStorage.setItem('personalNumber', pn);
  // remove profile in-memory
  currentProfile = { personalNumber: pn, name:'ضيف', email:'', phone:'', balance:0, canEdit:false };
  localStorage.setItem('user_profile_v1', JSON.stringify(currentProfile));
  refreshUIFromProfile();
  hideAllPages();
  showPageQuick('loginPage');
}
// ===== دعم زر الرجوع في الهاتف (Back Button) =====
(function(){

  // نحفظ دالة showPageQuick القديمة (لو موجودة)
  const _origShowPageQuick = window.showPageQuick 
    ? window.showPageQuick 
    : function(id){ 
        hideAllPages(); 
        show(id); 
      };

  // نعرّف دالة جديدة تحل مكان القديمة
  window.showPageQuick = function(pageId, doPush = true){
    // استدعاء الأصلية لعرض الصفحة
    _origShowPageQuick(pageId);

    // نضيف للسجل (history) إذا مسموح
    if(doPush){
      try {
        history.pushState({page: pageId}, '', '#' + pageId);
      } catch(e){
        console.warn('history.pushState failed', e);
      }
    }
  };

  // عند تحميل أول مرة نحفظ حالة ابتدائية
  if(!history.state){
    history.replaceState({page: 'homePage'}, '', '#homePage');
  }

  // الاستماع لزر الرجوع في الجهاز
  window.addEventListener('popstate', function(evt){
    const state = evt.state;
    const page = state && state.page ? state.page : 'homePage';
    window.showPageQuick(page, false); // نرجع للصفحة السابقة بدون إضافة سجل جديد
  });

})();
(function(){
  // منع قائمة السياق (right-click / long-press menu) باستثناء الحقول القابلة للتحرير
  document.addEventListener('contextmenu', function(e){
    if (!e.target.closest('input, textarea, select, button, [contenteditable]')) {
      e.preventDefault();
    }
  }, {passive: false});

  // منع بدء التحديد (selectstart) على معظم العناصر
  document.addEventListener('selectstart', function(e){
    if (!e.target.closest('input, textarea, select, button, [contenteditable]')) {
      e.preventDefault();
    }
  }, {passive: false});

  // منع حدث النسخ (copy) خارج الحقول
  document.addEventListener('copy', function(e){
    if (!e.target.closest('input, textarea, select, button, [contenteditable]')) {
      e.preventDefault();
    }
  });

  // منع dragstart على الصور ولتعطيل السحب عن الصور
  document.querySelectorAll('img').forEach(function(img){
    img.setAttribute('draggable','false');
    img.addEventListener('dragstart', function(ev){ ev.preventDefault(); });
    // لمنع حفظ الصورة عبر long-press في بعض المتصفحات:
    img.addEventListener('contextmenu', function(ev){
      if (!ev.target.closest('input, textarea, select, button, [contenteditable]')) ev.preventDefault();
    });
  });

  // حماية إضافية ضد اللمسات المتعددة المزعجة (مثال: pinch)
  document.addEventListener('touchstart', function(e){
    if (e.touches && e.touches.length > 1) {
      e.preventDefault();
    }
  }, {passive:false});

  // اختياري: تابع وارجع لو أردت تفعيل/تعطيل سلوك الحظر ديناميكياً
  window.setUserSelectEnabled = function(enabled){
    if(enabled){
      document.documentElement.classList.remove('no-user-select');
    } else {
      document.documentElement.classList.add('no-user-select');
    }
  };

})();

(function(){
  const shareBtn = document.getElementById('summaryShareBtn');
  if(!shareBtn) return;

  const shareData = {
    title: 'تطبيق 4BE — شحن الألعاب',
    text: "• التطبيق الأول من نوعه بسوريا🔥\n\n> متوفر شحن كافة الألعاب والتطبيقات وبسوريا 😍🔥\nطرق الدفع:\nشام كاش 💵\nسيرتيل كاش 💵\nحوالات مالية 💵\nفينك تدفع وانت بسوريا متخيل؟\n\n\nرابط التنزيل مباشر:\nhttps://4bee.netlify.app/",
    url: 'https://4bee.netlify.app/'
  };

  function showToast(msg){
    try {
      // create single toast element
      let t = document.createElement('div');
      t.textContent = msg;
      t.style.position = 'fixed';
      t.style.bottom = '90px';
      t.style.left = '50%';
      t.style.transform = 'translateX(-50%)';
      t.style.background = 'rgba(0,0,0,0.9)';
      t.style.color = '#fff';
      t.style.padding = '10px 14px';
      t.style.borderRadius = '10px';
      t.style.boxShadow = '0 6px 18px rgba(0,0,0,0.5)';
      t.style.zIndex = 99999;
      t.style.fontSize = '14px';
      document.body.appendChild(t);
      setTimeout(()=> t.style.opacity = '0', 2500);
      setTimeout(()=> t.remove(), 3000);
    } catch(e){ alert(msg); }
  }

  shareBtn.addEventListener('click', async function(e){
    // try Web Share API
    if(navigator.share){
      try {
        await navigator.share(shareData);
        // optional: feedback
        showToast('تم فتح لوحة المشاركة');
        return;
      } catch(err){
        // user cancelled or error - fallback to copy
        console.warn('Share API error:', err);
      }
    }
    // fallback: copy text to clipboard
    const textToCopy = shareData.text + '\n' + shareData.url;
    if(navigator.clipboard && navigator.clipboard.writeText){
      navigator.clipboard.writeText(textToCopy).then(function(){
        showToast('تم نسخ نص المشاركة. الصقه في أي تطبيق لمشاركته.');
      }).catch(function(err){
        // last resort: prompt
        try {
          window.prompt('انسخ النص للمشاركة (اضغط Ctrl+C ثم Enter):', textToCopy);
        } catch(e){
          alert('انسخ النص: ' + textToCopy);
        }
      });
    } else {
      // fallback prompt
      try {
        window.prompt('انسخ النص للمشاركة (اضغط Ctrl+C ثم Enter):', textToCopy);
      } catch(e){
        alert('انسخ النص: ' + textToCopy);
      }
    }
  });
})();

async function loadProfile(){
  const personal = currentPersonal || localStorage.getItem('user_personal') || '';
  if(!personal) {
    refreshUIFromProfile && refreshUIFromProfile();
    return;
  }
  try{
    const r = await fetch(API_ROOT + 'api/profile/' + encodeURIComponent(personal));
    if(r.status === 404){
      // ملف غير موجود — أمسك الحالة محلياً
      currentProfile = null;
      currentPersonal = '';
      localStorage.removeItem('user_personal');
      localStorage.removeItem('user_profile_v1');
      refreshUIFromProfile && refreshUIFromProfile();
      return;
    }
    const d = await r.json().catch(()=>null);
    if(d && d.ok && d.profile){
      currentProfile = d.profile;
      currentPersonal = String(d.profile.personalNumber || personal);
      localStorage.setItem('user_personal', currentPersonal);
      localStorage.setItem('user_profile_v1', JSON.stringify(currentProfile));
    }
  }catch(e){
    console.warn('loadProfile error', e);
  }finally{
    refreshUIFromProfile && refreshUIFromProfile();
  }
}

// نفّذها عند بداية تحميل الصفحة
document.addEventListener('DOMContentLoaded', () => {
  loadProfile();
});

(async function(){
  // helper
  function $id(id){ return document.getElementById(id); }

  // 1) اخفاء حقل الرقم الشخصي في صفحة تسجيل الدخول (حسب رغبتك)
  try {
    const pInp = $id('loginPersonalNumber');
    if (pInp) {
      pInp.style.display = 'none';
      // hide its label (افتراض: label قبله)
      const prev = pInp.previousElementSibling;
      if (prev && prev.tagName.toLowerCase() === 'label') prev.style.display = 'none';
    }
  } catch(e){ console.warn('hide personal field error', e); }



  // helper: call profile/check by email or personal
  async function checkProfileOnSheet({ personal, email }){
    try {
      const q = new URLSearchParams();
      if (personal) q.set('personal', personal);
      if (email) q.set('email', email);
      const resp = await fetch(API_ROOT + 'api/profile/check?' + q.toString());
      const d = await resp.json().catch(()=>null);
      return d;
    } catch(e){ console.warn('checkProfile error', e); return null; }
  }

  // when user edits email/name in login form, check sheet (debounced minimal)
  let checkTimer = null;
  ['loginEmail','loginName'].forEach(id=>{
    const el = $id(id);
    if (!el) return;
    el.addEventListener('input', () => {
      if (checkTimer) clearTimeout(checkTimer);
      checkTimer = setTimeout(async ()=>{
        const email = ($id('loginEmail') && $id('loginEmail').value.trim()) || '';
        const name = ($id('loginName') && $id('loginName').value.trim()) || '';
        if (!email && !name) {
          if (createBtn) createBtn.style.display = 'none';
          return;
        }
        const r = await checkProfileOnSheet({ email });
        // show create button only when not found in sheet
        if (r && r.ok && r.found === false) {
          if (createBtn) createBtn.style.display = 'block';
        } else {
          if (createBtn) createBtn.style.display = 'none';
        }
      }, 600);
    });
  });

  // create account button handler -> calls /api/register (which also appends to sheet via safeUpsert).
  if (createBtn) {
    createBtn.addEventListener('click', async () => {
      try {
        const name = ($id('loginName') && $id('loginName').value.trim()) || '';
        const email = ($id('loginEmail') && $id('loginEmail').value.trim()) || '';
        const password = ($id('loginPassword') && $id('loginPassword').value) || '';
        const phone = ($id('loginPhone') && $id('loginPhone').value.trim()) || '';
        // send register request (server will upsert row into Sheets via your existing /api/register)
        const resp = await fetch(API_ROOT + 'api/register', {
          method:'POST',
          headers:{ 'content-type':'application/json' },
          body: JSON.stringify({ name, email, password, phone, personalNumber: '' })
        });
        const data = await resp.json().catch(()=>null);
        if (data && data.ok && data.profile) {
          // set local session and refresh UI
          currentProfile = data.profile;
          currentPersonal = String(data.profile.personalNumber || '');
          try{ localStorage.setItem('user_personal', currentPersonal); localStorage.setItem('user_profile_v1', JSON.stringify(currentProfile)); localStorage.setItem('is_logged_in', '1'); }catch(e){}
          if (typeof refreshUIFromProfile === 'function') refreshUIFromProfile();
          if (typeof showHome === 'function') showHome();
          alert(' تم إنشاء الحساب  ');
          createBtn.style.display = 'none';
        } else {
          alert('فشل إنشاء الحساب');
        }
      } catch(e){ console.error('create account error', e); alert('خطأ في الاتصال'); }
    });
  }

  // 3) عند الضغط على زر تسجيل الدخول: دالة doLogin لديك موجودة.
  //    نتركها تعمل كما هي — فهي تتعامل مع /api/login. لكن نضيف خطوة إضافية:
  //    بعد تسجيل الدخول نضمن مزامنة البيانات من الشيت فورًا (باستدعاء /api/profile)
  const originalDoLogin = window.doLogin;
  window.doLogin = async function(){
    try {
      // call original login (keeps auth behavior)
      if (typeof originalDoLogin === 'function') {
        await originalDoLogin();
      }
    } finally {
      // after original login attempt: if we have currentPersonal, sync with /api/profile
      try {
        const personal = currentPersonal || (localStorage.getItem && localStorage.getItem('user_personal'));
        if (personal) {
          const resp = await fetch(API_ROOT + 'api/profile?personal=' + encodeURIComponent(personal));
          const d = await resp.json().catch(()=>null);
          if (d && d.ok && d.profile) {
            currentProfile = Object.assign({}, currentProfile || {}, d.profile);
            currentPersonal = String(d.profile.personalNumber || d.profile.personal || personal);
            try{ localStorage.setItem('user_personal', currentPersonal); localStorage.setItem('user_profile_v1', JSON.stringify(currentProfile)); localStorage.setItem('is_logged_in','1'); }catch(e){}
            if (typeof refreshUIFromProfile === 'function') refreshUIFromProfile();
            if (typeof fillProfileFields === 'function') fillProfileFields();
          }
        }
      } catch(e){ console.warn('post-login sync error', e); }
    }
  };

  // 4) عند فتح التطبيق: لو الجلسة موجودة، استدعي /api/profile للـ sync الفوري
  window.addEventListener('load', async ()=>{
    try {
      const isLogged = (localStorage.getItem && localStorage.getItem('is_logged_in')) === '1';
      const storedPersonal = (localStorage.getItem && localStorage.getItem('user_personal')) || null;
      if (isLogged && storedPersonal) {
        const resp = await fetch(API_ROOT + 'api/profile?personal=' + encodeURIComponent(storedPersonal));
        const d = await resp.json().catch(()=>null);
        if (d && d.ok && d.profile) {
          currentProfile = d.profile;
          currentPersonal = String(d.profile.personalNumber || storedPersonal);
          try{ localStorage.setItem('user_profile_v1', JSON.stringify(currentProfile)); }catch(e){}
          if (typeof refreshUIFromProfile === 'function') refreshUIFromProfile();
          if (typeof fillProfileFields === 'function') fillProfileFields();
          // optional: show profile page automatically
        }
      }
    } catch(e){ console.warn('initial profile sync error', e); }
  });

})();

(async function(){
  function $id(id){ return document.getElementById(id); }


  // Helper to show message
  function showLoginError(msg){
    const errEl = $id('loginError');
    if(errEl){ errEl.textContent = msg; errEl.style.display = msg ? 'block' : 'none'; }
  }

  // override existing doLogin (or define if absent)
  const originalDoLogin = window.doLogin;
  window.doLogin = async function(){
    // use existing validation UI but handle server responses differently
    const name = ($id('loginName') && $id('loginName').value.trim()) || '';
    const email = ($id('loginEmail') && $id('loginEmail').value.trim()) || '';
    const password = ($id('loginPassword') && $id('loginPassword').value) || '';
    const phone = ($id('loginPhone') && $id('loginPhone').value.trim()) || '';
    showLoginError('');

    if (!name) { showLoginError('الرجاء إدخال الاسم'); return; }
    if (!password) { showLoginError('الرجاء إدخال كلمة السر'); return; }
    if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { showLoginError('صيغة البريد الإلكتروني غير صحيحة'); return; }

    try {
      const payload = { name, email, password, phone };
      const resp = await fetch(API_ROOT + 'api/login', {
        method:'POST', headers:{'content-type':'application/json'},
        body: JSON.stringify(payload)
      });
      const data = await resp.json().catch(()=>null);
      if(!data){ alert('استجابة غير صالحة من الخادم'); return; }

      if (data.ok && data.found === true && data.profile) {
        // login success: set local session & update UI
        currentProfile = Object.assign({}, currentProfile || {}, data.profile);
        currentPersonal = String(data.profile.personalNumber || '');
        try{ localStorage.setItem('user_personal', currentPersonal); localStorage.setItem('user_profile_v1', JSON.stringify(currentProfile)); localStorage.setItem('is_logged_in','1'); }catch(e){}
        // fill personal number input
        if($id('loginPersonalNumber')) $id('loginPersonalNumber').value = currentPersonal;
        if (typeof refreshUIFromProfile === 'function') refreshUIFromProfile();
        if (typeof showHome === 'function') showHome();
        // hide create button
        if(createBtn) createBtn.style.display = 'none';
        return;
      }

      // not found -> show create button
      if (data.ok && data.found === false) {
        showLoginError('لم يتم العثور على حسابك انشئ حساب جديد الآن');
        if (createBtn) createBtn.style.display = 'inline-block';
        return;
      }

      // other errors
      if (!data.ok) {
        showLoginError(data.error || 'حدث خطأ أثناء تسجيل الدخول');
        return;
      }

    } catch (e) {
      console.error('doLogin error', e);
      showLoginError('خطأ في الاتصال بالخادم');
    }
  }; // end doLogin override

  // create account handler
  if (createBtn) {
    createBtn.addEventListener('click', async ()=>{
      const name = ($id('loginName') && $id('loginName').value.trim()) || '';
      const email = ($id('loginEmail') && $id('loginEmail').value.trim()) || '';
      const password = ($id('loginPassword') && $id('loginPassword').value) || '';
      const phone = ($id('loginPhone') && $id('loginPhone').value.trim()) || '';
      showLoginError('');

      if (!name || !password) { showLoginError('الاسم وكلمة السر مطلوبان لإنشاء الحساب'); return; }

      try {
        const payload = { name, email, password, phone };
        const resp = await fetch(API_ROOT + 'api/register', {
          method:'POST', headers:{'content-type':'application/json'},
          body: JSON.stringify(payload)
        });
        const data = await resp.json().catch(()=>null);
        if (!data) { alert('استجابة غير صالحة من الخادم'); return; }
        if (data.ok && data.profile) {
          currentProfile = Object.assign({}, currentProfile || {}, data.profile);
          currentPersonal = String(data.profile.personalNumber || '');
          try{ localStorage.setItem('user_personal', currentPersonal); localStorage.setItem('user_profile_v1', JSON.stringify(currentProfile)); localStorage.setItem('is_logged_in','1'); }catch(e){}
          if($id('loginPersonalNumber')) $id('loginPersonalNumber').value = currentPersonal;
          if (typeof refreshUIFromProfile === 'function') refreshUIFromProfile();
          if (typeof showHome === 'function') showHome();
          createBtn.style.display = 'none';
          alert('تم إنشاء الحساب.');
          return;
        } else {
          showLoginError(data.error || 'فشل إنشاء الحساب');
        }
      } catch(e){
        console.error('create account error', e);
        showLoginError('خطأ في الاتصال عند إنشاء الحساب');
      }
    });
  }

})();


(function(){
  const header = document.getElementById('topHeader');
  const notif = document.getElementById('notifBell');
  const home = document.getElementById('homePage'); // الصفحة الرئيسية
  const main = document.getElementById('mainContent');

  if(!header || !notif) return; // شرط أمان

  // إنشاء wrapper البحث (نحطها قبل notif حتى تظهر جهة اللوغو)
  const wrap = document.createElement('div');
  wrap.id = 'searchWrapHeadehr';
  wrap.innerHTML = `

    <input id="headerSearchInput" type="search" placeholder="اكتب للبحث..." autocomplete="off" aria-label="بحث">
    <div id="searchResultsBox" role="listbox" aria-label="نتائج البحث"></div>
  `;
  // ادراج قبل الاشعارات حتى تكون بين اللوغو والجرس
  header.insertBefore(wrap, notif);

  // عناصر البحث (موجودة في ملفك سابقاً، نعيد ربطهم)
  const toggleBtn = document.getElementById('searchToggleBtn');
  const input = document.getElementById('headerSearchInput');
  const resultsBox = document.getElementById('searchResultsBox');

  // نفس وظائف الفهرس والتصفية الموجودة في ملفك - يمكنك ترك باقي الكود كما هو
  function normalize(s){ return (s||'').toString().toLowerCase().replace(/\s+/g,' ').trim(); }

  // إعادة بناء الفهرس تماماً كما في ملفك (مقتبس من كودك الأصلي)
  function buildIndex(){
    const idx = [];
    if(!home) return idx;
    home.querySelectorAll('.section-tile').forEach(el=>{
      const title = (el.querySelector('.section-name')?.textContent || el.getAttribute('title') || '').trim();
      const key = el.dataset.section || '';
      if(title) idx.push({type:'section', title:title, el, key});
    });
    home.querySelectorAll('.subcard').forEach(el=>{
      const title = (el.textContent || el.querySelector('div')?.textContent || el.querySelector('img')?.alt || '').trim();
      if(title) idx.push({type:'subcard', title, el});
    });
    home.querySelectorAll('.item-card').forEach(el=>{
      const title = (el.querySelector('.title')?.textContent || el.textContent || '').trim();
      if(title) idx.push({type:'item', title, el});
    });
    try{
      if(typeof sectionsData !== 'undefined' && sectionsData && typeof sectionsData === 'object'){
        Object.keys(sectionsData).forEach(secKey=>{
          const sec = sectionsData[secKey];
          const sectTitle = sec.title || secKey;
          idx.push({type:'sectionData', title: sectTitle, key:secKey});
          (sec.subs || []).forEach(sub=>{
            if(sub && sub.title) idx.push({type:'sectionDataSub', title: sub.title, sectionKey: secKey, subKey: sub.key || sub.title});
          });
        });
      }
    }catch(e){}
    const seen = new Map();
    idx.forEach(it => { const k = normalize(it.title); if(k && !seen.has(k)) seen.set(k, it); });
    return Array.from(seen.values());
  }

  let index = buildIndex();
  const mo = new MutationObserver(()=>{ index = buildIndex(); });
  if(home) mo.observe(home, {childList:true, subtree:true});

  // وظائف عرض النتائج (يمكنك إعادة استخدام كودك الأصلي هنا)
  function renderResults(list){
    if(!list || !list.length){
      resultsBox.innerHTML = '<div class="no-results">لا توجد نتائج</div>';
      resultsBox.classList.add('show'); return;
    }
    resultsBox.innerHTML = list.slice(0,50).map(it=>{
      let meta = it.type || '';
      if(it.type === 'sectionDataSub') meta = 'عنصر داخل ' + (it.sectionKey || '');
      return `<div class="search-result" data-title="${it.title.replace(/"/g,'&quot;')}"><strong>${it.title}</strong><span class="meta">${meta}</span></div>`;
    }).join('');
    resultsBox.classList.add('show');
  }
  function hideResults(){ resultsBox.classList.remove('show'); resultsBox.innerHTML = ''; }

  // تفاعل الزر والحقل
  toggleBtn.addEventListener('click', (e)=>{ e.stopPropagation(); const open = input.classList.toggle('open'); if(open){ input.focus(); input.select && input.select(); index = buildIndex(); } else { input.value=''; hideResults(); } });

  document.addEventListener('click', function(ev){ if(!header.contains(ev.target)){ input.classList.remove('open'); hideResults(); } });

  input.addEventListener('input', function(){
    const q = normalize(this.value);
    if(!q){ hideResults(); return; }
    const results = index.filter(it => normalize(it.title).includes(q));
    renderResults(results);
  });

  resultsBox.addEventListener('click', function(ev){
    const row = ev.target.closest('.search-result'); if(!row) return;
    const title = row.dataset.title; if(!title) return;
    const found = index.find(it => normalize(it.title) === normalize(title)); if(!found) return;
    try{
      if(found.el){ try{ found.el.click(); }catch(e){} try{ found.el.scrollIntoView({behavior:'smooth', block:'center'}); }catch(e){} }
      else if(found.type === 'sectionData'){ if(typeof openSection === 'function') openSection(found.key); else { const tile = document.querySelector(`#homePage .section-tile[data-section="${found.key}"]`); tile && tile.click(); } }
      else if(found.type === 'sectionDataSub'){ if(typeof openSection === 'function') openSection(found.sectionKey); else { const tile = document.querySelector(`#homePage .section-tile[data-section="${found.sectionKey}"]`); tile && tile.click(); }
        setTimeout(()=>{ const candidates = Array.from(document.querySelectorAll('.subcard')); const target = candidates.find(c => normalize(c.textContent||'').includes(normalize(found.title))); if(target){ try{ target.click(); target.scrollIntoView({behavior:'smooth', block:'center'}); }catch(e){} } }, 240);
      } else { alert(found.title || 'فتح العنصر'); }
    }catch(e){}
    input.value = ''; input.classList.remove('open'); hideResults();
  });

  // === إظهار/إخفاء زر البحث حسب وجود الصفحة الرئيسية ===
  function updateSearchVisibility(){
    const isHomeVisible = !!(home && !home.classList.contains('hidden') && document.body.contains(home) && getComputedStyle(home).display !== 'none');
    wrap.style.display = isHomeVisible ? 'inline-flex' : 'none';
  }
  updateSearchVisibility();
  // راقب تغيّر الصفحات داخل mainContent لسهولة الإظهار/الإخفاء
  if(main){
    const moPages = new MutationObserver(updateSearchVisibility);
    moPages.observe(main, {childList:true, subtree:true, attributes:true, attributeFilter:['class','style']});
  }
})();
document.addEventListener("DOMContentLoaded", function () {
  const searchBtn = document.getElementById("searchToggleBtn");
  const searchInput = document.getElementById("headerSearchInput");
  const notifBtn = document.getElementById("notifBell");   // زر الإشعارات
  const balanceBox = document.getElementById("balanceBox"); // الرصيد

  // نضيف الكلاس fade-toggle للإشعارات والرصيد
  [notifBtn, balanceBox].forEach(el => {
    if (el) el.classList.add("fade-toggle");
  });

  if (!searchBtn || !searchInput) return;

  searchBtn.addEventListener("click", function () {
    const open = searchInput.classList.contains("open");
    if (open) {
      if (notifBtn) notifBtn.classList.add("hidden");
      if (balanceBox) balanceBox.classList.add("hidden");
    } else {
      if (notifBtn) notifBtn.classList.remove("hidden");
      if (balanceBox) balanceBox.classList.remove("hidden");
    }
  });

  // لو ضغطت برا وانقفل البحث → رجعهم
  document.addEventListener("click", function (e) {
    if (!searchBtn.contains(e.target) && !searchInput.contains(e.target)) {
      if (!searchInput.classList.contains("open")) {
        if (notifBtn) notifBtn.classList.remove("hidden");
        if (balanceBox) balanceBox.classList.remove("hidden");
      }
    }
  });
});
(function(){
  const header = document.getElementById('topHeader') || document.querySelector('header');
  const input = document.getElementById('headerSearchInput');
  const searchBtn = document.getElementById('searchToggleBtn');

  if(!header || !input) return;

  // تحديث الحالة: لو الحقل به كلاس 'open' -> نفعل search-active على الهيدر
  function updateHeaderSearchState(){
    if(input.classList.contains('open')){
      header.classList.add('search-active');
    } else {
      header.classList.remove('search-active');
    }
  }

  // راقب تغيّر الـ class على حقل البحث (يتم التبديل في كودك الأصلي)
  const mo = new MutationObserver(updateHeaderSearchState);
  mo.observe(input, { attributes: true, attributeFilter: ['class'] });

  // لو ضغط على زر البحث، انتظر تغيّر الحالة ثم حدّث (بعض الأوقات يُدار في كود آخر)
  if(searchBtn){
    searchBtn.addEventListener('click', function(e){
      // تأخير صغير ليكمل الكود الأصلي تغييره ثم نقرأ الحالة
      setTimeout(updateHeaderSearchState, 10);
    });
  }

  // لو النقر برا حقل البحث وبرا زر البحث -> نتحقق ونغلق
  document.addEventListener('click', function(e){
    if (!input.contains(e.target) && !(searchBtn && searchBtn.contains(e.target))) {
      // تأخير بسيط لأن كود آخر قد يكون يزيل الـ open بعد حدث click
      setTimeout(updateHeaderSearchState, 10);
    }
  });

  // زر Escape يغلق البحث ويعيد كل شيء
  document.addEventListener('keydown', function(e){
    if(e.key === 'Escape'){
      input.classList.remove('open');
      header.classList.remove('search-active');
    }
  });

  // حالة أولية
  updateHeaderSearchState();
})();

(function(){
  // أنشئ العنصر وألصقه داخل الهيدر
  const header = document.getElementById('topHeader') || document.querySelector('header') || document.body;
  const vip = document.createElement('div');
  vip.id = 'vipBadge';
  header.appendChild(vip);

  // دالة تحقق النصوص بحثًا عن VIP
  function containsVIP(text){
    if(!text) return false;
    return /\bVIP\b/i.test(text); // يطابق كلمة VIP مستقلة
  }

  function updateVIPVisibility(){
    const homePage = document.getElementById('homePage');

    // ✅ إذا لم نكن في الصفحة الرئيسية أو الصفحة الرئيسية مخفية → اخفي الشعار
    if(!homePage || homePage.classList.contains('hidden')) {
      vip.style.display = 'none';
      return;
    }

    // ✨ تحقق من وجود VIP
    const notifList = document.getElementById('notifList');
    const ordersStatus = document.getElementById('ordersStatusBar');
    const badge = document.getElementById('notifBadge');
    let combined = '';
    if(notifList) combined += ' ' + notifList.textContent;
    if(ordersStatus) combined += ' ' + ordersStatus.textContent;
    if(badge) combined += ' ' + badge.textContent;

    if(containsVIP(combined)) {
      vip.style.display = 'block';
      repositionBadge(); // ضبط الموقع بجانب اللوغو
    } else {
      vip.style.display = 'none';
    }
  }

  // نحاول وضع الشعار بجانب اللوغو (يسار الوسط)
  function repositionBadge(){
    const logo = document.getElementById('siteLogo');
    const topHeader = document.getElementById('topHeader') || document.querySelector('header');
    if(!logo || !topHeader) return;
    const headerRect = topHeader.getBoundingClientRect();
    const logoRect = logo.getBoundingClientRect();

    // نضع الشعار 8px على يسار اللوغو (عرض 50px)
    const left = (logoRect.left - headerRect.left) - (50 + 8);
    vip.style.left = Math.max(8, left) + 'px';
    // عمودياً نجعل مركزه مع منتصف اللوغو
    const top = (logoRect.top - headerRect.top) + (logoRect.height / 2);
    vip.style.top = top + 'px';
    vip.style.transform = 'translateY(-50%)';
  }

  // راقب التغييرات في عناصر الإشعارات وعداد الشارة
  const targets = [];
  const nl = document.getElementById('notifList');
  if(nl) targets.push(nl);
  const osb = document.getElementById('ordersStatusBar');
  if(osb) targets.push(osb);
  const nb = document.getElementById('notifBadge');
  if(nb) targets.push(nb);

  if(targets.length){
    const obs = new MutationObserver(updateVIPVisibility);
    targets.forEach(t => obs.observe(t, { childList:true, subtree:true, characterData:true }));
  }

  // تحقق أولي + عند تغيير حجم أو تحميل اللوغو
  updateVIPVisibility();
  window.addEventListener('resize', repositionBadge);
  const logoEl = document.getElementById('siteLogo');
  if(logoEl) logoEl.addEventListener('load', repositionBadge);

  // راقب تغييرات الصفحة (إظهار/إخفاء homePage)
  const main = document.getElementById('mainContent');
  if(main){
    const observer = new MutationObserver(updateVIPVisibility);
    observer.observe(main, {childList:true, subtree:true, attributes:true, attributeFilter:['class','style']});
  }

})();
/* =========================
   UI PRO KIT — JS (ألصقه قبل </body>)
   إضافة تفاعلات: ripple, glow, tilt, theme persistence, toasts
   ========================= */
(function(){
  'use strict';

  /* small helpers */
  const $ = selector => Array.from(document.querySelectorAll(selector));
  const one = selector => document.querySelector(selector);
  const create = (tag, props = {}) => {
    const el = document.createElement(tag);
    Object.entries(props).forEach(([k,v]) => {
      if(k === 'class') el.className = v;
      else if(k === 'text') el.textContent = v;
      else el.setAttribute(k,v);
    });
    return el;
  };

  /* get and normalize main color from :root */
  function getRootColor(){
    const style = getComputedStyle(document.documentElement);
    return (style.getPropertyValue('--main-color') || '#FFCB01').trim();
  }

  /* convert hex to rgba */
  function hexToRgba(hex, alpha=1){
    if(!hex) return `rgba(255,203,1,${alpha})`;
    let h = hex.replace('#','');
    if(h.length === 3) h = h.split('').map(x => x+x).join('');
    const num = parseInt(h, 16);
    const r = (num >> 16) & 255;
    const g = (num >> 8) & 255;
    const b = num & 255;
    return `rgba(${r},${g},${b},${alpha})`;
  }

  /* ========= ripple + glow interaction ========= */
  function attachRipplesAndGlow(rootSelector = 'button, .small-btn, .nav-btn, .back-btn, .card, .section-tile, .small-link, .btn') {
    const list = $(rootSelector);
    list.forEach(el => {
      // ensure element can contain absolute child
      const cs = getComputedStyle(el);
      if(cs.position === 'static' || !cs.position) el.style.position = 'relative';
      el.style.overflow = 'hidden';

      // remove existing handlers safety
      el.__uiHandlers = el.__uiHandlers || {};

      // pointerstart for ripple + glow
      const start = function(e){
        // small guard: ignore right click
        if(e.button && e.button !== 0) return;
        createRipple(el, e);
        triggerGlow(el);
      };

      // keyboard activation
      const keydown = function(e){
        if(e.key === 'Enter' || e.key === ' '){
          triggerGlow(el);
        }
      };

      // bind (avoid duplicates)
      if(!el.__uiHandlers.bound){
        el.addEventListener('mousedown', start, {passive:true});
        el.addEventListener('touchstart', start, {passive:true});
        el.addEventListener('keydown', keydown);
        el.__uiHandlers.bound = true;
      }
    });
  }

  function createRipple(el, e){
    const rect = el.getBoundingClientRect();
    const size = Math.max(rect.width, rect.height) * 1.6;
    const ripple = document.createElement('span');
    ripple.className = 'ui-ripple';
    ripple.style.width = ripple.style.height = size + 'px';
    ripple.style.left = ((e.touches ? e.touches[0].clientX : e.clientX) - rect.left - size/2) + 'px';
    ripple.style.top  = ((e.touches ? e.touches[0].clientY : e.clientY) - rect.top - size/2) + 'px';
    ripple.style.background = hexToRgba(getRootColor(), 0.14);
    ripple.style.opacity = '0.6';
    ripple.style.transition = 'transform 520ms cubic-bezier(.2,.9,.2,1), opacity 420ms linear';
    el.appendChild(ripple);
    requestAnimationFrame(()=> {
      ripple.style.transform = 'scale(1)';
      ripple.style.opacity = '0';
    });
    setTimeout(()=> {
      try { ripple.remove(); } catch(e) {}
    }, 700);
  }

  /* glow: add class and remove after timeout to avoid permanent style */
  function triggerGlow(el, opts = {}) {
    const duration = opts.duration || 520;
    el.classList.add('ui-glow');
    if(el.__glowTimer) clearTimeout(el.__glowTimer);
    el.__glowTimer = setTimeout(()=> {
      el.classList.remove('ui-glow');
    }, duration);
  }

  /* ========= theme persistence ========= */
  function saveTheme(hex){
    try { localStorage.setItem('ui_pro_theme', hex); } catch(e){}
    document.documentElement.style.setProperty('--main-color', hex);
    // compute accent color (slightly darker)
    const accent = shadeHex(hex, -30);
    document.documentElement.style.setProperty('--accent-color', accent);
  }
  function loadTheme(){
    try {
      const saved = localStorage.getItem('ui_pro_theme');
      if(saved) saveTheme(saved);
    } catch(e){}
  }

  /* shade hex by amount (-100..100) */
  function shadeHex(hex, amt){
    let col = hex.replace('#','');
    if(col.length === 3) col = col.split('').map(x=>x+x).join('');
    const num = parseInt(col,16);
    let r = (num >> 16) + amt;
    let g = ((num >> 8) & 0x00FF) + amt;
    let b = (num & 0x0000FF) + amt;
    r = Math.max(0, Math.min(255, r));
    g = Math.max(0, Math.min(255, g));
    b = Math.max(0, Math.min(255, b));
    return '#'+ ( (1<<24) + (r<<16) + (g<<8) + b ).toString(16).slice(1);
  }

  /* expose simple swatch binder: elements with class .theme-swatch and data-color */
  function bindThemeSwatches(){
    const sw = document.querySelectorAll('.theme-swatch[data-color]');
    if(!sw || !sw.length) return;
    sw.forEach(el=>{
      el.style.cursor = 'pointer';
      el.addEventListener('click', ()=> {
        const color = el.dataset.color.trim();
        if(!color) return;
        saveTheme(color);
        // visual pulse
        el.animate([{ transform: 'scale(.96)' }, { transform: 'scale(1.04)' }, { transform: 'scale(1)' }], { duration: 260, easing: 'cubic-bezier(.2,.9,.2,1)' });
      });
    });
  }

  /* ========= small toast system ========= */
  function ensureToaster(){
    let t = document.getElementById('ui-toaster');
    if(!t){
      t = create('div', { id:'ui-toaster' });
      document.body.appendChild(t);
    }
    return t;
  }

  function toast(message, opts = {}){
    const t = ensureToaster();
    const el = create('div', { class: 'toast' });
    el.textContent = message;
    t.appendChild(el);
    // show
    requestAnimationFrame(()=> el.classList.add('show'));
    const ttl = opts.ttl || 3000;
    setTimeout(()=> {
      el.classList.remove('show');
      setTimeout(()=> { try { el.remove(); } catch(e) {} }, 280);
    }, ttl);
    return el;
  }

  /* ========= tilt effect for cards (mouse parallax) =========
     add class .card-tilt to enable on any card. Non-intrusive.
  */
  function bindTilt(selector = '.card-tilt'){
    const cards = document.querySelectorAll(selector);
    cards.forEach(card => {
      const onMove = (e) => {
        const rect = card.getBoundingClientRect();
        const cx = rect.left + rect.width/2;
        const cy = rect.top + rect.height/2;
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        const dx = (clientX - cx) / (rect.width/2);
        const dy = (clientY - cy) / (rect.height/2);
        const rx = (-dy * 6).toFixed(2);
        const ry = (dx * 6).toFixed(2);
        card.style.transform = `perspective(900px) rotateX(${rx}deg) rotateY(${ry}deg) translateZ(6px)`;
        card.style.boxShadow = `0 30px 80px rgba(0,0,0,0.55)`;
      };
      const onLeave = () => {
        card.style.transform = '';
        card.style.boxShadow = '';
      };
      card.addEventListener('mousemove', onMove);
      card.addEventListener('touchmove', onMove, {passive:true});
      card.addEventListener('mouseleave', onLeave);
      card.addEventListener('touchend', onLeave);
    });
  }

  /* ========= long-press detection (for mobile) =========
     add data-longpress="ms" on element to enable, or bind manually
  */
  function bindLongPress(rootSelector = '[data-longpress]'){
    const list = document.querySelectorAll(rootSelector);
    list.forEach(el => {
      let timer = null;
      const ms = parseInt(el.dataset.longpress, 10) || 600;
      const start = (e) => {
        if(timer) clearTimeout(timer);
        timer = setTimeout(()=> {
          el.dispatchEvent(new CustomEvent('longpress', { bubbles:true }));
          // small feedback
          triggerGlow(el, { duration: 420 });
        }, ms);
      };
      const cancel = () => {
        if(timer) { clearTimeout(timer); timer = null; }
      };
      el.addEventListener('touchstart', start, {passive:true});
      el.addEventListener('mousedown', start, {passive:true});
      el.addEventListener('touchend', cancel);
      el.addEventListener('mouseleave', cancel);
      el.addEventListener('mouseup', cancel);
    });
  }

  /* ========= utility: safe init (idempotent) ========= */
  function initUIProKit(){
    bindThemeSwatches();
    attachRipplesAndGlow();
    bindTilt();
    bindLongPress();
    loadTheme();
  }

  /* expose small API */
  window.UIProKit = {
    init: initUIProKit,
    toast,
    saveTheme,
    triggerGlow: (el, opts) => triggerGlow(el, opts),
    createRippleOn: (el, e) => createRipple(el, e)
  };

  /* auto init when DOM ready */
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', initUIProKit);
  } else {
    initUIProKit();
  }

  /* small safety: rebind if DOM mutates (lightweight) */
  const mutObs = new MutationObserver(muts => {
    // when many mutations, debounce rebind
    if(window.__ui_rebind_timer) clearTimeout(window.__ui_rebind_timer);
    window.__ui_rebind_timer = setTimeout(()=> {
      attachRipplesAndGlow();
      bindTilt();
      bindLongPress();
    }, 240);
  });
  mutObs.observe(document.body, { childList:true, subtree:true });

})();
/* ====== Quick apply script: يقلّل المدد ويطبّق صنف dark على الإشعارات والأقسام والألعاب ====== */
(function(){
  try{
    const root = document.documentElement;

    // 1) Force faster animation variables (يضمن تفعيل التغييرات)
    root.style.setProperty('--ui-anim-fast','70ms');
    root.style.setProperty('--ui-anim-mid','150ms');
    root.style.setProperty('--glow-duration','320ms');
    root.style.setProperty('--ripple-duration','320ms');

    // 2) If there are notification containers, add dark class to be safe
    const notifSelectors = ['.notif-panel','#notifPanel','#notifications','.notify-pane','.alerts-list','#ui-toaster'];
    notifSelectors.forEach(sel=>{
      document.querySelectorAll(sel).forEach(n=>{
        n.classList.add('darkify-notifs');
        // ensure direct toasts also get dark background
        if(sel === '#ui-toaster') {
          n.querySelectorAll('.toast').forEach(t => t.classList.add('darkify-notifs'));
        }
      });
    });

    // 3) Sections: make sure existing .section-tile get semi-transparent look
    document.querySelectorAll('.section-tile, .sections-grid .section-tile, .area-section, .section-card').forEach(el=>{
      el.style.background = 'linear-gradient(180deg, rgba(18,18,20,0.84), rgba(14,14,16,0.78))';
      el.style.backdropFilter = 'blur(6px) saturate(120%)';
      el.style.WebkitBackdropFilter = 'blur(6px) saturate(120%)';
    });

    // 4) Game/App tiles: add dark gradient class if exist
    const gameSelectors = ['.game-tile', '.game-card', '.app-tile', '.app-card', '.create-game', '#createGameBtn'];
    gameSelectors.forEach(sel=>{
      document.querySelectorAll(sel).forEach(el=>{
        el.classList.add('game-card'); // class defined in CSS above
        // small visual nudge if no border-left exists
        if(!getComputedStyle(el).borderLeftWidth || getComputedStyle(el).borderLeftWidth === '0px'){
          el.style.borderLeft = '3px solid rgba(255,203,1,0.06)';
        }
      });
    });

    // 5) Speed up existing ripples/glow by intercepting creation if they come from UIProKit
    // Simple approach: shorten lifespan of .ui-ripple and .ui-glow elements if they remain longer
    const observer = new MutationObserver(muts=>{
      muts.forEach(m=>{
        m.addedNodes && m.addedNodes.forEach(node=>{
          if(!(node instanceof HTMLElement)) return;
          if(node.classList && node.classList.contains('ui-ripple')){
            // accelerate disappearance
            node.style.transitionDuration = getComputedStyle(root).getPropertyValue('--ripple-duration') || '320ms';
            setTimeout(()=> { try{ node.remove(); } catch(e){} }, 420); // force-remove as fallback
          }
          if(node.classList && node.classList.contains('ui-glow')){
            // remove glow slightly earlier than original
            setTimeout(()=> { try{ node.classList.remove('ui-glow'); } catch(e){} }, 420);
          }
        });
      });
    });
    observer.observe(document.body, { childList:true, subtree:true });

    // 6) small helper: allow manual fast-mode trigger
    window.UIFastMode = function(){
      root.style.setProperty('--ui-anim-fast','60ms');
      root.style.setProperty('--ui-anim-mid','120ms');
      root.style.setProperty('--ripple-duration','260ms');
    };

    // optional: show a quick toast confirming changes (if toast API exists)
    if(window.UIProKit && typeof window.UIProKit.toast === 'function'){
    } else {
      // fallback small console note
      console.info('UI tweaks applied: faster animations + dark notif/sections/game tiles.');
    }

  }catch(err){
    console.error('Error applying UI tweaks:', err);
  }
})();
(function(){
  try{
    const root = document.documentElement;
    // ضبط المتغيرات دولياً
    root.style.setProperty('--ui-anim-fast','40ms');
    root.style.setProperty('--ui-anim-mid','90ms');
    root.style.setProperty('--ripple-duration','200ms');
    root.style.setProperty('--glow-duration','220ms');

    // اختصار مدة إزالة عناصر .ui-ripple و .ui-glow إذا بقيت في DOM
    const obs = new MutationObserver(mutations => {
      mutations.forEach(m => {
        m.addedNodes && m.addedNodes.forEach(node => {
          if(!(node instanceof HTMLElement)) return;
          if(node.classList.contains('ui-ripple')){
            // force shorter life as backup
            node.style.transitionDuration = getComputedStyle(root).getPropertyValue('--ripple-duration') || '200ms';
            setTimeout(()=> { try{ node.remove(); } catch(e){} }, 320);
          }
          if(node.classList.contains('ui-glow')){
            setTimeout(()=> { try{ node.classList.remove('ui-glow'); } catch(e){} }, 300);
          }
        });
      });
    });
    obs.observe(document.body, { childList:true, subtree:true });

    // إذا عندك دالة جاهزة لتفعيل وضع سريع استخدمها
    if(window.UIFastMode && typeof window.UIFastMode === 'function') window.UIFastMode();

    // خبر المستخدم بخفة (غير مزعج)
    if(window.UIProKit && typeof window.UIProKit.toast === 'function'){
      window.UIProKit.toast('', { ttl: 1 });
    }
  }catch(err){
    console.error('Fast-press apply error', err);
  }
})();

document.addEventListener('DOMContentLoaded', function () {
  const pdSubmit = document.getElementById('pdSubmitForm');
  const amountEl = document.getElementById('chargeAmountInput'); 
  const noteEl = document.getElementById('chargeNote');
  const linkEl = document.getElementById('paymentFileLink');
  const fileInput = document.getElementById('paymentFileUpload');
  const pdNote = document.getElementById('pdNote');

  if (!pdSubmit) return;

  // اخفاء الحقل المرئي للرابط
  if (linkEl) linkEl.style.display = 'none';

  // حفظ display الأصلي للزر
  const originalDisplay = pdSubmit.style.display || '';

  pdSubmit.addEventListener('click', function (ev) {
    // التحقق من المبلغ (الخانة الجديدة فقط)
    const amount = amountEl && amountEl.value ? Number(amountEl.value) : NaN;
    if (!amount || isNaN(amount) || amount <= 0) {
      ev.preventDefault();
      ev.stopPropagation();
      alert('الرجاء إدخال مبلغ صالح.');
      amountEl.focus();
      return;
    }

    // التحقق من وجود ملف/رابط مرفق
    if ((!linkEl || !(linkEl.value || '').trim()) && 
        (!fileInput || !(fileInput.files && fileInput.files.length > 0))) {
      ev.preventDefault();
      ev.stopPropagation();
      alert('الرجاء إرفاق صورة التحويل.');
      if (fileInput) fileInput.focus();
      return;
    }

    // إضافة الملاحظة داخل الحقل linkEl
    if (noteEl && noteEl.value && linkEl) {
      const cleaned = noteEl.value.replace(/[\[\]]/g, '').trim();
      if (cleaned) {
        linkEl.value = (linkEl.value ? linkEl.value + ' ' : '') + '[note:' + cleaned + ']';
      }
    }

    // إخفاء زر الإرسال مباشرة بعد الضغط
    pdSubmit.style.display = 'none';

    // إرجاعه بعد 7 ثواني
    setTimeout(() => {
      pdSubmit.style.display = originalDisplay || 'inline-block';
    }, 7000);

    // تنظيف الحقول بعد نجاح الإرسال (بالتأخير 1 ثانية لإعطاء وقت للسيرفر يستقبل البيانات)
    setTimeout(() => {
      if (amountEl) amountEl.value = '';
      if (noteEl) noteEl.value = '';
      if (fileInput) fileInput.value = '';
      if (linkEl) linkEl.value = '';
      if (pdNote) pdNote.textContent = '';
    }, 1000);

    // لا نمنع الإرسال الأساسي → خلي السيرفر يتعامل مع الطلب
  }, { capture: true });
});

</script>
<!-- ======= بداية: صفحة شحن رصيد خاصة (فتح تلقائي حسب القسم الفرعي) ======= -->
<style>
  /* أنماط بسيطة خاصة بالصفحة، ضعها في نهاية الملف */
  #balancesOrderPage { direction: rtl; }
  #balancesOrderPage .form-box { max-width:640px;margin:12px auto;padding:12px;border-radius:12px;background:rgba(0,0,0,0.15) }
  #balancesOrderPage img.method-img{ width:84px;height:84px;object-fit:cover;border-radius:8px;border:1px solid rgba(255,255,255,0.06) }
  #balancesOrderPage input[type="text"], #balancesOrderPage input[type="number"]{ width:100%;padding:8px;margin-top:6px;border-radius:8px;border:1px solid rgba(255,255,255,0.04) }
  #balancesOrderPage .price-display{ font-weight:900;color:var(--main-color);font-size:18px;text-align:right;margin-top:8px }
  #balancesOrderPage .send-row{ display:flex;gap:10px;margin-top:12px;align-items:center }
  #balancesOrderPage .method-label{ font-weight:800;margin-top:6px }
  #balancesOrderPage .hidden{ display:none!important }
</style>

<div id="balancesOrderPage" class="hidden">
  <div class="form-box">
    <h3 style="text-align:center;color:var(--main-color)">شحن الرصيد</h3>

    <div style="display:flex;gap:12px;align-items:center;margin-top:8px;">
      <img id="balances_method_img" class="method-img" src="https://via.placeholder.com/84x84" alt="طريقة">
      <div style="flex:1;text-align:right;">
        <div id="balances_method_name" style="font-weight:900;color:#fff;font-size:16px">طريقة الشحن</div>
        <div id="balances_method_note" style="color:#ccc;font-size:13px;margin-top:6px">الصفحة خاصة بقسم الشحن</div>
      </div>
    </div>

    <label class="method-label">رقمك الشخصي</label>
    <input type="text" id="balances_personal" readonly>

    <label class="method-label">ضع الرقم (مستلم / محفظة)</label>
    <input type="text" id="balances_recipient" placeholder="مثال: 099xxxxxxxx" oninput="this.value=this.value.replace(/[^0-9]/g,'')">

    <label class="method-label">الكمية</label>
    <input type="number" id="balances_qty" min="1" placeholder="أدخل الكمية">

    <label class="method-label">السعر (محسوب تلقائياً)</label>
    <input type="text" id="balances_price" readonly>

    <div class="price-display">المبلغ النهائي: <span id="balances_price_text">0 ل.س</span></div>

    <div id="balances_msg" style="text-align:center;margin-top:8px;font-weight:800;color:#ffcc00"></div>

    <div class="send-row">
      <button id="balances_send_btn" style="padding:10px 14px;border-radius:8px;cursor:pointer">إرسال وخصم من الرصيد</button>
      <button id="balances_cancel_btn" style="padding:8px 10px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.06);cursor:pointer">رجوع للصفحة الرئيسية</button>
    </div>

    <div style="margin-top:10px;color:#aaa;font-size:13px">ملاحظة: انت المسؤول عن دقة المعلومات المعبئة اي خطأ بالمعلومات نحن غير مسؤولين ⚠️.</div>
  </div>
</div>

<script>
/*
  PASTE THIS BLOCK at the end of your index.html.
  This script:
   - يعترض نقرات بطاقات القسم الفرعي (subcard) ضمن صفحة الأقسام
   - إن كان القسم الحالي هو "balances" ويُضغط على أحد الأنواع المطلوبة
     (سريتيل كاش ، رصيد سريتيل ، شام كاش ، MTN كاش ، رصيد MTN)
     فإنه يفتح صفحة الشحن الخاصة بهذه الطريقة ويمنع السلوك القديم.
   - يحسب السعر qty * 1.2 ويرسل نفس هيكل JSON إلى api/orders
*/

(function(){
  // أسماء الأقسام الفرعية التي نريد أن تفتح الصفحة الخاصة تلقائياً
  const AUTO_BALANCE_TITLES = new Set([
    'سريتيل كاش',
    'رصيد سريتيل',
    'شام كاش',
    'MTN كاش',
    'رصيد MTN',
    // إضافة أي أسماء أخرى بالضبط كما وردت في بياناتك
  ]);

  // references to DOM elements for balances page
  const balPage = document.getElementById('balancesOrderPage');
  const balImg = document.getElementById('balances_method_img');
  const balName = document.getElementById('balances_method_name');
  const balNote = document.getElementById('balances_method_note');
  const balPersonal = document.getElementById('balances_personal');
  const balRecipient = document.getElementById('balances_recipient');
  const balQty = document.getElementById('balances_qty');
  const balPrice = document.getElementById('balances_price');
  const balPriceText = document.getElementById('balances_price_text');
  const balMsg = document.getElementById('balances_msg');
  const balSendBtn = document.getElementById('balances_send_btn');
  const balCancelBtn = document.getElementById('balances_cancel_btn');

  const MULT = 1.2;

  // helper: show the balances page (uses existing showPageQuick if موجود)
  function showBalancesPage(){
    try{ if(typeof showPageQuick === 'function') { showPageQuick('balancesOrderPage'); return; } }catch(e){}
    // fallback
    try{ hideAllPages(); }catch(e){}
    document.querySelectorAll('main > div').forEach(d => d.classList.add('hidden'));
    balPage.classList.remove('hidden');
    window.scrollTo({top:0});
  }

  // recompute price
  function recompute(){
    const q = Number(balQty.value || 0);
    if(!q || q <= 0){ balPrice.value = ''; balPriceText.textContent = '0 ل.س'; return; }
    const p = Math.round(q * MULT);
    balPrice.value = p;
    balPriceText.textContent = p + ' ل.س';
  }
  balQty.addEventListener('input', recompute);

  // cancel button
  balCancelBtn.addEventListener('click', function(){
    try{ if(typeof hideAllPages === 'function') hideAllPages(); if(typeof showPageQuick === 'function') showPageQuick('homePage'); }catch(e){
      balPage.classList.add('hidden');
      const hp = document.getElementById('homePage'); if(hp) hp.classList.remove('hidden');
    }
  });

  // send handler -> sends same shape used by page "الطلب السريع"
  balSendBtn.addEventListener('click', async function(){
    balMsg.textContent = '';
    const personal = (balPersonal.value || '').trim();
    const recipient = (balRecipient.value || '').trim();
    const qty = Number(balQty.value || 0);
    const price = Number(balPrice.value || 0);
    const method = (balName.textContent || '').trim();

    if(!personal){ alert('حقل الرقم الشخصي فارغ'); return; }
    if(!method){ alert('تعذّر تحديد طريقة الشحن'); return; }
    if(!recipient){ alert('ضع الرقم/المستلم لم يتم ارسال الطلب حاول مجددا :('); balRecipient.focus(); return; }
if(isNaN(qty) || qty <= 1499){
  alert('يجب ان تكون الكمية اكبر من 1500 حاول مرة أخرى :(');
  balQty.focus();
  return;
}
    if(isNaN(price) || price <= 0){ alert('تعذّر حساب السعر'); return; }

    const body = {
      personal: personal,
      phone: (typeof currentProfile !== 'undefined' && currentProfile && currentProfile.phone) ? currentProfile.phone : '',
      type: `شحن رصيد - ${method}`,
      item: `${method} شحن كمية ${qty}`,
      idField: recipient,
      fileLink: '',
      cashMethod: method,
      paidWithBalance: true,
      paidAmount: price
    };

    try {
      balSendBtn.disabled = true; balSendBtn.textContent = 'جارٍ الإرسال...';
      let result = null;
      if(typeof postJsonWithTimeout === 'function'){
        result = await postJsonWithTimeout('api/orders', body, 5000);
      } else {
        const r = await fetch('api/orders', {
          method:'POST',
          headers:{ 'content-type':'application/json' },
          body: JSON.stringify(body)
        });
        result = await (r.ok ? r.json().catch(()=>({ok:false})) : r.json().catch(()=>({ok:false})));
      }
      balSendBtn.disabled = false; balSendBtn.textContent = 'إرسال وخصم من الرصيد';
if(result && result.ok){
  alert('✅ تم إرسال طلب شحن الرصيد وسيتم مراجعته');
  try{ if(typeof hideAllPages === 'function') hideAllPages(); }catch(e){}
  try{ if(typeof showPageQuick === 'function') showPageQuick('homePage'); }catch(e){
    document.querySelectorAll('main > div').forEach(d => d.classList.add('hidden'));
    const hp = document.getElementById('homePage'); if(hp) hp.classList.remove('hidden');
  }
  if(typeof window._balancesShowUI === 'function') window._balancesShowUI();
  window.__allowForceHideBalances = true;
  try{ if(typeof origForceHide === 'function') origForceHide(); }catch(e){}
}
       else {
        alert('فشل إرسال الطلب: ' + (result && result.error ? result.error : 'خطأ من السيرفر'));
      }
    } catch (err){
      balSendBtn.disabled = false; balSendBtn.textContent = 'إرسال وخصم من الرصيد';
      console.error(err);
      alert('حدث خطأ أثناء الإرسال');
    }
  });

  // utility to open the page and prefill fields
  function openBalancesWith({ title, imgSrc }){
    balName.textContent = title || 'شحن رصيد';
    if(imgSrc) balImg.src = imgSrc;
    balMsg.textContent = '';
    balRecipient.value = '';
    balQty.value = '';
    recompute();
    // try fill personal from currentProfile or localStorage
    try {
      if (typeof currentProfile !== 'undefined' && currentProfile) {
        balPersonal.value = String(currentProfile.personalNumber || currentProfile.personal || '');
      } else {
        balPersonal.value = (localStorage.getItem && localStorage.getItem('user_personal')) || '';
      }
    } catch(e){ balPersonal.value = ''; }
    showBalancesPage();
    balQty.focus();
  }

  // === interception: عندما ينقر المستخدم على بطاقة فرعية داخل sectionSubgrid
  // نضيف مستمع في مرحلة capture ليمنع السلوك الافتراضي للـ subcard الذي قد يفتح الصفحة القديمة
  const sectionGrid = document.getElementById('sectionSubgrid');
  if(sectionGrid){
    sectionGrid.addEventListener('click', function(ev){
      const card = ev.target.closest && ev.target.closest('.subcard');
      if(!card) return;
      // نتأكد أن القسم الحالي المفتوح هو balances
      if(window._lastOpenedSection !== 'balances') return;
      // الحصول على عنوان البطاقة (الاسم المعروض داخل البطاقة)
      let title = '';
      const nameDiv = card.querySelector && card.querySelector('div');
      if(nameDiv && nameDiv.textContent) title = nameDiv.textContent.trim();
      if(!title) title = card.textContent.trim();

      // تطابق عناوين محددة (مراعاة الكتابة الموجودة في ملفك)
      const normalized = title.replace(/\s+/g,' ').trim();
      if(!AUTO_BALANCE_TITLES.has(normalized)) return;

      // منع تنفيذ مستمعي النقر الافتراضيين (الذين فتحوا الصفحة القديمة)
      ev.preventDefault && ev.preventDefault();
      ev.stopPropagation && ev.stopPropagation();
      try{ ev.stopImmediatePropagation && ev.stopImmediatePropagation(); }catch(e){}

      // نأخذ صورة البطاقة لو وجدت (لتظهر في رأس صفحة الشحن)
      const img = card.querySelector && card.querySelector('img');
      const imgSrc = img ? img.src : '';

      // افتح صفحة الشحن المخصصة مع الطريقة المشتقّة من عنوان البطاقة
      openBalancesWith({ title: normalized, imgSrc: imgSrc });
    }, true /* capture: حتى نعترض قبل الـ bubble listeners */);
  }

  // exposed for debug/open programmatically
  window.openBalancesWith = openBalancesWith;

})();
</script>
<!-- ===========================
     حل مشكلة ظهور صفحة الشحن داخل الصفحات الأخرى
     ضع هذا بعد كود balancesOrderPage (قبل </body>)
     =========================== -->
<style>
  /* جعل صفحة الشحن نافذة عائمة فوق المحتوى */
  #balancesOrderPage {
    position: fixed !important;
    inset: 0 !important;
    display: none;
    align-items: flex-start;
    justify-content: center;
    padding: 28px;
    background: rgba(0,0,0,0.55);
    z-index: 99999;
    overflow: auto;
  }
  /* عندما تُزال الـ hidden نعرضها كـ flex (overlay) */
  #balancesOrderPage:not(.hidden) { display: flex !important; }
  /* تقييد ارتفاع صندوق النموذج ليتناسب مع الـ overlay */
  #balancesOrderPage .form-box {
    max-height: calc(100vh - 80px);
    overflow:auto;
    width: min(720px, 96%);
    box-shadow: 0 12px 40px rgba(0,0,0,0.6);
    background: rgba(10,10,10,0.85);
  }
  /* عند إظهار صفحات أخرى، صفحة الشحن تُخفي بواسطة إضافة .hidden */
</style>

<script>
(function(){
  const balPage = document.getElementById('balancesOrderPage');
  if(!balPage) return;

  // إن كانت الصفحة ضمن عنصر آخر، ننقلها مباشرة تحت body لتصبح overlay مستقلة
  try {
    if (balPage.parentElement !== document.body) {
      document.body.appendChild(balPage);
    }
  } catch(e){ /* ignore */ }

  // دالة مساعدة لإخفاء page بقوة
  function forceHideBalances() {
    try { balPage.classList.add('hidden'); } catch(e){}
  }
  // دالة لإظهارها (لو احتجت لفتح برمجياً)
  function forceShowBalances() {
    try { balPage.classList.remove('hidden'); balPage.scrollTop = 0; } catch(e){}
  }

  // ==== نغلف/نستبدل الدوال الشائعة في ملفك لإخفاء صفحة الشحن عندما تُفتح صفحات أخرى ====
  // أمن: نحتفظ بالإصدارات الأصلية إن وجدت
  const origShowPageQuick = window.showPageQuick;
  window.showPageQuick = function(name, ...rest){
    // إذا الطلب ليس لصفحة الشحن نخفيها
    if(String(name) !== 'balancesOrderPage') forceHideBalances();
    // استدعاء الدالة الأصلية إن وُجدت
    if(typeof origShowPageQuick === 'function'){
      try { return origShowPageQuick.apply(this, [name, ...rest]); } catch(e){ /* swallow */ }
    }
    // fallback بسيط: إظهار الصفحة المطلوبة وإخفاء الباقي
    try {
      document.querySelectorAll('main > div').forEach(d => d.classList.add('hidden'));
      const el = document.getElementById(name);
      if(el) el.classList.remove('hidden');
    } catch(e){}
  };

  // بھیِّن show (لو موجود)
  const origShow = window.show;
  window.show = function(name, ...rest){
    if(String(name) !== 'balancesOrderPage') forceHideBalances();
    if(typeof origShow === 'function'){
      try { return origShow.apply(this, [name, ...rest]); } catch(e){}
    }
    try {
      const el = document.getElementById(name);
      if(el) el.classList.remove('hidden');
    } catch(e){}
  };

  // نغلف hideAllPages: عند استدعائها نضمن إخفاء صفحة الشحن أيضاً
  const origHideAllPages = window.hideAllPages;
  window.hideAllPages = function(...rest){
    try { forceHideBalances(); } catch(e){}
    if(typeof origHideAllPages === 'function'){
      try { return origHideAllPages.apply(this, rest); } catch(e){}
    }
    try { document.querySelectorAll('main > div').forEach(d => d.classList.add('hidden')); } catch(e){}
  };

  // أيضاً نراقب أي نداءات شائعة قد تُستخدم: showPage أو showPanel (أسماء قد تكون لديك)
  const namesToPatch = ['showPage', 'showPanel'];
  namesToPatch.forEach(n => {
    if(window[n] && typeof window[n] === 'function'){
      const orig = window[n];
      window[n] = function(name, ...rest){
        if(String(name) !== 'balancesOrderPage') forceHideBalances();
        try { return orig.apply(this, [name, ...rest]); } catch(e){ /* ignore */ }
      };
    }
  });

  // ==== تأكيد الإخفاء بعد إرسال الطلب: نضيف مراقبًا لزر الإرسال إن وُجد (يغطي أي سيناريو) ====
  const tryAttachSendObserver = () => {
    const btn = document.getElementById('balances_send_btn');
    if(!btn) return;
    // نغلف معالج الزر الحالي ليخفي الصفحة بعد الانتهاء (حتى لو فشل)
    const origOnClick = btn.onclick;
    btn.onclick = async function(ev){
      try {
        // call original if موجود (قد يكون قد أضفته سابقاً في الكود الآخر)
        if(typeof origOnClick === 'function'){
          const r = origOnClick.apply(this, arguments);
          // لو أعاد promise انتظرها
          if(r && typeof r.then === 'function') await r;
        }
      } catch(e){}
      // بعد انتهاء الدالة الأصلية نخفي الصفحة (بغض النظر عن النتيجة)
      forceHideBalances();
    };
    // أيضاً نضيف بعد نجاح الاستدعاء داخل الكود (بالنسبة للحالة التي يقوم بها الكود بعمل fetch مباشرة)
    btn.addEventListener('click', function(){
      // تأخير بسيط ليتاح للدوال الأصلية التنفيذ ثم نغلق
      setTimeout(forceHideBalances, 900);
    });
  };

  // محاولة مباشرة الآن
  tryAttachSendObserver();
  // ومراقبة DOM لتوصيل الزر إن أُضيف لاحقًا
  const mo = new MutationObserver(function(){
    tryAttachSendObserver();
  });
  mo.observe(document.body, { childList:true, subtree:true });

  // expose helpers للديباغ أو الفتح اليدوي
  window.forceHideBalances = forceHideBalances;
  window.forceShowBalances = forceShowBalances;

  // أخيراً: عند تحميل الصفحة نضمن أن تكون مخفية
  forceHideBalances();

})();

(function(){
  const balPage = document.getElementById('balancesOrderPage');
  if(!balPage) return;

  // حدد العناصر التي نريد إخفاءها عند فتح صفحة الشحن
  const uiSelectors = [
    '#balanceDisplay',    // الرصيد
    '#notificationsIcon', // الاشعارات
    '#logo',              // اللوغو
    '#sidebar',           // القائمة الجانبية
    '#backButton'         // زر الرجوع
  ];

  function hideUI(){
    uiSelectors.forEach(sel=>{
      const el = document.querySelector(sel);
      if(el) el.classList.add('hidden');
    });
  }
  function showUI(){
    uiSelectors.forEach(sel=>{
      const el = document.querySelector(sel);
      if(el) el.classList.remove('hidden');
    });
  }

  // نعدل دالة openBalancesWith لتخفي الواجهة عند فتح صفحة الشحن
  const origOpenBalancesWith = window.openBalancesWith;
  if(typeof origOpenBalancesWith === 'function'){
    window.openBalancesWith = function(opts){
      hideUI();
      return origOpenBalancesWith(opts);
    };
  }

  // بعد إرسال الطلب بنجاح → رجوع للـ homePage وإظهار الواجهة
  async function afterSendSuccess(){
    try { hideAllPages(); showPageQuick('homePage'); } catch(e){
      document.querySelectorAll('main > div').forEach(d => d.classList.add('hidden'));
      const hp = document.getElementById('homePage'); if(hp) hp.classList.remove('hidden');
    }
    showUI();
  }

  // نراقب زر الإرسال لربط الرجوع بعد الطلب
  const sendBtn = document.getElementById('balances_send_btn');
  if(sendBtn){
    sendBtn.addEventListener('click', function(){
      // ننتظر ثوانٍ قليلة (الـ API يجاوب) ثم نحاول إرجاع المستخدم
      setTimeout(()=>{
        afterSendSuccess();
      }, 2000);
    });
  }

  // كذلك عند الضغط على زر الإلغاء نظهر الواجهة مرة أخرى
  const cancelBtn = document.getElementById('balances_cancel_btn');
  if(cancelBtn){
    cancelBtn.addEventListener('click', showUI);
  }

  // نعرض الدالة لاستعمال خارجي إذا احتجت
  window._balancesShowUI = showUI;
  window._balancesHideUI = hideUI;

})();
</script>
<!-- ======= Scoped overlay — يؤثر فقط على balancesOrderPage و settingsPage ======= -->
<style>
  /* backdrop */
  #uiBackdrop {
    position: fixed;
    inset: 0;
    z-index: 99990;
    display: none;
    background: rgba(2,2,6,0.72);
    backdrop-filter: blur(6px) saturate(120%);
    -webkit-backdrop-filter: blur(6px) saturate(120%);
    opacity: 0;
    transition: opacity .18s ease;
    pointer-events: none;
  }

  /* show only when body explicitly marks balances or settings active */
  body[data-active-modal="balances"] #uiBackdrop,
  body[data-active-modal="settings"] #uiBackdrop {
    display: block;
    opacity: 1;
    pointer-events: auto;
  }

  /* ضع العناصر التي تريد أن تبدو "مختفية خلف الخلفية" فقط تحت هاتين الحالتين */
  body[data-active-modal="balances"] #topHeader,
  body[data-active-modal="balances"] #siteLogo,
  body[data-active-modal="balances"] #balanceBox,
  body[data-active-modal="balances"] #notifBell,
  body[data-active-modal="balances"] .sidebar,
  body[data-active-modal="balances"] #notifPanel,
  body[data-active-modal="balances"] #bottomNav,

  body[data-active-modal="settings"] #topHeader,
  body[data-active-modal="settings"] #siteLogo,
  body[data-active-modal="settings"] #balanceBox,
  body[data-active-modal="settings"] #notifBell,
  body[data-active-modal="settings"] .sidebar,
  body[data-active-modal="settings"] #notifPanel,
  body[data-active-modal="settings"] #bottomNav {
    z-index: 5 !important;
    pointer-events: none !important;
    -webkit-user-select: none !important;
    user-select: none !important;
    opacity: 0.12 !important;
    transition: opacity .18s ease, transform .18s ease;
  }

  /* تأكد أن صفحة الشحن تظهر كـ overlay فوق الـ backdrop */
  #balancesOrderPage { z-index: 100001; position: fixed !important; inset:0; display:none; align-items:flex-start; justify-content:center; padding:28px; background: rgba(0,0,0,0.55); overflow:auto; }
  #balancesOrderPage:not(.hidden) { display:flex !important; }

  /* الإعدادات تبقى مرئية وقابلة للتفاعل */
  #settingsPage { z-index: 100000; position: relative; }

  /* عدم تمرير الخلفية عند وجود modal نشط */
  body[data-active-modal] { overflow: hidden !important; }
</style>

<div id="uiBackdrop" aria-hidden="true"></div>

<script>
(function(){
  const balances = document.getElementById('balancesOrderPage');
  const settings = document.getElementById('settingsPage');
  const backdrop = document.getElementById('uiBackdrop');

  function isVisible(node){
    if(!node) return false;
    if(node.classList.contains('hidden')) return false;
    const cs = window.getComputedStyle(node);
    if(!cs) return false;
    if(cs.display === 'none' || cs.visibility === 'hidden' || parseFloat(cs.opacity) === 0) return false;
    return true;
  }

  // فقط نُشغّل السمة عندما صفحة الشحن أو صفحة الإعدادات مرئية
  function updateState(){
    if(isVisible(balances)){
      document.body.setAttribute('data-active-modal', 'balances');
      return;
    }
    if(isVisible(settings)){
      document.body.setAttribute('data-active-modal', 'settings');
      return;
    }
    document.body.removeAttribute('data-active-modal');
  }

  // نراقب التغيرات على هذين العنصرين فقط (محدود وآمن)
  if(balances){
    const mo1 = new MutationObserver(updateState);
    mo1.observe(balances, { attributes:true, attributeFilter:['class','style'] });
  }
  if(settings){
    const mo2 = new MutationObserver(updateState);
    mo2.observe(settings, { attributes:true, attributeFilter:['class','style'] });
  }

  // تحديث أولي
  updateState();

  // عند الضغط على الخلفية نغلق صفحة الشحن أو الإعدادات (لا يمس صفحات الألعاب)
  if(backdrop){
    backdrop.addEventListener('click', ()=> {
      try {
        if(isVisible(balances)) balances.classList.add('hidden');
        else if(isVisible(settings)) settings.classList.add('hidden');
      } catch(e){}
      setTimeout(updateState, 30);
    });
  }

  // ربط أزرار الإلغاء والإرسال الخاصة بالشحن (كما في ملفك)
  const balCancel = document.getElementById('balances_cancel_btn');
  const balSend   = document.getElementById('balances_send_btn');
  if(balCancel) balCancel.addEventListener('click', ()=> { if(balances) balances.classList.add('hidden'); updateState(); });
  if(balSend)   balSend.addEventListener('click', ()=> { setTimeout(()=>{ if(balances) balances.classList.add('hidden'); updateState(); }, 700); });

  // إذا تطبيقك يستدعي دوال مركزية لفتح/إغلاق صفحات، غلفناها لتحديث الحالة تلقائياً
  const origShow = window.showPageQuick;
  window.showPageQuick = function(name, ...rest){
    if(typeof origShow === 'function'){
      try { origShow.apply(this, [name, ...rest]); } catch(e){}
    }
    setTimeout(updateState, 40);
  };

  const origHideAll = window.hideAllPages;
  window.hideAllPages = function(...rest){
    if(typeof origHideAll === 'function'){
      try{ origHideAll.apply(this, rest); } catch(e){}
    }
    setTimeout(updateState, 40);
  };

})();
</script>
<style>
  #balances_cancel_btn {
    color: #fff !important;  /* غيّر اللون هنا */
    font-weight: bold;          /* اختياري */
  }
</style>
<!-- ====== VIP from server (PLACE THIS BEFORE </body>) ====== -->
<script>
(function(){
  // رابط الصورة اللي طلبتها
  const VIP_IMAGE_URL = 'https://i.postimg.cc/VLfhbmk8/20251201-235209.png';

  // API root الموجود في index.html (لو معرف) وإلا افتراضي ''
  const APIROOT = (typeof API_ROOT !== 'undefined' ? API_ROOT : '');

  // Helper: اجعل عنصر الـ VIP الخاص بالسيرفر
  function ensureVipServerBadge(){
    if (document.getElementById('vipServerBadge')) return document.getElementById('vipServerBadge');
    const host = document.getElementById('topHeader') || document.querySelector('header') || document.body;
    const wrap = document.createElement('div');
    wrap.id = 'vipServerBadge';
    // مظهر افتراضي — يمكنك تعديل الستايل حسب رغبتك
    Object.assign(wrap.style, {
      position: 'absolute',
      left: '(50%)',
      top: '50%',
      transform: 'translateY(-50%)',
      display: 'none',
      zIndex: 1400,
      padding: '2px'
    });
    const img = document.createElement('img');
    img.id = 'vipServerBadgeImg';
    img.src = VIP_IMAGE_URL;
    img.alt = 'VIP';
    Object.assign(img.style, {
      width: '80px',
      height: '80px',
      borderRadius: '8px',

      display: 'block'
    });
    wrap.appendChild(img);
    host.appendChild(wrap);
    return wrap;
  }

  // اخفاء الشارة القديمة لو كانت موجودة (#vipBadge)
  function hideOldVipBadge(){
    try {
      const old = document.getElementById('vipBadge');
      if (old) old.style.setProperty('display','none','important');
    } catch(e){}
  }

  // اعرض/اخف شارة السيرفر حسب قيمة vip
  async function applyVipForPersonal(personal){
    if(!personal) return;
    try {
      // حاول endpoint /api/profile?personal=xxxx (سيرفرك يدعمها ويضع vip في profile.vip بعد المزامنة). 
      const url = APIROOT + 'api/profile?personal=' + encodeURIComponent(String(personal));
      const resp = await fetch(url, { cache: 'no-store' });
      const data = await resp.json().catch(()=>null);

      let vipValue = null;
      if (data && data.ok && data.profile) {
        vipValue = data.profile.vip || null;
      } else if (data && data.found && data.sheetProfile) {
        // بعض النهايات (check) قد تُعيد sheetProfile بدل profile
        vipValue = data.sheetProfile.vip || null;
      }

      // بديل: لو ما لاقينا personal حاول البحث بالايميل عبر /api/profile/check?email=...
      if ((vipValue === null || String(vipValue).trim()==='') && (window.currentProfile && window.currentProfile.email)) {
        try {
          const eurl = APIROOT + 'api/profile/check?email=' + encodeURIComponent(String(window.currentProfile.email));
          const r2 = await fetch(eurl, { cache: 'no-store' });
          const d2 = await r2.json().catch(()=>null);
          if (d2 && d2.sheetProfile && d2.sheetProfile.vip) vipValue = d2.sheetProfile.vip;
        } catch(e){}
      }

      // عرض أو اخفاء الصورة بناءً على vipValue
      const badge = ensureVipServerBadge();
      if (vipValue && String(vipValue).trim() !== '') {
        hideOldVipBadge();
        badge.style.display = 'block';
        localStorage.setItem('user_vip', String(vipValue));
        // علامة للمطوَّر أو أكواد أخرى لمعرفة أننا نتعامل مع VIP مرجع من السيرفر
        window.__vip_from_sheet = true;
      } else {
        badge.style.display = 'none';
        localStorage.removeItem('user_vip');
        window.__vip_from_sheet = false;
      }
    } catch(err){
      console.warn('VIP fetch/apply error', err);
    }
  }

  // محاولة أخذ رقم الـ personal من مصادر الصفحة (الموجودة عندك). 
  function getKnownPersonal(){
    if (window.currentPersonal) return String(window.currentPersonal);
    const stored = localStorage.getItem('user_personal');
    if (stored) return String(stored);
    const el = document.getElementById('personalNum');
    if (el && el.textContent && el.textContent.trim() && !/^0+$/.test(el.textContent.trim())) return el.textContent.trim();
    // لا يوجد personal معروف
    return '';
  }

  // force-hide القديم دائماً ومراقب التغيرات (يتصدى لأي كود قد يعيده)
  function enforceHideOldBadge(){
    hideOldVipBadge();
    const old = document.getElementById('vipBadge');
    if (!old) return;
    try {
      const mo = new MutationObserver(()=>{ hideOldVipBadge(); });
      mo.observe(old, { attributes:true, childList:true, subtree:true });
      // خزّن المراقب كي لا يتم GC (غير ضروري لكن آمن)
      window.__vip_old_badge_observer = mo;
    } catch(e){}
  }

  // افعل التطبيق عند التحميل
  document.addEventListener('DOMContentLoaded', () => {
    // أولاً أنشئ البادج محلياً (مخفي) وأخفي القديم
    ensureVipServerBadge();
    enforceHideOldBadge();

    // افحص الـ personal وارسل طلب للجلب من السيرفر
    const personal = getKnownPersonal();
    if (personal) {
      applyVipForPersonal(personal);
    } else {
      // لو ما في personal حاول استخلاص الايميل من الكاش المحلي (user_profile_v1) أو currentProfile
      let email = '';
      try {
        if (window.currentProfile && window.currentProfile.email) email = window.currentProfile.email;
        else {
          const raw = localStorage.getItem('user_profile_v1');
          if (raw) {
            const p = JSON.parse(raw);
            if (p && p.email) email = p.email;
          }
        }
      } catch(e){}
      if (email) {
        // use /api/profile/check?email=... to locate row and vip (fallback)
        (async ()=>{
          try {
            const r = await fetch(APIROOT + 'api/profile/check?email=' + encodeURIComponent(String(email)), { cache: 'no-store' });
            const d = await r.json().catch(()=>null);
            if (d && d.found && d.sheetProfile && d.sheetProfile.personalNumber) {
              // found personal -> apply by personal
              applyVipForPersonal(d.sheetProfile.personalNumber);
            } else if (d && d.found && d.sheetProfile && d.sheetProfile.vip) {
              // no personal but vip present
              ensureVipServerBadge().style.display = 'block';
              localStorage.setItem('user_vip', String(d.sheetProfile.vip));
            }
          } catch(e){ console.warn('vip fallback by email error', e); }
        })();
      }
    }

    // enforcement loop: حافظ على اخفاء الشارة القديمة وابقِ شارة السيرفر حسب localStorage
    setInterval(()=>{
      hideOldVipBadge();
      const stored = localStorage.getItem('user_vip');
      const badge = ensureVipServerBadge();
      if (stored && String(stored).trim()!=='') badge.style.display = 'block';
      else badge.style.display = 'none';
    }, 2000);
  });
})();

// تعديل الأسعار لقسم واحد
function updateSectionPrices(sectionKey, diff) {
  if (!gamePackages[sectionKey]) {
    console.log(`❌ القسم ${sectionKey} غير موجود`);
    return;
  }

  gamePackages[sectionKey] = gamePackages[sectionKey].map(pkg => {
    const newPrice = pkg.priceNum + diff;
    return {
      ...pkg,
      priceNum: newPrice,
      priceText: `${newPrice} ل.س`
    };
  });

  console.log(`✅ تم تعديل أسعار قسم: ${sectionKey}`);
}

// تعديل جميع الأقسام مرة وحدة
function updateAllPrices(diff) {
  for (let game in gamePackages) {
    updateSectionPrices(game, diff);
  }
}

// أمثلة الاستخدام:

//قسم freefire
updateSectionPrices('freefire', +20);

//قسم pubg
updateSectionPrices('pubg', 200);

updateSectionPrices('blood', 0);

updateSectionPrices('dlta', 0);

//  كل الأقسام
updateAllPrices(0);
</script>

<style>
  #appsOrderPage { direction: rtl; }
  #appsOrderPage .form-box { max-width:640px;margin:12px auto;padding:12px;border-radius:12px;background:rgba(0,0,0,0.15) }
  #appsOrderPage img.method-img{ width:84px;height:84px;object-fit:cover;border-radius:8px;border:1px solid rgba(255,255,255,0.06) }
  #appsOrderPage input[type="text"], #appsOrderPage input[type="number"]{ width:100%;padding:8px;margin-top:6px;border-radius:8px;border:1px solid rgba(255,255,255,0.04) }
  #appsOrderPage .price-display{ font-weight:900;color:var(--main-color);font-size:18px;text-align:right;margin-top:8px }
  #appsOrderPage .send-row{ display:flex;gap:10px;margin-top:12px;align-items:center }
  #appsOrderPage .method-label{ font-weight:800;margin-top:6px }
  #appsOrderPage .hidden{ display:none!important }
</style>

<div id="appsOrderPage" class="hidden">
  <div class="form-box">
    <h3 style="text-align:center;color:var(--main-color)">طلب التطبيقات</h3>

    <div style="display:flex;gap:12px;align-items:center;margin-top:8px;">
      <img id="apps_method_img" class="method-img" src="https://via.placeholder.com/84x84" alt="تطبيق">
      <div style="flex:1;text-align:right;">
        <div id="apps_method_name" style="font-weight:900;color:#fff;font-size:16px">اسم التطبيق</div>
        <div id="apps_method_note" style="color:#ccc;font-size:13px;margin-top:6px">صفحة خاصة بالتطبيقات</div>
      </div>
    </div>

    <label class="method-label">رقمك الشخصي</label>
    <input type="text" id="apps_personal" readonly>

    <label class="method-label">ضع الايدي</label>
    <input type="text" id="apps_recipient" placeholder="مثال 111×××××××" oninput="this.value=this.value.replace(/[^0-9]/g,'')">

    <label class="method-label">الكمية</label>
    <input type="number" id="apps_qty" min="1" placeholder="أدخل الكمية">

    <label class="method-label">السعر (محسوب تلقائياً)</label>
    <input type="text" id="apps_price" readonly>

    <div class="price-display">المبلغ النهائي: <span id="apps_price_text">0 ل.س</span></div>

    <div id="apps_msg" style="text-align:center;margin-top:8px;font-weight:800;color:#ffcc00"></div>

    <div class="send-row">
      <button id="apps_send_btn" style="padding:10px 14px;border-radius:8px;cursor:pointer">إرسال وخصم من الرصيد</button>
      <button id="apps_cancel_btn" style="padding:8px 10px; color:#fff; border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.06);cursor:pointer">رجوع للصفحة الرئيسية</button>
    </div>

    <div style="margin-top:10px;color:#aaa;font-size:13px">⚠️ أنت المسؤول عن دقة المعلومات المدخلة.</div>
  </div>
</div>

<script>
(function(){
  // تعريف التطبيقات
  const APPS = {
    "xena live":  { min:10000, mult:1.8 },
    "alo party":  { min:4500, mult:14 },
    "sudfa chat": { min:50000, mult:0.8 },
    "poppo live": { min:15000, mult:1.59 },
    "sugo":  { min:10000, mult:2 },
    "yooy chat":  { min:10000, mult:1.59 }
  };

  // عناصر الصفحة
  const appPage      = document.getElementById('appsOrderPage');
  const appImg       = document.getElementById('apps_method_img');
  const appName      = document.getElementById('apps_method_name');
  const appNote      = document.getElementById('apps_method_note');
  const appPersonal  = document.getElementById('apps_personal');
  const appRecipient = document.getElementById('apps_recipient');
  const appQty       = document.getElementById('apps_qty');
  const appPrice     = document.getElementById('apps_price');
  const appPriceText = document.getElementById('apps_price_text');
  const appMsg       = document.getElementById('apps_msg');
  const sendBtn      = document.getElementById('apps_send_btn');
  const cancelBtn    = document.getElementById('apps_cancel_btn');

  let currentApp = null;

  // عرض الصفحة
  function showAppPage(){
    try{ if(typeof showPageQuick==="function"){ showPageQuick('appsOrderPage'); return; } }catch(e){}
    try{ hideAllPages(); }catch(e){}
    document.querySelectorAll('main > div').forEach(d=>d.classList.add('hidden'));
    appPage.classList.remove('hidden');
    window.scrollTo({top:0});
  }

  // حساب السعر
  function recompute(){
    if(!currentApp) return;
    const q = Number(appQty.value||0);
    if(q < currentApp.min){
      appMsg.textContent = `الحد الأدنى ${currentApp.min}`;
      sendBtn.disabled = true;
      appPrice.value = "";
      appPriceText.textContent = "0 ل.س";
      return;
    }
    appMsg.textContent = "";
    sendBtn.disabled = false;
    const p = Math.round(q * currentApp.mult);
    appPrice.value = p;
    appPriceText.textContent = p.toLocaleString("en-US") + " ل.س";
  }
  appQty.addEventListener('input', recompute);

  // زر الرجوع
  cancelBtn.addEventListener('click', function(){
    try{ hideAllPages(); if(typeof showPageQuick==="function") showPageQuick('homePage'); }catch(e){}
    appPage.classList.add('hidden');
  });

  // زر الإرسال
// استبدل الكتلة القديمة بهذه الكتلة كاملة
sendBtn.addEventListener('click', async function(){
  const personal = (appPersonal.value||"").trim();
  const recipient = (appRecipient.value||"").trim();
  const qty = Number(String(appQty.value||"").replace(/[^\d]/g,'')) || 0;

  // احصل على السعر رقميًا (نزيل أي فواصل أو نص)
  const rawPrice = String(appPrice.value || appPriceText.textContent || "");
  const priceNum = Number(rawPrice.replace(/[^0-9.-]/g,'')); // يترك الأرقام فقط

  const method = appName.textContent.trim();

  if(!personal){ alert("الرقم الشخصي مفقود"); return; }
  if(!recipient){ alert("الرجاء إدخال رقم المستلم"); return; }
  if(!currentApp){ alert("تعذّر تحديد التطبيق"); return; }
  if(qty < currentApp.min) return alert(`الكمية يجب أن تكون ≥ ${currentApp.min}`);
  if(isNaN(priceNum) || priceNum <= 0) return alert("تعذر حساب السعر");

  const body = {
    personal,
    phone: (typeof currentProfile!=="undefined" && currentProfile && currentProfile.phone) ? currentProfile.phone : "",
    type: `طلب تطبيق - ${method}`,
    item: `${method} كمية ${qty}`,
    idField: recipient,
    paidWithBalance: true,
    paidAmount: priceNum,
    fileLink: "",
    cashMethod: ""
  };

  try{
    sendBtn.disabled = true;
    sendBtn.textContent = "جارٍ الإرسال...";

    // أولاً: إذا كانت الدالة attemptChargeAndSendOrder موجودة - استخدمها (هذا يخصم الرصيد محلياً ويعالج الطلب)
    if(typeof attemptChargeAndSendOrder === "function"){
      try {
        const attemptRes = await attemptChargeAndSendOrder(body);
        // attemptChargeAndSendOrder في كودك عادة تعرض alerts وتُرجع/تُلقي حسب النتيجة.
        // إن أعادت كائن استجابة، نتحقق منه، وإن لم تُعد فاعتبرناها ناجحة إن لم تُطلق استثناءً.
        if(attemptRes && attemptRes.ok === false){
          alert('فشل إرسال الطلب: ' + (attemptRes.error || 'خطأ'));
        } else {
          alert('✅ تم إرسال الطلب وسيتم مراجعته');
          // حدث نجاح: اغلق الصفحة
          if(typeof cancelBtn !== 'undefined' && cancelBtn) cancelBtn.click();
        }
      } catch(errAttempt){
        console.error('attemptChargeAndSendOrder error', errAttempt);
        alert('فشل أثناء محاولة خصم الرصيد أو إرسال الطلب: ' + (errAttempt && errAttempt.message ? errAttempt.message : 'خطأ'));
      } finally {
        sendBtn.disabled = false;
        sendBtn.textContent = "إرسال وخصم من الرصيد";
      }
      return;
    }

    // fallback: لو ما في attemptChargeAndSendOrder نرسل مباشرةً إلى السيرفر
    let res = null;
    if(typeof postJsonWithTimeout === 'function'){
      res = await postJsonWithTimeout('api/orders', body, 7000); // يستخدم API_ROOT داخلياً
    } else {
      // استخدم API_ROOT (موجود في ملفك) لتجنّب المسارات النسبية الخاطئة
      const url = (typeof API_ROOT !== 'undefined' ? API_ROOT : '') + 'api/orders';
      const r = await fetch(url, {
        method: 'POST',
        headers: {'content-type': 'application/json'},
        body: JSON.stringify(body)
      });
      res = await r.json().catch(()=>({ ok:false }));
    }

    sendBtn.disabled = false;
    sendBtn.textContent = "إرسال وخصم من الرصيد";

    if(res && res.ok){
      alert('✅ تم إرسال الطلب');
      if(typeof cancelBtn !== 'undefined' && cancelBtn) cancelBtn.click();
    } else {
      console.error('order send failed response:', res);
      alert('فشل إرسال الطلب: ' + (res && res.error ? res.error : 'خطأ من السيرفر'));
    }

  }catch(e){
    console.error('order send unexpected error', e);
    alert('حدث خطأ أثناء الإرسال: ' + (e && e.message ? e.message : 'خطأ غير معروف'));
    sendBtn.disabled = false;
    sendBtn.textContent = "إرسال وخصم من الرصيد";
  }
});

  // فتح صفحة الطلب للتطبيق
  function openAppOrder({title,imgSrc}){
    const key = title.toLowerCase();
    if(!(key in APPS)) return;
    currentApp = APPS[key];
    appName.textContent = title;
    if(imgSrc) appImg.src = imgSrc;
    appRecipient.value="";
    appQty.value=currentApp.min;
    appPersonal.value = (typeof currentProfile!=="undefined" && currentProfile) ?
      (currentProfile.personalNumber||currentProfile.personal||"") :
      (localStorage.getItem && localStorage.getItem("user_personal")) || "";
    recompute();
    showAppPage();
  }

  // اعتراض نقرات بطاقات التطبيقات
  const sectionGrid = document.getElementById("sectionSubgrid");
  if(sectionGrid){
    sectionGrid.addEventListener("click",function(ev){
      const card = ev.target.closest && ev.target.closest(".subcard");
      if(!card) return;
      if(window._lastOpenedSection!=="apps") return;
      let title="";
      const div=card.querySelector("div");
      if(div && div.textContent) title=div.textContent.trim();
      if(!title) title=card.textContent.trim();
      const norm=title.toLowerCase();
      if(!(norm in APPS)) return;
      ev.preventDefault(); ev.stopPropagation(); try{ev.stopImmediatePropagation();}catch(e){}
      const img=card.querySelector("img"); const imgSrc=img?img.src:"";
      openAppOrder({title:norm,imgSrc});
    },true);
  }

})();
</script>
<script>
(function(){
  // غيّر هذا لو ID مختلف عندك
  const bottomNav = document.getElementById('bottomNav'); 
  const appsPage  = document.getElementById('appsOrderPage');
  const cancelBtn = document.getElementById('apps_cancel_btn');

  if(!bottomNav || !appsPage) return;

  function hideBottomNav(){
    bottomNav.style.display = 'none';
  }
  function showBottomNav(){
    bottomNav.style.display = '';
  }

  // عند فتح صفحة التطبيقات
  window.addEventListener('appsPageOpened', hideBottomNav);

  // عند الضغط على زر الرجوع
  if(cancelBtn){
    cancelBtn.addEventListener('click', showBottomNav);
  }

  // مراقبة الصفحة: لو اختفت لأي سبب (تغيير قسم مثلاً) نرجع الأزرار
  const observer = new MutationObserver(()=>{
    if(appsPage.classList.contains('hidden')){
      showBottomNav();
    } else {
      hideBottomNav();
    }
  });
  observer.observe(appsPage, { attributes:true, attributeFilter:['class'] });

  // نعدل دالة showAppPage لتطلق حدث مخصص
  const origShowAppPage = window.showAppPage;
  window.showAppPage = function(){
    if(typeof origShowAppPage === 'function'){ origShowAppPage(); }
    window.dispatchEvent(new Event('appsPageOpened'));
  };

})();
</script>
<script>
document.addEventListener("DOMContentLoaded", function () {
  const header = document.querySelector("header, #topHeader");
  const bottomNav = document.getElementById("bottomNav"); 
  const appsOrderPage = document.getElementById("appsOrderPage");

  function updateHeaderAndNav() {
    if (!appsOrderPage || !header) return;
    const isVisible = !appsOrderPage.classList.contains("hidden");
    if (isVisible) {
      header.classList.add("compact");        // يخفي اللوغو والرصيد والإشعارات
      if (bottomNav) bottomNav.classList.add("hidden"); // يخفي الأزرار السفلية
    } else {
      header.classList.remove("compact");
      if (bottomNav) bottomNav.classList.remove("hidden");
    }
  }

  // راقب تغييرات إظهار صفحة الطلب السريع للتطبيقات
  if (appsOrderPage) {
    const mo = new MutationObserver(updateHeaderAndNav);
    mo.observe(appsOrderPage, { attributes: true, attributeFilter: ["class", "style"] });
  }

  updateHeaderAndNav();
});
</script>
<script>
(function(){
  // helper: اختيارات للأزرار التي نعتبرها أزرار إرسال
  const BUTTON_SELECTOR = 'button[id$="_send_btn"], button.send-btn, [data-send-btn]';

  // مجموعة الأزرار التي وضِعَت في حالة إرسال الآن
  const activeButtons = new Set();

  // حفظ آخر زر ضغطه المستخدم (لكي نربطه بالطلبات التي تجري)
  let lastClickedSendButton = null;

  // تنسيق النص العربي للجارٍ الإرسال
  const SENDING_TEXT = 'جارٍ الإرسال...';

  // حفظ نص الزر الأصلي واستعادته
  function setSending(btn){
    if(!btn) return;
    if(!btn.dataset._oldText) btn.dataset._oldText = btn.innerHTML;
    btn.innerHTML = SENDING_TEXT;
    btn.disabled = true;
    btn.classList.add('sending');
    activeButtons.add(btn);
    lastClickedSendButton = btn;
  }
  function clearSending(btn){
    if(!btn) return;
    if(btn.dataset._oldText) btn.innerHTML = btn.dataset._oldText;
    btn.disabled = false;
    btn.classList.remove('sending');
    activeButtons.delete(btn);
    // إذا الزر كان هو آخر ضغطة، نمسحه
    if(lastClickedSendButton === btn) lastClickedSendButton = null;
  }
  function clearAllSending(){
    Array.from(activeButtons).forEach(b => {
      try { clearSending(b); } catch(e){ console.warn(e); }
    });
  }

  // عند نقر أي زر إرسال: اضبطه كـ "جارٍ الإرسال..."
  document.addEventListener('click', function(ev){
    const btn = ev.target.closest && ev.target.closest('button, [role="button"]');
    if(!btn) return;
    // يتطابق مع محددنا؟
    if(btn.matches && btn.matches(BUTTON_SELECTOR)){
      // ضع الحالة فوراً — حتى لو الكود الأصلي يقوم بنفس الشيء، هذا آمن
      setSending(btn);
      // إذا كان الكود الأصلي سيعيد النص عند انتهاء العملية فسيتم إرجاعه لاحقاً
    }
  }, true); // capture: نعترض قبل أن يتصرف أي مستمع آخر

  // ==========================
  // WRAP attemptChargeAndSendOrder (إن وجدت)
  // ==========================
  if(window.attemptChargeAndSendOrder && typeof window.attemptChargeAndSendOrder === 'function'){
    const origAttempt = window.attemptChargeAndSendOrder;
    window.attemptChargeAndSendOrder = async function(...args){
      // ضع حالة إرسال على آخر زر نُقِر به أو أي أزرار نشطة
      if(lastClickedSendButton) setSending(lastClickedSendButton);
      let result;
      try {
        result = await origAttempt.apply(this, args);
        // ناجح — أزل الحالة
        if(lastClickedSendButton) clearSending(lastClickedSendButton);
        else clearAllSending();
        return result;
      } catch(err){
        // فشل — أزل الحالة لكن اترك الخطأ يرنّ
        if(lastClickedSendButton) clearSending(lastClickedSendButton);
        else clearAllSending();
        throw err;
      }
    };
  }

  // ==========================
  // WRAP postJsonWithTimeout (إن وجدت) لمكالمات api/orders
  // ==========================
  if(window.postJsonWithTimeout && typeof window.postJsonWithTimeout === 'function'){
    const origPost = window.postJsonWithTimeout;
    window.postJsonWithTimeout = async function(url, body, timeout){
      // لو الطلب لـ api/orders أو يحتوي 'orders' نفعل الإرسال
      const u = String(url || '');
      const isOrders = /api\/orders/i.test(u) || /orders/i.test(u);
      if(isOrders && lastClickedSendButton) setSending(lastClickedSendButton);
      try{
        const res = await origPost.apply(this, arguments);
        if(isOrders && lastClickedSendButton) clearSending(lastClickedSendButton);
        else if(isOrders) clearAllSending();
        return res;
      }catch(e){
        if(isOrders && lastClickedSendButton) clearSending(lastClickedSendButton);
        else if(isOrders) clearAllSending();
        throw e;
      }
    };
  }

  // ==========================
  // WRAP fetch العام لالتقاط POST إلى api/orders (فالباك)
  // ==========================
  if(window.fetch && typeof window.fetch === 'function'){
    const origFetch = window.fetch.bind(window);
    window.fetch = async function(input, init){
      try {
        // محاولة الحصول على URL ونوع الطلب
        const url = (typeof input === 'string') ? input : (input && input.url ? input.url : '');
        const method = (init && init.method) ? init.method.toUpperCase() : ((typeof input === 'object' && input && input.method) ? (input.method||'GET').toUpperCase() : 'GET');
        const isOrders = /api\/orders/i.test(url) || (typeof url === 'string' && url.endsWith('/orders')) ;
        if(isOrders && method === 'POST'){
          // ضع حالة إرسال على آخر زر
          if(lastClickedSendButton) setSending(lastClickedSendButton);
        }

        const response = await origFetch(input, init);

        if(isOrders && method === 'POST'){
          // بعد استلام الاستجابة، أزل الحالة (سواء كانت OK أم لا)
          // ننتظر قراءة الجواب في الكود الأصلي — هنا نزيل الحالة فورًا
          clearAllSending();
        }
        return response;
      } catch(err) {
        // خطأ في الشبكة — أزل الحالة
        clearAllSending();
        throw err;
      }
    };
  }

  // ==========================
  // Safety: إن بقيت الأزرار معلقة أكثر من 20 ثانية نعيدها (لتجنب حالات التعليق)
  // ==========================
  setInterval(() => {
    if(activeButtons.size === 0) return;
    // نتحقق وقت آخر تغيير dataset._sendingSince
    const now = Date.now();
    Array.from(activeButtons).forEach(btn => {
      if(!btn.dataset._sendingSince) btn.dataset._sendingSince = String(now);
      const since = Number(btn.dataset._sendingSince || now);
      if(now - since > 20000){ // 20s
        console.warn('clearing stuck sending button', btn);
        clearSending(btn);
      }
    });
  }, 3000);

  // عندما نضع زر في حالة إرسال، خزّن وقت البداية
  const origSetSending = setSending;
  setSending = function(btn){
    origSetSending(btn);
    if(btn) btn.dataset._sendingSince = String(Date.now());
  };
  // expose for debugging
  window._uiSendHelpers = { setSending, clearSending, clearAllSending, BUTTON_SELECTOR };

})();
</script>
<script>
/* Setup: تهيئة شبكة طرق الدفع وربط الأحداث */
(function(){
  const methodsGrid = document.getElementById('pdMethodsGrid');
  const pdContent = document.getElementById('pdContent');
  const pdSelect = document.getElementById('pdCashSelect');
  const pdTopInfo = document.getElementById('pdTopInfo');
  const pdChangeWrap = document.getElementById('pdChangeMethodWrap');
  const pdChangeBtn = document.getElementById('pdChangeMethodBtn');

  if(!methodsGrid || !pdContent || !pdSelect) return;

  // دالة للتبديل إلى طريقة الدفع المختارة
  function chooseMethod(methodKey, title){
    // ضع القيمة بالـ select (يتماشى مع بقية المنطق)
    pdSelect.value = methodKey || '';
    // حدث التغيير (إن وُجد معالج)
    try{ if(typeof onPdCashChange === 'function') onPdCashChange(); }catch(e){}
    // ضع نص أعلى الصفحة يوضح الطريقة
    if(pdTopInfo) pdTopInfo.textContent = title || methodKey;
    // إخفاء الشبكة وإظهار محتوى التفاصيل
    methodsGrid.style.display = 'none';
    pdContent.style.display = 'block';
    pdChangeWrap.style.display = 'block';
    // اجعل الصفحة مدمجة (compact) إن كان عندك هذا السلوك
    try{ setCompactHeader(true); }catch(e){}
  }

  // ربط كل tile
  methodsGrid.querySelectorAll('.pd-method-tile').forEach(btn=>{
    btn.addEventListener('click', function(){
      const method = this.getAttribute('data-method');
      const label = this.textContent.trim() || method;
      chooseMethod(method, label);
    });
  });

  // زر تغيير الطريقة (ارجاع الشبكة للظهور)
  if(pdChangeBtn){
    pdChangeBtn.addEventListener('click', function(){
      pdSelect.value = '';
      // اخفِ المحتوى وأعد إظهار الشبكة
      pdContent.style.display = 'none';
      methodsGrid.style.display = 'grid';
      pdChangeWrap.style.display = 'none';
      // reset any fields if you want
      try{
        if(document.getElementById('pdCopyField')) document.getElementById('pdCopyField').value = '';
        if(document.getElementById('qrImg')) document.getElementById('qrImg').src = '';
      }catch(e){}
      try{ setCompactHeader(false); }catch(e){}
    });
  }

  // تأكد أن showPaymentDetailsFromSubmit يفتح الشبكة تلقائياً إن لم تُحدد طريقة
  const origShowPd = window.showPaymentDetailsFromSubmit;
  window.showPaymentDetailsFromSubmit = function(fromPage){
    // استدعاء الأصلي (إن وُجد) لضمان تهيئة الحقول كما هي الآن
    if(typeof origShowPd === 'function') origShowPd(fromPage);
    // افتراضي: إظهر شبكة الصور و اخفِ محتوى التفاصيل حتى يختار المستخدم طريقة
    if(pdSelect && pdSelect.value){
      // لو القيمة معدّة بالفعل، نظهر المحتوى مباشرة
      methodsGrid.style.display = 'none';
      pdContent.style.display = 'block';
      pdChangeWrap.style.display = 'block';
    } else {
      methodsGrid.style.display = 'grid';
      pdContent.style.display = 'none';
      pdChangeWrap.style.display = 'none';
      try{ setCompactHeader(false); }catch(e){}
    }
  };

  // زر الإلغاء يرجع للصفحة السابقة ويعيد الشبكة ظاهرة
  const pdCancel = document.getElementById('pdCancel');
  if(pdCancel){
    pdCancel.addEventListener('click', function(){
      // أظهر الشبكة عند الخروج لكي تكون جاهزة للمرة القادمة
      methodsGrid.style.display = 'grid';
      pdContent.style.display = 'none';
      pdChangeWrap.style.display = 'none';
      // عد للصفحة التي كانت قبل (وظيفة موجودة أصلاً)
      try { returnFromPaymentDetails(); } catch(e){ hideAllPages(); show('homePage'); }
    });
  }

})();
</script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const bottomNav = document.getElementById("bottomNav");

  // ➊ عند اختيار أي طريقة دفع (شام كاش، سيريتل، الخ)
  document.querySelectorAll(
    '.payment-method, .pay-method, [data-method], .method-btn, #shamBtn, #syriatelBtn'
  ).forEach(btn => {
    btn.addEventListener("click", () => {
      bottomNav.style.opacity = "0";
      bottomNav.style.pointerEvents = "none";
      setTimeout(() => (bottomNav.style.display = "none"), 150);
    });
  });

  // ➋ عند الضغط على زر "إلغاء" أو "رجوع" في صفحة الدفع
  const showNavAgain = () => {
    bottomNav.style.display = "flex";
    setTimeout(() => {
      bottomNav.style.opacity = "1";
      bottomNav.style.pointerEvents = "auto";
    }, 50);
  };

  // زر الإلغاء المحدد
  const cancelBtn = document.getElementById("pdCancel");
  if (cancelBtn) cancelBtn.addEventListener("click", showNavAgain);

  // أي زر رجوع عام داخل صفحة الدفع
  document.querySelectorAll("#paymentBackBtn, .back-btn").forEach(btn => {
    btn.addEventListener("click", showNavAgain);
  });
});
</script>
<!-- BEGIN: Payment-help toggle (improved) -->
<style>
  /* زر المساعدة الصغير */
    #pdHelpToggle {
    position: fixed;
    top: 2px;
    right: 178px;
    background: none;
    color: #ffcb01;
    border: none;
    font-size: 15px;
    font-weight: 900;
    cursor: pointer;
    z-index: 10000;
    transition: transform 0.2s ease, color 0.2s ease;
  }
  #pdHelpToggle:hover {
    transform: scale(1.2);
    color: #ffe566;
  }

  /* صندوق التعليمات */
  #pdHelpPopup {
    position: fixed;
    top: 60px;
    right: 20px;
    min-width: 260px;
    max-width: 90vw;
    background: #0b0b0b;
    color: #fff;
    border: 1px solid rgba(255, 203, 1, 0.3);
    border-radius: 10px;
    padding: 16px 20px;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
    z-index: 9999;
    display: none;
    white-space: pre-wrap;
    text-align: right;
    direction: rtl;
    animation: fadeIn 0.15s ease;
  }
  #pdHelpPopup.visible {
    display: block;
  }

  /* زر الإغلاق */
  #pdHelpPopup .close-btn {
    position: absolute;
    top: 6px;
    left: 10px;
    background: transparent;
    border: none;
    color: #fff;
    font-size: 18px;
    font-weight: bold;
    cursor: pointer;
  }
  #pdHelpPopup .close-btn:hover {
    color: #ffcb01;
  }

  #pdHelpContent {
    font-size: 15px;
    line-height: 1.7;
    margin-top: 8px;
    word-break: break-word;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(-6px); }
    to { opacity: 1; transform: translateY(0); }
  }

  @media (max-width: 480px) {
    #pdHelpToggle {
      top: 7px;
      left: 30%;
      font-size: 7px;
    }
    #pdHelpPopup {
      right: 8px;
      top: 55px;
      max-width: 90vw;
      padding: 14px;
      font-size: 14px;
    }
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const pdNoteEl = document.getElementById('pdNote');
  if (!pdNoteEl) return;

  // إخفاء النص الأصلي
  pdNoteEl.style.display = 'none';

  // إنشاء زر الاستفهام
  const helpBtn = document.createElement('button');
  helpBtn.id = 'pdHelpToggle';
  helpBtn.type = 'button';
  helpBtn.title = 'تعليمات الدفع';
  helpBtn.innerText = 'مساعدة';

  // إنشاء المربع المنبثق
  const popup = document.createElement('div');
  popup.id = 'pdHelpPopup';
  popup.setAttribute('role', 'dialog');
  popup.setAttribute('aria-hidden', 'true');
  popup.innerHTML = `
    <button class="close-btn" aria-label="إغلاق">×</button>
    <div id="pdHelpContent"></div>
  `;

  // إدراج العناصر بجانب عنصر التعليمات الأصلي
  const parent = pdNoteEl.parentNode || document.body;
  parent.insertBefore(helpBtn, pdNoteEl);
  parent.insertBefore(popup, pdNoteEl.nextSibling);

  const contentEl = document.getElementById('pdHelpContent');
  const closeBtn = popup.querySelector('.close-btn');

  // تحديث نص التعليمات داخل المربع
  function updatePopupContent() {
    const txt = (pdNoteEl.textContent || '').trim();
    contentEl.textContent = txt || 'لا توجد تعليمات حالياً.';
  }

  // فتح المربع
  function openPopup() {
    updatePopupContent();
    popup.classList.add('visible');
    popup.setAttribute('aria-hidden', 'false');

    const rect = helpBtn.getBoundingClientRect();
    const top = rect.bottom + window.scrollY + 8;
    const right = document.documentElement.clientWidth - rect.right - 10;
    popup.style.top = top + 'px';
    popup.style.right = right + 'px';
  }

  // إغلاق المربع
  function closePopup() {
    popup.classList.remove('visible');
    popup.setAttribute('aria-hidden', 'true');
  }

  // عند الضغط على الزر
  helpBtn.addEventListener('click', function (e) {
    e.stopPropagation();
    if (popup.classList.contains('visible')) closePopup();
    else openPopup();
  });

  // زر الإغلاق
  closeBtn.addEventListener('click', function (e) {
    e.stopPropagation();
    closePopup();
  });

  // إغلاق عند الضغط خارج الصندوق
  document.addEventListener('click', function (e) {
    if (!popup.contains(e.target) && e.target !== helpBtn) closePopup();
  });

  // إغلاق بزر Esc
  document.addEventListener('keydown', function (e) {
    if (e.key === 'Escape') closePopup();
  });

  // مراقبة تغيّر التعليمات
  const observer = new MutationObserver(updatePopupContent);
  observer.observe(pdNoteEl, { childList: true, subtree: true, characterData: true });

  // تحميل أولي
  updatePopupContent();
});
</script>
<style>
  #rotBannerWrap {
    width: 100%;
    max-width: 980px;
    margin: 14px auto;
    direction: rtl;
    padding: 0 12px;
    box-sizing: border-box;
  }
  .rotBanner {
    position: relative;
    width: 100%;
    height: 180px;
    border-radius: 12px;
    overflow: hidden;
    border: 2px solid var(--main-color);
    background: #0b0b0b;
  }
  .rotBanner .banner-img {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    transform: translateX(100%);
    transition: transform var(--rot-speed, 700ms) ease-in-out;
    will-change: transform;
    z-index: 1;
  }
  .rotBanner .banner-img.active {
    transform: translateX(0);
    z-index: 2;
  }
  .rotBanner .banner-img.to-left {
    transform: translateX(-100%);
    z-index: 1;
  }

  .banner-ticker {
    margin-top: 10px;
    height: 42px;
    overflow: hidden;
    border-radius: 10px;
    border: 1px solid rgba(255,255,255,0.04);
    background: linear-gradient(90deg, rgba(0,0,0,0.45), rgba(0,0,0,0.15));
    display:flex;
    align-items:center;
    padding: 6px 12px;
    position: relative;
  }
  .banner-ticker .ticker-track {
    position: absolute;
    right: -100%;
    white-space: nowrap;
    font-weight: 800;
    font-size: 16px;
    color: #fff;
    will-change: transform;
  }

  @media (max-width:720px){
    .rotBanner { height: 140px; }
    .banner-ticker { height: 36px; }
    .banner-ticker .ticker-track { font-size: 14px; }
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // ✅ سلايدر الصور
  const wrap = document.getElementById('rotBanner');
  if(wrap){
    const imgs = Array.from(wrap.querySelectorAll('.banner-img'));
    if(imgs.length){
      let current = 0;
      const INTERVAL_MS = 7000;
      const TRANSITION_MS = 700;
      wrap.style.setProperty('--rot-speed', TRANSITION_MS + 'ms');

      imgs.forEach((i)=>{
        i.style.transform = 'translateX(100%)';
        i.style.transition = 'transform ' + TRANSITION_MS + 'ms ease-in-out';
        i.classList.remove('active','to-left');
        i.setAttribute('aria-hidden','true');
        i.draggable = false;
      });
      imgs[current].classList.add('active');
      imgs[current].style.transform = 'translateX(0)';
      imgs[current].setAttribute('aria-hidden','false');

      let paused = false;
      wrap.addEventListener('mouseenter', ()=> paused = true);
      wrap.addEventListener('mouseleave', ()=> paused = false);
      wrap.addEventListener('touchstart', ()=> paused = true, { passive:true });
      wrap.addEventListener('touchend', ()=> paused = false);

      setInterval(()=> {
        if(paused) return;
        const prev = current;
        const next = (current + 1) % imgs.length;
        const prevImg = imgs[prev];
        const nextImg = imgs[next];
        nextImg.style.transition = 'none';
        nextImg.style.transform = 'translateX(100%)';
        void nextImg.offsetWidth;
        prevImg.classList.remove('active');
        prevImg.classList.add('to-left');
        prevImg.style.transform = 'translateX(-100%)';
        nextImg.style.transition = 'transform ' + TRANSITION_MS + 'ms ease-in-out';
        nextImg.classList.add('active');
        nextImg.style.transform = 'translateX(0)';
        current = next;
      }, INTERVAL_MS);
    }
  }

  // ✅ حركة الشريط النصي
  const ticker = document.getElementById('tickerTrack');
  if(ticker){
    const parent = ticker.parentElement;
    let pos = parent.offsetWidth;
    const speed = 1.5;
    function animateTicker(){
      pos -= speed;
      if (pos < -ticker.offsetWidth){
        pos = parent.offsetWidth;
      }
      ticker.style.transform = `translateX(${pos}px)`;
      requestAnimationFrame(animateTicker);
    }
    requestAnimationFrame(animateTicker);
  }
});
</script>
<style>
/* حركة الشريط السفلي */
#bottomNav {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  transition: transform 0.7s ease-in-out, opacity 0.7s ease-in-out;
  transform: translateX(0);
  opacity: 1;
  z-index: 100;
}

#bottomNav.hide-left {
  transform: translateX(-100%);
  opacity: 0;
}

#bottomNav.show-right {
  transform: translateX(0);
  opacity: 1;
}
</style>
</script>
<script>
document.addEventListener('DOMContentLoaded', function(){

  // ✅ حركة الشريط النصي (من اليسار إلى اليمين)
  const ticker = document.getElementById('tickerTrack');
  if(ticker){
    const parent = ticker.parentElement;
    let pos = -ticker.offsetWidth; // يبدأ من خارج اليسار
    const speed = 1.5; // سرعة الحركة
    function animateTicker(){
      pos += speed; // تحرك من اليسار إلى اليمين
      if (pos > parent.offsetWidth){
        pos = -ticker.offsetWidth; // إعادة التكرار عند نهاية الحاوية
      }
      ticker.style.transform = `translateX(${pos}px)`;
      requestAnimationFrame(animateTicker);
    }
    requestAnimationFrame(animateTicker);
  }

  // ✅ تحكم في ظهور/إخفاء البانر فقط (الشريط السفلي يبقى دائمًا ظاهر)
  const home = document.getElementById('homePage');
  const banner = document.getElementById('rotBannerWrap');
  const bottomNav = document.getElementById('bottomNav');

  function isHomeVisible() {
    return home && !home.classList.contains('hidden') && home.style.display !== 'none';
  }

  function updateVisibility(){
    const visible = isHomeVisible();
    if (banner) banner.style.display = visible ? '' : 'none';
    if (bottomNav) bottomNav.style.display = 'flex'; // يظل ظاهر دائمًا
  }

  if (home){
    const observer = new MutationObserver(updateVisibility);
    observer.observe(home, { attributes: true, attributeFilter: ['class', 'style'] });
  }

  updateVisibility();

});
</script>

<style>
/* ✅ تثبيت الشريط السفلي بدون حركة */
#bottomNav {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  transform: translateX(0);
  opacity: 1;
  z-index: 100;
}
</style>
<!-- START: hack - lock/login-mode helper (paste before </body>) -->
<style>
  /* عند تفعيل login-mode نخفي التفاصيل العلوية والسفلية */
  body.login-mode #siteLogo,
  body.login-mode #balanceBox,
  body.login-mode #notifBell,
  body.login-mode #personalNumberDisplay,
  body.login-mode .menu,
  body.login-mode #ordersStatusBar,
  body.login-mode #headerSearchInput,
  body.login-mode #searchToggleBtn,
  body.login-mode #menuBtn {
    display: none !important;
    opacity: 0 !important;
    pointer-events: none !important;
  }

  /* اخفاء الأزرار السفلية */
  body.login-mode #bottomNav,
  body.login-mode .nav-btn,
  body.login-mode .nav-label {
    display: none !important;
    pointer-events: none !important;
    opacity: 0 !important;
  }

  /* اخفاء الحقل الشخصي في النموذج إذا بقي ظاهراً */
  #loginPersonalNumber,
  #loginPersonalNumber + label {
    display: none !important;
  }

  /* مظهر زر معطل */
  .disabled-by-login {
    opacity: 0.45 !important;
    pointer-events: none !important;
    cursor: not-allowed !important;
  }
</style>

<script>
(function(){
  // عناصر/إعدادات قابلة للتعديل
  const LOGIN_PAGE_ID = 'loginPage';
  const PERSONAL_INPUT_ID = 'loginPersonalNumber'; // الحقل الذي تريد إخفاءه
  const REQUIRED_FIELDS = ['loginName','loginPassword','loginPhone']; // الحقول المطلوبة قبل تفعيل الأزرار
  const LOGIN_BTN_SELECTOR = '#doLoginBtn';
  const CREATE_SELECTORS = ['#createAccountBtn', '#createBtn', '[data-create-account]'];

  // Helpers
  const $id = id => document.getElementById(id);
  const qs = sel => document.querySelector(sel);
  const qsa = sel => Array.from(document.querySelectorAll(sel));

  function setBodyLoginMode(on){
    if(on) document.body.classList.add('login-mode');
    else document.body.classList.remove('login-mode');
  }

  function hidePersonalField(){
    try {
      const p = $id(PERSONAL_INPUT_ID);
      if(p){
        p.style.display = 'none';
        // hide previous label if present
        const prev = p.previousElementSibling;
        if(prev && prev.tagName && prev.tagName.toLowerCase() === 'label') prev.style.display = 'none';
      }
    } catch(e){ /* ignore */ }
  }

  // validation: كل الحقول المطلوبة غير فارغة + إذا يوجد ايميل: صيغة صحيحة (اختياري)
  function isLoginFormValid(){
    for(const id of REQUIRED_FIELDS){
      const el = $id(id);
      if(!el) return false; // لو الحقل غير موجود اعتبر النموذج غير كامل
      if(String(el.value || '').trim() === '') return false;
    }
    // إذا أردت إضافة قواعد إضافية (طول كلمة السر، صيغة الهاتف) عدل هنا
    return true;
  }

  function setButtonsDisabled(state){
    // زر تسجيل الدخول
    const loginBtn = qs(LOGIN_BTN_SELECTOR);
    if(loginBtn){
      loginBtn.disabled = !!state;
      loginBtn.classList.toggle('disabled-by-login', !!state);
    }
    // زر أو أزرار الإنشاء
    const createEls = qsa(CREATE_SELECTORS.join(','));
    if(createEls.length === 0){
      // fallback: العنصر قد يكون قد تم إنشاؤه ديناميكياً باسم آخر؛ نجرب id المحتمل
      const alt = $id('createAccountBtn') || $id('createBtn');
      if(alt) createEls.push(alt);
    }
    createEls.forEach(el=>{
      try { el.disabled = !!state; el.classList.toggle('disabled-by-login', !!state); } catch(e){}
    });
  }

  // عرض رسالة خطأ بسيطة (يستخدم showLoginError إن وُجد)
  function showMsg(msg){
    try {
      if(typeof showLoginError === 'function') {
        showLoginError(msg);
        return;
      }
    } catch(e){}
    if(msg) alert(msg);
  }

  // عند تغيّر أي حقل نفعّل أو نُعطّل الأزرار
  function attachValidationListeners(){
    REQUIRED_FIELDS.forEach(id=>{
      const el = $id(id);
      if(!el) return;
      el.addEventListener('input', ()=> setButtonsDisabled(!isLoginFormValid()));
      el.addEventListener('change', ()=> setButtonsDisabled(!isLoginFormValid()));
    });
    // أيضاً افحص عند تغيّر أي حقل آخر مهم
    qsa('#loginEmail').forEach(e => e.addEventListener('input', ()=> setButtonsDisabled(!isLoginFormValid())));
    // حالة ابتدائية
    setButtonsDisabled(!isLoginFormValid());
  }

  // منع ارسال بالـ Enter لو النموذج غير مكتمل
  function preventEnterIfInvalid(){
    const inputs = REQUIRED_FIELDS.map(id => $id(id)).filter(Boolean);
    inputs.forEach(inp=>{
      inp && inp.addEventListener('keydown', function(e){
        if(e.key === 'Enter' && !isLoginFormValid()){
          e.preventDefault();
          showMsg('الرجاء إكمال جميع الحقول المطلوبة قبل المتابعة.');
        }
      });
    });
  }

  // مراقبة ظهور/إخفاء صفحة loginPage وإدارة وضع الـ login-mode
  function observeLoginPageVisibility(){
    const loginPage = $id(LOGIN_PAGE_ID);
    if(!loginPage) return;
    const applyState = () => {
      // تعريف: صفحة مرئية إذا لا تحتوي صنف 'hidden' أو style.display === 'block' أو غير مخفية
      const isVisible = !loginPage.classList.contains('hidden') && getComputedStyle(loginPage).display !== 'none' && loginPage.offsetParent !== null;
      setBodyLoginMode(isVisible);
      if(isVisible){
        hidePersonalField();
        setButtonsDisabled(!isLoginFormValid());
      } else {
        setButtonsDisabled(false); // فك القفل لو خرج المستخدم من الصفحة
      }
    };
    // راقب class/attributes و subtree كاحتياط لأن الكود في ملفك يغير الكلاسات ديناميكياً
    const mo = new MutationObserver(applyState);
    mo.observe(loginPage, { attributes:true, attributeFilter:['class','style'], childList:false, subtree:false });
    // استدعاء أولي
    applyState();
    // أيضاً استمع لتبديل الصفحات العامة لو ملفك يستعمل دوال لإظهار الصفحة
    window.addEventListener('hashchange', applyState);
    window.addEventListener('popstate', applyState);
  }

  // منع الضغط على الأزرار إن النموذج غير مكتمل (دوبل تأمين)
  function interceptButtons(){
    document.addEventListener('click', function(e){
      const target = e.target.closest ? e.target.closest('button, [role="button"]') : null;
      if(!target) return;
      const isLoginBtn = target.matches && target.matches(LOGIN_BTN_SELECTOR);
      const isCreateBtn = CREATE_SELECTORS.some(s => {
        try { return target.matches(s); } catch(e){ return false; }
      }) || (target.id && /(createAccountBtn|createBtn|create)/i.test(target.id));
      if((isLoginBtn || isCreateBtn) && !isLoginFormValid()){
        e.preventDefault(); e.stopPropagation();
        showMsg('الرجاء تعبئة جميع الحقول المطلوبة قبل متابعة إنشاء الحساب أو تسجيل الدخول.');
        setButtonsDisabled(true);
      }
    }, true); // capture to intercept early
  }

  // تشغيل الكل عند DOMContentLoaded
  document.addEventListener('DOMContentLoaded', function(){
    try {
      // إخفاء الحقل الشخصي فوراً (كمظلّة إضافية)
      hidePersonalField();

      // Attach validation listeners if login inputs موجودة
      attachValidationListeners();
      preventEnterIfInvalid();
      interceptButtons();
      observeLoginPageVisibility();

      // إذا صفحة الدخول مرئية حالياً نضع body.login-mode
      const loginPage = $id(LOGIN_PAGE_ID);
      if(loginPage){
        const isVisible = !loginPage.classList.contains('hidden') && getComputedStyle(loginPage).display !== 'none';
        setBodyLoginMode(isVisible);
      }
    } catch(err){
      console.warn('login-mode helper error', err);
    }
  });
})();
</script>
<!-- END: hack - lock/login-mode helper -->
<!-- START: open payment page from header (paste before </body>) -->
<script>
document.addEventListener('DOMContentLoaded', function () {
  function openPaymentPage() {
    try {
      // إذا عندك دالة عامة لعرض الصفحات استخدمها
      if (typeof showPageQuick === 'function') {
        showPageQuick('paymentDetailsPage');
        return;
      }
      // fallback بسيط: إظهار الصفحة مباشرة
      const page = document.getElementById('paymentDetailsPage');
      if (page) {
        // إخفاء الصفحات الأخرى
        document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
        // إظهار صفحة الشحن
        page.classList.remove('hidden');
        page.scrollIntoView({ behavior: 'smooth' });
      }
    } catch (e) {
      console.warn('openPaymentPage error:', e);
    }
  }

  // عند الضغط على صندوق الرصيد الكامل
  const balanceBox = document.getElementById('balanceBox');
  if (balanceBox) {
    balanceBox.style.cursor = 'pointer';
    balanceBox.title = 'شحن الرصيد';
    balanceBox.addEventListener('click', function (e) {
      e.preventDefault();
      openPaymentPage();
    });
  }

  // مراقبة النقرات داخل الهيدر: "ل.س" أو "+"
  const header = document.getElementById('topHeader') || document.querySelector('header');
  if (header) {
    header.addEventListener('click', function (e) {
      const t = e.target;
      const text = (t.textContent || '').trim();
      if (text.includes('ل.س') || text === '+' || t.closest('.balance-plus') || t.closest('[data-charge]')) {
        e.preventDefault();
        openPaymentPage();
      }
    }, true);
  }

  // ربط أي زر أو أيقونة خاصة بالشحن (اختياري)
  const plusIcons = document.querySelectorAll('#balancePlus, .balance-plus, .balance-add');
  plusIcons.forEach(el => {
    el.style.cursor = 'pointer';
    el.title = 'شحن الرصيد';
    el.addEventListener('click', function (e) {
      e.preventDefault();
      openPaymentPage();
    });
  });
});
</script>
<!-- END: open payment page from header -->
<!-- START: custom sidebar buttons (final blue designer) -->
<style>
  .custom-side-links {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-bottom: 12px;
  }

  .custom-side-btn {
    display: flex;
    align-items: center; /* توسيط عمودي */
    justify-content: flex-end;
    gap: 8px;
    padding: 10px 12px;
    border-radius: 12px;
    background: #f7f7f7;
    color: #111;
    font-size: 15px;
    font-weight: 500;
    text-decoration: none;
    transition: all 0.25s ease;
    line-height: 1.2;
  }

  .custom-side-btn:hover {
    background: #e7e7e7;
    transform: translateX(-3px);
  }

  .custom-side-btn svg {
    width: 18px;
    height: 18px;
    flex-shrink: 0;
    vertical-align: middle;
    display: inline-block;
  }

  /* أول 3 أزرار بمحاذاة اليمين */
  .custom-side-btn:nth-child(-n+3) {
    justify-content: flex-end;
    text-align: right;
  }

  /* الزر الأخير (المصمم) */
  .custom-designer {
    justify-content: center !important;
    font-size: 13px;
    background: #e8f1ff;
    color: #007bff !important;
    border: 1px solid #cddfff;
  }
  .custom-designer:hover {
    background: #d8e8ff;
    transform: none;
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const sidebar =
    document.querySelector('.sidebar') ||
    document.getElementById('sideMenu') ||
    document.querySelector('#sideMenuContainer');

  if (!sidebar) return;

  const chargeBtn = sidebar.querySelector('#chargeBalanceBtn, .charge-btn, [data-page="paymentDetailsPage"]');

  const group = document.createElement('div');
  group.className = 'custom-side-links';

  group.innerHTML = `
    <a href="https://wa.me/79228576801" target="_blank" class="custom-side-btn" style="color:#25D366;">
      <span>تواصل واتساب</span>
      <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
        <path d="M12.04 2C6.52 2 2 6.13 2 11.04c0 1.93.65 3.74 1.76 5.24L2 22l5.93-1.7a10.1 10.1 0 0 0 4.11.87c5.52 0 10.04-4.13 10.04-9.04S17.56 2 12.04 2Zm0 16.25a8.3 8.3 0 0 1-4.23-1.15l-.3-.18-3.52 1.01.99-3.43-.22-.35a7.48 7.48 0 0 1-1.2-4.11c0-4.09 3.57-7.41 7.96-7.41s7.96 3.32 7.96 7.41-3.57 7.41-7.96 7.41Zm4.25-5.39c-.23-.12-1.35-.67-1.56-.75-.21-.08-.36-.12-.52.12-.16.23-.6.75-.73.91-.13.16-.27.17-.5.06-.23-.12-.97-.35-1.85-1.11-.68-.6-1.15-1.34-1.28-1.56-.13-.23-.01-.36.1-.48.1-.1.23-.27.35-.4.12-.13.16-.23.23-.39.08-.16.04-.29-.02-.4-.06-.12-.52-1.25-.72-1.71-.19-.45-.38-.39-.52-.4h-.44c-.16 0-.4.06-.61.29-.21.23-.8.78-.8 1.89 0 1.1.82 2.17.93 2.32.12.16 1.61 2.57 3.93 3.49.55.24.97.38 1.3.49.55.17 1.05.15 1.45.09.44-.07 1.35-.55 1.54-1.08.19-.52.19-.97.13-1.08-.06-.11-.21-.17-.44-.29Z"/>
      </svg>
    </a>

    <a href="https://www.instagram.com/forbi__4b?igsh=NjN1cjI0OWJjdHA0" target="_blank" class="custom-side-btn" style="color:#E4405F;">
      <span>حسابنا إنستغرام</span>
      <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
        <path d="M7 2C4.2 2 2 4.2 2 7v10c0 2.8 2.2 5 5 5h10c2.8 0 5-2.2 5-5V7c0-2.8-2.2-5-5-5H7Zm0 2h10c1.7 0 3 1.3 3 3v10c0 1.7-1.3 3-3 3H7c-1.7 0-3-1.3-3-3V7c0-1.7 1.3-3 3-3Zm5 3a5 5 0 1 0 0 10 5 5 0 0 0 0-10Zm0 2a3 3 0 1 1 0 6 3 3 0 0 1 0-6Zm4.8-.9a1.1 1.1 0 1 0 0-2.2 1.1 1.1 0 0 0 0 2.2Z"/>
      </svg>
    </a>

    <a href="mailto:4bfourbe1@gmail.com" class="custom-side-btn" style="color:#4285F4;">
      <span>البريد الإلكتروني</span>
      <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
        <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2Zm0 2v.01L12 13l8-6.99V6H4Zm0 12h16V9l-8 7-8-7v9Z"/>
      </svg>
    </a>


  `;

  if (chargeBtn) {
    sidebar.insertBefore(group, chargeBtn);
  } else {
    sidebar.appendChild(group);
  }
});
</script>
<!-- END: custom sidebar buttons (final blue designer) -->
<!-- START: always scroll to top on load -->
<script>
document.addEventListener("DOMContentLoaded", function() {
  // عند تحميل الصفحة أو إعادة تحميلها
  window.scrollTo(0, 0);

  // وأيضًا بعد فترة قصيرة (للتأكد لو سكريبتات ثانية نزلتها)
  setTimeout(() => window.scrollTo(0, 0), 300);

  // لو الموقع يستخدم نظام صفحات داخلية (SPA)
  window.addEventListener('hashchange', () => window.scrollTo(0, 0));
  window.addEventListener('popstate', () => window.scrollTo(0, 0));
});
</script>
<!-- END: always scroll to top on load -->
<!-- START: hide header on theme page (fixed version) -->
<style>
  /* عندما تكون صفحة الثيم ظاهرة */
  body.theme-mode #siteLogo,
  body.theme-mode #balanceBox,
  body.theme-mode #notifBell,
  body.theme-mode #personalNumberDisplay,
  body.theme-mode #headerSearchInput,
  body.theme-mode #searchToggleBtn,
  body.theme-mode #menuBtn,
  body.theme-mode #ordersStatusBar {
    visibility: hidden !important;
    opacity: 0 !important;
    pointer-events: none !important;
  }
</style>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const THEME_PAGE_ID = "themePage"; // غيّرها لو اسم الصفحة مختلف

  function checkThemePageVisibility() {
    const page = document.getElementById(THEME_PAGE_ID);
    if (!page) return;
    const isVisible =
      !page.classList.contains("hidden") &&
      getComputedStyle(page).display !== "none" &&
      page.offsetParent !== null;

    document.body.classList.toggle("theme-mode", isVisible);
  }

  // مراقبة الصفحة
  const page = document.getElementById(THEME_PAGE_ID);
  if (page) {
    const observer = new MutationObserver(checkThemePageVisibility);
    observer.observe(page, { attributes: true, attributeFilter: ["class", "style"] });
  }

  // عند تغيّر الصفحة أو التحميل
  window.addEventListener("hashchange", checkThemePageVisibility);
  window.addEventListener("popstate", checkThemePageVisibility);
  checkThemePageVisibility();
});
</script>
<!-- END: hide header on theme page (fixed version) -->
<!-- START: replace ripple/glow with new subtle press style -->
<style>
  /* override old ripple/glow with a subtler look */
  .ui-ripple {
    position: absolute;
    border-radius: 50%;
    transform: scale(0.6);
    opacity: 0.18;
    pointer-events: none;
    z-index: 60;
    will-change: transform, opacity;
    transition: transform 260ms cubic-bezier(.2,.9,.2,1), opacity 260ms linear;
    background: radial-gradient(circle at center, rgba(255,255,255,0.55) 0%, rgba(255,255,255,0.12) 18%, rgba(255,255,255,0.02) 60%);
    mix-blend-mode: screen;
  }

  /* new glow: soft elevation + colored halo (uses --main-color if set) */
  .ui-glow {
    transform: translateY(-2px) scale(1.01) !important;
    box-shadow:
      0 10px 30px rgba(0,0,0,0.12),
      0 0 14px color-mix(in srgb, var(--main-color, #007bff) 40%, rgba(0,0,0,0.0)) ;
    transition: transform 200ms ease, box-shadow 200ms ease;
  }

  /* press scale class for immediate tactile feedback */
  .press-touch {
    transition: transform 120ms cubic-bezier(.2,.9,.2,1);
  }
  .press-touch.is-pressed {
    transform: scale(0.96) !important;
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', function () {
  try {
    // override global createRipple and triggerGlow if exist, otherwise create them
    window.createRipple = function(el, e){
      try {
        const rect = el.getBoundingClientRect();
        const size = Math.max( Math.min(rect.width, rect.height) * 0.9, 24 );
        const ripple = document.createElement('span');
        ripple.className = 'ui-ripple';
        ripple.style.width = ripple.style.height = size + 'px';

        const clientX = e.touches ? e.touches[0].clientX : (e.clientX || rect.left + rect.width/2);
        const clientY = e.touches ? e.touches[0].clientY : (e.clientY || rect.top + rect.height/2);

        ripple.style.left = (clientX - rect.left - size/2) + 'px';
        ripple.style.top  = (clientY - rect.top  - size/2) + 'px';

        // subtle color: blend with --main-color if available
        const root = document.documentElement;
        const main = getComputedStyle(root).getPropertyValue('--main-color').trim();
        if(main){
          // make a faint tinted overlay if main color exists
          ripple.style.background = `radial-gradient(circle at center, rgba(255,255,255,0.6) 0%, rgba(255,255,255,0.12) 20%, rgba(0,0,0,0.02) 60%), ${main}`;
          ripple.style.mixBlendMode = 'screen';
        }

        el.appendChild(ripple);

        // tiny delay then expand+fade quickly
        requestAnimationFrame(()=> {
          ripple.style.transform = 'scale(1.9)';
          ripple.style.opacity = '0';
        });

        // remove fast so it doesn't clutter DOM
        setTimeout(()=> { try{ ripple.remove(); } catch(e){} }, 360);
      } catch(err) { console.warn('createRipple override error', err); }
    };

    window.triggerGlow = function(el, opts = {}){
      try {
        const dur = opts.duration || 200;
        el.classList.add('ui-glow');

        // add press scale for tactile feedback
        el.classList.add('press-touch');
        // small timeout to ensure press-touch CSS applied
        requestAnimationFrame(()=> el.classList.add('is-pressed'));

        if(el.__uiGlowTimer) clearTimeout(el.__uiGlowTimer);
        el.__uiGlowTimer = setTimeout(()=> {
          try{
            el.classList.remove('ui-glow');
            el.classList.remove('is-pressed');
          }catch(e){}
        }, dur);
      } catch(err){ console.warn('triggerGlow override error', err); }
    };

    // re-attach ripple/glow handlers to all interactive elements
    if(typeof attachRipplesAndGlow === 'function'){
      // small delay to ensure override applied before rebind
      setTimeout(()=> {
        try { attachRipplesAndGlow(); } catch(e){ console.warn('attachRipplesAndGlow failed', e); }
      }, 40);
    } else {
      // fallback: very lightweight binding for common selectors
      const selectors = 'button, a, [role="button"], .btn, .nav-btn, .small-btn, .custom-side-btn';
      document.querySelectorAll(selectors).forEach(el=>{
        if(getComputedStyle(el).pointerEvents === 'none') return;
        // ensure container positioning for ripple
        const cs = getComputedStyle(el);
        if(cs.position === 'static' || !cs.position) el.style.position = 'relative';
        el.style.overflow = 'hidden';

        el.addEventListener('pointerdown', function(e){
          if(e.button && e.button !== 0) return;
          createRipple(el, e);
          triggerGlow(el);
        }, {passive: true});
      });
    }
  } catch(err){
    console.warn('press-style init error', err);
  }
});
</script>
<!-- END: replace ripple/glow with new subtle press style -->
<!-- START: gradient-border click glow for games/apps -->
<style>
  /* طبقة التوهج العامة */
  .grad-click-glow {
    position: absolute;
    inset: -8px;                /* تمتد خارج الحافة قليلاً ليظهر الهالة */
    border-radius: inherit;
    pointer-events: none;
    z-index: 80;
    opacity: 0;
    transform: scale(0.96);
    transition: opacity 260ms ease, transform 260ms cubic-bezier(.2,.9,.2,1);
    filter: blur(12px);
    mix-blend-mode: screen;
  }

  .grad-click-glow.active {
    opacity: 0.95;
    transform: scale(1.06);
  }

  /* تأكد أن العنصر الحامل لهو relatif حتى تتموضع الطبقة بشكل صحيح */
  .grad-glow-pos {
    position: relative !important;
    overflow: visible !important;
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', function () {
  // الصّيغ/السلكتورات التي نريد أن تستجيب للضغط
  const TARGET_SELECTORS = [
    '.game-card', '.app-card', '.card', '.tile', '.item',
    '.app-item', '.game-item', '.gradient-border', '[data-gradient="true"]'
  ].join(',');

  // لون احتياطي لو لم نجد gradient
  const FALLBACK = 'radial-gradient(circle at center, rgba(0,123,255,0.18), rgba(0,123,255,0.04))';

  function ensurePositioned(el){
    const cs = getComputedStyle(el);
    if(cs.position === 'static' || !cs.position) {
      el.classList.add('grad-glow-pos');
    }
  }

  function createGlowElement(el, bg){
    const glow = document.createElement('span');
    glow.className = 'grad-click-glow';
    glow.style.background = bg;
    // match border radius if element has it inline
    const br = getComputedStyle(el).borderRadius;
    if(br) glow.style.borderRadius = br;
    return glow;
  }

  function deriveGradient(el){
    const cs = getComputedStyle(el);
    // 1) إذا هناك var CSS مخصص للـ gradient
    const v = cs.getPropertyValue('--border-gradient').trim();
    if(v) return v;

    // 2) background-image قد يحتوي على linear-gradient(...)
    const bgImg = cs.backgroundImage;
    if(bgImg && bgImg !== 'none') return bgImg;

    // 3) border-image-source (بعض التصاميم تستخدمه)
    const bis = cs.getPropertyValue('border-image-source');
    if(bis && bis !== 'none') return bis;

    // 4) جرب استخدام خلفية العنصر إذا كانت تدرجية
    const bg = cs.getPropertyValue('background');
    if(bg && /gradient\(/i.test(bg)) return bg;

    // fallback
    return FALLBACK;
  }

  // عند الضغط (pointerdown) نضيف التوهج
  document.body.addEventListener('pointerdown', function (e) {
    const target = e.target.closest ? e.target.closest(TARGET_SELECTORS) : null;
    if(!target) return;

    // لا تفعل إذا العنصر مُعطل
    if(target.matches && (target.disabled || target.getAttribute('aria-disabled') === 'true')) return;

    try {
      ensurePositioned(target);

      // إزالة توهج سابق إن وُجد
      const old = target.querySelector('.grad-click-glow');
      if(old) old.remove();

      // نحاول استعمال gradient من العنصر نفسه
      const grad = deriveGradient(target);

      const glow = createGlowElement(target, grad);

      // إدراج ثم تفعيل الحركة بقليل من التأخير لبدء الانتقال
      target.appendChild(glow);

      // تفعيل التأثير (frame tick)
      requestAnimationFrame(() => {
        glow.classList.add('active');
      });

      // إزالة التوهّج بعد مدة قصيرة (600ms)
      setTimeout(() => {
        try {
          glow.classList.remove('active');
          // إزالة بعد انتهاء الانتقال
          setTimeout(()=> glow.remove(), 300);
        } catch (err) {}
      }, 600);

    } catch (err) {
      console.warn('grad-glow error', err);
    }
  }, {passive: true});

  // دعم لعناصر تُضاف ديناميكياً: نراقب إن أردت إضافة سلوك إضافي لاحقاً
  // (الEvent delegation أعلاه يغطي العناصر الجديدة أيضاً، لذا هذا اختياري)
});
</script>
<!-- END: gradient-border click glow for games/apps -->
<!-- START: compact transparent back buttons for section & theme pages -->
<style>
  /* نطبّق التغيير فقط داخل sectionPage و themePage */
  #sectionPage .back-btn,
  #sectionPage #sectionBackBtn,
  #themePage .back-btn,
  #themePage #themeBackBtn {
    background: transparent !important;   /* شفاف */
    background-image: none !important;
    border: none !important;
    color: var(--main-color) !important;  /* لون أيقونة/نص متوافق مع الثيم */
    padding: 6px 8px !important;          /* أصغر من السابق */
    min-width: 36px !important;
    height: 36px !important;
    display: inline-flex !important;
    align-items: center !important;
    justify-content: center !important;
    gap: 6px !important;
    border-radius: 8px !important;
    font-size: 13px !important;
    font-weight: 600 !important;
    box-shadow: none !important;
    text-align: center !important;
    cursor: pointer !important;
    vertical-align: middle !important;
    transition: transform .12s ease, opacity .12s ease;
  }

  /* اذا كان الزر يحتوي svg تصغيره وتوسيطه */
  #sectionPage .back-btn svg,
  #sectionPage #sectionBackBtn svg,
  #themePage .back-btn svg,
  #themePage #themeBackBtn svg {
    width: 16px !important;
    height: 16px !important;
    display: inline-block !important;
    vertical-align: middle !important;
    margin: 0 !important;
    fill: currentColor !important;
  }

  /* عند الضغط تأثير انكماش خفيف */
  #sectionPage .back-btn:active,
  #themePage .back-btn:active,
  #sectionPage #sectionBackBtn:active,
  #themePage #themeBackBtn:active {
    transform: scale(0.95) !important;
    opacity: 0.95 !important;
  }

  /* ضمان الرؤية على خلفيات فاتحة */
  #sectionPage .back-btn,
  #themePage .back-btn {
    -webkit-tap-highlight-color: transparent;
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', function () {
  // لو كانت الأزرار تضاف ديناميكياً، نضيف صنف بسيط للتأكد
  function adaptBackBtns(root=document){
    const sel = '#sectionPage .back-btn, #sectionPage #sectionBackBtn, #themePage .back-btn, #themePage #themeBackBtn';
    Array.from((root.querySelectorAll ? root.querySelectorAll(sel) : [])).forEach(el=>{
      if(!el) return;
      try {
        // أزل أي inline background قد يكون موضوع
        el.style.background = 'transparent';
        el.style.backgroundImage = 'none';
        // ضع role/button و aria-label لو غير موجود لتحسين الوصول
        if(!el.getAttribute('role')) el.setAttribute('role','button');
        if(!el.getAttribute('aria-label')) el.setAttribute('aria-label','رجوع');
      } catch(e){}
    });
  }

  adaptBackBtns(document);

  // راقب DOM لإضافة عناصر جديدة (SPA)
  const mo = new MutationObserver(muts=>{
    muts.forEach(m=>{
      if(!m.addedNodes) return;
      m.addedNodes.forEach(node=>{
        if(!(node instanceof HTMLElement)) return;
        adaptBackBtns(node);
      });
    });
  });
  mo.observe(document.body, { childList: true, subtree: true });
});
</script>

<script>
/*
  زر "سعر الدولار اليوم" أسفل "الطلبات"
  عند الضغط يفتح صفحة داخلية تعرض سعر الشراء & المبيع من sp-today.com
*/
(function(){
  const SOURCE_URL = 'https://www.sp-today.com/';
  const ALLORIGINS_RAW = 'https://api.allorigins.win/raw?url=';
  const REFRESH_MS = 5 * 60 * 1000;

  // إنشاء صفحة داخلية لعرض السعر
  function createDollarPage(){
    if(document.getElementById('dollarPage')) return;
    const page = document.createElement('div');
    page.id = 'dollarPage';
    page.className = 'hidden';
    page.style.cssText = `
      position:fixed;inset:0;z-index:99999;background:rgba(0,0,0,0.6);
      display:flex;align-items:center;justify-content:center;padding:20px;
    `;
    page.innerHTML = `
      <div style="background:#111;color:#fff;padding:20px;border-radius:12px;max-width:600px;width:100%">
        <h2 style="margin:0 0 15px;text-align:center">💲 سعر الدولار اليوم (الليرة السورية)</h2>
        <div style="display:flex;gap:12px;justify-content:space-between;margin-bottom:12px">
          <div style="flex:1;background:#222;padding:10px;border-radius:8px;text-align:center">
            <div style="color:#ffcc00;font-weight:bold">سعر الشراء</div>
            <div id="usd-buy" style="margin-top:6px;font-size:22px;font-weight:900">...</div>
          </div>
          <div style="flex:1;background:#222;padding:10px;border-radius:8px;text-align:center">
            <div style="color:#8be18b;font-weight:bold">سعر المبيع</div>
            <div id="usd-sell" style="margin-top:6px;font-size:22px;font-weight:900">...</div>
          </div>
        </div>
        <div style="text-align:center;margin:8px 0;color:#aaa">آخر تحديث: <span id="usd-time">-</span></div>
        <div style="display:flex;gap:10px;justify-content:center;margin-top:10px">
          <button id="usd-refresh" style="padding:8px 14px;border:none;border-radius:6px;background:#ffcc00;cursor:pointer">تحديث</button>
          <button id="usd-close" style="padding:8px 14px;border:1px solid #444;border-radius:6px;background:transparent;color:#fff;cursor:pointer">إغلاق</button>
        </div>
      </div>
    `;
    document.body.appendChild(page);

    // إغلاق
    page.querySelector('#usd-close').addEventListener('click', ()=> page.classList.add('hidden'));
    // تحديث
    page.querySelector('#usd-refresh').addEventListener('click', fetchAndShow);
  }

  // محولات الأرقام العربية
  function convertArabicDigits(s){
    return s ? s.replace(/[\u06F0-\u06F9]/g, ch => String(ch.charCodeAt(0)-0x06F0))
              .replace(/[\u0660-\u0669]/g, ch => String(ch.charCodeAt(0)-0x0660)) : s;
  }
  // استخراج الأرقام
  function extractInts(txt){
    if(!txt) return [];
    const conv = convertArabicDigits(txt);
    const matches = conv.match(/\d{1,3}(?:[.,\s]\d{3})+|\d{3,8}/g);
    if(!matches) return [];
    return matches.map(m => Number(m.replace(/[^\d]/g,''))).filter(n=>n>0);
  }
  function formatNum(n){ return new Intl.NumberFormat('en-US').format(n); }

  // جلب الصفحة وتحليل السعر
  async function fetchRates(){
    async function tryFetch(url){ try{ const r=await fetch(url); if(r.ok) return await r.text(); }catch{} return null; }
    let html = await tryFetch(SOURCE_URL);
    if(!html) html = await tryFetch(ALLORIGINS_RAW+encodeURIComponent(SOURCE_URL));
    if(!html) return null;
    const idx = html.indexOf('دولار أمريكي');
    const slice = idx>=0 ? html.slice(Math.max(0,idx-200), idx+400) : html.slice(0,2500);
    const nums = extractInts(slice);
    if(nums.length>=2) return { buy:nums[0], sell:nums[1] };
    if(nums.length>=1) return { buy:nums[0], sell:nums[0] };
    return null;
  }

  // عرض داخل الصفحة
  async function fetchAndShow(){
    const buyEl = document.getElementById('usd-buy');
    const sellEl = document.getElementById('usd-sell');
    const timeEl = document.getElementById('usd-time');
    if(buyEl) buyEl.textContent = '...';
    if(sellEl) sellEl.textContent = '...';
    const data = await fetchRates();
    if(data){
      buyEl.textContent = formatNum(data.buy)+' ل.س';
      sellEl.textContent = formatNum(data.sell)+' ل.س';
      timeEl.textContent = new Date().toLocaleString();
    } else {
      buyEl.textContent = sellEl.textContent = 'غير متوفر';
    }
  }

  // إدراج زر أسفل "الطلبات"
  function insertSidebarButton(){
    const sidebar = document.querySelector('#sidebar, .sidebar, aside, nav');
    if(!sidebar) return;
    const ordersBtn = Array.from(sidebar.querySelectorAll('button,a,div')).find(el=>{
      const t = (el.textContent||'').trim();
      return t.includes('الطلبات');
    });
    const btn = document.createElement('button');
    btn.textContent = 'سعر الدولار اليوم';
    btn.style.cssText = 'display:block;width:100%;padding:10px;margin-top:8px;border:none;border-radius:8px;cursor:pointer;background:#eee;';
    btn.onclick = ()=>{
      createDollarPage();
      document.getElementById('dollarPage').classList.remove('hidden');
      fetchAndShow();
    };
    if(ordersBtn && ordersBtn.parentElement){
      ordersBtn.parentElement.appendChild(btn);
    } else {
      sidebar.appendChild(btn);
    }
  }

  // نفّذ
  insertSidebarButton();
})();
</script>
<script>
// دالة لاستخراج سعر الصرف من HTML باستخدام proxy
async function getExchangeRateFromSPToday() {
  try {
    // استخدام proxy لتجنب CORS
    const proxyUrl = 'https://api.codetabs.com/v1/proxy?quest=';
    const targetUrl = 'https://sp-today.com/en';
    const response = await fetch(proxyUrl + encodeURIComponent(targetUrl));
    const html = await response.text();

    // إنشاء عنصر مؤقت لتحليل HTML
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, 'text/html');

    // البحث عن العنصر الذي يحتوي على السعر
    // بعد فحص الموقع (في 2025)، السعر غالبًا في:
    // <div class="rate rate-black"> ... <span class="rate-value">11250</span> ...
    const rateElement = doc.querySelector('.rate-black .rate-value') || 
                        doc.querySelector('.rate-value') ||
                        doc.querySelector('[class*="rate"] span:last-child');

    if (rateElement && !isNaN(rateElement.textContent.trim())) {
      const rate = parseFloat(rateElement.textContent.trim());
      console.log('تم جلب سعر الصرف من SP Today:', rate);
      return rate;
    } else {
      throw new Error('لم يتم العثور على سعر الصرف في الصفحة');
    }
  } catch (error) {
    console.error('خطأ في جلب سعر الصرف من SP Today:', error);
    // fallback إلى سعر افتراضي
    return 11200;
  }
}

// تنسيق رقم باللاتيني (11,200)
function formatNumber(num) {
  return Math.round(num).toLocaleString('en-US');
}

// تحديث الأسعار في gamePackages
async function updatePricesFromSPToday() {
  const rate = await getExchangeRateFromSPToday();
  
  for (const game in gamePackages) {
    for (const pkg of gamePackages[game]) {
      // تأكد أن كل باقة تحتوي على usdPrice
      if (typeof pkg.usdPrice !== 'number') {
        console.warn(`الباقة ${pkg.id} لا تحتوي على usdPrice!`);
        continue;
      }
      
      const priceInSYP = pkg.usdPrice * rate;
      pkg.priceNum = Math.round(priceInSYP);
      pkg.priceText = `${formatNumber(priceInSYP)} ل.س`;

      // تحديث الواجهة إن وُجدت
      const el = document.getElementById(pkg.id);
      if (el) {
        const priceEl = el.querySelector('.price, [data-price]');
        if (priceEl) priceEl.textContent = pkg.priceText;
      }
    }
  }
}

// تشغيل عند تحميل الصفحة
document.addEventListener('DOMContentLoaded', updatePricesFromSPToday);


(async function() {
  const DB_NAME = "userSessionDB";
  const STORE_NAME = "session";
  const SESSION_KEY = "currentUser";

  // فتح قاعدة البيانات
  function openDB() {
    return new Promise((resolve, reject) => {
      const request = indexedDB.open(DB_NAME, 1);
      request.onupgradeneeded = e => {
        const db = e.target.result;
        if (!db.objectStoreNames.contains(STORE_NAME)) {
          db.createObjectStore(STORE_NAME, { keyPath: "id" });
        }
      };
      request.onsuccess = e => resolve(e.target.result);
      request.onerror = e => reject(e.target.error);
    });
  }

  // حفظ الجلسة
  async function saveSession(data) {
    const db = await openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(STORE_NAME, "readwrite");
      const store = tx.objectStore(STORE_NAME);
      store.put({ id: SESSION_KEY, ...data, savedAt: Date.now() });
      tx.oncomplete = () => resolve(true);
      tx.onerror = e => reject(e.target.error);
    });
  }

  // استرجاع الجلسة
  async function getSession() {
    const db = await openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(STORE_NAME, "readonly");
      const store = tx.objectStore(STORE_NAME);
      const req = store.get(SESSION_KEY);
      req.onsuccess = () => resolve(req.result || null);
      req.onerror = e => reject(e.target.error);
    });
  }

  // حذف الجلسة
  async function clearSession() {
    const db = await openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(STORE_NAME, "readwrite");
      const store = tx.objectStore(STORE_NAME);
      store.delete(SESSION_KEY);
      tx.oncomplete = () => resolve(true);
      tx.onerror = e => reject(e.target.error);
    });
  }

  // واجهات عامة لاستخدامها في أي مكان
  window.sessionStore = {
    save: saveSession,   // حفظ الجلسة
    get: getSession,     // استرجاع الجلسة
    clear: clearSession  // حذف الجلسة (تسجيل خروج)
  };

  // ✅ عند تحميل الصفحة، تحقق هل المستخدم مسجل مسبقًا
  document.addEventListener("DOMContentLoaded", async () => {
    const session = await getSession();
    if (session && session.loggedIn) {
      console.log("مرحبًا مجددًا،", session.username);
      // إعادة توجيه المستخدم مباشرة إلى الصفحة الرئيسية
      window.location.href = "home.html"; // غيّرها حسب صفحتك الرئيسية
    } else {
      console.log("لم يتم تسجيل الدخول بعد");
    }
  });

  // ✅ مثال: بعد نجاح تسجيل الدخول، استخدم هذا السطر لحفظ الجلسة
  // يمكنك وضعه بعد التحقق من كلمة المرور في كودك
  window.rememberUser = async function(username) {
    await saveSession({ username: username, loggedIn: true });
    console.log("تم حفظ الجلسة محليًا للمستخدم:", username);
  };

  // ✅ مثال: لتسجيل الخروج لاحقًا
  window.logoutUser = async function() {
    await clearSession();
    console.log("تم حذف الجلسة المحلية");
    window.location.href = "index.html"; // عُد لصفحة تسجيل الدخول
  };

})();
</script>
<!-- ======= enhanced loadOrdersList (paste before </body>) ======= -->
<script>
(function(){
  const DB_NAME = 'site_orders_v1';
  const DB_VER = 1;
  const STORE_ORDERS = 'orders';
  const STORE_CHARGES = 'charges';

  // فتح/تهيئة IndexedDB
  function openIdb(){
    return new Promise((res, rej) => {
      try{
        const req = indexedDB.open(DB_NAME, DB_VER);
        req.onupgradeneeded = (e) => {
          const db = e.target.result;
          if(!db.objectStoreNames.contains(STORE_ORDERS)) db.createObjectStore(STORE_ORDERS, { keyPath: 'id' });
          if(!db.objectStoreNames.contains(STORE_CHARGES)) db.createObjectStore(STORE_CHARGES, { keyPath: 'id' });
        };
        req.onsuccess = (e) => res(e.target.result);
        req.onerror = (e) => rej(e.target.error);
      }catch(err){ rej(err); }
    });
  }

  async function idbPutMany(storeName, items){
    if(!items || !items.length) return;
    const db = await openIdb();
    return new Promise((res, rej) => {
      try{
        const tx = db.transaction(storeName, 'readwrite');
        const store = tx.objectStore(storeName);
        items.forEach(it => {
          const obj = Object.assign({}, it);
          if(typeof obj.id === 'undefined' && (obj._id)) obj.id = obj._id;
          obj._savedAt = (new Date()).toISOString();
          try{ store.put(obj); }catch(e){ /* ignore individual put errors */ }
        });
        tx.oncomplete = ()=> res();
        tx.onerror = (e)=> rej(e.target ? e.target.error : e);
      }catch(e){ rej(e); }
    });
  }

  async function idbGetAll(storeName){
    const db = await openIdb();
    return new Promise((res, rej) => {
      try{
        const tx = db.transaction(storeName, 'readonly');
        const rq = tx.objectStore(storeName).getAll();
        rq.onsuccess = ()=> res(rq.result || []);
        rq.onerror = (e)=> rej(e.target ? e.target.error : e);
      }catch(e){ rej(e); }
    });
  }

  // قراءة من localStorage (back-compat)
  function readFromLocalStorage(personal){
    try{
      const orders = JSON.parse(localStorage.getItem('orders_history_' + (personal || 'guest')) || '[]') || [];
      const charges = JSON.parse(localStorage.getItem('charges_history_' + (personal || 'guest')) || '[]') || [];
      return { orders, charges };
    }catch(e){ return { orders:[], charges:[] }; }
  }

  // helper: وقت العنصر (محاولات متعددة للحقل)
  function _timeOf(item){
    if(!item) return 0;
    const cand = item.createdAt || item.created_at || item._savedAt || item.date || item.timestamp;
    if(cand){
      const n = Date.parse(cand);
      if(!isNaN(n)) return n;
      const num = Number(cand);
      if(!isNaN(num)) return num;
    }
    // fallback: حاول من id (إذا كان عددي)
    if(typeof item.id !== 'undefined'){
      const idNum = Number(item.id);
      if(!isNaN(idNum)) return idNum;
    }
    return 0;
  }

  // دالة العرض: تدمج الطلبات والشحنات وترتبها بالأحدث فوق
  function renderOrdersAndCharges(orders = [], charges = [], opts = {}){
    const container = document.getElementById('ordersList');
    if(!container) return;
    container.innerHTML = '';
    if((!orders || orders.length === 0) && (!charges || charges.length === 0)){
      container.innerHTML = '<div class="muted-small" style="text-align:center;padding:14px;color:#aaa">لا توجد طلبات حالياً</div>';
      return;
    }

    const normalized = [];
    (orders || []).forEach(o=>{
      const obj = Object.assign({}, o);
      obj._kind = 'order';
      normalized.push(obj);
    });
    (charges || []).forEach(c=>{
      const obj = Object.assign({}, c);
      obj._kind = 'charge';
      normalized.push(obj);
    });

    // sort descending: newest first
    normalized.sort((a,b) => _timeOf(b) - _timeOf(a));

    normalized.forEach(item=>{
      const d = document.createElement('div'); d.className='order-item';
      // يمكنك تعديل الـ innerHTML حسب الـ markup/CSS لديك
      if(item._kind === 'order'){
const created = item.createdAt || item.created_at || item._savedAt || '';
d.innerHTML = `
  <strong>#${item.id}</strong> - ${item.type || ''} - ${item.item || ''} 
  <br> الايدي: ${item.idField || ''} 
  <br> الهاتف: ${item.phone || ''} 
  <br> <span style="color: #19FF18; font-weight: bold;">تم قبول طلبك، انتظر بعض الوقت</span>
  <br>  ${ created ? new Date(created).toLocaleString() : '' }
`;
      }else{
        const created = item.createdAt || item.created_at || item._savedAt || '';
        d.innerHTML = `<strong>#${item.id}</strong> - شحن رصيد - المبلغ: ${item.amount || ''} <br> الحالة: <strong>${item.status || ''}</strong> <br> أنشئ: ${ created ? new Date(created).toLocaleString() : '' }`;
      }
      container.appendChild(d);
    });
  }

  // إعادة تعريف global loadOrdersList
  window.loadOrdersList = async function(){
    try{
      // تحديد المفتاح الشخصي (عدل لو عندك متغير آخر)
      const personal = (typeof currentProfile !== 'undefined' && currentProfile && currentProfile.personalNumber)
                       || (localStorage.getItem && (localStorage.getItem('user_personal') || localStorage.getItem('personalNumber')))
                       || 'guest';

      const container = document.getElementById('ordersList');
      if(container) container.innerHTML = '<div class="muted-small" style="text-align:center;padding:10px;color:#aaa">تحميل...</div>';

      let serverOk = false;
      let serverOrders = [];
      let serverCharges = [];

      // حاول جلب من السيرفر
      try{
        const url = (window.API_ROOT || '') + 'api/notifications/' + encodeURIComponent(personal);
        const resp = await fetch(url, { cache: 'no-store' });
        const data = await resp.json().catch(()=>null);
        if(data && (data.ok || data.success || data.notifications || data.orders || data.charges)){
          // حاول تحديد الحقول المناسبة
          serverOk = true;
          serverOrders = data.orders || data.notifications || data.orderList || [];
          serverCharges = data.charges || data.credits || data.chargeList || [];
        }
      }catch(err){
        serverOk = false;
      }

      // إذا السيرفر أعطى بيانات -> عرض + حفظ
      if(serverOk && ((serverOrders && serverOrders.length>0) || (serverCharges && serverCharges.length>0))){
        // تأكد من أن العناصر تملك id إذا كان السيرفر يستخدم _id
        serverOrders = (serverOrders || []).map(o => {
          const copy = Object.assign({}, o);
          if(typeof copy.id === 'undefined' && copy._id) copy.id = copy._id;
          return copy;
        });
        serverCharges = (serverCharges || []).map(c => {
          const copy = Object.assign({}, c);
          if(typeof copy.id === 'undefined' && copy._id) copy.id = copy._id;
          return copy;
        });

        // render (دمج وترتيب داخل الدالة)
        renderOrdersAndCharges(serverOrders, serverCharges);

        // احفظ في الـ IDB و localStorage (غير حاسم للعرض لا يمنع العرض)
        (async ()=>{
          try{
            await idbPutMany(STORE_ORDERS, serverOrders);
            await idbPutMany(STORE_CHARGES, serverCharges);
          }catch(e){ console.warn('idb save failed', e); }
          try{ localStorage.setItem('orders_history_' + personal, JSON.stringify(serverOrders)); }catch(e){}
          try{ localStorage.setItem('charges_history_' + personal, JSON.stringify(serverCharges)); }catch(e){}
        })();

        return;
      }

      // فشل السيرفر أو لا بيانات -> حاول IDB
      try{
        const idbOrders = await idbGetAll(STORE_ORDERS);
        const idbCharges = await idbGetAll(STORE_CHARGES);
        if((idbOrders && idbOrders.length) || (idbCharges && idbCharges.length)){
          renderOrdersAndCharges(idbOrders, idbCharges);
          try{ localStorage.setItem('orders_history_' + personal, JSON.stringify(idbOrders)); }catch(e){}
          try{ localStorage.setItem('charges_history_' + personal, JSON.stringify(idbCharges)); }catch(e){}
          return;
        }
      }catch(e){
        console.warn('idb read failed', e);
      }

      // fallback إلى localStorage
      const ls = readFromLocalStorage(personal);
      if((ls.orders && ls.orders.length) || (ls.charges && ls.charges.length)){
        renderOrdersAndCharges(ls.orders, ls.charges);
        return;
      }

      // لا بيانات مطلقاً
      if(container) container.innerHTML = '<div class="muted-small" style="text-align:center;padding:14px;color:#aaa">لا توجد طلبات حالياً</div>';
    }catch(ex){
      console.error('loadOrdersList (enhanced) error', ex);
      const container = document.getElementById('ordersList');
      if(container) container.innerHTML = '<div class="muted-small" style="text-align:center;padding:14px;color:#aaa">تعذر تحميل الطلبات</div>';
    }
  };

  // init idb in background
  openIdb().catch(()=>{ /* ignore init errors */ });

  // اختياري: حمل القوائم فور تحميل السكربت
  // window.addEventListener('DOMContentLoaded', () => { window.loadOrdersList(); });

})();
</script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const badge = document.getElementById('vipServerBadge') || document.querySelector('#vipServerBadge img')?.parentElement;

  function attachClick(el) {
    if (!el) return;
    el.style.cursor = 'pointer';
    el.addEventListener('click', () => {
      window.open(openLink, '_blank'); // يفتح vip.html في تبويب جديد
    });
  }

  if (badge) {
    attachClick(badge);
  } else {
    // في حال تأخّر ظهور الشارة (يتم مراقبة إضافتها لاحقًا)
    const obs = new MutationObserver(() => {
      const vip = document.getElementById('vipServerBadge');
      if (vip) {
        attachClick(vip);
        obs.disconnect();
      }
    });
    obs.observe(document.body, { childList: true, subtree: true });
  }
});
</script>
<script>
/* حظر عند كون "رقم الدخول" = 999
   مع أيقونة حمراء فوق عبارة "تم حظر حسابك"
   إذا لم يكن رقم الدخول 999 — ازل ملف الحظر من التخزين المحلي وأزل الواجهة
   ضع هذا السكربت آخر الملف (قبل </body>)
*/
(function(){
  'use strict';

  var BLOCK_FLAG_KEY = 'blockedOverlayLogin';

  function readLoginFromProfile(){
    try{
      if(typeof currentProfile !== 'undefined' && currentProfile){
        var keys = ['login','loginNumber','login_id','loginId','username','userLogin','user_login','id'];
        for(var i=0;i<keys.length;i++){
          var k = keys[i];
          if(currentProfile[k] !== undefined && currentProfile[k] !== null){
            return String(currentProfile[k]);
          }
        }
      }
    }catch(e){}
    return '';
  }

  function readLoginFromLocalStorage(){
    try{
      var keys = ['user_login','login','login_number','loginNumber','userLogin','user_login_number','current_login'];
      for(var i=0;i<keys.length;i++){
        var v = localStorage.getItem(keys[i]);
        if(v !== null) return String(v);
      }
    }catch(e){}
    return '';
  }

  function readLoginFromCookies(){
    try{
      var cookies = document.cookie.split(';');
      for(var i=0;i<cookies.length;i++){
        var kv = cookies[i].trim().split('=');
        if(kv.length<2) continue;
        var name = kv[0], val = decodeURIComponent(kv.slice(1).join('='));
        var candidates = ['user_login','login','login_number','session_login'];
        if(candidates.indexOf(name) !== -1) return String(val);
      }
    }catch(e){}
    return '';
  }

  function readLoginFromLoginForm(){
    try{
      var selectors = ['input[name="login"]','input[name="username"]','input[name="user"]','input#login','input#username'];
      for(var i=0;i<selectors.length;i++){
        var el = document.querySelector(selectors[i]);
        if(el && el.value) return String(el.value);
      }
    }catch(e){}
    return '';
  }

  function normalizeAndCheck(val){
    if(!val && val!==0) return false;
    val = String(val).trim();
    if(!val) return false;
    if(val === '999') return true;
    var num = Number(val);
    if(!Number.isNaN(num) && num === 1) return true;
    var digits = (String(val).match(/\d+/g) || []).join('');
    if(digits && Number(digits) === 1) return true;
    return false;
  }

  function getLoginCandidates(){
    var tries = [];
    tries.push(readLoginFromProfile());
    tries.push(readLoginFromLocalStorage());
    tries.push(readLoginFromCookies());
    tries.push(readLoginFromLoginForm());
    return tries;
  }

  function showBlockOverlay(){
    if(document.getElementById('blockedOverlayLogin')) return;
    var ov = document.createElement('div');
    ov.id = 'blockedOverlayLogin';
    Object.assign(ov.style, {
      position: 'fixed',
      inset: '0',
      background: '#000',
      color: '#fff',
      zIndex: 2147483647,
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      textAlign: 'center',
      padding: '20px',
      flexDirection: 'column',
      fontFamily: 'Cairo, Arial, sans-serif',
      fontSize: '24px',
      fontWeight: '700'
    });

    // 🔴 أيقونة حمراء فوق النص
    var icon = document.createElement('div');
    icon.innerHTML = `
      <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" fill="red"
           class="bi bi-person-fill-slash" viewBox="0 0 16 16">
        <path d="M13.879 10.414a2.501 2.501 0 0 0-3.465 3.465zm.707.707-3.465 3.465a2.501 2.501 0 0 0 3.465-3.465m-4.56-1.096a3.5 3.5 0 1 1 4.949 4.95 3.5 3.5 0 0 1-4.95-4.95ZM11 5a3 3 0 1 1-6 0 3 3 0 0 1 6 0m-9 8c0 1 1 1 1 1h5.256A4.5 4.5 0 0 1 8 12.5a4.5 4.5 0 0 1 1.544-3.393Q8.844 9.002 8 9c-5 0-6 3-6 4"/>
      </svg>`;
    icon.style.marginBottom = '20px';

    var text = document.createElement('div');
    text.style.maxWidth = '90%';
    text.style.lineHeight = '1.4';
    text.textContent = 'تم حظر حسابك';

    ov.appendChild(icon);
    ov.appendChild(text);
    document.body.appendChild(ov);

    try {
      document.documentElement.style.overflow = 'hidden';
      document.body.style.overflow = 'hidden';
    } catch(e) {}

    document.querySelectorAll('button, a, input, textarea, select').forEach(function(el){
      try {
        // احفظ الحالة السابقة لإعادة التفعيل لاحقاً
        el.dataset._wasDisabledByBlock = el.disabled ? '1' : '0';
        el.disabled = true;
        el.style.pointerEvents = 'none';
      } catch(e){}
    });
  }

  function removeBlockOverlay(){
    var ov = document.getElementById('blockedOverlayLogin');
    if(!ov) return;
    try {
      ov.parentNode.removeChild(ov);
    } catch(e){}
    try {
      document.documentElement.style.overflow = '';
      document.body.style.overflow = '';
    } catch(e){}

    // أعد تفعيل العناصر التي عطلتها
    document.querySelectorAll('button, a, input, textarea, select').forEach(function(el){
      try {
        if(el.dataset && typeof el.dataset._wasDisabledByBlock !== 'undefined'){
          el.disabled = (el.dataset._wasDisabledByBlock === '1');
          delete el.dataset._wasDisabledByBlock;
        } else {
          // إذا لم توجد علامة سابقة، فقط أزل تعطيل pointer-events
          el.style.pointerEvents = '';
        }
      } catch(e){}
    });
  }

  function setBlockedFlag(){
    try{ localStorage.setItem(BLOCK_FLAG_KEY, '1'); }catch(e){}
  }
  function clearBlockedFlag(){
    try{ localStorage.removeItem(BLOCK_FLAG_KEY); }catch(e){}
  }

  function blockIfLogin111(){
    try{
      var candidates = getLoginCandidates();
      for(var i=0;i<candidates.length;i++){
        if(candidates[i] && normalizeAndCheck(candidates[i])){
          // رقم الدخول 999 -> اعرض الحظر و ضع علم في التخزين المحلي
          showBlockOverlay();
          setBlockedFlag();
          return true;
        }
      }
      // إذا وصلنا هنا: لم نجد 999 -> تأكد من إزالة الواجهة وامسح علم الحظر
      clearBlockedFlag();
      removeBlockOverlay();
    }catch(e){}
    return false;
  }

  // عند تحميل الصفحة / DOMContentLoaded / load
  document.addEventListener('DOMContentLoaded', blockIfLogin111);
  window.addEventListener('load', blockIfLogin111);

  // استمع لتغييرات localStorage من نوافذ/تبويبات أخرى
  window.addEventListener('storage', function(e){
    if(!e.key) return;
    var watchKeys = ['user_login','login','login_number','loginNumber','userLogin', BLOCK_FLAG_KEY];
    if(watchKeys.indexOf(e.key) !== -1) {
      // أعد الفحص بعد أي تغيير ملحوظ
      blockIfLogin111();
    }
  });

  // فحص دوري قصير لحالات تحميل ديناميكية (مثل الـ SPA)
  var pollCount = 0;
  var pollMax = 30;
  var pollTimer = setInterval(function(){
    pollCount++;
    if(blockIfLogin111() || pollCount >= pollMax) clearInterval(pollTimer);
  }, 1000);

  // حاول التفاف على دوال تحديث الواجهة إن وُجدت في التطبيق بحيث نعيد التحقق
  try{
    if(typeof refreshUIFromProfile === 'function'){
      var orig = refreshUIFromProfile;
      refreshUIFromProfile = function(){
        try{ orig.apply(this, arguments); }catch(e){ console.warn(e); }
        try{ blockIfLogin111(); }catch(e){}
      };
    }
  }catch(e){ console.warn('wrap refreshUIFromProfile failed', e); }

})();
</script>
<script>  
/*  
  🔒 حظر لمدة 24 ساعة مع عدّ تنازلي + أيقونة حمراء فوق الرسالة  
  ضع هذا السكربت آخر index.html قبل </body>  
*/  
  
(function(){  
  'use strict';  
  
  // --- دوال المساعدة لقراءة رقم الدخول ---  
  function readLoginFromProfile(){  
    try{  
      if(typeof currentProfile !== 'undefined' && currentProfile){  
        var keys = ['login','loginNumber','login_id','loginId','username','userLogin','user_login','id'];  
        for(var i=0;i<keys.length;i++){  
          var k = keys[i];  
          if(currentProfile[k] !== undefined && currentProfile[k] !== null){  
            return String(currentProfile[k]);  
          }  
        }  
      }  
    }catch(e){}  
    return '';  
  }  
  
  function readLoginFromLocalStorage(){  
    try{  
      var keys = ['user_login','login','login_number','loginNumber','userLogin','user_login_number','current_login'];  
      for(var i=0;i<keys.length;i++){  
        var v = localStorage.getItem(keys[i]);  
        if(v !== null) return String(v);  
      }  
    }catch(e){}  
    return '';  
  }  
  
  function readLoginFromCookies(){  
    try{  
      var cookies = document.cookie.split(';');  
      var candidates = ['user_login','login','login_number','session_login'];  
      for(var i=0;i<cookies.length;i++){  
        var kv = cookies[i].trim().split('=');  
        if(kv.length<2) continue;  
        var name = kv[0], val = decodeURIComponent(kv.slice(1).join('='));  
        if(candidates.indexOf(name) !== -1) return String(val);  
      }  
    }catch(e){}  
    return '';  
  }  
  
  function readLoginFromLoginForm(){  
    try{  
      var selectors = ['input[name="login"]','input[name="username"]','input[name="user"]','input#login','input#username'];  
      for(var i=0;i<selectors.length;i++){  
        var el = document.querySelector(selectors[i]);  
        if(el && el.value) return String(el.value);  
      }  
    }catch(e){}  
    return '';  
  }  
  
  function getLoginCandidate(){  
    var tries = [readLoginFromProfile(), readLoginFromLocalStorage(), readLoginFromCookies(), readLoginFromLoginForm()];  
    for(var i=0;i<tries.length;i++){  
      if(tries[i]) return tries[i];  
    }  
    return '';  
  }  
  
  function isLogin111(val){  
    if(val === undefined || val === null) return false;  
    val = String(val).trim();  
    if(val === '') return false;  
    if(val === '111') return true;  
    var num = Number(val);  
    if(!Number.isNaN(num) && num === 2) return true;  
    var digits = (String(val).match(/\d+/g) || []).join('');  
    if(digits && Number(digits) === 2) return true;  
    return false;  
  }  
  
  // --- إعدادات الحظر ---  
  var BAN_KEY = 'ban_until_login_111';  
  var BAN_DURATION_MS = 24 * 60 * 60 * 1000; // 24 ساعة  
  
  // --- إنشاء واجهة الحظر ---  
  function createOverlay(){  
    if(document.getElementById('blockedOverlayLogin111')) return document.getElementById('blockedOverlayLogin111');  
  
    var ov = document.createElement('div');  
    ov.id = 'blockedOverlayLogin111';  
    Object.assign(ov.style, {  
      position: 'fixed',  
      inset: '0',  
      background: '#000',  
      color: '#fff',  
      zIndex: 2147483647,  
      display: 'flex',  
      alignItems: 'center',  
      justifyContent: 'center',  
      textAlign: 'center',  
      padding: '20px',  
      flexDirection: 'column',  
      fontFamily: 'Cairo, Arial, sans-serif',  
      fontSize: '22px',  
      fontWeight: '700'  
    });  
  
    // 🔴 أيقونة التحذير الحمراء  
    var icon = document.createElement('div');  
    icon.innerHTML = `  
      <svg xmlns="http://www.w3.org/2000/svg" width="56" height="56" fill="red"  
           class="bi bi-shield-fill-exclamation" viewBox="0 0 16 16">  
        <path fill-rule="evenodd"  
              d="M8 0c-.69 0-1.843.265-2.928.56-1.11.3-2.229.655-2.887.87a1.54 1.54 0 0 0-1.044 1.262  
              c-.596 4.477.787 7.795 2.465 9.99a11.8 11.8 0 0 0 2.517 2.453c.386.273.744.482 1.048.625.28.132.581.24.829.24  
              s.548-.108.829-.24a7 7 0 0 0 1.048-.625 11.8 11.8 0 0 0 2.517-2.453  
              c1.678-2.195 3.061-5.513 2.465-9.99a1.54 1.54 0 0 0-1.044-1.263  
              63 63 0 0 0-2.887-.87C9.843.266 8.69 0 8 0  
              m-.55 8.502L7.1 4.995a.905.905 0 1 1 1.8 0l-.35 3.507a.552.552 0 0 1-1.1 0  
              M8.002 12a1 1 0 1 1 0-2 1 1 0 0 1 0 2"/>  
      </svg>`;  
    icon.style.marginBottom = '16px';  
  
    var msg = document.createElement('div');  
    msg.style.maxWidth = '92%';  
    msg.style.lineHeight = '1.4';  
    msg.innerHTML = '<div style="margin-bottom:12px;font-size:26px">تم حظر حسابك</div>';  
  
    var countdown = document.createElement('div');  
    countdown.id = 'blockedCountdownLogin111';  
    countdown.style.fontSize = '20px';  
    countdown.style.fontWeight = '600';  
    countdown.style.marginTop = '6px';  
    countdown.innerText = 'المدة المتبقية: --:--:--';  
  
    var note = document.createElement('div');  
    note.style.marginTop = '12px';  
    note.style.fontSize = '14px';  
    note.style.fontWeight = '400';  
    note.style.opacity = '0.9';  
    note.innerText = 'ستنتهي حالة الحظر أوتوماتيكياً بعد 24 ساعة.';  
  
    ov.appendChild(icon);  
    ov.appendChild(msg);  
    ov.appendChild(countdown);  
    ov.appendChild(note);  
    document.body.appendChild(ov);  
  
    try { document.documentElement.style.overflow = 'hidden'; document.body.style.overflow = 'hidden'; }catch(e){}  
    document.querySelectorAll('button, a, input, textarea, select').forEach(function(el){  
      try{ el.dataset._wasDisabledByBlock = el.disabled ? '1' : '0'; el.disabled = true; el.style.pointerEvents = 'none'; }catch(e){}  
    });  
  
    return ov;  
  }  
  
  function removeOverlay(){  
    var ov = document.getElementById('blockedOverlayLogin111');  
    if(ov) ov.remove();  
    try { document.documentElement.style.overflow = ''; document.body.style.overflow = ''; }catch(e){}  
    document.querySelectorAll('[data-_wasDisabledByBlock]').forEach(function(el){  
      try{  
        if(el.dataset._wasDisabledByBlock === '0') el.disabled = false;  
        delete el.dataset._wasDisabledByBlock;  
        el.style.pointerEvents = '';  
      }catch(e){}  
    });  
  }  
  
  // --- عدّ تنازلي ---  
  var countdownTimer = null;  
  function startCountdown(untilTimestamp){  
    var countdownEl = document.getElementById('blockedCountdownLogin111');  
    if(!countdownEl){  
      createOverlay();  
      countdownEl = document.getElementById('blockedCountdownLogin111');  
    }  
    if(countdownTimer) clearInterval(countdownTimer);  
  
    function updateOnce(){  
      var now = Date.now();  
      var diff = Math.max(0, untilTimestamp - now);  
      var totalSeconds = Math.floor(diff / 1000);  
      var hours = Math.floor(totalSeconds / 3600);  
      var minutes = Math.floor((totalSeconds % 3600) / 60);  
      var seconds = totalSeconds % 60;  
      function pad(n){ return String(n).padStart(2,'0'); }  
      countdownEl.innerText = 'المدة المتبقية: ' + pad(hours)+':'+pad(minutes)+':'+pad(seconds);  
      if(diff <= 0){  
        clearInterval(countdownTimer);  
        localStorage.removeItem(BAN_KEY);  
        removeOverlay();  
      }  
    }  
    updateOnce();  
    countdownTimer = setInterval(updateOnce, 1000);  
  }  
  
  // --- تنفيذ الحظر ---  
  function enforceBanIfNeeded(){  
    try{  
      var login = getLoginCandidate();  
      var now = Date.now();  
      var banUntilRaw = localStorage.getItem(BAN_KEY);  
      var banUntil = banUntilRaw ? Number(banUntilRaw) : 0;  
  
      if(banUntil && now >= banUntil){  
        // الحظر انتهى زمنياً -> مسحه  
        localStorage.removeItem(BAN_KEY);  
        banUntil = 0;  
      }  
  
      if(isLogin111(login)){  
        // المستخدم 111 -> فرض الحظر (أو الاحتفاظ به إذا موجود)  
        if(!banUntil){  
          banUntil = now + BAN_DURATION_MS;  
          localStorage.setItem(BAN_KEY, String(banUntil));  
        }  
        createOverlay();  
        startCountdown(banUntil);  
        return true;  
      } else {  
        // <-- تم التعديل هنا: إذا رقم الدخول ليس 111 نحذف ملف الحظر من التخزين المحلي فوراً  
        if(banUntil){  
          try{ localStorage.removeItem(BAN_KEY); }catch(e){}  
          banUntil = 0;  
        }  
        // نزيل الواجهة إن كانت ظاهرة ثم ننهي الحالة كغير محظور  
        removeOverlay();  
        return false;  
      }  
    }catch(e){ console.warn('ban enforcement error', e); return false; }  
  }  
  
  // --- تفعيل ---  
  document.addEventListener('DOMContentLoaded', enforceBanIfNeeded);  
  window.addEventListener('load', enforceBanIfNeeded);  
  window.addEventListener('storage', function(e){  
    if(!e.key) return;  
    if(e.key === BAN_KEY || e.key === 'user_login' || e.key === 'login') enforceBanIfNeeded();  
  });  
  
  var pollCount = 0, pollMax = 30;  
  var pollTimer = setInterval(function(){  
    pollCount++;  
    if(enforceBanIfNeeded() || pollCount >= pollMax) clearInterval(pollTimer);  
  }, 1000);  
  
  try{  
    if(typeof refreshUIFromProfile === 'function'){  
      var orig = refreshUIFromProfile;  
      refreshUIFromProfile = function(){  
        try{ orig.apply(this, arguments); }catch(e){}  
        enforceBanIfNeeded();  
      };  
    }  
  }catch(e){}  
})();  
</script>

<style>
/* أنماط المفضلة */
#favoritesContainer{margin:10px 12px 6px 12px;padding:8px;border-radius:10px;border:1px dashed rgba(255,255,255,0.04);background:rgba(255,255,255,0.01);color:#fff}
#favoritesGrid{display:grid;gap:10px;grid-template-columns:repeat(4,1fr)}
@media(max-width:900px){#favoritesGrid{grid-template-columns:repeat(3,1fr)}}
@media(max-width:520px){#favoritesGrid{grid-template-columns:repeat(2,1fr)}}
.fav-preview{display:flex;gap:8px;align-items:center;padding:8px;border-radius:8px;cursor:pointer;background:#0b0b0b}
.fav-preview img{width:44px;height:44px;border-radius:8px;object-fit:cover}
.sec-tile .fav-btn,.subcard .fav-btn{position:absolute;left:10px;top:10px;width:34px;height:34px;border-radius:8px;border:none;background:rgba(255,255,255,0.04);color:var(--main-color);font-weight:900;cursor:pointer;display:flex;align-items:center;justify-content:center;z-index:5}
.fav-btn.active{background:linear-gradient(90deg,var(--main-color),#9D0003);color:#000}
.sec-tile{position:relative}
.subcard{position:relative}
#favoritesEmpty{color:#aaa;padding:14px;text-align:center}

#mainContent > div { position: relative; z-index: 10; }
.page-active { z-index: 1200 !important; }

/* صور مربعة */
#homePage .section-tile img,
#sectionPage .sec-tile img,
#sectionPage .subcard img,
#gameStoreGrid .item-card img,
#appsOrderGrid .item-card img,
#appsOrderPage .item-card img {
  width:120px !important;height:120px !important;object-fit:cover !important;background:transparent !important;border-radius:1px !important;display:block;
}

#topHeader, #siteLogo, #balanceBox, #notifBell, #personalNumberDisplay {
  display: flex !important;
  visibility: visible !important;
  opacity: 1 !important;
  pointer-events: auto !important;
}

</style>

<script>
(function(){
  const homeGrid=document.querySelector('#homePage .sections-grid');
  const navBtn=document.getElementById('navtodivideBtn');
  const sectionPage=document.getElementById('sectionPage');
  const sectionTitle=document.getElementById('sectionPageTitle');
  const sectionSubgrid=document.getElementById('sectionSubgrid');
  const sectionBack=document.getElementById('sectionBackBtn');
  if(!homeGrid||!navBtn||!sectionPage||!sectionSubgrid){console.warn('Sections: required DOM nodes not found');return;}
  homeGrid.style.display='none';

  /* IndexedDB + LocalStorage fallback */
  const IDB_DB='fourbeapp_db',IDB_STORE='favoritessections_v1';let dbPromise=null;
  function openDB(){if(dbPromise)return dbPromise;dbPromise=new Promise((resolve)=>{if(!window.indexedDB){resolve(null);return;}const req=indexedDB.open(IDB_DB,1);req.onupgradeneeded=function(e){const db=e.target.result;if(!db.objectStoreNames.contains(IDB_STORE)){db.createObjectStore(IDB_STORE,{keyPath:'key'});}};req.onsuccess=function(){resolve(req.result);};req.onerror=function(){resolve(null);};});return dbPromise;}
  async function idbPut(item){const db=await openDB();if(!db){const ls=JSON.parse(localStorage.getItem('favoritessectionsv1')||'{}');ls[item.key]=item;localStorage.setItem('favoritessectionsv1',JSON.stringify(ls));return;}return new Promise((res)=>{const tx=db.transaction(IDB_STORE,'readwrite');tx.objectStore(IDB_STORE).put(item);tx.oncomplete=()=>res();tx.onabort=tx.onerror=()=>res();});}
  async function idbDelete(key){const db=await openDB();if(!db){const ls=JSON.parse(localStorage.getItem('favoritessectionsv1')||'{}');delete ls[key];localStorage.setItem('favoritessectionsv1',JSON.stringify(ls));return;}return new Promise((res)=>{const tx=db.transaction(IDB_STORE,'readwrite');tx.objectStore(IDB_STORE).delete(key);tx.oncomplete=()=>res();tx.onabort=tx.onerror=()=>res();});}
  async function idbGetAll(){const db=await openDB();if(!db){const ls=JSON.parse(localStorage.getItem('favoritessectionsv1')||'{}');return Object.values(ls);}return new Promise((res)=>{const tx=db.transaction(IDB_STORE,'readonly');const req=tx.objectStore(IDB_STORE).getAll();req.onsuccess=()=>res(req.result||[]);req.onerror=()=>res([]);});}
  async function idbGet(key){const db=await openDB();if(!db){const ls=JSON.parse(localStorage.getItem('favoritessectionsv1')||'{}');return ls[key]||null;}return new Promise((res)=>{const tx=db.transaction(IDB_STORE,'readonly');const req=tx.objectStore(IDB_STORE).get(key);req.onsuccess=()=>res(req.result||null);req.onerror=()=>res(null);});}

  /* Favorites UI */
  function ensureFavoritesContainer(){let cont=document.getElementById('favoritesContainer');if(cont)return cont;cont=document.createElement('div');cont.id='favoritesContainer';cont.innerHTML='<h4 style="margin:6px 0 8px;color:#fff;font-weight:900">المفضلة</h4><div id="favoritesGrid" aria-live="polite"></div><div id="favoritesEmpty" class="muted-small"></div>';homeGrid.parentElement.insertBefore(cont,homeGrid);return cont;}
  const favCont=ensureFavoritesContainer(),favGrid=document.getElementById('favoritesGrid'),favEmpty=document.getElementById('favoritesEmpty');
  function favKeyForSection(sectionKey){return `section|${sectionKey}`;}
  function favKeyForSub(sectionKey,subKey){return `sub|${sectionKey}|${subKey}`;}

  async function buildSectionsList(){sectionSubgrid.innerHTML='';if(typeof sectionsData!=='object'){sectionSubgrid.innerHTML='<div class="sec-tile"><div class="info"><div class="name">لا توجد بيانات للأقسام</div></div></div>';return;}Object.keys(sectionsData).forEach(sectionKey=>{const sd=sectionsData[sectionKey];const tile=document.createElement('div');tile.className='sec-tile';tile.dataset.section=sectionKey;// قبل: const imgUrl=(sd.subs&&sd.subs[0]&&sd.subs[0].img)?sd.subs[0].img:'';
// استبدلها بـ:
const imgUrl = sd.img || SECTION_STATIC_IMAGES[sectionKey] || (sd.subs && sd.subs[0] && sd.subs[0].img) || '';
tile.innerHTML=`<button class="fav-btn">✯</button><img src="${imgUrl}" alt="${sd.title||sectionKey}" style="width:72px;height:72px;object-fit:cover;border-radius:8px;flex:0 0 72px;"><div class="info"><div class="name">${sd.title||sectionKey}</div></div>`;attachSectionTileEvents(tile);sectionSubgrid.appendChild(tile);});await refreshFavButtons();}

  function attachSectionTileEvents(tile){const favBtn=tile.querySelector('.fav-btn');const sectionKey=tile.dataset.section;tile.addEventListener('click',function(e){if(e.target.closest('.fav-btn'))return;openSectionDetails(sectionKey);});favBtn.addEventListener('click',function(ev){ev.stopPropagation();toggleFavorite(favKeyForSection(sectionKey),{key:favKeyForSection(sectionKey),type:'section',section:sectionKey,name:(sectionsData[sectionKey]&&sectionsData[sectionKey].title)||sectionKey,img:(sectionsData[sectionKey]&&sectionsData[sectionKey].subs&&sectionsData[sectionKey].subs[0]&&sectionsData[sectionKey].subs[0].img)||''}).then(()=>refreshFavButtons());});}

  function openSectionDetails(sectionKey){
    const sd = sectionsData[sectionKey];
    if(!sd) return;
    sectionTitle.textContent = sd.title || sectionKey;
    sectionSubgrid.innerHTML = '';

    (sd.subs||[]).forEach(sub=>{
      const d = document.createElement('div');
      d.className = 'subcard';
      d.dataset.section = sectionKey;
      d.dataset.sub = sub.key;
      const imgSrc = sub.img || '';

    d.innerHTML = `
  <button class="fav-btn">✯</button>
  <img src="${imgSrc}" alt="${sub.title}" style="width:72px;height:72px;object-fit:cover;border-radius:8px">
  <div style="font-weight:800;margin-top:8px;width:100%;text-align:right;padding-right:8px">${sub.title}</div>
`;


      // سلوك الضغط
      d.addEventListener('click', function(e){
        if(e.target.closest('.fav-btn')) return;
        if(sectionKey === 'games' && typeof openGameStore === 'function'){
          openGameStore(sub.key, sub.title); return;
        }
        
        if(sectionKey === "apps"){
    window._lastOpenedSection = "apps";
}
              if(sectionKey === "balances"){
    window._lastOpenedSection = "balances";
}

        if(typeof openGenericStore === 'function' && typeof Packages !== 'undefined'){
          if(Packages[sectionKey] && Packages[sectionKey][sub.key]){
            openGenericStore(sectionKey, sub.key, sub.title, Packages[sectionKey][sub.key]); return;
          }
        }
      });

      // زر المفضلة
      const favBtn = d.querySelector('.fav-btn');
      favBtn.addEventListener('click', function(ev){
        ev.stopPropagation();
        const k = favKeyForSub(sectionKey, sub.key);
        toggleFavorite(k,{
          key:k,type:'sub',section:sectionKey,sub:sub.key,
          name:sub.title,img:imgSrc
        }).then(()=>refreshFavButtons());
      });

      sectionSubgrid.appendChild(d);
    });

    openSectionsPage();
    refreshFavButtons();
  }

  /* ===== Favorites logic ===== */
  async function toggleFavorite(key,item){
    const exists = await idbGet(key);
    if(exists){ await idbDelete(key); showToast('حُذِف من المفضلة'); }
    else { await idbPut(item); showToast('أضيف إلى المفضلة'); }
    await renderFavorites();
    await refreshFavButtons();
  }

async function renderFavorites(){
  favGrid.innerHTML='';
  const favs = await idbGetAll();
  if(!favs.length){ 
    favEmpty.textContent='لم تضف أي عناصر للمفضلة بعد'; 
    return; 
  }
  favEmpty.textContent='';

  favs.forEach(f=>{
    let imgSrc = "";
    let name = f.name;

    // ---------------------------
    // تحديد صورة القسم الرئيسية أو الفرعية
    // ---------------------------
    if(f.key.startsWith("section|")){
      const secKey = f.key.split("|")[1];
      const sectionData = sectionsData[secKey];

      // صورة القسم الرئيسية
      imgSrc = sectionData.img 
        || SECTION_STATIC_IMAGES[secKey] 
        || ""; 
    }

    else if(f.key.startsWith("sub|")){
      const parts = f.key.split("|");
      const sec = parts[1];
      const subk = parts[2];

      const sectionData = sectionsData[sec];
      const sub = sectionData.subs.find(x => x.key === subk);

      imgSrc = sub ? sub.img : "";
    }

    // ---------------------------

    const p = document.createElement('div');
    p.className = 'fav-preview';
    p.dataset.key = f.key;

    p.innerHTML = `
      <img src="${imgSrc}" alt="${name}">
      <div style="flex:1;text-align:right">
        <div style="font-weight:800">${name}</div>
      </div>
    `;

    p.addEventListener('click', function(){
      if(f.key.startsWith('section|')){
        const sec = f.key.split('|')[1];
        openSectionsPage();
        setTimeout(()=>openSectionDetails(sec),120);
      } 
      else if(f.key.startsWith('sub|')){
        const parts=f.key.split('|');
        const sec=parts[1], subk=parts[2];
        openSectionsPage();
        setTimeout(()=>{
          openSectionDetails(sec);
          const node=[...document.querySelectorAll('#sectionSubgrid .subcard')]
            .find(x=>x.dataset.sub===subk);
          if(node) node.click();
        },120);
      }
    });

    favGrid.appendChild(p);
  });
}


  async function refreshFavButtons(){
    const favs=await idbGetAll();const keys=favs.map(x=>x.key);
    document.querySelectorAll('#sectionSubgrid .sec-tile').forEach(t=>{
      const k=favKeyForSection(t.dataset.section);
      const btn=t.querySelector('.fav-btn');
      if(keys.includes(k)) btn.classList.add('active'); else btn.classList.remove('active');
    });
    document.querySelectorAll('#sectionSubgrid .subcard').forEach(s=>{
      const k=favKeyForSub(s.dataset.section,s.dataset.sub);
      const btn=s.querySelector('.fav-btn');
      if(keys.includes(k)) btn.classList.add('active'); else btn.classList.remove('active');
    });
  }

  function showToast(text,timeout=1100){
    const t=document.createElement('div');
    t.style.position='fixed';t.style.left='50%';t.style.transform='translateX(-50%)';t.style.bottom='26px';
    t.style.padding='8px 12px';t.style.background='rgba(0,0,0,0.7)';t.style.color='#fff';t.style.borderRadius='8px';t.style.zIndex=2147483646;
    t.textContent=text;document.body.appendChild(t);
    setTimeout(()=>t.remove(),timeout);
  }

  /* ===== التحكم في الصفحات + الهيدر ===== */
  function updateHeaderVisibility(pageId){
    if(pageId==='homePage'){
      document.body.classList.add('home-page');
    }else{
      document.body.classList.remove('home-page');
    }
  }

  if(typeof showPageQuick==='function'){
    const orig=showPageQuick;
    showPageQuick=function(pageId){
      orig(pageId);
      setTimeout(()=>updateHeaderVisibility(pageId),40);
    };
  }

  window.openSectionsPage=function(){
    if(typeof showPageQuick==='function'){showPageQuick('sectionPage');}
    else{
      document.querySelectorAll('#mainContent > div').forEach(p=>{
        if(p.id==='sectionPage'){p.classList.remove('hidden');p.classList.add('page-active');p.style.zIndex=1200;}
        else{p.classList.add('hidden');p.classList.remove('page-active');p.style.zIndex=10;}
      });
    }
    updateHeaderVisibility('sectionPage');
  };

  window.closeSectionsPage=function(){
    if(typeof showPageQuick==='function'){showPageQuick('homePage');}
    else{
      document.querySelectorAll('#mainContent > div').forEach(p=>{
        if(p.id==='homePage'){p.classList.remove('hidden');p.classList.add('page-active');p.style.zIndex=1200;}
        else{p.classList.add('hidden');p.classList.remove('page-active');p.style.zIndex=10;}
      });
    }
    updateHeaderVisibility('homePage');
  };

  /* ===== ربط الأزرار ===== */
  navBtn.addEventListener('click',function(e){e.preventDefault();buildSectionsList();openSectionsPage();});
  if(sectionBack) sectionBack.addEventListener('click',()=>buildSectionsList());

  /* init */
  (async function init(){
    await renderFavorites();
    await refreshFavButtons();
    window.sectionsManager={open:openSectionsPage,close:closeSectionsPage,openSection:openSectionDetails,renderFavorites};
    updateHeaderVisibility('homePage');
  })();
})();
</script>
<script>
const clickSound = new Audio("click.mp3"); // اسم ملف الصوت

// يجعل الصوت يشتغل عند الضغط على أي زر في الصفحة
document.addEventListener("click", function(e){
  if(e.target.closest("button") || e.target.closest(".btn")){
      clickSound.currentTime = 0;
      clickSound.play();
  }
});
</script>
<!-- FAVORITES EMPTY UI -->
<style>
  #fav-empty-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
    padding: 15px;
    color: #bfc6ca;
    font-weight: 700;
  }
  #fav-empty-container svg {
    width: 55px;
    height: 55px;
    fill: #9aa0a6; /* رمادي */
  }
  #fav-empty-container button {
    margin-top: 6px;
    background: none;
    border: none;
    color: #9aa0a6;
    font-weight: 800;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 15px;
  }
  #fav-empty-container button svg {
    width: 20px;
    height: 20px;
  }
</style>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const emptyBox = document.getElementById("favoritesEmpty");

  // استبدل نص الرسالة بعرض زر + فقط عندما لا توجد مفضلات
  function showEmptyUI(){
    emptyBox.innerHTML = `
      <div id="fav-empty-container">

        <div>لم تضف أي عناصر للمفضلة بعد</div>

        <button id="favAddBtn">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16">
            <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
            <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4"/>
          </svg>
          إضافة عناصر
        </button>
      </div>
    `;

    // عند الضغط على زر إضافة عناصر
    document.getElementById("favAddBtn").onclick = () => {
      if (typeof openSectionsPage === "function") {
        openSectionsPage();
      }
    };
  }

  // نراقب أي تغيّر يحدث داخل favoritesEmpty
  const mo = new MutationObserver(() => {
    const txt = emptyBox.textContent.trim();
    if (txt === "لم تضف أي عناصر للمفضلة بعد") {
      showEmptyUI();
    }
  });

  mo.observe(emptyBox, { childList: true, subtree: true });

});
</script>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const cashBtn = document.querySelector('.pd-method-tilee[data-method="cash"]');
  if (!cashBtn) return;

  // لو الزر موجود كـ <button> وبدون type نضبطه ليمنع submit
  if (cashBtn.tagName.toLowerCase() === 'button') {
    cashBtn.type = 'button';
  }

  cashBtn.addEventListener("click", function (e) {
    // يمنع أي submit/انتقال ويوقف مستمعين آخرين
    e.preventDefault();
    e.stopPropagation();
    if (typeof e.stopImmediatePropagation === 'function') e.stopImmediatePropagation();

    // إذا البوب-أب مفتوح بالفعل، لا نعيد إنشاؤه
    if (document.querySelector('.cash-popup-overlay')) return;

    // خلفية وعلبة البوب-أب
    const overlay = document.createElement('div');
    overlay.className = 'cash-popup-overlay';
    Object.assign(overlay.style, {
      position: 'fixed',
      inset: '0',
      background: 'rgba(0,0,0,0.55)',
      backdropFilter: 'blur(4px)',
      display: 'flex',
      alignItems: 'flex-end',
      justifyContent: 'center',
      zIndex: '99999',
      transition: 'opacity .25s ease',
      opacity: '0'
    });

    const box = document.createElement('div');
    box.className = 'cash-popup-box quick-popup';
    Object.assign(box.style, {
      width: '100%',
      maxWidth: '460px',
      background: '#111',
      borderRadius: '18px 18px 0 0',
      padding: '20px',
      color: '#fff',
      boxShadow: '0 -4px 25px rgba(0,0,0,0.4)',
      transform: 'translateY(100%)',
      transition: 'transform .35s ease',
      position: 'relative',
      textAlign: 'center'
    });

    // محتوى البوب-أب (يمكن تعديله بسهولة)
    box.innerHTML = `
      <button id="closeCashPopup" aria-label="إغلاق" style="
        position:absolute;top:12px;right:12px;width:34px;height:34px;border-radius:50%;border:0;background:#222;color:#fff;font-size:18px;font-weight:900;cursor:pointer;display:flex;align-items:center;justify-content:center
      ">×</button>

      <h3 style="margin:0 0 14px;font-size:22px;font-weight:800;color:#ffc700">موقع استلام الكاش</h3>

      <iframe width="100%" height="260" frameborder="0" style="border:0;border-radius:12px;margin-bottom:14px;"
        src="https://www.google.com/maps?q=34.837938,36.727174&hl=ar&z=16&output=embed"></iframe>

      <a href="https://www.google.com/maps?q=34.837938,36.727174" target="_blank" rel="noopener noreferrer" style="
        display:block;margin:12px 0;padding:12px;background:#ffc700;color:#000;font-weight:800;border-radius:10px;text-decoration:none
      ">فتح الموقع على Google Maps</a>

      <a href="https://wa.me/00963982559890" target="_blank" rel="noopener noreferrer" style="
        display:block;margin:10px 0;padding:12px;background:#25D366;color:#000;font-weight:800;border-radius:10px;text-decoration:none
      ">تواصل عبر واتساب</a>
    `;

    overlay.appendChild(box);
    document.body.appendChild(overlay);

    // اجعل الصفحة لا تُهرّب التركيز/تمرير الخلفية
    const prevOverflow = document.documentElement.style.overflow;
    document.documentElement.style.overflow = 'hidden';

    // ظهور انسيابي
    requestAnimationFrame(() => {
      overlay.style.opacity = '1';
      box.style.transform = 'translateY(0)';
    });

    // إغلاق مرتب وآمن
    const close = () => {
      box.style.transform = 'translateY(100%)';
      overlay.style.opacity = '0';
      // استرجاع scroll بعد انتهاء الانتقال
      setTimeout(() => {
        if (overlay.parentNode) overlay.parentNode.removeChild(overlay);
        document.documentElement.style.overflow = prevOverflow || '';
      }, 300);
    };

    // زر الإغلاق
    overlay.querySelector('#closeCashPopup').addEventListener('click', function (ev) {
      ev.stopPropagation();
      close();
    });

    // إغلاق بالضغط خارج الصندوق
    overlay.addEventListener('click', (ev) => {
      if (ev.target === overlay) close();
    });

    // إغلاق بالـ Escape
    const onKey = (ev) => {
      if (ev.key === 'Escape') {
        close();
        document.removeEventListener('keydown', onKey, true);
      }
    };
    document.addEventListener('keydown', onKey, true);

    // منع أي روابط في الـ popup من تسبب تغيير نفس الصفحة (نحن نستخدم target=_blank لكن نضمن الأمان)
    box.addEventListener('click', (ev) => ev.stopPropagation());
  }, { passive: false });
});
</script>
<!-- FIX: Remove blur/backdrop for settings page -->
<style>
/* Hide uiBackdrop when settings modal/page is active (keep it for balances) */
body[data-active-modal="settings"] #uiBackdrop{
  display: none !important;
  opacity: 0 !important;
  pointer-events: none !important;
}

/* Ensure settingsPage is top and not blurred */
body[data-active-modal="settings"] #settingsPage,
#settingsPage.settings-no-blur {
  z-index: 2000 !important;
  position: relative !important;
  -webkit-backdrop-filter: none !important;
  backdrop-filter: none !important;
  filter: none !important;
}

/* Remove any page-wide blur when settings active (but keep for balances) */
body[data-active-modal="settings"] #mainContent,
body[data-active-modal="settings"] body,
body[data-active-modal="settings"] .page-wrapper {
  -webkit-backdrop-filter: none !important;
  backdrop-filter: none !important;
  filter: none !important;
}

/* Keep header hidden in settings if you already have code to hide it */
body[data-active-modal="settings"] #topHeader,
body[data-active-modal="settings"] #siteLogo,
body[data-active-modal="settings"] #balanceBox,
body[data-active-modal="settings"] #notifBell {
  display: none !important;
  visibility: hidden !important;
}
</style>

<script>
(function(){
  // helper
  const settings = document.getElementById('settingsPage');
  const uiBackdrop = document.getElementById('uiBackdrop');
  const main = document.getElementById('mainContent');

  function clearBlurNow(){
    try{
      // hide the backdrop element if body indicates settings active
      if(document.body.getAttribute('data-active-modal') === 'settings'){
        if(uiBackdrop){
          uiBackdrop.style.display = 'none';
          uiBackdrop.classList.add('hidden');
          uiBackdrop.style.opacity = '0';
          uiBackdrop.style.pointerEvents = 'none';
        }
        // remove filters
        document.body.style.backdropFilter = 'none';
        document.body.style.filter = 'none';
        if(main){
          main.style.backdropFilter = 'none';
          main.style.filter = 'none';
        }
        if(settings){
          settings.style.backdropFilter = 'none';
          settings.style.filter = 'none';
          settings.classList.add('settings-no-blur');
          // ensure visible on top
          settings.classList.remove('hidden');
          settings.classList.add('page-active');
          settings.style.zIndex = 2000;
        }
      } else {
        // nothing to do for other modals; keep default behavior (balances still uses backdrop)
        // we leave uiBackdrop alone unless we explicitly removed it earlier for settings
        // but do not override balances behavior
      }
    }catch(e){ console.warn('clearBlurNow err', e); }
  }

  // observe changes on body attribute data-active-modal (set by original script)
  const bodyObserver = new MutationObserver(function(muts){
    for(const m of muts){
      if(m.type === 'attributes' && m.attributeName === 'data-active-modal'){
        // small delay then clear blur
        setTimeout(clearBlurNow, 20);
      }
    }
  });
  bodyObserver.observe(document.body, { attributes: true });

  // also observe settings element visibility changes (class/style)
  if(settings){
    const sObs = new MutationObserver(function(){
      setTimeout(clearBlurNow, 20);
    });
    sObs.observe(settings, { attributes: true, attributeFilter: ['class','style'] });
  }

  // also wrap showSettings to force removing blur whenever settings opened programmatically
  const origShowSettings = window.showSettings;
  window.showSettings = function(){
    try{
      if(typeof origShowSettings === 'function') origShowSettings();
    }catch(e){}
    setTimeout(clearBlurNow, 20);
  };

  // also bind settings buttons to call our wrapper
  document.getElementById('settingsBtn')?.addEventListener('click', function(e){
    e?.preventDefault();
    window.showSettings();
  });
  document.getElementById('summarySettingsBtn')?.addEventListener('click', function(e){
    e?.preventDefault();
    window.showSettings();
  });

  // initial pass in case settings already open
  setTimeout(clearBlurNow, 40);
})();
</script>
<style>
/* خلفية البلور */
#firstLoadOverlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.35);
  backdrop-filter: blur(6px);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 99990; /* أقل من إشعار الانضمام */
  opacity: 1;
  transition: opacity .5s ease;
}

/* الدائرة الدوارة الجديدة */
#firstLoadSpinner {
  width: 70px;
  height: 70px;
  border: 6px solid rgba(255,0,0,0.3);
  border-top: 6px solid red;
  border-radius: 50%;
  animation: spinCircle 1s linear infinite;
}

@keyframes spinCircle {
  to { transform: rotate(360deg); }
}
</style>

<div id="firstLoadOverlay">
  <div id="firstLoadSpinner"></div>
</div>

<script>
// دائرة التحميل عند الدخول الأول
window.addEventListener("load", () => {
  const overlay = document.getElementById("firstLoadOverlay");

  // 4 ثواني ثم اختفاء
  setTimeout(() => {
    overlay.style.opacity = "0";

    // إزالة العنصر نهائيًا بعد الأنيميشن
    setTimeout(() => {
      overlay.remove();
    }, 400);

  }, 4000);
});
</script>

<style>
#whatsappJoinBox {
  position: fixed;
  top: 50%;
  left: 50%;
  width: 300px;
  background: #ffffff;
  border: 3px solid red;
  border-style: solid;
  border-image: repeating-linear-gradient(
    -45deg,
    red 0,
    red 10px,
    transparent 10px,
    transparent 20px
  ) 10;
  color: #000;
  z-index: 999999;
  padding: 16px;
  border-radius: 14px;
  box-shadow: 0 8px 30px rgba(0,0,0,0.25);
  font-family: sans-serif;
  text-align: center;
  transform: translate(-50%, -60%);
  display: none;
  animation: fadeInScale .4s ease;
}

@keyframes fadeInScale {
  from { transform: translate(-50%, -60%) scale(0.7); opacity:0; }
  to   { transform: translate(-50%, -60%) scale(1); opacity:1; }
}

#whatsappJoinBox h4 {
  margin: 0 0 10px 0;
  font-size: 18px;
  font-weight: 900;
  color: red;
}

#whatsappJoinBox p {
  font-size: 14px;
  margin: 0 0 14px;
  text-align: center;
}

#whatsappJoinBox button {
  padding: 10px 14px;
  border-radius: 8px;
  font-weight: 800;
  cursor: pointer;
  border: none;
  margin-top: 6px;
  width: 100%;
}

#joinNowBtn {
  background: red;
  color: #fff;
}

#closeJoinBtn {
  background: #ddd;
  color: #000;
}
</style>

<div id="whatsappJoinBox">
  <h4>📢 انضم إلى مجتمع الواتساب</h4>
  <p>احصل على العروض والتحديثات مباشرة داخل القروب الرسمي.</p>
  <button id="joinNowBtn">انضم الآن</button>
  <button id="closeJoinBtn">إغلاق</button>
</div>

<script>
(function(){

  // يظهر مرة واحدة في كل جلسة
  if(!sessionStorage.getItem("join_whatsapp_shown")){
    const box = document.getElementById("whatsappJoinBox");
    box.style.display = "block";

    // زر الانضمام
    document.getElementById("joinNowBtn").onclick = () => {
      window.open("https://chat.whatsapp.com/LvrWRUCqLOw4cxjPlnH33J", "_blank");
    };

    // زر الإغلاق
    document.getElementById("closeJoinBtn").onclick = () => {
      box.style.display = "none";
    };

    // حفظ أنه ظهر
    sessionStorage.setItem("join_whatsapp_shown", "1");
  }

})();
</script>


<!-- ======= Start: Guard for paymentDetailsPage + force-home default ======= -->
<script>
(function(){
  // الصفحات / معرفات صفحة الدفع الشائعة التي نريد حمايتها
  const PAYMENT_PAGE_IDS = new Set(['paymentDetailsPage','paymentDetails','pdPage']);

  // دالة تحقق ما إذا المستخدم مسجل محليًا (يتوافق مع كودك الموجود الذي يكتب 'is_logged_in'='1')
  function isLogged(){
    try {
      if(localStorage && localStorage.getItem('is_logged_in') === '1') return true;
    } catch(e){}
    // fallback: إن كانت هناك متغيرات حالية في النافذة
    try { if(window.currentProfile && window.currentProfile.name && window.currentProfile.name !== 'ضيف') return true; } catch(e){}
    return false;
  }

  // عرض نافذة تنبيهية خفيفة تطالب بتسجيل الدخول (مع زر يفتح index.html#loginpage ويعرض صفحة login فعلاً)
  function showLoginPrompt() {
    if (isLogged()) return false;
    if(document.getElementById('pd-login-prompt')) return false; // لا تكرر العنصر

    const wrap = document.createElement('div');
    wrap.id = 'pd-login-prompt';
    wrap.style.cssText = 'position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:999999;pointer-events:auto';
    wrap.innerHTML = `
      <div style="min-width:260px;max-width:92%;background:linear-gradient(180deg,#0d0d0d,#141414);border:1px solid rgba(255,255,255,0.06);
                   padding:16px;border-radius:12px;text-align:center;color:#fff;box-shadow:0 18px 60px rgba(0,0,0,0.7)">
        <div style="font-weight:800;color:var(--main-color);margin-bottom:8px">يرجى تسجيل الدخول</div>
        <div style="margin-bottom:12px;color:#ddd;font-size:14px;line-height:1.3">يجب أن تكون مسجّلًا لتتمكن من الوصول لصفحة تفاصيل الدفع.</div>
        <div style="display:flex;gap:8px;justify-content:center">
          <button id="pdLoginOpenBtn" style="padding:10px 12px;border-radius:8px;border:none;cursor:pointer;background:var(--main-color);color:#000;font-weight:800">
            تسجيل الدخول
          </button>
          <button id="pdLoginCloseBtn" style="padding:10px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);cursor:pointer;background:transparent;color:#fff;font-weight:700">
            إغلاق
          </button>
        </div>
      </div>
    `;
    document.body.appendChild(wrap);

    // زر يفتح الـ hash الذي طلبته + يحاول إظهار صفحة login فعليًا
    document.getElementById('pdLoginOpenBtn').addEventListener('click', function(){
      try { // حسب طلبك: افتح index.html#loginpage
        const base = window.location.pathname || 'index.html';
        window.location.href = base + '#loginpage';
      } catch(e){}
      // حاول أيضاً استدعاء دالة إظهار صفحة login داخل التطبيق لو كانت موجودة
      try { if(typeof showPageQuick === 'function') showPageQuick('loginPage'); } catch(e){}
      // إزالة النافذة المؤقتة بعد الفتح
      const el = document.getElementById('pd-login-prompt'); if(el) el.remove();
    });

    document.getElementById('pdLoginCloseBtn').addEventListener('click', function(){
      const el = document.getElementById('pd-login-prompt'); if(el) el.remove();
    });

    return true;
  }

  // محاولة إعادة الصفحة الرئيسية عند التحميل (لمنع ظهور صفحة login كافتراضية)
  function forceShowHome(){
    try {
      if(typeof showHome === 'function'){
        showHome();
        return;
      }
      // fallback: إظهار عنصر homePage إن وجد
      const homeEl = document.getElementById('homePage');
      if(homeEl){
        document.querySelectorAll('#mainContent > div').forEach(d => d.classList.add('hidden'));
        homeEl.classList.remove('hidden');
        window.scrollTo(0,0);
      }
    } catch(e){}
  }

  // --- Override لِـ showPageQuick (إن وُجد) ليحمي صفحة الدفع ---
  try {
    const originalShow = window.showPageQuick;
    if (typeof originalShow === 'function') {
      window.showPageQuick = function(pageId, ...args){
        try {
          if(pageId && PAYMENT_PAGE_IDS.has(String(pageId))) {
            if(!isLogged()){
              showLoginPrompt();
              return; // منع الوصول بدون تسجيل
            }
          }
        } catch(e){}
        return originalShow.call(this, pageId, ...args);
      };
    }
  } catch(e){ console.warn('guard: failed to wrap showPageQuick', e); }

  // --- Wrap دالة openChargePage إن وجدت (يستدعيها بعض عناصر الواجهة) ---
  try {
    const origOpenCharge = window.openChargePage;
    if(typeof origOpenCharge === 'function'){
      window.openChargePage = function(...a){
        if(!isLogged()){
          showLoginPrompt();
          return;
        }
        return origOpenCharge.apply(this,a);
      };
    }
  } catch(e){}

  // --- تفويض الاستماع للنقرات لعناصر تحمل data-page="paymentDetailsPage" أو روابط href="#paymentDetailsPage" ---
  document.addEventListener('click', function(ev){
    try{
      let t = ev.target;
      while(t && t !== document){
        // data-page
        if(t.dataset && t.dataset.page && PAYMENT_PAGE_IDS.has(t.dataset.page)){
          if(!isLogged()){ ev.preventDefault(); showLoginPrompt(); return; }
          break;
        }
        // anchor href="#paymentDetailsPage"
        if(t.tagName === 'A' && t.getAttribute('href')){
          const href = t.getAttribute('href').replace(/^#/, '');
          if(PAYMENT_PAGE_IDS.has(href)){
            if(!isLogged()){ ev.preventDefault(); showLoginPrompt(); return; }
            break;
          }
        }
        t = t.parentNode;
      }
    }catch(e){}
  }, true);

  // --- حماية التغيّر في hash (لو أحد غيّر الـ URL يدوياً) ---
  window.addEventListener('hashchange', function(){
    try {
      const h = (location.hash||'').replace('#','');
      if(PAYMENT_PAGE_IDS.has(h) && !isLogged()){
        // ارجع إلى الرئيسية أو أزل الـ hash لمنع الظهور
        history.replaceState(null, '', (location.pathname || '') + '#homePage');
        showLoginPrompt();
      }
    } catch(e){}
  });

  // --- بعد تحميل الصفحة، نُجبر عرض الرئيسية (يتجاوز السلوك الافتراضي الموجود في ملفك) ---
  window.addEventListener('load', function(){
    // نفّذ بعد قليل كي لا يتعارض مع سكربت التحميل الأصلي
    setTimeout(forceShowHome, 60);
  });

  // --- إغلاق أي prompt مفتوح عندما يصبح المستخدم مسجلًا (يحدث بعد doLogin الذي يضع is_logged_in) ---
  function closePromptIfLogged(){
    if(isLogged()){
      const el = document.getElementById('pd-login-prompt'); if(el) el.remove();
    }
  }
  window.addEventListener('storage', closePromptIfLogged);
  // poll قصير لمدة ما بعد تحميل الصفحة لإكتشاف تسجيل الدخول
  const poll = setInterval(function(){
    if(isLogged()){ closePromptIfLogged(); clearInterval(poll); }
  }, 800);

})(); 
</script>

<script>
// إظهار صفحة
function showPage(id){
  document.querySelectorAll('.login-page').forEach(p => p.classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
}

// فتح signup
document.getElementById("openSignupNew").onclick = () => {
  showPage("signupPage");
};

// فتح login
document.getElementById("openLoginNew").onclick = () => {
  showPage("loginPage");
};
</script>
<script>
async function doLogin(){
  const name = document.getElementById('loginName').value.trim();
  const email = document.getElementById('loginEmail').value.trim();
  const password = document.getElementById('loginPassword').value;
  const phone = document.getElementById('loginPhone').value.trim();
  const errEl = document.getElementById('loginError');

  errEl.style.display = "none";

  if(!name){ errEl.textContent = "الرجاء إدخال الاسم"; errEl.style.display="block"; return; }
  if(!email){ errEl.textContent = "الرجاء إدخال البريد"; errEl.style.display="block"; return; }
  if(!password){ errEl.textContent = "الرجاء إدخال كلمة السر"; errEl.style.display="block"; return; }

  try {
    const payload = { name, email, password, phone };
    const resp = await fetch(API_ROOT + 'api/login', {
      method: 'POST',
      headers: {'content-type':'application/json'},
      body: JSON.stringify(payload)
    });

    const data = await resp.json();

    if(data.ok && data.profile){
      currentProfile = data.profile;
      currentPersonal = data.profile.personalNumber;

      localStorage.setItem("user_profile_v1", JSON.stringify(currentProfile));
      localStorage.setItem("user_personal", currentPersonal);
      localStorage.setItem("is_logged_in", "1");

      refreshUIFromProfile && refreshUIFromProfile();
      showHome && showHome();

      return;
    }

    if(data.error === "not_found"){
      errEl.textContent = "الحساب غير موجود، يمكنك إنشاء حساب جديد";
      errEl.style.display = "block";
      return;
    }

    errEl.textContent = "خطأ: " + (data.error || "فشل تسجيل الدخول");
    errEl.style.display = "block";

  } catch (e){
    errEl.textContent = "خطأ في الاتصال بالخادم";
    errEl.style.display = "block";
  }
}
</script>
<script>
/* ===== helpers: hide/show bottom navigation ===== */
function hideBottomNav(){
  // عناصر مذكورة في مشروعك
  const ids = ['navHomeBtn','navtodivideBtn','navChargeBtn','navOrdersBtn','navProfileBtn','bottomButtons','bottomBar','footerNav','bottomNav'];
  ids.forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.style.display = 'none';
  });
  // كلاسات محتملة
  document.querySelectorAll('.bottom-nav, .navbar-bottom, .footer-buttons, .footer-nav').forEach(el => {
    el.style.display = 'none';
  });
}

function showBottomNav(){
  const ids = ['navHomeBtn','navtodivideBtn','navChargeBtn','navOrdersBtn','navProfileBtn','bottomButtons','bottomBar','footerNav','bottomNav'];
  ids.forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.style.display = '';
  });
  document.querySelectorAll('.bottom-nav, .navbar-bottom, .footer-buttons, .footer-nav').forEach(el => {
    el.style.display = '';
  });
}

/* ===== observe signupPage visibility to hide bottom nav automatically ===== */
(function setupSignupObserver(){
  const signupPage = document.getElementById('signupPage');
  if(!signupPage) return;

  // helper to check visibility
  function isVisible(el){
    if(!el) return false;
    if(el.classList.contains('hidden')) return false;
    const cs = window.getComputedStyle(el);
    if(!cs) return false;
    if(cs.display === 'none' || cs.visibility === 'hidden' || parseFloat(cs.opacity) === 0) return false;
    return true;
  }

  // initial check
  if(isVisible(signupPage)) hideBottomNav();

  // observe class/style/attribute changes
  const mo = new MutationObserver(() => {
    try {
      if(isVisible(signupPage)) hideBottomNav();
      else showBottomNav();
    } catch(e){}
  });
  mo.observe(signupPage, { attributes:true, attributeFilter:['class','style'] });

  // also listen to hashchange in case your app uses hash navigation
  window.addEventListener('hashchange', function(){
    try {
      const h = (location.hash||'').replace('#','');
      if(h && h.toLowerCase().includes('signup')) hideBottomNav();
      else showBottomNav();
    } catch(e){}
  });

  // also intercept clicks on any link/button that opens signup (best-effort)
  document.addEventListener('click', function(ev){
    try {
      let t = ev.target;
      while(t && t !== document){
        if(t.id && t.id.toLowerCase().includes('signup')) { // e.g., openSignupNew, openSignup, createAccountBtn
          // show signup page (if your app uses showPage function)
          try { if(typeof showPage === 'function') showPage('signupPage'); } catch(e){}
          hideBottomNav();
          return;
        }
        t = t.parentNode;
      }
    } catch(e){}
  }, true);

})();

/* ===== updated doSignup (hides signup page, shows home and bottom nav on success) ===== */
async function doSignup(){
  const name = (document.getElementById('suName') && document.getElementById('suName').value.trim()) || '';
  const email = (document.getElementById('suEmail') && document.getElementById('suEmail').value.trim()) || '';
  const password = (document.getElementById('suPassword') && document.getElementById('suPassword').value) || '';
  const phone = (document.getElementById('suPhone') && document.getElementById('suPhone').value.trim()) || '';
  const err = document.getElementById('signupError');

  if(err) { err.style.display = "none"; err.textContent = ''; }

  if(!name || !email || !password){
    if(err){ err.textContent = "جميع الحقول مطلوبة"; err.style.display = "block"; }
    return;
  }

  try {
    const resp = await fetch(API_ROOT + "api/register", {
      method: "POST",
      headers: {"content-type":"application/json"},
      body: JSON.stringify({
        name,
        email,
        password,
        phone,
        personalNumber: ""
      })
    });

    const data = await resp.json().catch(()=>null);

    if(data && data.ok && data.profile){

      // تسجيل الدخول المباشر بعد إنشاء الحساب
      currentProfile = data.profile;
      currentPersonal = data.profile.personalNumber || data.profile.personal || '';

      try { localStorage.setItem("user_profile_v1", JSON.stringify(currentProfile)); }catch(e){}
      try { localStorage.setItem("user_personal", String(currentPersonal)); }catch(e){}
      try { localStorage.setItem("is_logged_in", "1"); }catch(e){}

      // إخفاء صفحة إنشاء الحساب (نهائياً من الواجهة)
      const signupPage = document.getElementById("signupPage");
      if(signupPage){
        signupPage.classList.add("hidden");
        // اختياري: إزالة من DOM إن أردت
        // signupPage.remove();
      }

      // إخفاء صفحة تسجيل الدخول أيضاً (احتياط)
      const loginPage = document.getElementById("loginPage");
      if(loginPage) loginPage.classList.add("hidden");

      // تحديث الواجهة + الانتقال للصفحة الرئيسية
      try { refreshUIFromProfile && refreshUIFromProfile(); }catch(e){}
      try { showHome && showHome(); }catch(e){}

      // مهم: بعد فتح الرئيسية، أعد إظهار الـ bottom nav
      try { showBottomNav(); } catch(e){}

      return;
    }

    if(err){
      err.textContent = (data && data.error) ? data.error : "فشل إنشاء الحساب";
      err.style.display = "block";
    } else {
      alert((data && data.error) ? data.error : "فشل إنشاء الحساب");
    }

  } catch (e){
    if(err){ err.textContent = "خطأ في الاتصال"; err.style.display = "block"; }
    else { alert("خطأ في الاتصال"); }
    console.error('doSignup error', e);
  }
}

// تأكد من ربط الزر إذا لم يكن مرتبطًا بالفعل
try {
  const b = document.getElementById("signupBtn");
  if(b) b.onclick = doSignup;
} catch(e){}
</script>
<script>
(async function(){
  // helper
  function $(id){ return document.getElementById(id); }
  function create(tag, props = {}, children = []) {
    const el = document.createElement(tag);
    Object.keys(props).forEach(k => {
      if(k === 'class') el.className = props[k];
      else if(k === 'html') el.innerHTML = props[k];
      else el.setAttribute(k, props[k]);
    });
    (Array.isArray(children) ? children : [children]).forEach(c => { if(!c) return; if(typeof c === 'string') el.appendChild(document.createTextNode(c)); else el.appendChild(c); });
    return el;
  }

  // ensure modal container
  function ensureReferralModal(){
    if(window._referralModal) return window._referralModal;
    const overlay = create('div', { id:'referralOverlay', class:'quick-popup' });
    overlay.style.cssText = 'position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:99999;padding:18px;background:#000000;';
    const box = create('div', { class:'form-box' });
    box.style.cssText = 'max-width:520px;width:100%;direction:rtl;text-align:right;padding:18px;border-radius:12px;';
    box.innerHTML = `
      <h3 style="color:var(--main-color);margin-bottom:8px">كود الإحالة</h3>
      <div id="myReferralRow" style="margin-bottom:8px"></div>
      <div style="margin-bottom:8px">
        <button id="generateReferralBtn" class="small-btn">توليد كود إحالة</button>
        <button id="copyReferralBtn" class="small-btn" style="display:none;margin-right:5px">نسخ</button>
        <button id="shareReferralBtn" class="small-btn" style="display:none;margin-right:5px">مشاركة</button>
      </div>
      <div style="margin-top:12px">
        <label style="font-weight:700">ستحصل على 250ل.س وصاحب الكود على 500ل.س</label>
        <input id="useReferralInput" placeholder=" ضع الكود هنا          " style="margin-top:8px" />
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="useReferralBtn" class="button-option">استخدم الكود</button>
          <button id="closeReferralBtn" class="back-btn">إغلاق</button>
        </div>
        <div id="referralMsg" style="margin-top:10px;color:#ffd200;font-weight:700"></div>
      </div>
    `;
    overlay.appendChild(box);
    document.body.appendChild(overlay);
    window._referralModal = overlay;

    // handlers
    $('closeReferralBtn').addEventListener('click', ()=> {
  overlay.style.display = 'none';
});
    $('generateReferralBtn').addEventListener('click', generateReferralCodeHandler);
    $('copyReferralBtn').addEventListener('click', () => {
      const txt = $('myReferralRow').dataset.code || '';
      if(!txt) return toast('لا يوجد كود لنسخه');
      if(navigator.clipboard && navigator.clipboard.writeText){
        navigator.clipboard.writeText(txt).then(()=> toast('تم نسخ الكود')).catch(()=> prompt('انسخ الكود يدوياً:', txt));
      } else {
        prompt('انسخ الكود يدوياً:', txt);
      }
    });
    $('shareReferralBtn').addEventListener('click', () => {
      const txt = $('myReferralRow').dataset.code || '';
      if(!txt) return toast('لا يوجد كود للمشاركة');
      if(navigator.share){
        navigator.share({ title: 'كود إحالة', text: `هذا كود احالتي على الموقع يرجى الاستخدام للحصول على رصيد وشحن جواهر وشدات مجانية الموقع https://viproo.netlify.app كود احالتي ${txt}` }).catch(()=> {});
      } else {
        alert('المشاركة غير متاحة على هذا المتصفح. انسخ الكود وشاركه يدويًا.');
      }
    });
    $('useReferralBtn').addEventListener('click', useReferralHandler);

    return window._referralModal;
  }

  // open modal and load current data
  async function openReferralModal(){
    const modal = ensureReferralModal();
    $('referralMsg').textContent = '';
    const myRow = $('myReferralRow');
    myRow.textContent = 'جاري التحميل...';
    myRow.dataset.code = '';
    $('copyReferralBtn').style.display = 'none';
    $('shareReferralBtn').style.display = 'none';
    modal.style.display = 'flex';

    try {
      // try to fetch profile from server (up-to-date)
      const personal = (window.currentPersonal || (window.currentProfile && window.currentProfile.personalNumber) || localStorage.getItem('user_personal'));
      if(!personal) { myRow.textContent = 'لم يتم تسجيل الدخول'; return; }
      const resp = await fetch(API_ROOT + 'api/profile?personal=' + encodeURIComponent(personal));
      const d = await resp.json().catch(()=>null);
      const profile = (d && d.ok && d.profile) ? d.profile : (window.currentProfile || {});
      const code = profile.referralcode || profile.referralCode || '';
      if(code){
        myRow.textContent = 'كود إحالتك: ' + code;
        myRow.dataset.code = code;
        $('copyReferralBtn').style.display = 'inline-block';
        $('shareReferralBtn').style.display = 'inline-block';
      } else {
        myRow.textContent = 'لم تقم بتوليد كود بعد';
        myRow.dataset.code = '';
        $('copyReferralBtn').style.display = 'none';
        $('shareReferralBtn').style.display = 'none';
      }
    } catch(e){
      console.error('openReferralModal error', e);
      myRow.textContent = 'فشل جلب بياناتك';
    }
  }

  // generate button handler
  async function generateReferralCodeHandler(){
    const personal = (window.currentPersonal || (window.currentProfile && window.currentProfile.personalNumber) || localStorage.getItem('user_personal'));
    if(!personal) return alert('غير مسجل');
    const btn = $('generateReferralBtn');
    const old = btn.innerHTML;
    btn.innerHTML = 'جاري التوليد...'; btn.disabled = true;
    try {
      const r = await fetch(API_ROOT + 'api/referral/generate', {
        method:'POST', headers: {'content-type':'application/json'},
        body: JSON.stringify({ personal })
      });
      const j = await r.json().catch(()=>null);
      if(j && j.ok && j.code){
        $('myReferralRow').textContent = 'كود إحالتك: ' + j.code;
        $('myReferralRow').dataset.code = j.code;
        $('copyReferralBtn').style.display = 'inline-block';
        $('shareReferralBtn').style.display = 'inline-block';
        // update local profile & UI
        if(window.currentProfile) { window.currentProfile.referralcode = j.code; localStorage.setItem('user_profile_v1', JSON.stringify(window.currentProfile)); }
        toast('تم توليد الكود');
        if(typeof refreshUIFromProfile === 'function') refreshUIFromProfile();
      } else {
        alert('هذا كود احالتك' + (j && j.error ? j.error : 'خطأ غير معروف'));
      }
    } catch(e){
      console.error('generateReferralCodeHandler', e);
      alert('تم التأكيد');
    } finally {
      btn.innerHTML = old; btn.disabled = false;
    }
  }

  // use/referral redeem
  async function useReferralHandler(){
    const input = $('useReferralInput');
    const code = (input.value || '').trim();
    if(!code) return alert('ادخل الكود أولاً');
    const personal = (window.currentPersonal || (window.currentProfile && window.currentProfile.personalNumber) || localStorage.getItem('user_personal'));
    if(!personal) return alert('غير مسجل');

    const btn = $('useReferralBtn'); const old = btn.innerHTML;
    btn.innerHTML = 'جاري التطبيق...'; btn.disabled = true;
    try {
      const r = await fetch(API_ROOT + 'api/referral/redeem', {
        method:'POST', headers:{'content-type':'application/json'},
        body: JSON.stringify({ personal, code })
      });
      const j = await r.json().catch(()=>null);
      if(j && j.ok){
        // update local profile balance & referredby
        if(window.currentProfile){
          if(typeof j.newBalance !== 'undefined') window.currentProfile.balance = j.newBalance;
          if(j.referredby) window.currentProfile.referredby = j.referredby;
          localStorage.setItem('user_profile_v1', JSON.stringify(window.currentProfile));
        }
        toast('✅ تم تفعيل الكود. رصيدك زاد 250');
        $('referralMsg').textContent = 'اكتسبت 250 رصيد';
        input.value = '';
        if(typeof refreshUIFromProfile === 'function') refreshUIFromProfile();
      } else {
        alert(' خطأ الكود غير صالح!  ' + (j && j.error ? j.error : 'خطأ غير معروف'));
      }
    } catch(e){
      console.error('useReferralHandler', e);
      alert(' تم التحقق ');
    } finally {
      btn.innerHTML = old; btn.disabled = false;
    }
  }

  // bind click on existing payment tile (data-method="code")
  document.addEventListener('click', function(ev){
    const t = ev.target.closest && ev.target.closest('[data-method="codee"], .pd-method-tilee[data-method="codee"]');
    if(!t) return;
    ev.preventDefault();
    openReferralModal();
  });


  // expose for debugging
  window.openReferralModal = openReferralModal;
})();
</script>
<script>
/* ============================================
   نظام الحد من إنشاء الحسابات — IndexedDB
   يسمح فقط بإنشاء حسابين على نفس الجهاز
   ============================================ */
(function(){

  const DB_NAME = "UserAccountLimitDB";
  const STORE_NAME = "created_accounts";
  const LIMIT = 2;

  // -----------------------------
  // فتح قاعدة البيانات
  // -----------------------------
  function openDB(){
    return new Promise((resolve, reject)=>{
      const req = indexedDB.open(DB_NAME, 1);

      req.onupgradeneeded = (ev)=>{
        const db = ev.target.result;
        if(!db.objectStoreNames.contains(STORE_NAME)){
          db.createObjectStore(STORE_NAME, { keyPath:"id", autoIncrement:true });
        }
      };

      req.onsuccess = ()=> resolve(req.result);
      req.onerror = ()=> reject(req.error);
    });
  }

  // -----------------------------
  // جلب عدد الحسابات المخزنة
  // -----------------------------
  async function getCount(){
    const db = await openDB();
    return new Promise((resolve, reject)=>{
      const tx = db.transaction(STORE_NAME, "readonly");
      const store = tx.objectStore(STORE_NAME);
      const req = store.count();

      req.onsuccess = ()=> resolve(req.result || 0);
      req.onerror = ()=> reject(req.error);
    });
  }

  // -----------------------------
  // إضافة حساب جديد للتخزين
  // -----------------------------
  async function addAccount(identifier){
    const db = await openDB();
    return new Promise((resolve, reject)=>{
      const tx = db.transaction(STORE_NAME, "readwrite");
      const store = tx.objectStore(STORE_NAME);
      store.add({ identifier, time: Date.now() });
      tx.oncomplete = ()=> resolve(true);
      tx.onerror = ()=> reject(tx.error);
    });
  }

  // -----------------------------
  // عرض رسالة المنع
  // -----------------------------
  function showLimitMessage(){
    const msg = "لقد حاولت انشاء حساب مرارا وتكرارا";
    const err = document.getElementById("signupError");
    if(err){
      err.textContent = msg;
      err.style.display = "block";
    } else {
      alert(msg);
    }
  }

  // -----------------------------
  // لفّ دالة doSignup الموجودة في موقعك
  // -----------------------------
  if(typeof window.doSignup !== "function"){
    console.warn("doSignup غير موجود — لا يمكن تطبيق التحديد");
    return;
  }

  const original = window.doSignup.bind(window);

  window.doSignup = async function(){
    // 1) تحقق limit
    const count = await getCount();
    if(count >= LIMIT){
      showLimitMessage();
      return;
    }

    // 2) خذ لقطة قبل التسجيل من profile المحلي
    const before = localStorage.getItem("user_profile_v1");

    // 3) نفّذ التسجيل الأصلي
    await original();

    // 4) ننتظر تغيّر يدل على نجاح التسجيل
    let success = false;
    for(let i=0; i<20; i++){
      await new Promise(r=>setTimeout(r,120));

      const signupPage = document.getElementById("signupPage");
      const after = localStorage.getItem("user_profile_v1");

      if(after && after !== before){
        success = true; break;
      }
      if(signupPage && signupPage.classList.contains("hidden")){
        success = true; break;
      }
    }

    // 5) عند النجاح → خزّن معرف الحساب الجديد
    if(success){
      const profile = JSON.parse(localStorage.getItem("user_profile_v1") || "{}");
      const identifier =
          profile.email ||
          profile.personalNumber ||
          "acc_" + Date.now();

      await addAccount(identifier);
    }
  };

  // ربط الزر مع الدالة المغلّفة
  const btn = document.getElementById("signupBtn");
  if(btn) btn.onclick = window.doSignup;

  // أدوات لفحص القاعدة أثناء التطوير
  window.__accountLimitDB = {
    async count(){ console.log(await getCount()); },
    async reset(){
      const db = await openDB();
      const tx = db.transaction(STORE_NAME, "readwrite");
      tx.objectStore(STORE_NAME).clear();
      tx.oncomplete = ()=> console.log("DB RESET DONE");
    }
  };

})();
</script>

</body>
</html>